<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="前滴滴出行技术专家。极客时间《iOS开发高手课》和纸书《跟戴铭学iOS编程》作者。个人博客：戴铭的博客。微信公共号：starming-weixin。微博：@戴铭">
    <meta name="author" content="戴铭">
    
    <title>
        
            读 SnapKit 和 Masonry 自动布局框架源码 |
        
        戴铭的博客
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/img/logo-starming.png">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"ming1016.github.io","root":"/","language":"zh-Hans"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/img/ming.jpeg","favicon":"/img/logo-starming.png","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":null,"description":"混乱中的有序"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":false,"preload":false},"code_copy":{"enable":false,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                戴铭的博客
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                CATEGORIES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                </ul>
            </div>
            <div class="mobile">
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">CATEGORIES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">读 SnapKit 和 Masonry 自动布局框架源码</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/img/ming.jpeg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">戴铭</span>
                        
                            <span class="author-label">Lv4</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2018-04-07 22:14:18</span>
        <span class="mobile">2018-04-07 22:14</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Programming/">Programming</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/iOS/">iOS</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Swift/">Swift</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>4.9k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>23 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>一直觉得 SnapKit 和 Masonry 这两个框架设计和封装的很好，用起来的体验也是一致的，翻了下它们的源码，对其设计方式和涉及的技术做了下记录。文章打算围绕，给谁做约束？如何设置约束？设置完后如何处理？这三个问题看看 SnapKit 和 Masnory 分别是怎么做的，正好也能够窥探下作者是如何利用 Swift 和 Objective-C 两个不同语言的不同特性做到一致的使用体验的。</p>
<p>如果还不了解这两个框架的使用的话可以参看它们项目 GitHub 说明：<a target="_blank" rel="noopener" href="https://github.com/SnapKit/SnapKit">GitHub - SnapKit&#x2F;SnapKit: A Swift Autolayout DSL for iOS &amp; OS X</a>，<a target="_blank" rel="noopener" href="https://github.com/SnapKit/Masonry">GitHub - SnapKit&#x2F;Masonry: Harness the power of AutoLayout NSLayoutConstraints with a simplified, chainable and expressive syntax. Supports iOS and OSX Auto Layout</a></p>
<p>如果还不了解自动布局或者还没有用过的同学可以参看我三年前这篇文章，里面有详细的介绍和相关资料：<a target="_blank" rel="noopener" href="http://www.starming.com/2015/11/03/deeply-analyse-autolayout/">深入剖析Auto Layout，分析iOS各版本新增特性 | 星光社 - 戴铭的博客</a></p>
<p>进入那三个问题之前我们先看看两个框架的整体结构图，对它们有个大概的印象。</p>
<h2 id="SnapKit-源码结构图"><a href="#SnapKit-源码结构图" class="headerlink" title="SnapKit 源码结构图"></a>SnapKit 源码结构图</h2><p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/uploads/read-snapkit-and-masonry-source-code/01.jpg" class="lozad post-image"src="/uploads/read-snapkit-and-masonry-source-code/01.jpg"></p>
<h2 id="Masonry-源码结构图"><a href="#Masonry-源码结构图" class="headerlink" title="Masonry 源码结构图"></a>Masonry 源码结构图</h2><p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/uploads/read-snapkit-and-masonry-source-code/02.jpg" class="lozad post-image"src="/uploads/read-snapkit-and-masonry-source-code/02.jpg"></p>
<p>接下来我们来详细看看两个框架的内部，首先来看看刚才那三个问题中的第一个问题。</p>
<h1 id="给谁做约束？"><a href="#给谁做约束？" class="headerlink" title="给谁做约束？"></a>给谁做约束？</h1><h2 id="SnapKit"><a href="#SnapKit" class="headerlink" title="SnapKit"></a>SnapKit</h2><h3 id="ConstraintView"><a href="#ConstraintView" class="headerlink" title="ConstraintView"></a>ConstraintView</h3><p>这个 View 实际上在 iOS 里就是 UIView，在 macOS 上就是 NSView。</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token directive property"><span class="token directive-name">#if</span> os<span class="token punctuation">(</span>iOS<span class="token punctuation">)</span> <span class="token operator">||</span> os<span class="token punctuation">(</span>tvOS<span class="token punctuation">)</span></span>
    <span class="token keyword">public</span> <span class="token keyword">typealias</span> <span class="token class-name">ConstraintView</span> <span class="token operator">=</span> <span class="token class-name">UIView</span>
<span class="token directive property"><span class="token directive-name">#else</span></span>
    <span class="token keyword">public</span> <span class="token keyword">typealias</span> <span class="token class-name">ConstraintView</span> <span class="token operator">=</span> <span class="token class-name">NSView</span>
<span class="token directive property"><span class="token directive-name">#endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对 ConstraintView 做扩展，里面定义里一个属性 snp</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">public</span> <span class="token keyword">extension</span> <span class="token class-name">ConstraintView</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">var</span> snp<span class="token punctuation">:</span> <span class="token class-name">ConstraintViewDSL</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">ConstraintViewDSL</span><span class="token punctuation">(</span>view<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个 snp 属性的类型就是结构体 ConstraintViewDSL。下面来看看 ConstraintViewDSL 这个结构体做什么用的。</p>
<h3 id="ConstraintViewDSL"><a href="#ConstraintViewDSL" class="headerlink" title="ConstraintViewDSL"></a>ConstraintViewDSL</h3><p>这个结构体会在初始化时通过 view 属性持有 ConstraintView。</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">internal</span> <span class="token keyword">let</span> view<span class="token punctuation">:</span> <span class="token class-name">ConstraintView</span>

<span class="token keyword">internal</span> <span class="token keyword">init</span><span class="token punctuation">(</span>view<span class="token punctuation">:</span> <span class="token class-name">ConstraintView</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>view <span class="token operator">=</span> view
    
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同时还提供了那些我们必调用的 makeConstraints，contentHuggingHorizontalPriority 等等函数。这样我们就可以在 UIView 中直接调用这些函数来进行视图的约束设置了。</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function-definition function">makeConstraints</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> closure<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token omit keyword">_</span> make<span class="token punctuation">:</span> <span class="token class-name">ConstraintMaker</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">Void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ConstraintMaker</span><span class="token punctuation">.</span><span class="token function">makeConstraints</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">,</span> closure<span class="token punctuation">:</span> closure<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">var</span> contentHuggingHorizontalPriority<span class="token punctuation">:</span> <span class="token class-name">Float</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">get</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span><span class="token function">contentHuggingPriority</span><span class="token punctuation">(</span><span class="token keyword">for</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>horizontal<span class="token punctuation">)</span><span class="token punctuation">.</span>rawValue
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">set</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span><span class="token function">setContentHuggingPriority</span><span class="token punctuation">(</span><span class="token class-name">LayoutPriority</span><span class="token punctuation">(</span>rawValue<span class="token punctuation">:</span> newValue<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">for</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>horizontal<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//还有 remakeConstraints，contentCompressionResistanceHorizontalPriority 等等就不一一列出了</span>
<span class="token operator">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ConstraintViewDSL 是继承自 ConstraintAttributesDSL。</p>
<h3 id="ConstraintAttributesDSL"><a href="#ConstraintAttributesDSL" class="headerlink" title="ConstraintAttributesDSL"></a>ConstraintAttributesDSL</h3><p>ConstraintAttributesDSL 是个协议，继承于 ConstraintBasicAttributesDSL 这个协议，为什么要多这一层呢，因为 ConstraintAttributesDSL 这个里面定了 iOS 8 系统出现的新的属性，比如 lastBaseline，firstBaseline，leftMargin 等。而 ConstraintBasicAttributesDSL 里定义的是一开始就有的那些属性比如 left，top，centerX，size 等。</p>
<h2 id="Masonry"><a href="#Masonry" class="headerlink" title="Masonry"></a>Masonry</h2><p>接下来我们看看 Masonry 是给谁做的约束。</p>
<h3 id="View-MASAdditions"><a href="#View-MASAdditions" class="headerlink" title="View+MASAdditions"></a>View+MASAdditions</h3><p>View+MASAdditions 就是 Masonry 的一个外部的入口，实质上就是 UIView 的一个 Category 作用就是用来设置 MASViewAttribute 的属性，并实例化，并且指定当前的 UIView 对应的 LayoutAttribute。和 SnapKit 一样， Masonry 也对 iOS 和 macOS 做了兼容，在 macOS 里就是 NSView，相关代码在 MASUtilities.h 文件里，这里除了平台相关代码外，还有些宏的定义和静态方法。这里我们可以看看静态方法 static inline id _MASBoxValue(const char *type, …) 的作用：</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token keyword">static</span> <span class="token keyword">inline</span> id <span class="token function">_MASBoxValue</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    va_list v<span class="token punctuation">;</span>
    <span class="token function">va_start</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    id obj <span class="token operator">=</span> nil<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">@</span><span class="token function">encode</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        id actual <span class="token operator">=</span> <span class="token function">va_arg</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> actual<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">@</span><span class="token function">encode</span><span class="token punctuation">(</span>CGPoint<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        CGPoint actual <span class="token operator">=</span> <span class="token punctuation">(</span>CGPoint<span class="token punctuation">)</span><span class="token function">va_arg</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> CGPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token punctuation">[</span>NSValue value<span class="token punctuation">:</span><span class="token operator">&amp;</span>actual withObjCType<span class="token punctuation">:</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">@</span><span class="token function">encode</span><span class="token punctuation">(</span>CGSize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        CGSize actual <span class="token operator">=</span> <span class="token punctuation">(</span>CGSize<span class="token punctuation">)</span><span class="token function">va_arg</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> CGSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token punctuation">[</span>NSValue value<span class="token punctuation">:</span><span class="token operator">&amp;</span>actual withObjCType<span class="token punctuation">:</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">@</span><span class="token function">encode</span><span class="token punctuation">(</span>MASEdgeInsets<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        MASEdgeInsets actual <span class="token operator">=</span> <span class="token punctuation">(</span>MASEdgeInsets<span class="token punctuation">)</span><span class="token function">va_arg</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> MASEdgeInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token punctuation">[</span>NSValue value<span class="token punctuation">:</span><span class="token operator">&amp;</span>actual withObjCType<span class="token punctuation">:</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">@</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">double</span> actual <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token function">va_arg</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token punctuation">[</span>NSNumber numberWithDouble<span class="token punctuation">:</span>actual<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">@</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">float</span> actual <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token function">va_arg</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token punctuation">[</span>NSNumber numberWithFloat<span class="token punctuation">:</span>actual<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">@</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> actual <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">va_arg</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token punctuation">[</span>NSNumber numberWithInt<span class="token punctuation">:</span>actual<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">@</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">long</span> actual <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token function">va_arg</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token punctuation">[</span>NSNumber numberWithLong<span class="token punctuation">:</span>actual<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">@</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">long</span> <span class="token keyword">long</span> actual <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token function">va_arg</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token punctuation">[</span>NSNumber numberWithLongLong<span class="token punctuation">:</span>actual<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">@</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">short</span> actual <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token function">va_arg</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token punctuation">[</span>NSNumber numberWithShort<span class="token punctuation">:</span>actual<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">@</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">char</span> actual <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token function">va_arg</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token punctuation">[</span>NSNumber numberWithChar<span class="token punctuation">:</span>actual<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">@</span><span class="token function">encode</span><span class="token punctuation">(</span>bool<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        bool actual <span class="token operator">=</span> <span class="token punctuation">(</span>bool<span class="token punctuation">)</span><span class="token function">va_arg</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token punctuation">[</span>NSNumber numberWithBool<span class="token punctuation">:</span>actual<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">@</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> actual <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token function">va_arg</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token punctuation">[</span>NSNumber numberWithUnsignedChar<span class="token punctuation">:</span>actual<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">@</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> actual <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">va_arg</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token punctuation">[</span>NSNumber numberWithUnsignedInt<span class="token punctuation">:</span>actual<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">@</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> actual <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token function">va_arg</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token punctuation">[</span>NSNumber numberWithUnsignedLong<span class="token punctuation">:</span>actual<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">@</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> actual <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token function">va_arg</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token punctuation">[</span>NSNumber numberWithUnsignedLongLong<span class="token punctuation">:</span>actual<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">@</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">short</span> actual <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">)</span><span class="token function">va_arg</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token punctuation">[</span>NSNumber numberWithUnsignedShort<span class="token punctuation">:</span>actual<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">va_end</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>看这段代码是不是就能猜出来是做什么的了，对，它就是我们经常使用的 mas_equalTo 这个方法，这里可以看到它是如何支持变参和如何将 float，double，int 这样的值类型数据转换成和 equalTo 一样的对象 NSNumber 数据的。这个写法灵感来自<a target="_blank" rel="noopener" href="https://github.com/specta/expecta">GitHub - specta&#x2F;expecta: A Matcher Framework for Objective-C&#x2F;Cocoa</a>。 mas_equalTo 和 equalTo 都是宏定义的。</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">mas_equalTo</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>                 <span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token function">MASBoxValue</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">equalTo</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>                     <span class="token function">mas_equalTo</span><span class="token punctuation">(</span>__VA_ARGS__<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MASBoxValue</span><span class="token expression"><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token function">_MASBoxValue</span><span class="token punctuation">(</span><span class="token operator">@</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token function">__typeof__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>MASBoxValue 这个宏定义就是上面的 _MASBoxValue 这个方法。细心同学会发现这两个 equal 的宏对应的方法是不同的，一个是 equalTo(MASBoxValue((<strong>VA_ARGS</strong>))) 另一个是 mas_equalTo(<strong>VA_ARGS</strong>) 但是这两个方法的实现是一样的。</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span>MASConstraint <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>equalTo <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token operator">^</span><span class="token function">id</span><span class="token punctuation">(</span>id attribute<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">equalToWithRelation</span><span class="token punctuation">(</span>attribute<span class="token punctuation">,</span> NSLayoutRelationEqual<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token operator">-</span> <span class="token punctuation">(</span>MASConstraint <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>mas_equalTo <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token operator">^</span><span class="token function">id</span><span class="token punctuation">(</span>id attribute<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">equalToWithRelation</span><span class="token punctuation">(</span>attribute<span class="token punctuation">,</span> NSLayoutRelationEqual<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样写就是避免宏定义冲突的一种方式。</p>
<p>这个 Category 还有那些我们总是调用的 mas_makeConstraints，mas_updateConstraints，mas_remakeConstraint 等方法。</p>
<p>mas_makeConstraints 的 block 参数会将创建的 MASConstraintMaker 这个工厂类对象暴露出去，让我们去设置这个类对象中的 MASConstraint 属性，然后通过该对象的 install 方法将当前视图中所有添加的约束添加到一个数组里。该数组里存储是 MASViewConstraint 对象，对应的就是 NSLayoutConstraint。具体代码如下：</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span>NSArray <span class="token operator">*</span><span class="token punctuation">)</span>mas_makeConstraints<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>MASConstraintMaker <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>block <span class="token punctuation">&#123;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>translatesAutoresizingMaskIntoConstraints <span class="token operator">=</span> NO<span class="token punctuation">;</span>
    MASConstraintMaker <span class="token operator">*</span>constraintMaker <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>MASConstraintMaker alloc<span class="token punctuation">]</span> initWithView<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">block</span><span class="token punctuation">(</span>constraintMaker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>constraintMaker install<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这种设计模式和 SnapKit 的一样使用了闭包来获取用户设置的数据，在设计模式里叫做好莱坞原则。</p>
<p>mas_updateConstraints 和 mas_makeConstraints 差不多，不过里面多了一行：</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec">constraintMaker<span class="token punctuation">.</span>updateExisting <span class="token operator">=</span> YES<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这样当添加约束时会通过这个属性是否为真来检查约束是否 intall 了，是的话就更新，没有就添加。</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>updateExisting<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    existingConstraint <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span> layoutConstraintSimilarTo<span class="token punctuation">:</span>layoutConstraint<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>existingConstraint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// just update the constant</span>
    existingConstraint<span class="token punctuation">.</span>constant <span class="token operator">=</span> layoutConstraint<span class="token punctuation">.</span>constant<span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>layoutConstraint <span class="token operator">=</span> existingConstraint<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>installedView addConstraint<span class="token punctuation">:</span>layoutConstraint<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>layoutConstraint <span class="token operator">=</span> layoutConstraint<span class="token punctuation">;</span>
    <span class="token punctuation">[</span>firstLayoutItem<span class="token punctuation">.</span>mas_installedConstraints addObject<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>mas_remakeConstraints 的话是添加了这一句：</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec">constraintMaker<span class="token punctuation">.</span>removeExisting <span class="token operator">=</span> YES<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>设置为 YES 后会将以前设置的约束 uninstall 掉，后面再把新设置的约束添加上。</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>removeExisting<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    NSArray <span class="token operator">*</span>installedConstraints <span class="token operator">=</span> <span class="token punctuation">[</span>MASViewConstraint installedConstraintsForView<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>MASConstraint <span class="token operator">*</span>constraint <span class="token keyword">in</span> installedConstraints<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">[</span>constraint uninstall<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最后还有个方法 mas_closestCommonSuperview，这个方法一般我们都不会主动调用，所以很多人应该都太熟悉，不过这个断言报错大家应该会有很深刻的印象 couldn’t find a common superview for … 。所以这个方法如其名就是去找共同的父视图，还是最近的。框架内部也就在 MASViewConstraint  的 install 方法里用了一次。</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span>instancetype<span class="token punctuation">)</span>mas_closestCommonSuperview<span class="token punctuation">:</span><span class="token punctuation">(</span>MAS_VIEW <span class="token operator">*</span><span class="token punctuation">)</span>view <span class="token punctuation">&#123;</span>
    MAS_VIEW <span class="token operator">*</span>closestCommonSuperview <span class="token operator">=</span> nil<span class="token punctuation">;</span>

    MAS_VIEW <span class="token operator">*</span>secondViewSuperview <span class="token operator">=</span> view<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>closestCommonSuperview <span class="token operator">&amp;&amp;</span> secondViewSuperview<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        MAS_VIEW <span class="token operator">*</span>firstViewSuperview <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>closestCommonSuperview <span class="token operator">&amp;&amp;</span> firstViewSuperview<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>secondViewSuperview <span class="token operator">==</span> firstViewSuperview<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                closestCommonSuperview <span class="token operator">=</span> secondViewSuperview<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            firstViewSuperview <span class="token operator">=</span> firstViewSuperview<span class="token punctuation">.</span>superview<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        secondViewSuperview <span class="token operator">=</span> secondViewSuperview<span class="token punctuation">.</span>superview<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> closestCommonSuperview<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个查找是 N 方的，谁有办法能够优化下么。</p>
<h1 id="如何设置约束？"><a href="#如何设置约束？" class="headerlink" title="如何设置约束？"></a>如何设置约束？</h1><h2 id="SnapKit-1"><a href="#SnapKit-1" class="headerlink" title="SnapKit"></a>SnapKit</h2><p>先看看这张图，里面是我们使用框架时用的最多的设置 make 的过程，图里将每个操作对应的不同 ConstraintMaker 做了说明。<br><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/uploads/read-snapkit-and-masonry-source-code/03.jpg" class="lozad post-image"src="/uploads/read-snapkit-and-masonry-source-code/03.jpg"><br>下面来对这几种 ConstraintMaker 来详细说下。</p>
<h3 id="ConstraintMaker"><a href="#ConstraintMaker" class="headerlink" title="ConstraintMaker"></a>ConstraintMaker</h3><p>这个是设置的入口，makeConstraints 函数一个闭包参数可以提供外部去设置ConstraintMaker 自己的 left，right，top 等属性来描述约束。这些属性的 getter 方法会返回 ConstraintMakerExtendable 实例。</p>
<p>先看看 ConstraintMaker 的构造函数：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">internal</span> <span class="token keyword">init</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> <span class="token class-name">LayoutConstraintItem</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>item <span class="token operator">=</span> item
    <span class="token keyword">self</span><span class="token punctuation">.</span>item<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>LayoutConstraintItem 会通过给扩展 ConstraintLayoutGuide 和 ConstraintView 来达到约束 item 类型的作用。下面看看 prepare 这个函数的作用。</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">internal</span> <span class="token keyword">func</span> <span class="token function-definition function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> view <span class="token operator">=</span> <span class="token keyword">self</span> <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">ConstraintView</span> <span class="token punctuation">&#123;</span>
        view<span class="token punctuation">.</span>translatesAutoresizingMaskIntoConstraints <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>看，禁用 AutoresizeMask 是在这里统一处理了。<br>接下来看看闭包参数设置属性的 getter 方法。</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">public</span> <span class="token keyword">var</span> <span class="token keyword">left</span><span class="token punctuation">:</span> <span class="token class-name">ConstraintMakerExtendable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">makeExtendableWithAttributes</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">internal</span> <span class="token keyword">func</span> <span class="token function-definition function">makeExtendableWithAttributes</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> attributes<span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">ConstraintMakerExtendable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> description <span class="token operator">=</span> <span class="token class-name">ConstraintDescription</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>item<span class="token punctuation">,</span> attributes<span class="token punctuation">:</span> attributes<span class="token punctuation">)</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>descriptions<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>description<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token class-name">ConstraintMakerExtendable</span><span class="token punctuation">(</span>description<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ConstraintMaker 包含了一个 ConstraintDescription 数组，里面会记录用户设置的各个属性，然后返回 ConstraintMakerExtendable。</p>
<h4 id="OptionSet"><a href="#OptionSet" class="headerlink" title="OptionSet"></a>OptionSet</h4><p>这里的 ConstraintAttributes 是个 OptionSet，ConstraintAttributes 结构体来遵从 OptionSet 选项集合协议，为什么不用枚举呢？因为在一次只有一个选项被选中是枚举是 OK 的。但是在 Swift 里的枚举是没法将多个枚举选项组成一个值的，比如 ConstraintAttributes 里的 edges，size 和 center 等就是组合而成的。而 OptionSet 结构体使用了高效的位域来表示的。还有，OptionSet 继承于 ExpressibleByArrayLiteral，这样还能够使用数组字面量来生成选项的集合。下面看看这个 ConstraintAttributes 是如何定义的。</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">var</span> <span class="token keyword">none</span><span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">var</span> <span class="token keyword">left</span><span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">var</span> top<span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">var</span> <span class="token keyword">right</span><span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">var</span> bottom<span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">var</span> leading<span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">var</span> trailing<span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">var</span> width<span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">var</span> height<span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">var</span> centerX<span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">var</span> centerY<span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token comment">//更多就不一一列出来</span>
<span class="token operator">...</span>
<span class="token comment">// 组合的</span>
<span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">var</span> edges<span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">var</span> size<span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><span class="token number">192</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">var</span> center<span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><span class="token number">768</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>

<span class="token attribute atrule">@available</span><span class="token punctuation">(</span>iOS <span class="token number">8.0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">var</span> margins<span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><span class="token number">61440</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token comment">//还有一些，先不列了</span>
<span class="token operator">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到组合的 size 就是 width（64） + height（128）&#x3D; size（192）。</p>
<h4 id="重载和自定义操作符"><a href="#重载和自定义操作符" class="headerlink" title="重载和自定义操作符"></a>重载和自定义操作符</h4><p>ConstraintAttributes 重载了 +，+&#x3D;，-&#x3D; 和 &#x3D;&#x3D; 这些操作符。我们先看看代码</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">internal</span> <span class="token keyword">func</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">left</span><span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span><span class="token punctuation">,</span> <span class="token keyword">right</span><span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">ConstraintAttributes</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">left</span><span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span><span class="token keyword">right</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">internal</span> <span class="token keyword">func</span> <span class="token operator">+=</span><span class="token punctuation">(</span><span class="token keyword">left</span><span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token class-name">ConstraintAttributes</span><span class="token punctuation">,</span> <span class="token keyword">right</span><span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">left</span><span class="token punctuation">.</span><span class="token function">formUnion</span><span class="token punctuation">(</span><span class="token keyword">right</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">internal</span> <span class="token keyword">func</span> <span class="token operator">-=</span><span class="token punctuation">(</span><span class="token keyword">left</span><span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token class-name">ConstraintAttributes</span><span class="token punctuation">,</span> <span class="token keyword">right</span><span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">left</span><span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span><span class="token keyword">right</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">internal</span> <span class="token keyword">func</span> <span class="token operator">==</span><span class="token punctuation">(</span><span class="token keyword">left</span><span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span><span class="token punctuation">,</span> <span class="token keyword">right</span><span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">Bool</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">left</span><span class="token punctuation">.</span>rawValue <span class="token operator">==</span> <span class="token keyword">right</span><span class="token punctuation">.</span>rawValue
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这种重载很适合对自定义的结构体进行一些熟悉的简化符号操作。</p>
<p>如果希望自定义一些操作符的话就需要先声明下，让编译器知道这是个操作符，比如我们自定义一个操作符☃</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">struct</span> <span class="token class-name">A</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> v<span class="token punctuation">:</span><span class="token class-name">Int</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">infix</span> <span class="token keyword">operator</span> ☃
<span class="token keyword">func</span> ☃<span class="token punctuation">(</span><span class="token keyword">left</span><span class="token punctuation">:</span> <span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token keyword">right</span><span class="token punctuation">:</span> <span class="token class-name">A</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">Bool</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">left</span><span class="token punctuation">.</span>v <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> <span class="token keyword">right</span><span class="token punctuation">.</span>v
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的 infix 是中间运算符的意思，还有前置运算符 prefix 和后置运算符 postfix。自定义运算符之能是类似，&#x2F;，&#x3D;，-，+，*，%，&lt;，&gt;，!，&amp;，|，^，。，~ 等这样的符号组成，也能支持一些特殊的字符比如刚才的用的☃，还有⨁，∉ 这样的特殊符号。</p>
<p>自定义运算符还能够指定优先级分组 precedencegroup，如下：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">infix</span> <span class="token keyword">operator</span> ⊆ <span class="token punctuation">:</span> <span class="token class-name">CPrecedence</span>
<span class="token keyword">precedencegroup</span> <span class="token class-name">CPrecedence</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">associativity</span><span class="token punctuation">:</span> <span class="token keyword">left</span>
    <span class="token keyword">higherThan</span><span class="token punctuation">:</span> <span class="token class-name">AdditionPrecedence</span>
    <span class="token keyword">lowerThan</span><span class="token punctuation">:</span> <span class="token class-name">MultiplicationPrecedence</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下面列下常用类型对应的group</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token comment">// "Exponentiative"</span>
<span class="token keyword">infix</span> <span class="token keyword">operator</span>  <span class="token operator">&lt;&lt;</span> <span class="token punctuation">:</span> <span class="token class-name">BitwiseShiftPrecedence</span>
<span class="token keyword">infix</span> <span class="token keyword">operator</span> <span class="token operator">&amp;&lt;&lt;</span> <span class="token punctuation">:</span> <span class="token class-name">BitwiseShiftPrecedence</span>
<span class="token keyword">infix</span> <span class="token keyword">operator</span>  <span class="token operator">>></span> <span class="token punctuation">:</span> <span class="token class-name">BitwiseShiftPrecedence</span>
<span class="token keyword">infix</span> <span class="token keyword">operator</span> <span class="token operator">&amp;>></span> <span class="token punctuation">:</span> <span class="token class-name">BitwiseShiftPrecedence</span>

<span class="token comment">// "Multiplicative"</span>
<span class="token keyword">infix</span> <span class="token keyword">operator</span>   <span class="token operator">*</span> <span class="token punctuation">:</span> <span class="token class-name">MultiplicationPrecedence</span>
<span class="token keyword">infix</span> <span class="token keyword">operator</span>  <span class="token operator">&amp;*</span> <span class="token punctuation">:</span> <span class="token class-name">MultiplicationPrecedence</span>
<span class="token keyword">infix</span> <span class="token keyword">operator</span>   <span class="token operator">/</span> <span class="token punctuation">:</span> <span class="token class-name">MultiplicationPrecedence</span>
<span class="token keyword">infix</span> <span class="token keyword">operator</span>   <span class="token operator">%</span> <span class="token punctuation">:</span> <span class="token class-name">MultiplicationPrecedence</span>
<span class="token keyword">infix</span> <span class="token keyword">operator</span>   <span class="token operator">&amp;</span> <span class="token punctuation">:</span> <span class="token class-name">MultiplicationPrecedence</span>

<span class="token comment">// "Additive"</span>
<span class="token keyword">infix</span> <span class="token keyword">operator</span>   <span class="token operator">+</span> <span class="token punctuation">:</span> <span class="token class-name">AdditionPrecedence</span>
<span class="token keyword">infix</span> <span class="token keyword">operator</span>  <span class="token operator">&amp;+</span> <span class="token punctuation">:</span> <span class="token class-name">AdditionPrecedence</span>
<span class="token keyword">infix</span> <span class="token keyword">operator</span>   <span class="token operator">-</span> <span class="token punctuation">:</span> <span class="token class-name">AdditionPrecedence</span>
<span class="token keyword">infix</span> <span class="token keyword">operator</span>  <span class="token operator">&amp;-</span> <span class="token punctuation">:</span> <span class="token class-name">AdditionPrecedence</span>
<span class="token keyword">infix</span> <span class="token keyword">operator</span>   <span class="token operator">|</span> <span class="token punctuation">:</span> <span class="token class-name">AdditionPrecedence</span>
<span class="token keyword">infix</span> <span class="token keyword">operator</span>   <span class="token operator">^</span> <span class="token punctuation">:</span> <span class="token class-name">AdditionPrecedence</span>

<span class="token comment">// FIXME: is this the right precedence level for "..." ?</span>
<span class="token keyword">infix</span> <span class="token keyword">operator</span>  <span class="token operator">...</span> <span class="token punctuation">:</span> <span class="token class-name">RangeFormationPrecedence</span>
<span class="token keyword">infix</span> <span class="token keyword">operator</span> <span class="token operator">..&lt;</span> <span class="token punctuation">:</span> <span class="token class-name">RangeFormationPrecedence</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>完整的操作符的定义和 precedencegroup 之间的优先级关系在 Swift 源码的  swift&#x2F;stdlib&#x2F;public&#x2F;core&#x2F;Policy.swift 文件里，在线看地址是：<a target="_blank" rel="noopener" href="https://github.com/apple/swift/blob/a7ff0da33488b9050cf83df95f46e5b9aa2348d5/stdlib/public/core/Policy.swift">https://github.com/apple/swift/blob/a7ff0da33488b9050cf83df95f46e5b9aa2348d5/stdlib/public/core/Policy.swift</a> 。那些操作符优先级高些或者低些在这个文件里是一目了然。</p>
<h3 id="ConstraintMakerExtendable"><a href="#ConstraintMakerExtendable" class="headerlink" title="ConstraintMakerExtendable"></a>ConstraintMakerExtendable</h3><p>ConstraintMakerExtendable 继承 ConstraintMakerRelatable，它可以实现链式的多属性，有left，right，top 等等这样的属性，用以产生一个 ConstraintMakerRelatable 类型的实例。<br>我们看看 left 属性的 getter 定义：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">public</span> <span class="token keyword">var</span> <span class="token keyword">left</span><span class="token punctuation">:</span> <span class="token class-name">ConstraintMakerExtendable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>description<span class="token punctuation">.</span>attributes <span class="token operator">+=</span> <span class="token punctuation">.</span><span class="token keyword">left</span>
    <span class="token keyword">return</span> <span class="token keyword">self</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里可以看到通过重载的操作符 +&#x3D; 能够将 .left 加到 ConstraintAttributes 里。</p>
<h3 id="ConstraintMakerRelatable"><a href="#ConstraintMakerRelatable" class="headerlink" title="ConstraintMakerRelatable"></a>ConstraintMakerRelatable</h3><p>用于指定约束关系比如常用的 equalTo。equalTo 函数里面是调用的 relatedTo 函数，返回 ConstraintMakerEditable 类型的实例。</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token attribute atrule">@discardableResult</span>
<span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function-definition function">equalTo</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> other<span class="token punctuation">:</span> <span class="token class-name">ConstraintRelatableTarget</span><span class="token punctuation">,</span> <span class="token omit keyword">_</span> file<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token operator">=</span> <span class="token literal constant">#file</span><span class="token punctuation">,</span> <span class="token omit keyword">_</span> line<span class="token punctuation">:</span> <span class="token class-name">UInt</span> <span class="token operator">=</span> <span class="token literal constant">#line</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">ConstraintMakerEditable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">relatedTo</span><span class="token punctuation">(</span>other<span class="token punctuation">,</span> relation<span class="token punctuation">:</span> <span class="token punctuation">.</span>equal<span class="token punctuation">,</span> file<span class="token punctuation">:</span> file<span class="token punctuation">,</span> line<span class="token punctuation">:</span> line<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">internal</span> <span class="token keyword">func</span> <span class="token function-definition function">relatedTo</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> other<span class="token punctuation">:</span> <span class="token class-name">ConstraintRelatableTarget</span><span class="token punctuation">,</span> relation<span class="token punctuation">:</span> <span class="token class-name">ConstraintRelation</span><span class="token punctuation">,</span> file<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> line<span class="token punctuation">:</span> <span class="token class-name">UInt</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">ConstraintMakerEditable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> related<span class="token punctuation">:</span> <span class="token class-name">ConstraintItem</span>
    <span class="token keyword">let</span> constant<span class="token punctuation">:</span> <span class="token class-name">ConstraintConstantTarget</span>
    
    <span class="token keyword">if</span> <span class="token keyword">let</span> other <span class="token operator">=</span> other <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">ConstraintItem</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">guard</span> other<span class="token punctuation">.</span>attributes <span class="token operator">==</span> <span class="token class-name">ConstraintAttributes</span><span class="token punctuation">.</span><span class="token keyword">none</span> <span class="token operator">||</span>
            other<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span>layoutAttributes<span class="token punctuation">.</span>count <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token operator">||</span>
            other<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span>layoutAttributes <span class="token operator">==</span> <span class="token keyword">self</span><span class="token punctuation">.</span>description<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span>layoutAttributes <span class="token operator">||</span>
            other<span class="token punctuation">.</span>attributes <span class="token operator">==</span> <span class="token punctuation">.</span>edges <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>description<span class="token punctuation">.</span>attributes <span class="token operator">==</span> <span class="token punctuation">.</span>margins <span class="token operator">||</span>
            other<span class="token punctuation">.</span>attributes <span class="token operator">==</span> <span class="token punctuation">.</span>margins <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>description<span class="token punctuation">.</span>attributes <span class="token operator">==</span> <span class="token punctuation">.</span>edges <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token function">fatalError</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Cannot constraint to multiple non identical attributes. (</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">file</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">, </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">line</span><span class="token interpolation-punctuation punctuation">)</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        related <span class="token operator">=</span> other
        constant <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token keyword">let</span> other <span class="token operator">=</span> other <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">ConstraintView</span> <span class="token punctuation">&#123;</span>
        related <span class="token operator">=</span> <span class="token class-name">ConstraintItem</span><span class="token punctuation">(</span>target<span class="token punctuation">:</span> other<span class="token punctuation">,</span> attributes<span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span><span class="token punctuation">.</span><span class="token keyword">none</span><span class="token punctuation">)</span>
        constant <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token keyword">let</span> other <span class="token operator">=</span> other <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">ConstraintConstantTarget</span> <span class="token punctuation">&#123;</span>
        related <span class="token operator">=</span> <span class="token class-name">ConstraintItem</span><span class="token punctuation">(</span>target<span class="token punctuation">:</span> <span class="token nil constant">nil</span><span class="token punctuation">,</span> attributes<span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span><span class="token punctuation">.</span><span class="token keyword">none</span><span class="token punctuation">)</span>
        constant <span class="token operator">=</span> other
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token other-directive property">#available</span><span class="token punctuation">(</span>iOS <span class="token number">9.0</span><span class="token punctuation">,</span> <span class="token constant">OSX</span> <span class="token number">10.11</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">let</span> other <span class="token operator">=</span> other <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">ConstraintLayoutGuide</span> <span class="token punctuation">&#123;</span>
        related <span class="token operator">=</span> <span class="token class-name">ConstraintItem</span><span class="token punctuation">(</span>target<span class="token punctuation">:</span> other<span class="token punctuation">,</span> attributes<span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span><span class="token punctuation">.</span><span class="token keyword">none</span><span class="token punctuation">)</span>
        constant <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">fatalError</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Invalid constraint. (</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">file</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">, </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">line</span><span class="token interpolation-punctuation punctuation">)</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">let</span> editable <span class="token operator">=</span> <span class="token class-name">ConstraintMakerEditable</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>description<span class="token punctuation">)</span>
    editable<span class="token punctuation">.</span>description<span class="token punctuation">.</span>sourceLocation <span class="token operator">=</span> <span class="token punctuation">(</span>file<span class="token punctuation">,</span> line<span class="token punctuation">)</span>
    editable<span class="token punctuation">.</span>description<span class="token punctuation">.</span>relation <span class="token operator">=</span> relation
    editable<span class="token punctuation">.</span>description<span class="token punctuation">.</span>related <span class="token operator">=</span> related
    editable<span class="token punctuation">.</span>description<span class="token punctuation">.</span>constant <span class="token operator">=</span> constant
    <span class="token keyword">return</span> editable
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的 ConstraintRelatableTarget 是约束，equalTo 这个方法里面能传的参数类型比较多，可以通过这个协议来扩展下只支持的类型，达到限制类型的功能。ConstraintPriorityTarget，ConstraintInsetTarget，ConstraintOffsetTarget 和 ConstraintInsetTarget 也都有类似的作用，不过这几个还有个作用就是将 Float，Double，Int 和 UInt 这几种类型都转成 CGFloat。我们拿 ConstraintInsetTarget 来看看实现如下：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">extension</span> <span class="token class-name">ConstraintInsetTarget</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">internal</span> <span class="token keyword">var</span> constraintInsetTargetValue<span class="token punctuation">:</span> <span class="token class-name">ConstraintInsets</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> amount <span class="token operator">=</span> <span class="token keyword">self</span> <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">ConstraintInsets</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> amount
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token keyword">let</span> amount <span class="token operator">=</span> <span class="token keyword">self</span> <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">Float</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConstraintInsets</span><span class="token punctuation">(</span>top<span class="token punctuation">:</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">left</span><span class="token punctuation">:</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">,</span> bottom<span class="token punctuation">:</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">right</span><span class="token punctuation">:</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token keyword">let</span> amount <span class="token operator">=</span> <span class="token keyword">self</span> <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">Double</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConstraintInsets</span><span class="token punctuation">(</span>top<span class="token punctuation">:</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">left</span><span class="token punctuation">:</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">,</span> bottom<span class="token punctuation">:</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">right</span><span class="token punctuation">:</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token keyword">let</span> amount <span class="token operator">=</span> <span class="token keyword">self</span> <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">CGFloat</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConstraintInsets</span><span class="token punctuation">(</span>top<span class="token punctuation">:</span> amount<span class="token punctuation">,</span> <span class="token keyword">left</span><span class="token punctuation">:</span> amount<span class="token punctuation">,</span> bottom<span class="token punctuation">:</span> amount<span class="token punctuation">,</span> <span class="token keyword">right</span><span class="token punctuation">:</span> amount<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token keyword">let</span> amount <span class="token operator">=</span> <span class="token keyword">self</span> <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">Int</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConstraintInsets</span><span class="token punctuation">(</span>top<span class="token punctuation">:</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">left</span><span class="token punctuation">:</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">,</span> bottom<span class="token punctuation">:</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">right</span><span class="token punctuation">:</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token keyword">let</span> amount <span class="token operator">=</span> <span class="token keyword">self</span> <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">UInt</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConstraintInsets</span><span class="token punctuation">(</span>top<span class="token punctuation">:</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">left</span><span class="token punctuation">:</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">,</span> bottom<span class="token punctuation">:</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">right</span><span class="token punctuation">:</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConstraintInsets</span><span class="token punctuation">(</span>top<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">left</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> bottom<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">right</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ConstraintMakerEditable"><a href="#ConstraintMakerEditable" class="headerlink" title="ConstraintMakerEditable"></a>ConstraintMakerEditable</h3><p>ConstraintMakerEditable 继承 ConstraintMakerPriortizable，主要是设置约束的 offset 和 inset 还有 multipliedBy 和 dividedBy 函数。</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConstraintMakerEditable</span><span class="token punctuation">:</span> <span class="token class-name">ConstraintMakerPriortizable</span> <span class="token punctuation">&#123;</span>

    <span class="token attribute atrule">@discardableResult</span>
    <span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function-definition function">multipliedBy</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> amount<span class="token punctuation">:</span> <span class="token class-name">ConstraintMultiplierTarget</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">ConstraintMakerEditable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>description<span class="token punctuation">.</span>multiplier <span class="token operator">=</span> amount
        <span class="token keyword">return</span> <span class="token keyword">self</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token attribute atrule">@discardableResult</span>
    <span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function-definition function">dividedBy</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> amount<span class="token punctuation">:</span> <span class="token class-name">ConstraintMultiplierTarget</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">ConstraintMakerEditable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">multipliedBy</span><span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">/</span> amount<span class="token punctuation">.</span>constraintMultiplierTargetValue<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token attribute atrule">@discardableResult</span>
    <span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function-definition function">offset</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> amount<span class="token punctuation">:</span> <span class="token class-name">ConstraintOffsetTarget</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">ConstraintMakerEditable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>description<span class="token punctuation">.</span>constant <span class="token operator">=</span> amount<span class="token punctuation">.</span>constraintOffsetTargetValue
        <span class="token keyword">return</span> <span class="token keyword">self</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token attribute atrule">@discardableResult</span>
    <span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function-definition function">inset</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> amount<span class="token punctuation">:</span> <span class="token class-name">ConstraintInsetTarget</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">ConstraintMakerEditable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>description<span class="token punctuation">.</span>constant <span class="token operator">=</span> amount<span class="token punctuation">.</span>constraintInsetTargetValue
        <span class="token keyword">return</span> <span class="token keyword">self</span>
    <span class="token punctuation">&#125;</span>
    
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ConstraintMakerPriortizable"><a href="#ConstraintMakerPriortizable" class="headerlink" title="ConstraintMakerPriortizable"></a>ConstraintMakerPriortizable</h3><p>ConstraintMakerPriortizable 继承 ConstraintMakerFinalizable，用来设置优先级，返回 ConstraintMakerFinalizable 类型的实例。</p>
<h3 id="ConstraintMakerFinalizable"><a href="#ConstraintMakerFinalizable" class="headerlink" title="ConstraintMakerFinalizable"></a>ConstraintMakerFinalizable</h3><p>里面类型为 ConstraintDescription 的属性的类是一个完整的约束描述，有了这个描述就可以做后面的处理了。里面的内容是完整的，这个类是一个描述类, 用于描述一条具体的约束, 包含了包括 ConstraintAttributes 在内的各种与约束有关的元素，一个 ConstraintDescription 实例，就可以提供与一种约束有关的所有内容。可以看到前面设置的属性，关系，乘除系数，优先级等因有尽有，如下：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConstraintDescription</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">internal</span> <span class="token keyword">let</span> item<span class="token punctuation">:</span> <span class="token class-name">LayoutConstraintItem</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> attributes<span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> relation<span class="token punctuation">:</span> <span class="token class-name">ConstraintRelation</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> sourceLocation<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">UInt</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> label<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> related<span class="token punctuation">:</span> <span class="token class-name">ConstraintItem</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> multiplier<span class="token punctuation">:</span> <span class="token class-name">ConstraintMultiplierTarget</span> <span class="token operator">=</span> <span class="token number">1.0</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> constant<span class="token punctuation">:</span> <span class="token class-name">ConstraintConstantTarget</span> <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> priority<span class="token punctuation">:</span> <span class="token class-name">ConstraintPriorityTarget</span> <span class="token operator">=</span> <span class="token number">1000.0</span>
    <span class="token keyword">internal</span> <span class="token keyword">lazy</span> <span class="token keyword">var</span> constraint<span class="token punctuation">:</span> <span class="token class-name">Constraint</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">guard</span> <span class="token keyword">let</span> relation <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>relation<span class="token punctuation">,</span>
              <span class="token keyword">let</span> related <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>related<span class="token punctuation">,</span>
              <span class="token keyword">let</span> sourceLocation <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>sourceLocation <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token nil constant">nil</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">let</span> from <span class="token operator">=</span> <span class="token class-name">ConstraintItem</span><span class="token punctuation">(</span>target<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>item<span class="token punctuation">,</span> attributes<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>attributes<span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> <span class="token class-name">Constraint</span><span class="token punctuation">(</span>
            from<span class="token punctuation">:</span> from<span class="token punctuation">,</span>
            to<span class="token punctuation">:</span> related<span class="token punctuation">,</span>
            relation<span class="token punctuation">:</span> relation<span class="token punctuation">,</span>
            sourceLocation<span class="token punctuation">:</span> sourceLocation<span class="token punctuation">,</span>
            label<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>label<span class="token punctuation">,</span>
            multiplier<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>multiplier<span class="token punctuation">,</span>
            constant<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>constant<span class="token punctuation">,</span>
            priority<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>priority
        <span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">// MARK: Initialization</span>
    
    <span class="token keyword">internal</span> <span class="token keyword">init</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> <span class="token class-name">LayoutConstraintItem</span><span class="token punctuation">,</span> attributes<span class="token punctuation">:</span> <span class="token class-name">ConstraintAttributes</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>item <span class="token operator">=</span> item
        <span class="token keyword">self</span><span class="token punctuation">.</span>attributes <span class="token operator">=</span> attributes
    <span class="token punctuation">&#125;</span>
    
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Masonry-1"><a href="#Masonry-1" class="headerlink" title="Masonry"></a>Masonry</h2><p>在 Masonry 也有对应的 ConstraintMaker。</p>
<h3 id="MASConstraintMaker"><a href="#MASConstraintMaker" class="headerlink" title="MASConstraintMaker"></a>MASConstraintMaker</h3><p>MASConstraintMaker 是创建 MASConstraint 对象的。里面有个 constraints 数组专门用来存储创建的这些对象。前面 mas_makeConstraints 的那个 Block 暴露出的就是 MASConstraintMaker 对象。</p>
<p>接下来看看 MASConstraint 属性的 getter 方法：</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span>MASConstraint <span class="token operator">*</span><span class="token punctuation">)</span>left <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">self</span> addConstraintWithLayoutAttribute<span class="token punctuation">:</span>NSLayoutAttributeLeft<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>会发现这些 getter 方法都会调用 addConstraintWithLayoutAttribute 这个方法。</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span>MASConstraint <span class="token operator">*</span><span class="token punctuation">)</span>constraint<span class="token punctuation">:</span><span class="token punctuation">(</span>MASConstraint <span class="token operator">*</span><span class="token punctuation">)</span>constraint addConstraintWithLayoutAttribute<span class="token punctuation">:</span><span class="token punctuation">(</span>NSLayoutAttribute<span class="token punctuation">)</span>layoutAttribute <span class="token punctuation">&#123;</span>
    MASViewAttribute <span class="token operator">*</span>viewAttribute <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>MASViewAttribute alloc<span class="token punctuation">]</span> initWithView<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>view layoutAttribute<span class="token punctuation">:</span>layoutAttribute<span class="token punctuation">]</span><span class="token punctuation">;</span>
    MASViewConstraint <span class="token operator">*</span>newConstraint <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>MASViewConstraint alloc<span class="token punctuation">]</span> initWithFirstViewAttribute<span class="token punctuation">:</span>viewAttribute<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>constraint isKindOfClass<span class="token punctuation">:</span>MASViewConstraint<span class="token punctuation">.</span>class<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//replace with composite constraint</span>
        NSArray <span class="token operator">*</span>children <span class="token operator">=</span> <span class="token operator">@</span><span class="token punctuation">[</span>constraint<span class="token punctuation">,</span> newConstraint<span class="token punctuation">]</span><span class="token punctuation">;</span>
        MASCompositeConstraint <span class="token operator">*</span>compositeConstraint <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>MASCompositeConstraint alloc<span class="token punctuation">]</span> initWithChildren<span class="token punctuation">:</span>children<span class="token punctuation">]</span><span class="token punctuation">;</span>
        compositeConstraint<span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token keyword">self</span> constraint<span class="token punctuation">:</span>constraint shouldBeReplacedWithConstraint<span class="token punctuation">:</span>compositeConstraint<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> compositeConstraint<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>constraint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        newConstraint<span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>constraints addObject<span class="token punctuation">:</span>newConstraint<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> newConstraint<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里会发现每次 getter 都会创建一个新的 MASViewConstraint 对象，这里通过将新的 MASViewConstraint 对象的 delegate 设置成自己的方式让新对象也能够调用相同的方法创建一个新的 MASViewConstraint 对象，使得能够支持进行链式的调用。</p>
<h1 id="设置完后如何处理？"><a href="#设置完后如何处理？" class="headerlink" title="设置完后如何处理？"></a>设置完后如何处理？</h1><h2 id="SnapKit-2"><a href="#SnapKit-2" class="headerlink" title="SnapKit"></a>SnapKit</h2><p>下面通过 makeConstraints 我们来看看 ConstraintMaker 是如何在外部通过一个闭包来写约束关系的。</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">makeConstraints</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> <span class="token class-name">LayoutConstraintItem</span><span class="token punctuation">,</span> closure<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token omit keyword">_</span> make<span class="token punctuation">:</span> <span class="token class-name">ConstraintMaker</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">Void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> maker <span class="token operator">=</span> <span class="token class-name">ConstraintMaker</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> item<span class="token punctuation">)</span>
    <span class="token function">closure</span><span class="token punctuation">(</span>maker<span class="token punctuation">)</span>
    <span class="token keyword">var</span> constraints<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Constraint</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> description <span class="token keyword">in</span> maker<span class="token punctuation">.</span>descriptions <span class="token punctuation">&#123;</span>
        <span class="token keyword">guard</span> <span class="token keyword">let</span> constraint <span class="token operator">=</span> description<span class="token punctuation">.</span>constraint <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">&#125;</span>
        constraints<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>constraint<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> constraint <span class="token keyword">in</span> constraints <span class="token punctuation">&#123;</span>
        constraint<span class="token punctuation">.</span><span class="token function">activateIfNeeded</span><span class="token punctuation">(</span>updatingExisting<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个闭包给叫做 maker 的 ConstraintMaker 实例写入了信息，遍历 maker 的 descriptions 之后（我们之前说一条约束语句最终得到一个 self.description，但往往会有多条约束，所以 ConstraintMakerFinalizable 里面的 self.description，在 ConstraintMaker 里被一个数组维护），我们得到了 Constraint 数组。<br>跟进 Constraint 里的 activateIfNeeded 这个函数看看约束是怎么写出来的了</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">internal</span> <span class="token keyword">func</span> <span class="token function-definition function">activateIfNeeded</span><span class="token punctuation">(</span>updatingExisting<span class="token punctuation">:</span> <span class="token class-name">Bool</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">guard</span> <span class="token keyword">let</span> item <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>from<span class="token punctuation">.</span>layoutConstraintItem <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"WARNING: SnapKit failed to get from item from constraint. Activate will be a no-op."</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">let</span> layoutConstraints <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>layoutConstraints
    
    <span class="token keyword">if</span> updatingExisting <span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> existingLayoutConstraints<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">LayoutConstraint</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> constraint <span class="token keyword">in</span> item<span class="token punctuation">.</span>constraints <span class="token punctuation">&#123;</span>
            existingLayoutConstraints <span class="token operator">+=</span> constraint<span class="token punctuation">.</span>layoutConstraints
        <span class="token punctuation">&#125;</span>
        
        <span class="token keyword">for</span> layoutConstraint <span class="token keyword">in</span> layoutConstraints <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> existingLayoutConstraint <span class="token operator">=</span> existingLayoutConstraints<span class="token punctuation">.</span>first <span class="token punctuation">&#123;</span> <span class="token short-argument">$0</span> <span class="token operator">==</span> layoutConstraint <span class="token punctuation">&#125;</span>
            <span class="token keyword">guard</span> <span class="token keyword">let</span> updateLayoutConstraint <span class="token operator">=</span> existingLayoutConstraint <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token function">fatalError</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Updated constraint could not find existing matching constraint to update: </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">layoutConstraint</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
            
            <span class="token keyword">let</span> updateLayoutAttribute <span class="token operator">=</span> <span class="token punctuation">(</span>updateLayoutConstraint<span class="token punctuation">.</span>secondAttribute <span class="token operator">==</span> <span class="token punctuation">.</span>notAnAttribute<span class="token punctuation">)</span> <span class="token operator">?</span> updateLayoutConstraint<span class="token punctuation">.</span>firstAttribute <span class="token punctuation">:</span> updateLayoutConstraint<span class="token punctuation">.</span>secondAttribute
            updateLayoutConstraint<span class="token punctuation">.</span>constant <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>constant<span class="token punctuation">.</span><span class="token function">constraintConstantTargetValueFor</span><span class="token punctuation">(</span>layoutAttribute<span class="token punctuation">:</span> updateLayoutAttribute<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">NSLayoutConstraint</span><span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span>layoutConstraints<span class="token punctuation">)</span>
        item<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>constraints<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Masonry-2"><a href="#Masonry-2" class="headerlink" title="Masonry"></a>Masonry</h2><h3 id="MASViewConstraint"><a href="#MASViewConstraint" class="headerlink" title="MASViewConstraint"></a>MASViewConstraint</h3><p>这个类是对 NSLayoutConstriant 的封装。它的父类是 MASConstraint，MASConstraint 是一个抽象不可实例的类，里面有接口和协议。它的兄弟类是 MASCompositeConstraint，里面有个数组专门存储 MASViewConstraint 对象。</p>
<p>MASViewConstraint 对象的 install 方法会将各个约束 install 到对应的视图上。我们看看 MASConstraintMaker 的 install 方法：</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span>NSArray <span class="token operator">*</span><span class="token punctuation">)</span>install <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>removeExisting<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        NSArray <span class="token operator">*</span>installedConstraints <span class="token operator">=</span> <span class="token punctuation">[</span>MASViewConstraint installedConstraintsForView<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>MASConstraint <span class="token operator">*</span>constraint <span class="token keyword">in</span> installedConstraints<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">[</span>constraint uninstall<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    NSArray <span class="token operator">*</span>constraints <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>constraints<span class="token punctuation">.</span>copy<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>MASConstraint <span class="token operator">*</span>constraint <span class="token keyword">in</span> constraints<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        constraint<span class="token punctuation">.</span>updateExisting <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>updateExisting<span class="token punctuation">;</span>
        <span class="token punctuation">[</span>constraint install<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>constraints removeAllObjects<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> constraints<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法会遍历 constraints 里每个约束进行 install。在这个 install 方法里会创建 MASLayoutConstraint 对象，然后把这个对象添加到对应的的视图上。</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec">MASLayoutConstraint <span class="token operator">*</span>layoutConstraint
    <span class="token operator">=</span> <span class="token punctuation">[</span>MASLayoutConstraint constraintWithItem<span class="token punctuation">:</span>firstLayoutItem
        attribute<span class="token punctuation">:</span>firstLayoutAttribute
        relatedBy<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>layoutRelation
        toItem<span class="token punctuation">:</span>secondLayoutItem
        attribute<span class="token punctuation">:</span>secondLayoutAttribute
        multiplier<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>layoutMultiplier
        constant<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>layoutConstant<span class="token punctuation">]</span><span class="token punctuation">;</span>

layoutConstraint<span class="token punctuation">.</span>priority <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>layoutPriority<span class="token punctuation">;</span>
layoutConstraint<span class="token punctuation">.</span>mas_key <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>mas_key<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建完 MASLayoutConstraint 对象后，会根据约束的设置判断将约束添加到哪个视图上。</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>secondViewAttribute<span class="token punctuation">.</span>view<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    MAS_VIEW <span class="token operator">*</span>closestCommonSuperview <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>firstViewAttribute<span class="token punctuation">.</span>view mas_closestCommonSuperview<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>secondViewAttribute<span class="token punctuation">.</span>view<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">NSAssert</span><span class="token punctuation">(</span>closestCommonSuperview<span class="token punctuation">,</span>
             <span class="token string">@"couldn't find a common superview for %@ and %@"</span><span class="token punctuation">,</span>
              <span class="token keyword">self</span><span class="token punctuation">.</span>firstViewAttribute<span class="token punctuation">.</span>view<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>secondViewAttribute<span class="token punctuation">.</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>installedView <span class="token operator">=</span> closestCommonSuperview<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>firstViewAttribute<span class="token punctuation">.</span>isSizeAttribute<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>installedView <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>firstViewAttribute<span class="token punctuation">.</span>view<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>installedView <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>firstViewAttribute<span class="token punctuation">.</span>view<span class="token punctuation">.</span>superview<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


MASLayoutConstraint <span class="token operator">*</span>existingConstraint <span class="token operator">=</span> nil<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>updateExisting<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    existingConstraint <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span> layoutConstraintSimilarTo<span class="token punctuation">:</span>layoutConstraint<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>existingConstraint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// just update the constant</span>
    existingConstraint<span class="token punctuation">.</span>constant <span class="token operator">=</span> layoutConstraint<span class="token punctuation">.</span>constant<span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>layoutConstraint <span class="token operator">=</span> existingConstraint<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>installedView addConstraint<span class="token punctuation">:</span>layoutConstraint<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>layoutConstraint <span class="token operator">=</span> layoutConstraint<span class="token punctuation">;</span>
    <span class="token punctuation">[</span>firstLayoutItem<span class="token punctuation">.</span>mas_installedConstraints addObject<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过上面代码里的条件判断可以看出，如果有设置相对的那个视图就用先前提到的那个 mas_closestCommonSuperview 方法去找两视图的共同父视图，不然如果只设置了高宽，就把约束加到当前视图上，其它情况就加到当前视图的父视图上。</p>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li>Post title：读 SnapKit 和 Masonry 自动布局框架源码</li>
        <li>Post author：戴铭</li>
        <li>Create time：2018-04-07 22:14:18</li>
        <li>
            Post link：https://ming1016.github.io/2018/04/07/read-snapkit-and-masonry-source-code/
        </li>
        <li>
            Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/iOS/">#iOS</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/Swift/">#Swift</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2018/04/21/deeply-analyse-javascriptcore/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">深入剖析 JavaScriptCore</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2018/04/02/record-and-think-about-swift-project-jsondecoder-networking-and-pop/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Swift 项目中涉及到 JSONDecoder，网络请求，泛型协议式编程的一些记录和想法</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2014</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">戴铭</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
            <div class="icp-info info-item"><a target="_blank" rel="nofollow" href="https://beian.miit.gov.cn">鄂ICP备17011999号 京公网安备 7011999号</a></div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SnapKit-%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84%E5%9B%BE"><span class="nav-number">1.1.</span> <span class="nav-text">SnapKit 源码结构图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Masonry-%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84%E5%9B%BE"><span class="nav-number">1.2.</span> <span class="nav-text">Masonry 源码结构图</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%99%E8%B0%81%E5%81%9A%E7%BA%A6%E6%9D%9F%EF%BC%9F"><span class="nav-number">2.</span> <span class="nav-text">给谁做约束？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SnapKit"><span class="nav-number">2.1.</span> <span class="nav-text">SnapKit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ConstraintView"><span class="nav-number">2.1.1.</span> <span class="nav-text">ConstraintView</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConstraintViewDSL"><span class="nav-number">2.1.2.</span> <span class="nav-text">ConstraintViewDSL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConstraintAttributesDSL"><span class="nav-number">2.1.3.</span> <span class="nav-text">ConstraintAttributesDSL</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Masonry"><span class="nav-number">2.2.</span> <span class="nav-text">Masonry</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#View-MASAdditions"><span class="nav-number">2.2.1.</span> <span class="nav-text">View+MASAdditions</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E8%AE%BE%E7%BD%AE%E7%BA%A6%E6%9D%9F%EF%BC%9F"><span class="nav-number">3.</span> <span class="nav-text">如何设置约束？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SnapKit-1"><span class="nav-number">3.1.</span> <span class="nav-text">SnapKit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ConstraintMaker"><span class="nav-number">3.1.1.</span> <span class="nav-text">ConstraintMaker</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OptionSet"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">OptionSet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E8%BD%BD%E5%92%8C%E8%87%AA%E5%AE%9A%E4%B9%89%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="nav-number">3.1.1.2.</span> <span class="nav-text">重载和自定义操作符</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConstraintMakerExtendable"><span class="nav-number">3.1.2.</span> <span class="nav-text">ConstraintMakerExtendable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConstraintMakerRelatable"><span class="nav-number">3.1.3.</span> <span class="nav-text">ConstraintMakerRelatable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConstraintMakerEditable"><span class="nav-number">3.1.4.</span> <span class="nav-text">ConstraintMakerEditable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConstraintMakerPriortizable"><span class="nav-number">3.1.5.</span> <span class="nav-text">ConstraintMakerPriortizable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConstraintMakerFinalizable"><span class="nav-number">3.1.6.</span> <span class="nav-text">ConstraintMakerFinalizable</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Masonry-1"><span class="nav-number">3.2.</span> <span class="nav-text">Masonry</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MASConstraintMaker"><span class="nav-number">3.2.1.</span> <span class="nav-text">MASConstraintMaker</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E5%AE%8C%E5%90%8E%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%EF%BC%9F"><span class="nav-number">4.</span> <span class="nav-text">设置完后如何处理？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SnapKit-2"><span class="nav-number">4.1.</span> <span class="nav-text">SnapKit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Masonry-2"><span class="nav-number">4.2.</span> <span class="nav-text">Masonry</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MASViewConstraint"><span class="nav-number">4.2.1.</span> <span class="nav-text">MASViewConstraint</span></a></li></ol></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>








<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
