<!DOCTYPE html>
<html>
<meta  lang="zh-Hans" >
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#fff" id="theme-color">
  <link rel="icon" href="/img/logo-starming.png">
  <title>戴铭的博客</title>
  <script>
    // control reverse button
    var reverseDarkList = {
      dark: 'light',
      light: 'dark'
    };
    var themeColor = {
      dark: '#1c1c1e',
      light: '#fff'
    }
    // get the data of css prefers-color-scheme
    var getCssMediaQuery = function() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };
    // reverse current darkmode setting function
    var reverseDarkModeSetting = function() {
      var setting = localStorage.getItem('user-color-scheme');
      if(reverseDarkList[setting]) {
        setting = reverseDarkList[setting];
      } else if(setting === null) {
        setting = reverseDarkList[getCssMediaQuery()];
      } else {
        return;
      }
      localStorage.setItem('user-color-scheme', setting);
      return setting;
    };
    // apply current darkmode setting
    var setDarkmode = function(mode) {
      var setting = mode || localStorage.getItem('user-color-scheme');
      if(setting === getCssMediaQuery()) {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[setting];
      } else if(reverseDarkList[setting]) {
        document.documentElement.setAttribute('data-user-color-scheme', setting);
        document.getElementById('theme-color').content = themeColor[setting];
      } else {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[getCssMediaQuery()];
      }
    };
    setDarkmode();
  </script>
  <script>
    function loadScript(url, cb) {
      var script = document.createElement('script');
      script.src = url;
      if (cb) script.onload = cb;
      script.async = true;
      document.body.appendChild(script);
    }
  </script>
  
  <link rel="preload" href="//at.alicdn.com/t/font_1946621_vpj3dq9ceqa.css" as="style" >
  <link rel="preload" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css" as="style" >
  
  <link rel="preload" href="//cdn.jsdelivr.net/npm/fslightbox@3.1.0/index.min.js" as="script">
  
  
  <link rel="preload" href="/js/lib/lozad.min.js" as="script">
  
  
  
  
  
  
  
  
<link rel="stylesheet" href="/css/main.css">

  
  
<link rel="stylesheet" href="//at.alicdn.com/t/font_1946621_vpj3dq9ceqa.css">

  
  
<link rel="stylesheet" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css">

  
  
  
  
  
  <link href="/js/lib/prism/prism.min.css" rel="stylesheet" data-prism="prism">
  
  
  
<link rel="stylesheet" href="/js/lib/prism/prism-line-numbers.min.css">

  
  
  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  <div class="wrapper">
    
    <nav class="navbar">
  <div class="navbar-logo">
    <span class="navbar-logo-main">
      
      <img class="navbar-logo-img" src="/img/logo-starming.png">
      
      <span class="navbar-logo-dsc">戴铭的博客</span>
    </span>
  </div>
  <div class="navbar-menu">
    
    <a href="/" class="navbar-menu-item">Home </a>
    
    <a href="/archives" class="navbar-menu-item">Archive </a>
    
    <a href="/tags" class="navbar-menu-item">Tags </a>
    
    <a href="/categories" class="navbar-menu-item">Categories </a>
    
    <a href="/about" class="navbar-menu-item">About </a>
    
    <a href="/friends" class="navbar-menu-item">Friends </a>
    
    <a class="navbar-menu-item darknavbar" id="dark"><i class="iconfont icon-weather"></i></a>
  </div>
</nav>
    
    <div class="section-wrap">
      <div class="container">
        <div class="columns">
          <main class="main-column">
<article class="card card-content">
  <header>
    <h1 class="post-title">
      Swift 项目中涉及到 JSONDecoder，网络请求，泛型协议式编程的一些记录和想法
    </h1>
  </header>
  <div class="post-meta post-show-meta">
    <time datetime="2018-04-02T11:12:28.000Z" style="display: flex; align-items: center;">
      <i class="iconfont icon-calendar" style="margin-right: 2px;"></i>
      <span>2018-04-02</span>
    </time>
    
    <span class="dot"></span>
    
    <a href="/categories/Programming/" class="post-meta-link">Programming</a>
    
    
    
    <span class="dot"></span>
    <span>7k words</span>
    
  </div>
  
  <div class="post-meta post-show-meta" style="margin-top: -10px;">
    <div style="display: flex; align-items: center;">
      <i class="iconfont icon-biaoqian" style="margin-right: 2px; font-size: 1.15rem;"></i>
      
      
        <a href="/tags/iOS/" class="post-meta-link">iOS</a>
      
      
      <span class="dot"></span>
      
        <a href="/tags/Swift/" class="post-meta-link">Swift</a>
      
    </div>
  </div>
  
  </header>
  <div id="section" class="post-content">
    <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近项目开发一直在使用 swift，因为 HTN 项目最近会有另外一位同事加入，所以打算对最近涉及到的一些技术和自己的一些想法做个记录，同时也能够方便同事熟悉代码。</p>
<h1 id="JSON-数据的处理"><a href="#JSON-数据的处理" class="headerlink" title="JSON 数据的处理"></a>JSON 数据的处理</h1><p>做项目只要是涉及到服务器端接口都没法避免和 JSON 数据打交道。对于来自网络的 JSON 结构化数据的处理，可以使用 JSONDecoder 这个苹果自己提供的字符串转模型类，这个类是在 Swift 4 的 Fundation 模块里提供的，可以在Swift 源码目录 swift&#x2F;stdlib&#x2F;public&#x2F;SDK&#x2F;Fundation&#x2F;JSONEncoder.swift 看到苹果对这个类实现。</p>
<p>其它对 JSON 处理的库还有 SwiftyJSON <a target="_blank" rel="noopener" href="https://github.com/SwiftyJSON/SwiftyJSON">GitHub - SwiftyJSON&#x2F;SwiftyJSON: The better way to deal with JSON data in Swift</a></p>
<h2 id="使用-JSONDecoder"><a href="#使用-JSONDecoder" class="headerlink" title="使用 JSONDecoder"></a>使用 JSONDecoder</h2><p>下面苹果使用 JSONDecoder 的一个例子来看看如何使用 JSONDecoder</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">struct</span> <span class="token class-name">GroceryProduct</span><span class="token punctuation">:</span> <span class="token class-name">Codable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">var</span> points<span class="token punctuation">:</span> <span class="token class-name">Int</span>
    <span class="token keyword">var</span> description<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token operator">?</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">let</span> json <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"""
&#123;
    "name": "Durian",
    "points": 600,
    "description": "A fruit with a distinctive scent."
&#125;
"""</span></span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>using<span class="token punctuation">:</span> <span class="token punctuation">.</span>utf8<span class="token punctuation">)</span><span class="token operator">!</span>

<span class="token keyword">let</span> decoder <span class="token operator">=</span> <span class="token class-name">JSONDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> product <span class="token operator">=</span> <span class="token keyword">try</span> decoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">GroceryProduct</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> from<span class="token punctuation">:</span> json<span class="token punctuation">)</span>

<span class="token function">print</span><span class="token punctuation">(</span>product<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// Prints "Durian"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里要注意 GroceryProduct 结构体需要遵循 Codable，因为 JSONDecoder 的实例对象的 decode 方法需要遵循 Decodable 协议的结构体。Codable 是 Encodable 和 Decodable 两个协议的组合，写法如下：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">public</span> <span class="token keyword">typealias</span> <span class="token class-name">Codable</span> <span class="token operator">=</span> <span class="token class-name">Decodable</span> <span class="token operator">&amp;</span> <span class="token class-name">Encodable</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>当然 JSON 数据的结构不会都是这么简单，如果遇到嵌套情况如下：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">let</span> json <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"""
&#123;
    "name": "Durian",
    "points": 600,
    "ability": &#123;
        "mathematics": "excellent",
        "physics": "bad",
        "chemistry": "fine"
    &#125;,
    "description": "A fruit with a distinctive scent."
&#125;
"""</span></span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>using<span class="token punctuation">:</span> <span class="token punctuation">.</span>utf8<span class="token punctuation">)</span><span class="token operator">!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这时可以通过在 struct 里再套一个 struct 来做，修改过的 struct 如下：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">struct</span> <span class="token class-name">GroceryProduct</span><span class="token punctuation">:</span> <span class="token class-name">Codable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">var</span> points<span class="token punctuation">:</span> <span class="token class-name">Int</span>
    <span class="token keyword">var</span> ability<span class="token punctuation">:</span> <span class="token class-name">Ability</span>
    <span class="token keyword">var</span> description<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token operator">?</span>
    
    <span class="token keyword">struct</span> <span class="token class-name">Ability</span><span class="token punctuation">:</span> <span class="token class-name">Codable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> mathematics<span class="token punctuation">:</span> <span class="token class-name">String</span>
        <span class="token keyword">var</span> physics<span class="token punctuation">:</span> <span class="token class-name">String</span>
        <span class="token keyword">var</span> chemistry<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里可以观察到 ability 里数学物理化学的评价都是那几个，无非是优良差，所以很适合用枚举表示，swift 的枚举对于字符串关联类型枚举也有很好的支持，只要声明关联值类型是 String 就行了，改后的代码如下：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">struct</span> <span class="token class-name">GroceryProduct</span><span class="token punctuation">:</span> <span class="token class-name">Codable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">var</span> points<span class="token punctuation">:</span> <span class="token class-name">Int</span>
    <span class="token keyword">var</span> ability<span class="token punctuation">:</span> <span class="token class-name">Ability</span>
    <span class="token keyword">var</span> description<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token operator">?</span>
    
    <span class="token keyword">struct</span> <span class="token class-name">Ability</span><span class="token punctuation">:</span> <span class="token class-name">Codable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> mathematics<span class="token punctuation">:</span> <span class="token class-name">Appraise</span>
        <span class="token keyword">var</span> physics<span class="token punctuation">:</span> <span class="token class-name">Appraise</span>
        <span class="token keyword">var</span> chemistry<span class="token punctuation">:</span> <span class="token class-name">Appraise</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">enum</span> <span class="token class-name">Appraise</span><span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Codable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> excellent<span class="token punctuation">,</span> fine<span class="token punctuation">,</span> bad
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>API 返回的结果会有一个不可控的因素，是什么呢？那就是有的键值有时会返回有时不会返回，那么这个 struct 怎么兼容呢？</p>
<p>好在swift 原生就支持了 optional，只需要在属性后加个问号就行了。比如 points 有时会返回有时不会，那么就可以这么写：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">struct</span> <span class="token class-name">GroceryProduct</span><span class="token punctuation">:</span> <span class="token class-name">Codable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">var</span> points<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token operator">?</span> <span class="token comment">//可能会用不到</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="CodingKey-协议"><a href="#CodingKey-协议" class="headerlink" title="CodingKey 协议"></a>CodingKey 协议</h2><p>接口还会有一些其它不可控因素，比如会产生出 snake case 的命名风格，要求风格统一固然是很好，但是现实环境总会有些不可抗拒的因素，比如不同团队，不同公司或者不同风格洁癖的 coder 之间。还好 JSONDecoder 已经做好了。下面我们看看如何用：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">let</span> json <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"""
&#123;
    "nick_name": "Tom",
    "points": 600,
&#125;
"""</span></span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>using<span class="token punctuation">:</span> <span class="token punctuation">.</span>utf8<span class="token punctuation">)</span><span class="token operator">!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里 nick_name 我们希望处理成 swift 的风格，那么我们可以使用一个遵循 CodingKey 协议的枚举来做映射。</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">struct</span> <span class="token class-name">GroceryProduct</span><span class="token punctuation">:</span> <span class="token class-name">Codable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> nickName<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">var</span> points<span class="token punctuation">:</span> <span class="token class-name">Int</span>
    
    <span class="token keyword">enum</span> <span class="token class-name">CodingKeys</span> <span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">CodingKey</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> nickName <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"nick_name"</span></span>
        <span class="token keyword">case</span> points
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当然这个方法是个通用方法，不光能够处理 snake case 还能够起自己喜欢的命名，比如你喜欢简写，nick name 写成 nName，那么也可以用这个方法。Codable 协议默认的实现实际上已经能够 cover 掉现实环境的大部分问题了，如果有些自定义的东西要处理的话可以通过覆盖默认 Codable 的方式来做。关键点就是 encoder 的 container，通过获取 container 对象进行自定义操作。</p>
<h2 id="JSONDecoder-的-keyDecodingStrategy-属性"><a href="#JSONDecoder-的-keyDecodingStrategy-属性" class="headerlink" title="JSONDecoder 的 keyDecodingStrategy 属性"></a>JSONDecoder 的 keyDecodingStrategy 属性</h2><p>JSONDecoder 里还有专门的一个属性 keyDecodingStrategy，这个值是个布尔值，有个 case 是 convertFromSnakeCase，这样就会按照这个 strategy 来转换 snake case，这个是核心功能内置的，就不需要我们额外写代码处理了。上面加上的枚举 CodingKeys 也可以去掉了，只需要在 JSONDecoder 这个实例设置这个属性就行。</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">let</span> decoder <span class="token operator">=</span> <span class="token class-name">JSONDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
decoder<span class="token punctuation">.</span>keyDecodingStrategy <span class="token operator">=</span> <span class="token punctuation">.</span>convertFromSnakeCase<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>keyDecodingStrategy 这个属性是在 swift 4.1 加上的，所以这个版本之前的还是用 CodingKey 这个协议来处理吧。</p>
<p>那么苹果是如何通过这个 keyDecodingStrategy 属性的设置来做到的呢？</p>
<p>感谢苹果使用 Swift 写了 Swift 的核心功能，以后想要了解更多功能背后原理可以不用啃 C++ 了，一边学习原理还能一边学习苹果内部是如何使用 Swift 的，所谓一举两得。</p>
<p>实现这个功能代码就在上文提到的 Swift 源码目录 swift&#x2F;stdlib&#x2F;public&#x2F;SDK&#x2F;Fundation&#x2F; 下的 JSONEncoder.swift  文件，如果不想把源码下下来也可以在 GitHub 上在线看，地址：<a target="_blank" rel="noopener" href="https://github.com/apple/swift/blob/master/stdlib/public/SDK/Foundation/JSONEncoder.swift">https://github.com/apple/swift/blob/master/stdlib/public/SDK/Foundation/JSONEncoder.swift</a></p>
<p>先看看这个属性的定义：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token comment">/// The strategy to use for decoding keys. Defaults to `.useDefaultKeys`.</span>
<span class="token keyword">open</span> <span class="token keyword">var</span> keyDecodingStrategy<span class="token punctuation">:</span> <span class="token class-name">KeyDecodingStrategy</span> <span class="token operator">=</span> <span class="token punctuation">.</span>useDefaultKeys<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这个属性是一个 keyDecodingStrategy 枚举，默认是 .userDefaultKeys。这个枚举是这样定义的：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">KeyDecodingStrategy</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/// Use the keys specified by each type. This is the default strategy.</span>
    <span class="token keyword">case</span> useDefaultKeys
    
    <span class="token comment">/// Convert from "snake_case_keys" to "camelCaseKeys" before attempting to match a key with the one specified by each type.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// The conversion to upper case uses `Locale.system`, also known as the ICU "root" locale. This means the result is consistent regardless of the current user's locale and language preferences.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// Converting from snake case to camel case:</span>
    <span class="token comment">/// 1. Capitalizes the word starting after each `_`</span>
    <span class="token comment">/// 2. Removes all `_`</span>
    <span class="token comment">/// 3. Preserves starting and ending `_` (as these are often used to indicate private variables or other metadata).</span>
    <span class="token comment">/// For example, `one_two_three` becomes `oneTwoThree`. `_one_two_three_` becomes `_oneTwoThree_`.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// - Note: Using a key decoding strategy has a nominal performance cost, as each string key has to be inspected for the `_` character.</span>
    <span class="token keyword">case</span> convertFromSnakeCase
    
    <span class="token comment">/// Provide a custom conversion from the key in the encoded JSON to the keys specified by the decoded types.</span>
    <span class="token comment">/// The full path to the current decoding position is provided for context (in case you need to locate this key within the payload). The returned key is used in place of the last component in the coding path before decoding.</span>
    <span class="token comment">/// If the result of the conversion is a duplicate key, then only one value will be present in the container for the type to decode from.</span>
    <span class="token keyword">case</span> <span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> codingPath<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">CodingKey</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">CodingKey</span><span class="token punctuation">)</span>
    
    <span class="token keyword">fileprivate</span> <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">_convertFromSnakeCase</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> stringKey<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">String</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">...</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>case convertFromSnakeCase 就是我们使用的，注释部分描述了整个过程，首先会把 ‘_’ 符号后面的字母转成大写的，然后移除掉所有的 ‘_’ 符号，保留最前面和最后的 ‘_’ 符号。比如 _<em>nick_name</em> 就会转换成 _<em>nickName</em> 而这些都是在枚举里定义的静态方法 _convertFromSnakeCase 里完成的。</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">fileprivate</span> <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">_convertFromSnakeCase</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> stringKey<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">String</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">guard</span> <span class="token operator">!</span>stringKey<span class="token punctuation">.</span>isEmpty <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> stringKey <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// Find the first non-underscore character</span>
    <span class="token keyword">guard</span> <span class="token keyword">let</span> firstNonUnderscore <span class="token operator">=</span> stringKey<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token keyword">where</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> <span class="token short-argument">$0</span> <span class="token operator">!=</span> <span class="token string-literal"><span class="token string">"_"</span></span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Reached the end without finding an _</span>
        <span class="token keyword">return</span> stringKey
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// Find the last non-underscore character</span>
    <span class="token keyword">var</span> lastNonUnderscore <span class="token operator">=</span> stringKey<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>before<span class="token punctuation">:</span> stringKey<span class="token punctuation">.</span>endIndex<span class="token punctuation">)</span>
    <span class="token keyword">while</span> lastNonUnderscore <span class="token operator">></span> firstNonUnderscore <span class="token operator">&amp;&amp;</span> stringKey<span class="token punctuation">[</span>lastNonUnderscore<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string-literal"><span class="token string">"_"</span></span> <span class="token punctuation">&#123;</span>
        stringKey<span class="token punctuation">.</span><span class="token function">formIndex</span><span class="token punctuation">(</span>before<span class="token punctuation">:</span> <span class="token operator">&amp;</span>lastNonUnderscore<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">let</span> keyRange <span class="token operator">=</span> firstNonUnderscore<span class="token operator">...</span>lastNonUnderscore
    <span class="token keyword">let</span> leadingUnderscoreRange <span class="token operator">=</span> stringKey<span class="token punctuation">.</span>startIndex<span class="token operator">..&lt;</span>firstNonUnderscore
    <span class="token keyword">let</span> trailingUnderscoreRange <span class="token operator">=</span> stringKey<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>after<span class="token punctuation">:</span> lastNonUnderscore<span class="token punctuation">)</span><span class="token operator">..&lt;</span>stringKey<span class="token punctuation">.</span>endIndex
    
    <span class="token keyword">var</span> components <span class="token operator">=</span> stringKey<span class="token punctuation">[</span>keyRange<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>separator<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"_"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> joinedString <span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">if</span> components<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// No underscores in key, leave the word as is - maybe already camel cased</span>
        joinedString <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">(</span>stringKey<span class="token punctuation">[</span>keyRange<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        joinedString <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>components<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">lowercased</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> components<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">.</span>map <span class="token punctuation">&#123;</span> <span class="token short-argument">$0</span><span class="token punctuation">.</span>capitalized <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">joined</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// Do a cheap isEmpty check before creating and appending potentially empty strings</span>
    <span class="token keyword">let</span> result <span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>leadingUnderscoreRange<span class="token punctuation">.</span>isEmpty <span class="token operator">&amp;&amp;</span> trailingUnderscoreRange<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        result <span class="token operator">=</span> joinedString
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>leadingUnderscoreRange<span class="token punctuation">.</span>isEmpty <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>trailingUnderscoreRange<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Both leading and trailing underscores</span>
        result <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">(</span>stringKey<span class="token punctuation">[</span>leadingUnderscoreRange<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> joinedString <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">(</span>stringKey<span class="token punctuation">[</span>trailingUnderscoreRange<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>leadingUnderscoreRange<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Just leading</span>
        result <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">(</span>stringKey<span class="token punctuation">[</span>leadingUnderscoreRange<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> joinedString
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Just trailing</span>
        result <span class="token operator">=</span> joinedString <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">(</span>stringKey<span class="token punctuation">[</span>trailingUnderscoreRange<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这段代码处理的逻辑不算复杂，功能也不多，但是还是有很多值得学习的地方，首先可以看看是如何处理边界条件的。可以看到两个边界条件都是用 guard 语法来处理的。</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">guard</span> <span class="token operator">!</span>stringKey<span class="token punctuation">.</span>isEmpty <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> stringKey <span class="token punctuation">&#125;</span>

<span class="token comment">// Find the first non-underscore character</span>
<span class="token keyword">guard</span> <span class="token keyword">let</span> firstNonUnderscore <span class="token operator">=</span> stringKey<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token keyword">where</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> <span class="token short-argument">$0</span> <span class="token operator">!=</span> <span class="token string-literal"><span class="token string">"_"</span></span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Reached the end without finding an _</span>
    <span class="token keyword">return</span> stringKey
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一个是判断空，第二个是通过 String 的 public func index(where predicate: (Character) throws -&gt; Bool) rethrows -&gt; String.Index?  这个函数来看字符串里是否包含了 ‘_’ 符号，如果没有包含就直接返回原 String 值。这个函数的参数就是一个自定义返回布尔值的 block，返回 true 即刻返回不再继续遍历了，可见苹果对于性能一点也不浪费。</p>
<p>然后这个返回的 index 值还有个作用就是可以得到 ‘_’ 符号在最前面后第一个非 ‘_’ 符号的字符。因为需求如此，不需要把最前面和最后面的 ‘_’ 转驼峰，但是前面和后面的 ‘_’ 符号个数又不一定，所以需要得到前面 ‘_’ 符号和后面的范围。</p>
<p>那么得到前面的范围后，后面的苹果是怎么做的呢？</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token comment">// Find the last non-underscore character</span>
<span class="token keyword">var</span> lastNonUnderscore <span class="token operator">=</span> stringKey<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>before<span class="token punctuation">:</span> stringKey<span class="token punctuation">.</span>endIndex<span class="token punctuation">)</span>
<span class="token keyword">while</span> lastNonUnderscore <span class="token operator">></span> firstNonUnderscore <span class="token operator">&amp;&amp;</span> stringKey<span class="token punctuation">[</span>lastNonUnderscore<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string-literal"><span class="token string">"_"</span></span> <span class="token punctuation">&#123;</span>
    stringKey<span class="token punctuation">.</span><span class="token function">formIndex</span><span class="token punctuation">(</span>before<span class="token punctuation">:</span> <span class="token operator">&amp;</span>lastNonUnderscore<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里正好可以看到对 String 的 public func formIndex(before i: inout String.Index) 函数的应用，这里的参数定义为 inout 的作用是能够在函数里对这个参数不用通过返回的方式直接修改生效。这个函数的作用就是移动字符的 index，before 是往前移动，after 是往后移动。</p>
<p>上面的代码就是先找到整个字符串的最后的 index 然后开始从后往前找，找到不是 ‘_’ 符号时跳出这个 while，同时还要满足不超过 lastNonUnderscore 的范围。</p>
<p>在接下内容之前可以考虑这样一个问题，为什么在做前面的判断时为什么不用 public func formIndex(after i: inout String.Index) 这个方法，after 不是代表从开始往后移动遍历么，也可以达到找到第一个不是 ‘_’ 的字符就停止的效果。</p>
<p>苹果真是双枪老太婆，一击两发，既解决了边界问题又能解决一个需求，代码有了优化，代码量还减少了。其实面试过程中通常都会有些算法题的环节，很多人都以为只要有了解决思路或者写出简单的处理代码就可以了，我碰到了一些的面试人甚至用中文一条条写出思路以为就完事了。其实算法题的考察是分为两种的，一种是考智商的，就是解决办法很多或者解决办法很难，能够想到解法或者最优解是比较困难的，这样的题适合那些在面谈过程中能觉得实力和深度不错的人，通过这些题同时还能更多为判断面试人是否更具创造力，属于拔尖的考法。还有种是考严谨和实际项目能力的，这种更多是考察边界条件的处理，逻辑的严谨还有对代码优化的处理，这种题的解法和逻辑会比较简单。</p>
<p>_convertFromSnakeCase 这个枚举的静态函数会在创建 container 的时候调用，具体使用的函数是 _JSONKeyedDecodingContainer，在它的初始化方法里会判断  decoder.options.keyDecodingStrategy  这个枚举值，满足 convertFromSnakeCase 就会调用那个静态函数了。调用的时候还要注意一个处理就是转换成驼峰后的 key 可能会和已有命名重名，那么就需要选择进行一个选择，苹果的选择是第一个。实现方式如下：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">self</span><span class="token punctuation">.</span>container <span class="token operator">=</span> <span class="token class-name">Dictionary</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>map <span class="token punctuation">&#123;</span>
    key<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token class-name">JSONDecoder</span><span class="token punctuation">.</span><span class="token class-name">KeyDecodingStrategy</span><span class="token punctuation">.</span><span class="token function">_convertFromSnakeCase</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> uniquingKeysWith<span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">(</span>first<span class="token punctuation">,</span> <span class="token omit keyword">_</span><span class="token punctuation">)</span> <span class="token keyword">in</span> first <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这里遇到一个 Dictionary 的初始化函数 </p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">public</span> <span class="token keyword">init</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token omit keyword">_</span> keysAndValues<span class="token punctuation">:</span> <span class="token class-name">S</span><span class="token punctuation">,</span> uniquingKeysWith combine<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token class-name">Dictionary</span><span class="token punctuation">.</span><span class="token class-name">Value</span><span class="token punctuation">,</span> <span class="token class-name">Dictionary</span><span class="token punctuation">.</span><span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-></span> <span class="token class-name">Dictionary</span><span class="token punctuation">.</span><span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token keyword">rethrows</span> <span class="token keyword">where</span> <span class="token class-name">S</span> <span class="token punctuation">:</span> <span class="token class-name">Sequence</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">.</span><span class="token class-name">Element</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token class-name">Key</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个函数就是专门用来处理上面的重复 key 的问题。如果要选择最后一个 key 的值用这个函数也会很容易。</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">let</span> pairsWithDuplicateKeys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"a"</span></span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"b"</span></span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"a"</span></span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"b"</span></span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">let</span> firstValues <span class="token operator">=</span> <span class="token class-name">Dictionary</span><span class="token punctuation">(</span>pairsWithDuplicateKeys<span class="token punctuation">,</span>
                             uniquingKeysWith<span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">(</span>first<span class="token punctuation">,</span> <span class="token omit keyword">_</span><span class="token punctuation">)</span> <span class="token keyword">in</span> first <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token comment">// ["b": 2, "a": 1]</span>
<span class="token keyword">let</span> lastValues <span class="token operator">=</span> <span class="token class-name">Dictionary</span><span class="token punctuation">(</span>pairsWithDuplicateKeys<span class="token punctuation">,</span>
                            uniquingKeysWith<span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">(</span><span class="token omit keyword">_</span><span class="token punctuation">,</span> last<span class="token punctuation">)</span> <span class="token keyword">in</span> last <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token comment">// ["b": 4, "a": 3]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="枚举定义-block"><a href="#枚举定义-block" class="headerlink" title="枚举定义 block"></a>枚举定义 block</h2><p>KeyEncodingStrategy 还可以自定义 codingKey</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">case</span> <span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> codingPath<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">CodingKey</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">CodingKey</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在 container 初始化时会调用这个 block 来进行 key 的转换，同样如果转换后出现重复 key 也会和 convertFromSnakeCase 一样选择第一个。这里可以看到 Swift 里的枚举还能够定义一个 block 方便自定义处理自己特定规则，这样就可以完全抛弃以前的那种覆盖 Codable 协议默认实现的方式了。</p>
<h2 id="inout"><a href="#inout" class="headerlink" title="inout"></a>inout</h2><p>上面提到了 public func formIndex(before i: inout Index) 这个函数，那么跟着这个函数在源码里看看它的实现，这个函数是在这个文件里实现的 <a target="_blank" rel="noopener" href="https://github.com/apple/swift/blob/master/stdlib/public/SDK/Foundation/IndexSet.swift">swift&#x2F;IndexSet.swift at master · apple&#x2F;swift · GitHub</a></p>
<p>找到这个方法时发现没有 inout 定义的同名函数也还在那里</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>before i<span class="token punctuation">:</span> <span class="token class-name">Index</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">Index</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> i<span class="token punctuation">.</span>value <span class="token operator">==</span> i<span class="token punctuation">.</span>extent<span class="token punctuation">.</span>lowerBound <span class="token punctuation">&#123;</span>
        <span class="token comment">// Move to the next range</span>
        <span class="token keyword">if</span> i<span class="token punctuation">.</span>rangeIndex <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// We have no more to go</span>
            <span class="token keyword">return</span> <span class="token class-name">Index</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> i<span class="token punctuation">.</span>value<span class="token punctuation">,</span> extent<span class="token punctuation">:</span> i<span class="token punctuation">.</span>extent<span class="token punctuation">,</span> rangeIndex<span class="token punctuation">:</span> i<span class="token punctuation">.</span>rangeIndex<span class="token punctuation">,</span> rangeCount<span class="token punctuation">:</span> i<span class="token punctuation">.</span>rangeCount<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> rangeIndex <span class="token operator">=</span> i<span class="token punctuation">.</span>rangeIndex <span class="token operator">-</span> <span class="token number">1</span>
            <span class="token keyword">let</span> rangeCount <span class="token operator">=</span> i<span class="token punctuation">.</span>rangeCount
            <span class="token keyword">let</span> extent <span class="token operator">=</span> <span class="token function">_range</span><span class="token punctuation">(</span>at<span class="token punctuation">:</span> rangeIndex<span class="token punctuation">)</span>
            <span class="token keyword">let</span> value <span class="token operator">=</span> extent<span class="token punctuation">.</span>upperBound <span class="token operator">-</span> <span class="token number">1</span>
            <span class="token keyword">return</span> <span class="token class-name">Index</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> value<span class="token punctuation">,</span> extent<span class="token punctuation">:</span> extent<span class="token punctuation">,</span> rangeIndex<span class="token punctuation">:</span> rangeIndex<span class="token punctuation">,</span> rangeCount<span class="token punctuation">:</span> rangeCount<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Move to the previous value in this range</span>
        <span class="token keyword">return</span> <span class="token class-name">Index</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> i<span class="token punctuation">.</span>value <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> extent<span class="token punctuation">:</span> i<span class="token punctuation">.</span>extent<span class="token punctuation">,</span> rangeIndex<span class="token punctuation">:</span> i<span class="token punctuation">.</span>rangeIndex<span class="token punctuation">,</span> rangeCount<span class="token punctuation">:</span> i<span class="token punctuation">.</span>rangeCount<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function-definition function">formIndex</span><span class="token punctuation">(</span>before i<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token class-name">Index</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> i<span class="token punctuation">.</span>value <span class="token operator">==</span> i<span class="token punctuation">.</span>extent<span class="token punctuation">.</span>lowerBound <span class="token punctuation">&#123;</span>
        <span class="token comment">// Move to the next range</span>
        <span class="token keyword">if</span> i<span class="token punctuation">.</span>rangeIndex <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// We have no more to go</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            i<span class="token punctuation">.</span>rangeIndex <span class="token operator">-=</span> <span class="token number">1</span>
            i<span class="token punctuation">.</span>extent <span class="token operator">=</span> <span class="token function">_range</span><span class="token punctuation">(</span>at<span class="token punctuation">:</span> i<span class="token punctuation">.</span>rangeIndex<span class="token punctuation">)</span>
            i<span class="token punctuation">.</span>value <span class="token operator">=</span> i<span class="token punctuation">.</span>extent<span class="token punctuation">.</span>upperBound <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Move to the previous value in this range</span>
        i<span class="token punctuation">.</span>value <span class="token operator">-=</span> <span class="token number">1</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这两个函数的实现最直观的感受就是 inout 的少了三个 return。还有一个好处就是值类型参数 i 可以以引用方式传递，不需要 var 和 let 来修饰</p>
<p>当然 inout 还有一个好处在上面的函数里没有体现出来，那就是可以方便对多个值类型数据进行修改而不需要一一指明返回。</p>
<h1 id="网络请求"><a href="#网络请求" class="headerlink" title="网络请求"></a>网络请求</h1><p>说到网络请求，在 Objective-C 世界里基本都是用的 AFNetworking <a target="_blank" rel="noopener" href="https://github.com/AFNetworking/AFNetworking">GitHub - AFNetworking&#x2F;AFNetworking: A delightful networking framework for iOS, macOS, watchOS, and tvOS.</a> 在 Swift 里就是 Alamofire <a target="_blank" rel="noopener" href="https://github.com/Alamofire/Alamofire">GitHub - Alamofire&#x2F;Alamofire: Elegant HTTP Networking in Swift</a> 。我在 Swift 1.0 之前 beta 版本时就注意到 Alamofire 库里，那时还是 Mattt Thompson 一个人在写，文件也只有一个。如今功能已经多了很多，但代码量依然不算太大。我在做 HTN 项目时对于网络请求的需求不是那么大，但是也有，于是开始的时候就是简单的使用 URLSession 来实现了一下网路请求，就是想直接拉下接口下发的 JSON 数据。</p>
<p>开始结合着前面解析 JSON 的方法，我这么写了个网络请求：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">struct</span> <span class="token class-name">WebJSON</span><span class="token punctuation">:</span><span class="token class-name">Codable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> name<span class="token punctuation">:</span><span class="token class-name">String</span>
    <span class="token keyword">var</span> node<span class="token punctuation">:</span><span class="token class-name">String</span>
    <span class="token keyword">var</span> version<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token operator">?</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">let</span> session <span class="token operator">=</span> <span class="token class-name">URLSession</span><span class="token punctuation">.</span>shared
<span class="token keyword">let</span> request<span class="token punctuation">:</span><span class="token class-name">URLRequest</span> <span class="token operator">=</span> <span class="token class-name">NSURLRequest</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token function">URL</span><span class="token punctuation">(</span>string<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"http://www.starming.com/api.php?get=testjson"</span></span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token class-name">URLRequest</span>
<span class="token keyword">let</span> task <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">dataTask</span><span class="token punctuation">(</span>with<span class="token punctuation">:</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">(</span>data<span class="token punctuation">,</span> res<span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token keyword">in</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> <span class="token nil constant">nil</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> decoder <span class="token operator">=</span> <span class="token class-name">JSONDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"解析 JSON 成功"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">let</span> jsonModel <span class="token operator">=</span> <span class="token keyword">try</span> decoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">WebJSON</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> from<span class="token punctuation">:</span> data<span class="token operator">!</span><span class="token punctuation">)</span>
            <span class="token function">print</span><span class="token punctuation">(</span>jsonModel<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"解析 JSON 失败"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这么写是 ok 的，能够成功请求得到 JSON 数据然后转换成对应的结构数据。不过如果还有另外几处也要进行网络请求，拿这一坨代码不是要到处写了。那么先看看 Alamofire 干这个活是什么样子的？</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token class-name">Alamofire</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"https://httpbin.org/get"</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>responseData <span class="token punctuation">&#123;</span> response <span class="token keyword">in</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> data <span class="token operator">=</span> response<span class="token punctuation">.</span>data <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> decoder <span class="token operator">=</span> <span class="token class-name">JSONDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"解析 JSON 成功"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">let</span> jsonModel <span class="token operator">=</span> <span class="token keyword">try</span> decoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">H5Editor</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> from<span class="token punctuation">:</span> data<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"解析 JSON 失败"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Alamofire 有 responseJSON 的方法，不过解完是个字典，用的时候需要做很多容错判断很不方便，所以还是要使用 JSONDecoder 或者其它第三方库。不过 Alamofire 的写法已经做了一些简化，当然里面还实现了更多的功能，我待会再说，现在我的主要任务是简化调用。于是动手改改先前的实现，学习 Alamofire 的做法，首先创建一个类，然后简化掉 request 写法，再建个 block 方便请求完成后的数据返回处理，最后使用泛型支持不同 struct 的数据统一返回。写完后，我给这个网络类起个名字叫 SMNetWorking 这个类实现如下：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">open</span> <span class="token keyword">class</span> <span class="token class-name">SMNetWorking</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span><span class="token class-name">Codable</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">open</span> <span class="token keyword">let</span> session<span class="token punctuation">:</span><span class="token class-name">URLSession</span>
    
    <span class="token keyword">typealias</span> <span class="token class-name">CompletionJSONClosure</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token omit keyword">_</span> data<span class="token punctuation">:</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">Void</span>
    <span class="token keyword">var</span> completionJSONClosure<span class="token punctuation">:</span><span class="token class-name">CompletionJSONClosure</span> <span class="token operator">=</span>  <span class="token punctuation">&#123;</span><span class="token omit keyword">_</span> <span class="token keyword">in</span> <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>session <span class="token operator">=</span> <span class="token class-name">URLSession</span><span class="token punctuation">.</span>shared
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">//JSON的请求</span>
    <span class="token keyword">func</span> <span class="token function-definition function">requestJSON</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> url<span class="token punctuation">:</span> <span class="token class-name">SMURLNetWorking</span><span class="token punctuation">,</span>
                     doneClosure<span class="token punctuation">:</span><span class="token attribute atrule">@escaping</span> <span class="token class-name">CompletionJSONClosure</span>
                    <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>completionJSONClosure <span class="token operator">=</span> doneClosure
        <span class="token keyword">let</span> request<span class="token punctuation">:</span><span class="token class-name">URLRequest</span> <span class="token operator">=</span> <span class="token class-name">NSURLRequest</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> url<span class="token punctuation">.</span><span class="token function">asURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token class-name">URLRequest</span>
        <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">dataTask</span><span class="token punctuation">(</span>with<span class="token punctuation">:</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">(</span>data<span class="token punctuation">,</span> res<span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token keyword">in</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> <span class="token nil constant">nil</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">let</span> decoder <span class="token operator">=</span> <span class="token class-name">JSONDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"解析 JSON 成功"</span></span><span class="token punctuation">)</span>
                    <span class="token keyword">let</span> jsonModel <span class="token operator">=</span> <span class="token keyword">try</span> decoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> from<span class="token punctuation">:</span> data<span class="token operator">!</span><span class="token punctuation">)</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">completionJSONClosure</span><span class="token punctuation">(</span>jsonModel<span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"解析 JSON 失败"</span></span><span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span>
                
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        task<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    
<span class="token punctuation">&#125;</span>

<span class="token comment">/*----------Protocol----------*/</span>
<span class="token keyword">protocol</span> <span class="token class-name">SMURLNetWorking</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">func</span> <span class="token function-definition function">asURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token constant">URL</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*----------Extension---------*/</span>
<span class="token keyword">extension</span> <span class="token class-name">String</span><span class="token punctuation">:</span> <span class="token class-name">SMURLNetWorking</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function-definition function">asURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token constant">URL</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">guard</span> <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token function">URL</span><span class="token punctuation">(</span>string<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">URL</span><span class="token punctuation">(</span>string<span class="token punctuation">:</span><span class="token string-literal"><span class="token string">"http:www.starming.com"</span></span><span class="token punctuation">)</span><span class="token operator">!</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> url
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样调用起来就简单得多了，看起来如下：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token class-name">SMNetWorking</span><span class="token operator">&lt;</span><span class="token class-name">WModel</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requestJSON</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"https://httpbin.org/get"</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">(</span>jsonModel<span class="token punctuation">)</span> <span class="token keyword">in</span>
    <span class="token function">print</span><span class="token punctuation">(</span>jsonModel<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>当然这样写起来是简单多了，特别是请求不同的接口返回不同结构时，本地定义了很多的 model 结构体，那么请求时只需要指明不同的 model 类型，block 里就能够直接返回对应的值。</p>
<p>默认都按照 GET 方法请求，在实际项目中会用到其它比如 POST 等方法，Alamofire 的做法是这样的：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token comment">/// HTTP method definitions.</span>
<span class="token comment">///</span>
<span class="token comment">/// See https://tools.ietf.org/html/rfc7231#section-4.3</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">HTTPMethod</span><span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> options <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"OPTIONS"</span></span>
    <span class="token keyword">case</span> <span class="token keyword">get</span>     <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"GET"</span></span>
    <span class="token keyword">case</span> head    <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"HEAD"</span></span>
    <span class="token keyword">case</span> post    <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"POST"</span></span>
    <span class="token keyword">case</span> put     <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"PUT"</span></span>
    <span class="token keyword">case</span> patch   <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"PATCH"</span></span>
    <span class="token keyword">case</span> delete  <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"DELETE"</span></span>
    <span class="token keyword">case</span> trace   <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"TRACE"</span></span>
    <span class="token keyword">case</span> connect <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"CONNECT"</span></span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>会先定义一个枚举，依据的标准也列在了注释里。使用起来是这样的：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token class-name">Alamofire</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"https://httpbin.org/get"</span></span><span class="token punctuation">)</span> <span class="token comment">// method defaults to `.get`</span>

<span class="token class-name">Alamofire</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"https://httpbin.org/post"</span></span><span class="token punctuation">,</span> method<span class="token punctuation">:</span> <span class="token punctuation">.</span>post<span class="token punctuation">)</span>
<span class="token class-name">Alamofire</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"https://httpbin.org/put"</span></span><span class="token punctuation">,</span> method<span class="token punctuation">:</span> <span class="token punctuation">.</span>put<span class="token punctuation">)</span>
<span class="token class-name">Alamofire</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"https://httpbin.org/delete"</span></span><span class="token punctuation">,</span> method<span class="token punctuation">:</span> <span class="token punctuation">.</span>delete<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出在 request 方法里有个可选参数，设置完会给 NSURLRequest 的 httpMethod 的这个可选属性附上设置的值。</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">public</span> <span class="token keyword">init</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token class-name">URLConvertible</span><span class="token punctuation">,</span> method<span class="token punctuation">:</span> <span class="token class-name">HTTPMethod</span><span class="token punctuation">,</span> headers<span class="token punctuation">:</span> <span class="token class-name">HTTPHeaders</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token keyword">try</span> url<span class="token punctuation">.</span><span class="token function">asURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> url<span class="token punctuation">)</span>
    
    httpMethod <span class="token operator">=</span> method<span class="token punctuation">.</span>rawValue
    
    <span class="token keyword">if</span> <span class="token keyword">let</span> headers <span class="token operator">=</span> headers <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>headerField<span class="token punctuation">,</span> headerValue<span class="token punctuation">)</span> <span class="token keyword">in</span> headers <span class="token punctuation">&#123;</span>
            <span class="token function">setValue</span><span class="token punctuation">(</span>headerValue<span class="token punctuation">,</span> forHTTPHeaderField<span class="token punctuation">:</span> headerField<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么接下来我在 SMNetWorking 类里也加上这个功能，先定义一个枚举：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">enum</span> <span class="token class-name">HTTPMethod</span><span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> <span class="token constant">GET</span><span class="token punctuation">,</span><span class="token constant">OPTIONS</span><span class="token punctuation">,</span><span class="token constant">HEAD</span><span class="token punctuation">,</span><span class="token constant">POST</span><span class="token punctuation">,</span><span class="token constant">PUT</span><span class="token punctuation">,</span><span class="token constant">PATCH</span><span class="token punctuation">,</span><span class="token constant">DELETE</span><span class="token punctuation">,</span><span class="token constant">TRACE</span><span class="token punctuation">,</span><span class="token constant">CONNECT</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>利用枚举的字符串协议特性，可以将枚举名直接转值的字符串，可以通过这种方式简化枚举定义。</p>
<p>翻下 NSURLRequest 提供的那些可选设置项还不少，如果把这些设置都做成一个个可配参数那么后期维护会非常麻烦。所以我打算使用链式来弄。先 fix HTTPMethod 这个。</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token comment">//链式方法</span>
<span class="token comment">//HTTPMethod 的设置</span>
<span class="token keyword">func</span> <span class="token function-definition function">httpMethod</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> md<span class="token punctuation">:</span><span class="token class-name">HTTPMethod</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">SMNetWorking</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>httpMethod <span class="token operator">=</span> md
    <span class="token keyword">return</span> <span class="token keyword">self</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的 op 是个结构体，专门用来存放这些可选项的值的。完整的代码可以在这里看到 <a target="_blank" rel="noopener" href="https://github.com/ming1016/HTN/blob/master/HTNSwift/HTNSwift/Core/HTNFundation/SMNetWorking.swift">HTN&#x2F;SMNetWorking.swift at master · ming1016&#x2F;HTN · GitHub</a></p>
<p>使用起来也很方便：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token class-name">SMNetWorking</span><span class="token operator">&lt;</span><span class="token class-name">WModel</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requestJSON</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"https://httpbin.org/get"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>有了这样一个结构的设计后面扩展起来会非常方便，不过目前的功能是能够满足基本需求的，所以需要完善的比如对于 POST 请求需要的 HTTTP Body，还有 HTTP Headers 的自定义设置，Authentication 里的 HTTP Basic Authentication，Authentication with URLCredential 等，这些也可以先提供一个接口到外部去设置。所以可以先建个 block 把 URLRequest 提供出去由外围设置。</p>
<p>弄完后的使用效果如下：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token class-name">SMNetWorking</span><span class="token operator">&lt;</span><span class="token class-name">WModel</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span><span class="token punctuation">.</span>configRequest <span class="token punctuation">&#123;</span> <span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token keyword">in</span>
    <span class="token comment">//设置 request</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">requestJSON</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"https://httpbin.org/get"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>就刚才提到的请求参数来说，Alamofire 是定义了一个 ParameterEncoding 协议，协议里规定一个统一处理的方法 func encode(_ urlRequest: URLRequestConvertible, with parameters: Parameters?) throws -&gt; URLRequest 这样就可以对多种情况做一样的返回处理了。从遵循这个协议的结构体可以看到 URL，JSON 和 PropertyList 都遵循了，那么从实现这个协议的 encode 函数的实现里可以看到他们都是殊途同归到 request 的 httpBody 里。可以拿 URLEncoding 看看具体实现：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function-definition function">encode</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> urlRequest<span class="token punctuation">:</span> <span class="token class-name">URLRequestConvertible</span><span class="token punctuation">,</span> with parameters<span class="token punctuation">:</span> <span class="token class-name">Parameters</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-></span> <span class="token class-name">URLRequest</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> urlRequest <span class="token operator">=</span> <span class="token keyword">try</span> urlRequest<span class="token punctuation">.</span><span class="token function">asURLRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">guard</span> <span class="token keyword">let</span> parameters <span class="token operator">=</span> parameters <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> urlRequest <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">if</span> <span class="token keyword">let</span> method <span class="token operator">=</span> <span class="token class-name">HTTPMethod</span><span class="token punctuation">(</span>rawValue<span class="token punctuation">:</span> urlRequest<span class="token punctuation">.</span>httpMethod <span class="token operator">??</span> <span class="token string-literal"><span class="token string">"GET"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">encodesParametersInURL</span><span class="token punctuation">(</span>with<span class="token punctuation">:</span> method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">guard</span> <span class="token keyword">let</span> url <span class="token operator">=</span> urlRequest<span class="token punctuation">.</span>url <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token class-name">AFError</span><span class="token punctuation">.</span><span class="token function">parameterEncodingFailed</span><span class="token punctuation">(</span>reason<span class="token punctuation">:</span> <span class="token punctuation">.</span>missingURL<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token keyword">if</span> <span class="token keyword">var</span> urlComponents <span class="token operator">=</span> <span class="token class-name">URLComponents</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> url<span class="token punctuation">,</span> resolvingAgainstBaseURL<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">!</span>parameters<span class="token punctuation">.</span>isEmpty <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> percentEncodedQuery <span class="token operator">=</span> <span class="token punctuation">(</span>urlComponents<span class="token punctuation">.</span>percentEncodedQuery<span class="token punctuation">.</span>map <span class="token punctuation">&#123;</span> <span class="token short-argument">$0</span> <span class="token operator">+</span> <span class="token string-literal"><span class="token string">"&amp;"</span></span> <span class="token punctuation">&#125;</span> <span class="token operator">??</span> <span class="token string-literal"><span class="token string">""</span></span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">query</span><span class="token punctuation">(</span>parameters<span class="token punctuation">)</span>
            urlComponents<span class="token punctuation">.</span>percentEncodedQuery <span class="token operator">=</span> percentEncodedQuery
            urlRequest<span class="token punctuation">.</span>url <span class="token operator">=</span> urlComponents<span class="token punctuation">.</span>url
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> urlRequest<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>forHTTPHeaderField<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"Content-Type"</span></span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token nil constant">nil</span> <span class="token punctuation">&#123;</span>
            urlRequest<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"application/x-www-form-urlencoded; charset=utf-8"</span></span><span class="token punctuation">,</span> forHTTPHeaderField<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"Content-Type"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        
        urlRequest<span class="token punctuation">.</span>httpBody <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span>parameters<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>using<span class="token punctuation">:</span> <span class="token punctuation">.</span>utf8<span class="token punctuation">,</span> allowLossyConversion<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">return</span> urlRequest
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h1 id="泛型协议式编程"><a href="#泛型协议式编程" class="headerlink" title="泛型协议式编程"></a>泛型协议式编程</h1><p>对于目前 HTN 项目来说，请求到了数据，将 JSON 解析生成了对应的 Struct，那么下一步就是要把这个结构化的数据生成不同平台的代码，比如首先是 Objective-C 代码，然后是 Swift 代码，再然后会有 Java 代码。为了能够更好的合并多语言里重复的东西，我打算将处理生成不同语言的实现遵循相同的协议，这样就可以更规范更减少重复的实现这样的功能了。最终的效果如下：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token class-name">SMNetWorking</span><span class="token operator">&lt;</span><span class="token class-name">H5Editor</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requestJSON</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"https://httpbin.org/get"</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">(</span>jsonModel<span class="token punctuation">)</span> <span class="token keyword">in</span>
        <span class="token keyword">let</span> reStr <span class="token operator">=</span> <span class="token class-name">H5EditorToFrame</span><span class="token operator">&lt;</span><span class="token class-name">H5EditorObjc</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token class-name">H5EditorObjc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>jsonModel<span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span>reStr<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果是转成 Swift 的话就把 H5EditorObjc 改成 H5EditorSwift 就好了，他们遵循的都是 HTNMultilingualismSpecification 协议，其它语言依此类推。如果遇到统一的实现，可以建个协议的扩展，然后用统一函数去实现就好了。</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">extension</span> <span class="token class-name">HTNMultilingualismSpecification</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//统一处理函数放这里</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这种设计很类似类簇，比如我们熟悉的 NSString 就是这么设计的，根据初始化的不同，比如 initWith 什么的实例出来的对象是不同的，不过他们都遵循了相同的协议，所以我们在使用的时候没有感觉到差别。</p>
<p>HTNMultilingualismSpecification 这个协议里具体的定义在这里：<a target="_blank" rel="noopener" href="https://github.com/ming1016/HTN/blob/master/HTNSwift/HTNSwift/Core/HTNFundation/HTNMultilingualism.swift">https://github.com/ming1016/HTN/blob/master/HTNSwift/HTNSwift/Core/HTNFundation/HTNMultilingualism.swift</a></p>
<p>回头看看 JSONDecoder 也是使用协议泛型式编程的一个典范。先看看 decode 函数的定义</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">open</span> <span class="token keyword">func</span> <span class="token function-definition function">decode</span><span class="token operator">&lt;</span><span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token class-name">Decodable</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token omit keyword">_</span> type<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">.</span><span class="token keyword">Type</span><span class="token punctuation">,</span> from data<span class="token punctuation">:</span> <span class="token class-name">Data</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-></span> <span class="token class-name">T</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>入参 type 是遵循了统一的 Decodable 协议的，那么就可以按照统一的方法去做处理，在内部实现时实际上 JSONDecoder 会代理给 _JSONDecoder 来实现具体逻辑的。所以在 decode 里的具体实现值类型转换的 unbox 函数都是在 _JSONDecoder 的扩展里实现的。unbox 会处理数字，字符串，布尔值这些基础数据类型，如果有其它层级的结构体也会一层层解下去， _JSONDecoder 的 _JSONDecodingStorage 通过保存最终得到完整的结构体。可以通过下面的代码看出支持这个过程的结构是怎么设计的。首先是 _JSONDecoder 的属性</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token comment">/// The decoder's storage.</span>
<span class="token keyword">fileprivate</span> <span class="token keyword">var</span> storage<span class="token punctuation">:</span> _JSONDecodingStorage

<span class="token comment">/// Options set on the top-level decoder.</span>
<span class="token keyword">fileprivate</span> <span class="token keyword">let</span> options<span class="token punctuation">:</span> <span class="token class-name">JSONDecoder</span><span class="token punctuation">.</span>_Options

<span class="token comment">/// The path to the current point in encoding.</span>
<span class="token keyword">fileprivate</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">var</span> codingPath<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">CodingKey</span><span class="token punctuation">]</span>

<span class="token comment">/// Contextual user-provided information for use during encoding.</span>
<span class="token keyword">public</span> <span class="token keyword">var</span> userInfo<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">CodingUserInfoKey</span> <span class="token punctuation">:</span> <span class="token keyword">Any</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>userInfo
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下面是初始化</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token comment">/// Initializes `self` with the given top-level container and options.</span>
<span class="token keyword">fileprivate</span> <span class="token keyword">init</span><span class="token punctuation">(</span>referencing container<span class="token punctuation">:</span> <span class="token keyword">Any</span><span class="token punctuation">,</span> at codingPath<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">CodingKey</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> options<span class="token punctuation">:</span> <span class="token class-name">JSONDecoder</span><span class="token punctuation">.</span>_Options<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>storage <span class="token operator">=</span> <span class="token function">_JSONDecodingStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>container<span class="token punctuation">:</span> container<span class="token punctuation">)</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>codingPath <span class="token operator">=</span> codingPath
    <span class="token keyword">self</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里可以看到 storage 在初始化时只 push 了顶层，push 的实现是：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">fileprivate</span> <span class="token keyword">mutating</span> <span class="token keyword">func</span> <span class="token function-definition function">push</span><span class="token punctuation">(</span>container<span class="token punctuation">:</span> <span class="token keyword">Any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>containers<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>containers 在定义的时候是个 [Any] 数组，这样就允许 container 包含 container 也就是 struct 包含 struct 这样的结构。</p>
<h1 id="函数式思想编程"><a href="#函数式思想编程" class="headerlink" title="函数式思想编程"></a>函数式思想编程</h1><p>在处理映射成表达式是设置布局属性最复杂的地方，需要考虑兼顾到各种表达式情况的处理，这样救需要设计一个类似 SnapKit 那样可链式调用设置值的结构，我先设计了一个结构体用来存一些可变的信息</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">struct</span> <span class="token class-name">PtEqual</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> leftId <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span>
    <span class="token keyword">var</span> <span class="token keyword">left</span> <span class="token operator">=</span> <span class="token class-name">WgPt</span><span class="token punctuation">.</span><span class="token keyword">none</span>
    <span class="token keyword">var</span> leftIdPrefix <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span> <span class="token comment">//左前缀</span>
    <span class="token keyword">var</span> rightType <span class="token operator">=</span> <span class="token class-name">PtEqualRightType</span><span class="token punctuation">.</span>pt
    <span class="token keyword">var</span> rightId <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span>
    <span class="token keyword">var</span> rightIdPrefix <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span>
    <span class="token keyword">var</span> <span class="token keyword">right</span> <span class="token operator">=</span> <span class="token class-name">WgPt</span><span class="token punctuation">.</span><span class="token keyword">none</span>
    <span class="token keyword">var</span> rightFloat<span class="token punctuation">:</span><span class="token class-name">Float</span> <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">var</span> rightInt<span class="token punctuation">:</span><span class="token class-name">Int</span> <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">var</span> rightColor <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span>
    <span class="token keyword">var</span> rightText <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span>
    <span class="token keyword">var</span> rightString <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span>
    <span class="token keyword">var</span> rightSuffix <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span>
    
    <span class="token keyword">var</span> equalType <span class="token operator">=</span> <span class="token class-name">EqualType</span><span class="token punctuation">.</span>normal
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对于这些结构的设置会在 PtEqualC 这个类里去处理，把每个结构体属性的设置做成各个函数返回类本身即可实现。效果如下：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift">p<span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">(</span><span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">leftId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">leftIdPrefix</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"self."</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightType</span><span class="token punctuation">(</span><span class="token punctuation">.</span>float<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightFloat</span><span class="token punctuation">(</span>fl<span class="token punctuation">.</span>viewPt<span class="token punctuation">.</span>padding<span class="token punctuation">.</span><span class="token keyword">left</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalType</span><span class="token punctuation">(</span><span class="token punctuation">.</span>decrease<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>不过每次设置完后需要累加到最后返回的字符串里，这样一个过程其实也可以封装一个简单函数，比如 add()。这个怎么做能够更通用呢？比如希望支持不同的累加方法等。</p>
<p>那么可以先设计一个累加的 block 属性</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">typealias</span> <span class="token class-name">MutiClosure</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token omit keyword">_</span> pe<span class="token punctuation">:</span> <span class="token class-name">PtEqual</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">String</span>
<span class="token keyword">var</span> accumulatorLineClosure<span class="token punctuation">:</span><span class="token class-name">MutiClosure</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token omit keyword">_</span> <span class="token keyword">in</span> <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">""</span></span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>添加累加字符串和换行标示</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">var</span> mutiEqualStr <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span>         <span class="token comment">//累加的字符串</span>
<span class="token keyword">var</span> mutiEqualLineMark <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"\n"</span></span>  <span class="token comment">//换行标识</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>写个函数去设置这个 block 返回是类自己用于链式</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token comment">//累计设置的 PtEqual 字符串</span>
<span class="token keyword">func</span> <span class="token function-definition function">accumulatorLine</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> closure<span class="token punctuation">:</span><span class="token attribute atrule">@escaping</span> <span class="token class-name">MutiClosure</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">PtEqualC</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>accumulatorLineClosure <span class="token operator">=</span> closure
    <span class="token keyword">return</span> <span class="token keyword">self</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后添加一个函数专门用来使用的</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token comment">//执行累加动作</span>
<span class="token keyword">func</span> <span class="token function-definition function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> filterBl <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>mutiEqualStr <span class="token operator">+=</span> <span class="token function">accumulatorLineClosure</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>pe<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>mutiEqualLineMark
    <span class="token punctuation">&#125;</span>
    <span class="token omit keyword">_</span> <span class="token operator">=</span> <span class="token function">resetFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们看看用起来是什么效果：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"> <span class="token class-name">HTNMt</span><span class="token punctuation">.</span><span class="token class-name">PtEqualC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">accumulatorLine</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token punctuation">(</span>pe<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">String</span> <span class="token keyword">in</span>
    <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">ptEqualToStr</span><span class="token punctuation">(</span>pe<span class="token punctuation">:</span> pe<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">Bool</span> <span class="token keyword">in</span>
    <span class="token keyword">return</span> vpt<span class="token punctuation">.</span>isNormal
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token keyword">in</span>
    p<span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">(</span><span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightFloat</span><span class="token punctuation">(</span>fl<span class="token punctuation">.</span>viewPt<span class="token punctuation">.</span>padding<span class="token punctuation">.</span>top <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>细心的同学会注意到这里多了两个东西，一个是 filter， 一个是 once，这两个函数里的 block 会把一些通用逻辑进行封装。filter 的设置会根据返回决定是否处理后面的 block 或者结构体属性的设置，实现方式如下</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token comment">//过滤条件</span>
<span class="token keyword">func</span> <span class="token function-definition function">filter</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> closure<span class="token punctuation">:</span> <span class="token class-name">FilterClosure</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">PtEqualC</span> <span class="token punctuation">&#123;</span>
    filterBl <span class="token operator">=</span> <span class="token function">closure</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">self</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的 filterBl 是类的一个属性，后面会根据这个属性来决定动作是否继续执行。比如属性的设置会去判断</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">func</span> <span class="token function-definition function">left</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> wp<span class="token punctuation">:</span><span class="token class-name">WgPt</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">PtEqualC</span> <span class="token punctuation">&#123;</span>
    filterBl <span class="token operator">?</span> <span class="token keyword">self</span><span class="token punctuation">.</span>pe<span class="token punctuation">.</span><span class="token keyword">left</span> <span class="token operator">=</span> wp <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">self</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>once 这个函数也会判断</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">func</span> <span class="token function-definition function">once</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> closure<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> pc<span class="token punctuation">:</span> <span class="token class-name">PtEqualC</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">Void</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">PtEqualC</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> filterBl <span class="token punctuation">&#123;</span>
        <span class="token function">closure</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token omit keyword">_</span> <span class="token operator">=</span> <span class="token function">resetPe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token omit keyword">_</span> <span class="token operator">=</span> <span class="token function">resetFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">self</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同时 once 这个函数还会重置 filterBl 和重置设置的结构体，一箭三雕，相当于一个完整的设置周期。</p>
<p>有了这样一套函数，再复杂的设置过程以及逻辑处理都可以很清晰统一的表达出来，下面可以看一个复杂布局比如映射成原生表达式的代码效果：</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token comment">//UIView *myViewContainer = [UIView new];</span>
lyStr <span class="token operator">+=</span> <span class="token function">newEqualStr</span><span class="token punctuation">(</span>vType<span class="token punctuation">:</span> <span class="token punctuation">.</span>view<span class="token punctuation">,</span> id<span class="token punctuation">:</span> cId<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string-literal"><span class="token string">"\n"</span></span>

<span class="token comment">//属性拼装</span>
lyStr <span class="token operator">+=</span> <span class="token class-name">HTNMt</span><span class="token punctuation">.</span><span class="token class-name">PtEqualC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">accumulatorLine</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token punctuation">(</span>pe<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">String</span> <span class="token keyword">in</span>
    <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">ptEqualToStr</span><span class="token punctuation">(</span>pe<span class="token punctuation">:</span> pe<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token keyword">in</span>
    p<span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">(</span><span class="token punctuation">.</span>top<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">leftId</span><span class="token punctuation">(</span>cId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> fl<span class="token punctuation">.</span>isFirst <span class="token punctuation">&#123;</span>
        <span class="token comment">//myViewContainer.top = 0.0;</span>
        p<span class="token punctuation">.</span><span class="token function">rightType</span><span class="token punctuation">(</span><span class="token punctuation">.</span>float<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightFloat</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//myViewContainer.top = lastView.bottom;</span>
        p<span class="token punctuation">.</span><span class="token function">rightId</span><span class="token punctuation">(</span>fl<span class="token punctuation">.</span>lastId <span class="token operator">+</span> <span class="token string-literal"><span class="token string">"Container"</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightType</span><span class="token punctuation">(</span><span class="token punctuation">.</span>pt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">right</span><span class="token punctuation">(</span><span class="token punctuation">.</span>bottom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token keyword">in</span>
    <span class="token comment">//myViewContainer.left = 0.0;</span>
    p<span class="token punctuation">.</span><span class="token function">leftId</span><span class="token punctuation">(</span>cId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightType</span><span class="token punctuation">(</span><span class="token punctuation">.</span>float<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightFloat</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token keyword">in</span>
    <span class="token comment">//myViewContainer.width = self.myView.width;</span>
    p<span class="token punctuation">.</span><span class="token function">leftId</span><span class="token punctuation">(</span>cId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">(</span><span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightType</span><span class="token punctuation">(</span><span class="token punctuation">.</span>pt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightIdPrefix</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"self."</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">right</span><span class="token punctuation">(</span><span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">//myViewContainer.height = self.myView.height;</span>
    p<span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">(</span><span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">right</span><span class="token punctuation">(</span><span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token keyword">in</span>
    <span class="token comment">//self.myView.width -= 16 * 2;</span>
    p<span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">(</span><span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">leftId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">leftIdPrefix</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"self."</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightType</span><span class="token punctuation">(</span><span class="token punctuation">.</span>float<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightFloat</span><span class="token punctuation">(</span>fl<span class="token punctuation">.</span>viewPt<span class="token punctuation">.</span>padding<span class="token punctuation">.</span><span class="token keyword">left</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalType</span><span class="token punctuation">(</span><span class="token punctuation">.</span>decrease<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">//self.myView.height -= 8 * 2;</span>
    p<span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">(</span><span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightFloat</span><span class="token punctuation">(</span>fl<span class="token punctuation">.</span>viewPt<span class="token punctuation">.</span>padding<span class="token punctuation">.</span>top <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">//self.myView.top = 8;</span>
    p<span class="token punctuation">.</span><span class="token function">equalType</span><span class="token punctuation">(</span><span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">(</span><span class="token punctuation">.</span>top<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightType</span><span class="token punctuation">(</span><span class="token punctuation">.</span>float<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightFloat</span><span class="token punctuation">(</span>fl<span class="token punctuation">.</span>viewPt<span class="token punctuation">.</span>padding<span class="token punctuation">.</span>top<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">//属性 verticalAlign 或 horizontalAlign 是 padding 和其它排列时的区别处理</span>
    <span class="token keyword">if</span> fl<span class="token punctuation">.</span>viewPt<span class="token punctuation">.</span>horizontalAlign <span class="token operator">==</span> <span class="token punctuation">.</span>padding <span class="token punctuation">&#123;</span>
        <span class="token comment">//self.myView.left = 16;</span>
        p<span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightFloat</span><span class="token punctuation">(</span>fl<span class="token punctuation">.</span>viewPt<span class="token punctuation">.</span>padding<span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//[self.myView sizeToFit];</span>
        p<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">sizeToFit</span><span class="token punctuation">(</span>elm<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"self.</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">id</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">(</span><span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightType</span><span class="token punctuation">(</span><span class="token punctuation">.</span>pt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightId</span><span class="token punctuation">(</span>cId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">right</span><span class="token punctuation">(</span><span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">switch</span> fl<span class="token punctuation">.</span>viewPt<span class="token punctuation">.</span>horizontalAlign <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token punctuation">.</span>center<span class="token punctuation">:</span>
            p<span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">(</span><span class="token class-name">HTNMt</span><span class="token punctuation">.</span><span class="token class-name">WgPt</span><span class="token punctuation">.</span>center<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">right</span><span class="token punctuation">(</span><span class="token punctuation">.</span>center<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">:</span>
            p<span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">right</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token keyword">right</span><span class="token punctuation">:</span>
            p<span class="token punctuation">.</span><span class="token keyword">left</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token keyword">right</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">right</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token keyword">right</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mutiEqualStr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>完整代码在这里：<a target="_blank" rel="noopener" href="https://github.com/ming1016/HTN/blob/master/HTNSwift/HTNSwift/H5Editor/H5EditorObjc.swift">https://github.com/ming1016/HTN/blob/master/HTNSwift/HTNSwift/H5Editor/H5EditorObjc.swift</a></p>
<p>PS：最近在一个公司分享时有人希望推荐下 iOS 相关的博客，当时我推荐了孙源的博客，其实孙源也推荐过一个博客，当时由于地址没记住没有说出来，现在推荐给大家：<a target="_blank" rel="noopener" href="https://www.mikeash.com/">https://www.mikeash.com/</a> 他的twitter：<a target="_blank" rel="noopener" href="https://twitter.com/mikeash?lang=en">https://twitter.com/mikeash</a></p>

  </div>
  <div>
  
  <div class="post-note note-warning copyright" style="margin-top: 42px">
    <p><span style="font-weight: bold;">作者：</span><a target="_blank" rel="nofollow noopener noreferrer" href="https://starming.com/about">戴铭</a></p>
    <p><span style="font-weight: bold;">文章链接：</span><a target="_blank" rel="nofollow noopener noreferrer" href="https://starming.com/2018/04/02/record-and-think-about-swift-project-jsondecoder-networking-and-pop/">https://starming.com/2018/04/02/record-and-think-about-swift-project-jsondecoder-networking-and-pop/</a></p>
    <p><span style="font-weight: bold;">版权声明：</span>本博客所有文章除特别声明外，均采用<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0 协议</a>。转载请注明出处！</p>
  </div>
  
  </div>
</article>
<div class="nav">
  
  <div class="nav-item-prev">
    <a href="/2018/04/07/read-snapkit-and-masonry-source-code/" class="nav-link">
      <i class="iconfont icon-left nav-prev-icon"></i>
      <div>
        <div class="nav-label">Prev</div>
        
        <div class="nav-title">读 SnapKit 和 Masonry 自动布局框架源码 </div>
        
      </div>
    </a>
  </div>
  
  
  <div class="nav-item-next">
    <a href="/2018/01/24/why-swift/" class="nav-link">
      <div>
        <div class="nav-label">Next</div>
        
        <div class="nav-title">Why Swift? Generics(泛型), Collection(集合类型), POP(协议式编程), Memory Management(内存管理) </div>
        
      </div>
      <i class="iconfont icon-right nav-next-icon"></i>
    </a>
  </div>
  
</div>

<div class="card card-content toc-card" id="mobiletoc">
  <div class="toc-header"><i class="iconfont icon-menu" style="padding-right: 2px;"></i>TOC</div>
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JSON-%E6%95%B0%E6%8D%AE%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">JSON 数据的处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-JSONDecoder"><span class="toc-number">2.1.</span> <span class="toc-text">使用 JSONDecoder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CodingKey-%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.2.</span> <span class="toc-text">CodingKey 协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JSONDecoder-%E7%9A%84-keyDecodingStrategy-%E5%B1%9E%E6%80%A7"><span class="toc-number">2.3.</span> <span class="toc-text">JSONDecoder 的 keyDecodingStrategy 属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E5%AE%9A%E4%B9%89-block"><span class="toc-number">2.4.</span> <span class="toc-text">枚举定义 block</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#inout"><span class="toc-number">2.5.</span> <span class="toc-text">inout</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82"><span class="toc-number">3.</span> <span class="toc-text">网络请求</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B3%9B%E5%9E%8B%E5%8D%8F%E8%AE%AE%E5%BC%8F%E7%BC%96%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">泛型协议式编程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%BC%8F%E6%80%9D%E6%83%B3%E7%BC%96%E7%A8%8B"><span class="toc-number">5.</span> <span class="toc-text">函数式思想编程</span></a></li></ol>
</div></main>
          <aside class="left-column">
            
            <div class="card card-author">
              
<img src="/img/ming.jpeg" class="author-img">

<p class="author-name">戴铭</p>
<p class="author-description">极客时间《iOS开发高手课》和纸书《跟戴铭学iOS编程》作者</p>
<div class="author-message">
  <a class="author-posts-count" href="/archives">
    <span>79</span>
    <span>Posts</span>
  </a>
  <a class="author-categories-count" href="/categories">
    <span>8</span>
    <span>Categories</span>
  </a>
  <a class="author-tags-count" href="/tags">
    <span>44</span>
    <span>Tags</span>
  </a>
</div>

<div class="author-card-society">
  
    <div class="author-card-society-icon">
      <a target="_blank" rel="noopener" href="https://weibo.com/allstarming">
        <i class="iconfont icon-sina society-icon"></i>
      </a>
    </div>
  
    <div class="author-card-society-icon">
      <a target="_blank" rel="noopener" href="https://github.com/ming1016">
        <i class="iconfont icon-github society-icon"></i>
      </a>
    </div>
  
    <div class="author-card-society-icon">
      <a href="mailto:ming1016@foxmail.com">
        <i class="iconfont icon-mail society-icon"></i>
      </a>
    </div>
  
    <div class="author-card-society-icon">
      <a href="/atom.xml">
        <i class="iconfont icon-chrome society-icon"></i>
      </a>
    </div>
  
</div>

            </div>
            
            <div class="sticky-tablet">
  
  
  <article class="display-when-two-columns spacer">
    <div class="card card-content toc-card">
      <div class="toc-header"><i class="iconfont icon-menu" style="padding-right: 2px;"></i>TOC</div>
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JSON-%E6%95%B0%E6%8D%AE%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">JSON 数据的处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-JSONDecoder"><span class="toc-number">2.1.</span> <span class="toc-text">使用 JSONDecoder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CodingKey-%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.2.</span> <span class="toc-text">CodingKey 协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JSONDecoder-%E7%9A%84-keyDecodingStrategy-%E5%B1%9E%E6%80%A7"><span class="toc-number">2.3.</span> <span class="toc-text">JSONDecoder 的 keyDecodingStrategy 属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E5%AE%9A%E4%B9%89-block"><span class="toc-number">2.4.</span> <span class="toc-text">枚举定义 block</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#inout"><span class="toc-number">2.5.</span> <span class="toc-text">inout</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82"><span class="toc-number">3.</span> <span class="toc-text">网络请求</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B3%9B%E5%9E%8B%E5%8D%8F%E8%AE%AE%E5%BC%8F%E7%BC%96%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">泛型协议式编程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%BC%8F%E6%80%9D%E6%83%B3%E7%BC%96%E7%A8%8B"><span class="toc-number">5.</span> <span class="toc-text">函数式思想编程</span></a></li></ol>
    </div>
  </article>
  
  
  <article class="card card-content">
    <div class="categories-card">
  <div class="categories-header"><i class="iconfont icon-fenlei" style="padding-right: 2px;"></i>Categories</div>
  <div class="categories-list">
    
      <a href="/categories/Programming">
        <div class="categories-list-item">
          Programming
          <span class="categories-list-item-badge">50</span>
        </div>
      </a>
    
      <a href="/categories/My-novel">
        <div class="categories-list-item">
          My-novel
          <span class="categories-list-item-badge">4</span>
        </div>
      </a>
    
      <a href="/categories/My-painting">
        <div class="categories-list-item">
          My-painting
          <span class="categories-list-item-badge">8</span>
        </div>
      </a>
    
      <a href="/categories/Podcast">
        <div class="categories-list-item">
          Podcast
          <span class="categories-list-item-badge">3</span>
        </div>
      </a>
    
      <a href="/categories/App">
        <div class="categories-list-item">
          App
          <span class="categories-list-item-badge">11</span>
        </div>
      </a>
    
      <a href="/categories/travel">
        <div class="categories-list-item">
          travel
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/macOS">
        <div class="categories-list-item">
          macOS
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/AI">
        <div class="categories-list-item">
          AI
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
  </div>
</div>
  </article>
  
  <article class="card card-content">
    <div class="tags-card">
  <div class="tags-header"><i class="iconfont icon-biaoqian" style="padding-right: 2px;"></i>hot tags</div>
  <div class="tags-list">
    
    <a href="\tags\iOS" title="iOS"><div class="tags-list-item">iOS</div></a>
    
    <a href="\tags\Swift" title="Swift"><div class="tags-list-item">Swift</div></a>
    
    <a href="\tags\Apple" title="Apple"><div class="tags-list-item">Apple</div></a>
    
    <a href="\tags\SwiftUI" title="SwiftUI"><div class="tags-list-item">SwiftUI</div></a>
    
    <a href="\tags\Painting" title="Painting"><div class="tags-list-item">Painting</div></a>
    
    <a href="\tags\App" title="App"><div class="tags-list-item">App</div></a>
    
    <a href="\tags\Slides" title="Slides"><div class="tags-list-item">Slides</div></a>
    
    <a href="\tags\iPad" title="iPad"><div class="tags-list-item">iPad</div></a>
    
    <a href="\tags\Procreate" title="Procreate"><div class="tags-list-item">Procreate</div></a>
    
    <a href="\tags\LLVM" title="LLVM"><div class="tags-list-item">LLVM</div></a>
    
    <a href="\tags\Performance optimization" title="Performance optimization"><div class="tags-list-item">Performance optimization</div></a>
    
    <a href="\tags\Web" title="Web"><div class="tags-list-item">Web</div></a>
    
    <a href="\tags\Novel" title="Novel"><div class="tags-list-item">Novel</div></a>
    
    <a href="\tags\Manga" title="Manga"><div class="tags-list-item">Manga</div></a>
    
    <a href="\tags\Podcast" title="Podcast"><div class="tags-list-item">Podcast</div></a>
    
    <a href="\tags\macOS" title="macOS"><div class="tags-list-item">macOS</div></a>
    
  </div>
</div>
  </article>
  
  
</div>
          </aside>
          <aside class="right-column">
            <div class="sticky-widescreen">
  
  
  <article class="card card-content toc-card">
    <div class="toc-header"><i class="iconfont icon-menu" style="padding-right: 2px;"></i>TOC</div>
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JSON-%E6%95%B0%E6%8D%AE%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">JSON 数据的处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-JSONDecoder"><span class="toc-number">2.1.</span> <span class="toc-text">使用 JSONDecoder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CodingKey-%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.2.</span> <span class="toc-text">CodingKey 协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JSONDecoder-%E7%9A%84-keyDecodingStrategy-%E5%B1%9E%E6%80%A7"><span class="toc-number">2.3.</span> <span class="toc-text">JSONDecoder 的 keyDecodingStrategy 属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E5%AE%9A%E4%B9%89-block"><span class="toc-number">2.4.</span> <span class="toc-text">枚举定义 block</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#inout"><span class="toc-number">2.5.</span> <span class="toc-text">inout</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82"><span class="toc-number">3.</span> <span class="toc-text">网络请求</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B3%9B%E5%9E%8B%E5%8D%8F%E8%AE%AE%E5%BC%8F%E7%BC%96%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">泛型协议式编程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%BC%8F%E6%80%9D%E6%83%B3%E7%BC%96%E7%A8%8B"><span class="toc-number">5.</span> <span class="toc-text">函数式思想编程</span></a></li></ol>
  </article>
  
  
  <article class="card card-content">
    <div class="recent-posts-card">
  <div class="recent-posts-header"><i class="iconfont icon-wenzhang_huaban" style="padding-right: 2px;"></i>Recent Posts</div>
  <div class="recent-posts-list">
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2025-05-05</div>
        <a href="/2025/05/05/pamphlet-app667/"><div class="recent-posts-item-content">憋了个大招！《戴铭的小册子》6.6.7 版：不止搞开发，这次玩儿大了！</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2025-03-06</div>
        <a href="/2025/03/06/letsvision25-ai-improve-ios-skill/"><div class="recent-posts-item-content">使用 AI 突破 iOS 开发者能力边界</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2025-02-18</div>
        <a href="/2025/02/18/macos-app-i-used/"><div class="recent-posts-item-content">2025 年我正在使用的 macOS 应用</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2025-01-21</div>
        <a href="/2025/01/21/ios-conf-sg-25-share/"><div class="recent-posts-item-content">我在 iOS Conf SG 25 的演讲</div></a>
      </div>
    
  </div>
</div>
  </article>
  
  
</div>
          </aside>
        </div>
      </div>
    </div>
  </div>
  
  <footer class="footer">
  <div class="footer-container">
    <div>
      <div class="footer-dsc">
        <span>Copyright ©
          
          2014 -
          
          2025
        </span>
        <a href="/" class="footer-link">戴铭的博客 </a>
      </div>
    </div>

    
    
    
    <div class="BbeiAn-info">
      <a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">京ICP备2024068292号-1 </a>
    </div>
    
    <div class="BbeiAn-info">
      <span style="padding-left: 25px;background: url(/img/beian.png) no-repeat left center"></span>
      <a target="_blank" rel="noopener" href="https://beian.mps.gov.cn/#/query/webSearch?code=11010802044427 ">京公网安备11010802044427
      </a>
      <br />
    </div>
    
    
    
      <div class="footer-dsc">
        
        本站总访问量<span id="busuanzi_value_site_pv"></span>次
        
        
        <span>&nbsp;|&nbsp;</span>
        
        
        本站总访客数<span id="busuanzi_value_site_uv"></span>次
        
      </div>
      
    
</footer>
  <a role="button" id="scrollbutton" class="basebutton" >
  <i class="iconfont icon-arrowleft button-icon"></i>
</a>
<a role="button" id="menubutton" class="basebutton">
  <i class="iconfont icon-menu button-icon"></i>
</a>
<a role="button" id="popbutton" class="basebutton">
  <i class="iconfont icon-expand button-icon"></i>
</a>
<a role="button" id="darkbutton" class="basebutton darkwidget">
  <i class="iconfont icon-weather button-icon"></i>
</a>

  
  
  
  <script>
  var addImgLayout = function () {
    var img = document.querySelectorAll('.post-content img');
    var i;
    for (i = 0; i < img.length; i++) {
      var wrapper = document.createElement('a');
      wrapper.setAttribute('data-fslightbox', 'gallery');
      wrapper.setAttribute('href', img[i].getAttribute('data-src'));
      wrapper.setAttribute('style', 'width: 100%; display: flex; justify-content: center;');
      img[i].parentElement.insertBefore(wrapper, img[i]);
      wrapper.appendChild(img[i]);
    }
    refreshFsLightbox();
  }
</script>
<script>loadScript("//cdn.jsdelivr.net/npm/fslightbox@3.1.0/index.min.js", addImgLayout)</script>
  
  
  
<script src="/js/main.js"></script>

  
  <script>loadScript("/js/lib/busuanzi.min.js")</script>
  
  
  <script>
    var addLazyload = function () {
      var observer = lozad('.lozad', {
        load: function (el) {
          el.srcset = el.getAttribute('data-src');
        },
        loaded: function (el) {
          el.classList.add('loaded');
        }
      });
      observer.observe();
    }
  </script>
  <script>loadScript("/js/lib/lozad.min.js", addLazyload)</script>
  
  
</body>

</html>