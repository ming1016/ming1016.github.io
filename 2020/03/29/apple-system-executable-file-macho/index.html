<!DOCTYPE html>
<html>
<meta  lang="zh-Hans" >
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#fff" id="theme-color">
  <link rel="icon" href="/img/logo-starming.png">
  <title>戴铭的博客</title>
  <script>
    // control reverse button
    var reverseDarkList = {
      dark: 'light',
      light: 'dark'
    };
    var themeColor = {
      dark: '#1c1c1e',
      light: '#fff'
    }
    // get the data of css prefers-color-scheme
    var getCssMediaQuery = function() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };
    // reverse current darkmode setting function
    var reverseDarkModeSetting = function() {
      var setting = localStorage.getItem('user-color-scheme');
      if(reverseDarkList[setting]) {
        setting = reverseDarkList[setting];
      } else if(setting === null) {
        setting = reverseDarkList[getCssMediaQuery()];
      } else {
        return;
      }
      localStorage.setItem('user-color-scheme', setting);
      return setting;
    };
    // apply current darkmode setting
    var setDarkmode = function(mode) {
      var setting = mode || localStorage.getItem('user-color-scheme');
      if(setting === getCssMediaQuery()) {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[setting];
      } else if(reverseDarkList[setting]) {
        document.documentElement.setAttribute('data-user-color-scheme', setting);
        document.getElementById('theme-color').content = themeColor[setting];
      } else {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[getCssMediaQuery()];
      }
    };
    setDarkmode();
  </script>
  <script>
    function loadScript(url, cb) {
      var script = document.createElement('script');
      script.src = url;
      if (cb) script.onload = cb;
      script.async = true;
      document.body.appendChild(script);
    }
  </script>
  
  <link rel="preload" href="//at.alicdn.com/t/font_1946621_vpj3dq9ceqa.css" as="style" >
  <link rel="preload" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css" as="style" >
  
  <link rel="preload" href="//cdn.jsdelivr.net/npm/fslightbox@3.1.0/index.min.js" as="script">
  
  
  <link rel="preload" href="/js/lib/lozad.min.js" as="script">
  
  
  
  
  
  
  
  
<link rel="stylesheet" href="/css/main.css">

  
  
<link rel="stylesheet" href="//at.alicdn.com/t/font_1946621_vpj3dq9ceqa.css">

  
  
<link rel="stylesheet" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css">

  
  
  
  
  
  <link href="/js/lib/prism/prism.min.css" rel="stylesheet" data-prism="prism">
  
  
  
<link rel="stylesheet" href="/js/lib/prism/prism-line-numbers.min.css">

  
  
  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  <div class="wrapper">
    
    <nav class="navbar">
  <div class="navbar-logo">
    <span class="navbar-logo-main">
      
      <img class="navbar-logo-img" src="/img/logo-starming.png">
      
      <span class="navbar-logo-dsc">戴铭的博客</span>
    </span>
  </div>
  <div class="navbar-menu">
    
    <a href="/" class="navbar-menu-item">Home </a>
    
    <a href="/archives" class="navbar-menu-item">Archive </a>
    
    <a href="/tags" class="navbar-menu-item">Tags </a>
    
    <a href="/categories" class="navbar-menu-item">Categories </a>
    
    <a href="/about" class="navbar-menu-item">About </a>
    
    <a href="/friends" class="navbar-menu-item">Friends </a>
    
    <a class="navbar-menu-item darknavbar" id="dark"><i class="iconfont icon-weather"></i></a>
  </div>
</nav>
    
    <div class="section-wrap">
      <div class="container">
        <div class="columns">
          <main class="main-column">
<article class="card card-content">
  <header>
    <h1 class="post-title">
      Apple 操作系统可执行文件 Mach-O
    </h1>
  </header>
  <div class="post-meta post-show-meta">
    <time datetime="2020-03-29T08:13:45.000Z" style="display: flex; align-items: center;">
      <i class="iconfont icon-calendar" style="margin-right: 2px;"></i>
      <span>2020-03-29</span>
    </time>
    
    <span class="dot"></span>
    
    <a href="/categories/Programming/" class="post-meta-link">Programming</a>
    
    
    
    <span class="dot"></span>
    <span>7.5k words</span>
    
  </div>
  
  <div class="post-meta post-show-meta" style="margin-top: -10px;">
    <div style="display: flex; align-items: center;">
      <i class="iconfont icon-biaoqian" style="margin-right: 2px; font-size: 1.15rem;"></i>
      
      
        <a href="/tags/iOS/" class="post-meta-link">iOS</a>
      
      
      <span class="dot"></span>
      
        <a href="/tags/Apple/" class="post-meta-link">Apple</a>
      
      
      <span class="dot"></span>
      
        <a href="/tags/Mach-O/" class="post-meta-link">Mach-O</a>
      
    </div>
  </div>
  
  </header>
  <div id="section" class="post-content">
    <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Mach-O 的全称是 Mach Object File Format。可以是可执行文件，目标代码或共享库，动态库。Mach 内核的操作系统比如 macOS，iPadOS 和 iOS 都是用的 Mach-O。Mach-O 包含程序的核心逻辑，以及入口点主要功能。</p>
<p>通过学习 Mach-O，可以了解应用程序是如何加载到系统的，如何执行的。还能了解符号查找，函数调用堆栈符号化等。更重要的是能够了解如何设计数据结构，这对于日后开发生涯的收益是长期的。了解这些对于了解编译和逆向工程都会有帮助，你还会了解到动态链接器的内部工作原理以及字节码格式的信息，Leb128字节流，Mach 导出时 Trie 二进制 image 压缩。</p>
<p>对于 Mach-O，你一定不陌生，但是对于它内部逻辑你一定会好奇，比如它是怎么构建出来的，组织方式如何，怎么加载的，如何工作，谁让它工作的，怎样导入和导出符号的。</p>
<p>接下来我们先看看怎么构建一个 Mach-O 文件的吧。</p>
<h2 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h2><p>构建 Mach-O 文件，主要需要用到编译器和静态链接器，编译器可以将编写的高级语言代码转成中间目标文件，然后用静态链接器把中间目标文件组合成 Mach-O。</p>
<p>编译器驱动程序使用的是 clang，有编译、组装和链接的能力，调用 Xcode Tools 里的其他工具来实现源码到 Mach-O 文件生成。其他工具包括将汇编代码创建为中间目标文件的 as 汇编程序，组合中间目标文件成 Mach-O 文件的静态链接器 ld，还有创建静态库或共享库的 libtool。</p>
<p>构建成 Mach-O 包括中间对象文件（MH_OBJECT）、可执行二进制（MH_EXECUTE）、VM 共享库文件（MH_FVMLIB）、Crash 产生的 Core 文件（MH_CORE）、preload（MH_PRELOAD）、动态共享库（MH_DYLIB）、动态链接器（MH_DYLINKER）、静态链接文件（MH_DYLIB_STUB）、符号文件和调试信息（MH_DSYM）这几种类型。其中框架会包含Mach-O和图片、文档、接口等相关资源。</p>
<p>写个 main.c 文件代码：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>通过 clang 构建成 Mach-O 文件 a.out。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">xcrun clang main<span class="token punctuation">.</span>c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>如果有多个文件，先将多个文件生成中间目标文件，后缀是.o，使用 clang 的选项 -c。每个目标文件都是模块。使用静态链接器可以把多个模块组合成一个动态共享库。通过 ld 可以完成这个操作。使用 libtool 的选项 -static 可以构建静态库。</p>
<p>组合成动态库可以使用 clang 的 -dynamiclib 选项，命令如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">xcrun clang <span class="token operator">-</span>dynamiclib command<span class="token punctuation">.</span>c header<span class="token punctuation">.</span>c <span class="token operator">-</span>fvisibility<span class="token operator">=</span>hidden <span class="token operator">-</span>o mac<span class="token punctuation">.</span>dylib<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>静态链接就是把各个模块组合成一个整体，生成新的 Mach-O，链接的内容就是把各个模块间相互的引用能够正确的链接好，原理就是把一些指令对其他符号的地址引用进行修正。过程包含地址和空间分配，符号解析和围绕符号进行的重定位。核心是重定位，X86-64寻址方式是 RIP-relative 寻址，就是基于 RIP 来计算目标地址，通过 jumpq 跳转目标地址，就是当前指令下一条指令地址来加偏移量。</p>
<p>构建完 Mach-O。那你一定好奇 Mach-O 里面都有什么呢？分析 Mach-O 的工具有分析体系结构的 lipo，显式文件类型的 file，列 Data 内容的 otool，分析 image 每个逻辑信息符号的 pagestuff，符号表显示的 nm。</p>
<h2 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h2><p>Mach-O 会将数据流分组，每组都会有自己的意义，主要分三大部分，分别是 Mach Header、Load Command、Data。</p>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>Mach Header 里会有 Mach-O 的 CPU 信息，以及 Load Command 的信息。可以使用 otool 查看内容：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">otool <span class="token operator">-</span>v <span class="token operator">-</span>h a<span class="token punctuation">.</span>out<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>结果如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Mach header
      magic cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags
MH_MAGIC_64  X86_64        ALL  <span class="token number">0x00</span>     EXECUTE    <span class="token number">16</span>       <span class="token number">1368</span>   NOUNDEFS DYLDLINK TWOLEVEL PIE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


<p>通过 _dyld_get_image_header 函数可以获取 mach_header 结构体。<a target="_blank" rel="noopener" href="https://github.com/ming1016/GCDFetchFeed/blob/master/GCDFetchFeed/GCDFetchFeed/Lib/SMLagMonitor/SMCallStack.m">GCDFetchFeed&#x2F;SMCallStack.m at master · ming1016&#x2F;GCDFetchFeed · GitHub</a> 里这段代码里有判断 Mach Header 结构体魔数的函数 smCmdFirstPointerFromMachHeader，代码如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uintptr_t</span> <span class="token function">smCmdFirstPointerFromMachHeader</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">mach_header</span><span class="token operator">*</span> <span class="token keyword">const</span> machHeader<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>machHeader<span class="token operator">-></span>magic<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> MH_MAGIC<span class="token operator">:</span>
        <span class="token keyword">case</span> MH_CIGAM<span class="token operator">:</span>
        <span class="token keyword">case</span> MH_MAGIC_64<span class="token operator">:</span>
        <span class="token keyword">case</span> MH_CIGAM_64<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>machHeaderByCPU<span class="token operator">*</span><span class="token punctuation">)</span>machHeader<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Header 不合法</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>还有 Fat Header，里面会包含多个架构的 Header。</p>
<p>LLVM 中生成 Mach Header 的代码如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> MachOFileLayout<span class="token operator">::</span><span class="token function">writeMachHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">auto</span> cpusubtype <span class="token operator">=</span> MachOLinkingContext<span class="token operator">::</span><span class="token function">cpuSubtypeFromArch</span><span class="token punctuation">(</span>_file<span class="token punctuation">.</span>arch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// dynamic x86 executables on newer OS version should also set the</span>
  <span class="token comment">// CPU_SUBTYPE_LIB64 mask in the CPU subtype.</span>
  <span class="token comment">// FIXME: Check that this is a dynamic executable, not a static one.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_file<span class="token punctuation">.</span>fileType <span class="token operator">==</span> llvm<span class="token operator">::</span>MachO<span class="token operator">::</span>MH_EXECUTE <span class="token operator">&amp;&amp;</span>
      cpusubtype <span class="token operator">==</span> CPU_SUBTYPE_X86_64_ALL <span class="token operator">&amp;&amp;</span>
      _file<span class="token punctuation">.</span>os <span class="token operator">==</span> MachOLinkingContext<span class="token operator">::</span>OS<span class="token operator">::</span>macOSX<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">uint32_t</span> version<span class="token punctuation">;</span>
    bool failed <span class="token operator">=</span> MachOLinkingContext<span class="token operator">::</span><span class="token function">parsePackedVersion</span><span class="token punctuation">(</span><span class="token string">"10.5"</span><span class="token punctuation">,</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>failed <span class="token operator">&amp;&amp;</span> _file<span class="token punctuation">.</span>minOSverson <span class="token operator">>=</span> version<span class="token punctuation">)</span>
      cpusubtype <span class="token operator">|=</span> CPU_SUBTYPE_LIB64<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  mach_header <span class="token operator">*</span>mh <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>mach_header<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mh<span class="token operator">-></span>magic <span class="token operator">=</span> _is64 <span class="token operator">?</span> llvm<span class="token operator">::</span>MachO<span class="token operator">::</span>MH_MAGIC_64 <span class="token operator">:</span> llvm<span class="token operator">::</span>MachO<span class="token operator">::</span>MH_MAGIC<span class="token punctuation">;</span>
  mh<span class="token operator">-></span>cputype <span class="token operator">=</span>  MachOLinkingContext<span class="token operator">::</span><span class="token function">cpuTypeFromArch</span><span class="token punctuation">(</span>_file<span class="token punctuation">.</span>arch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mh<span class="token operator">-></span>cpusubtype <span class="token operator">=</span> cpusubtype<span class="token punctuation">;</span>
  mh<span class="token operator">-></span>filetype <span class="token operator">=</span> _file<span class="token punctuation">.</span>fileType<span class="token punctuation">;</span>
  mh<span class="token operator">-></span>ncmds <span class="token operator">=</span> _countOfLoadCommands<span class="token punctuation">;</span>
  mh<span class="token operator">-></span>sizeofcmds <span class="token operator">=</span> _endOfLoadCommands <span class="token operator">-</span> _startOfLoadCommands<span class="token punctuation">;</span>
  mh<span class="token operator">-></span>flags <span class="token operator">=</span> _file<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_swap<span class="token punctuation">)</span>
    <span class="token function">swapStruct</span><span class="token punctuation">(</span><span class="token operator">*</span>mh<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="Load-Command"><a href="#Load-Command" class="headerlink" title="Load Command"></a>Load Command</h3><p>Load Command 包含 Mach-O 里命令类型信息，名称和二进制文件的位置。</p>
<p>使用 otool 命令可以查看详细：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">otool <span class="token operator">-</span>v <span class="token operator">-</span>l a<span class="token punctuation">.</span>out<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>遍历 Mach Header 里的 ncmds 可以取到所有 Load Command。代码如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> iCmd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> iCmd <span class="token operator">&lt;</span> machHeader<span class="token operator">-></span>ncmds<span class="token punctuation">;</span> iCmd<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">load_command</span><span class="token operator">*</span> loadCmd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">load_command</span><span class="token operator">*</span><span class="token punctuation">)</span>cmdPointer<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


<p>load_command 里的 cmd 是以 LC_ 开头定义的宏，可以参看 loader.h 里的定义，有50多个，主要的是：</p>
<ul>
<li>LC_SEGMENT_64(_PAGEZERO)</li>
<li>LC_SEGMENT_64(_TEXT)</li>
<li>LC_SEGMENT_64(_DATA)</li>
<li>LC_SEGMENT_64(_LINKEDIT)</li>
<li>LC_DYLD_INFO_ONLY</li>
<li>LC_SYMTAB</li>
<li>LC_DYSYMTAB</li>
<li>LC_LOAD_DYLINKER</li>
<li>LC_UUID</li>
<li>LC_BUILD_VERSION</li>
<li>LC_SOURCE_VERSION</li>
<li>LC_MAIN</li>
<li>LC_LOAD_DYLIB(libSystem.B.dylib)</li>
<li>LC_FUNCTION_STARTS</li>
<li>LC_DATA_IN_CODE</li>
</ul>
<p>每个 command 的结构都是独立的，前两个字段 cmd 和 cmdsize 是一样的。</p>
<p>根据 Load Command 可以得到 Segment 的偏移量。</p>
<p>生成 Load Command 的代码如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">llvm<span class="token operator">::</span>Error MachOFileLayout<span class="token operator">::</span><span class="token function">writeLoadCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token class-name">uint8_t</span> <span class="token operator">*</span>lc <span class="token operator">=</span> <span class="token operator">&amp;</span>_buffer<span class="token punctuation">[</span>_startOfLoadCommands<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_file<span class="token punctuation">.</span>fileType <span class="token operator">==</span> llvm<span class="token operator">::</span>MachO<span class="token operator">::</span>MH_OBJECT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Object files have one unnamed segment which holds all sections.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_is64<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> ec <span class="token operator">=</span> writeSingleSegmentLoadCommand<span class="token operator">&lt;</span>MachO64Trait<span class="token operator">></span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token keyword">return</span> ec<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> ec <span class="token operator">=</span> writeSingleSegmentLoadCommand<span class="token operator">&lt;</span>MachO32Trait<span class="token operator">></span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ec<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// Add LC_SYMTAB with symbol table info</span>
    symtab_command<span class="token operator">*</span> st <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>symtab_command<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    st<span class="token operator">-></span>cmd     <span class="token operator">=</span> LC_SYMTAB<span class="token punctuation">;</span>
    st<span class="token operator">-></span>cmdsize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>symtab_command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    st<span class="token operator">-></span>symoff  <span class="token operator">=</span> _startOfSymbols<span class="token punctuation">;</span>
    st<span class="token operator">-></span>nsyms   <span class="token operator">=</span> _file<span class="token punctuation">.</span>stabsSymbols<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> _file<span class="token punctuation">.</span>localSymbols<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                  _file<span class="token punctuation">.</span>globalSymbols<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> _file<span class="token punctuation">.</span>undefinedSymbols<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    st<span class="token operator">-></span>stroff  <span class="token operator">=</span> _startOfSymbolStrings<span class="token punctuation">;</span>
    st<span class="token operator">-></span>strsize <span class="token operator">=</span> _endOfSymbolStrings <span class="token operator">-</span> _startOfSymbolStrings<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_swap<span class="token punctuation">)</span>
      <span class="token function">swapStruct</span><span class="token punctuation">(</span><span class="token operator">*</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>
    lc <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>symtab_command<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add LC_VERSION_MIN_MACOSX, LC_VERSION_MIN_IPHONEOS,</span>
    <span class="token comment">// LC_VERSION_MIN_WATCHOS, LC_VERSION_MIN_TVOS</span>
    <span class="token function">writeVersionMinLoadCommand</span><span class="token punctuation">(</span>_file<span class="token punctuation">,</span> _swap<span class="token punctuation">,</span> lc<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add LC_FUNCTION_STARTS if needed.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_functionStartsSize <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      linkedit_data_command<span class="token operator">*</span> dl <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>linkedit_data_command<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">;</span>
      dl<span class="token operator">-></span>cmd      <span class="token operator">=</span> LC_FUNCTION_STARTS<span class="token punctuation">;</span>
      dl<span class="token operator">-></span>cmdsize  <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>linkedit_data_command<span class="token punctuation">)</span><span class="token punctuation">;</span>
      dl<span class="token operator">-></span>dataoff  <span class="token operator">=</span> _startOfFunctionStarts<span class="token punctuation">;</span>
      dl<span class="token operator">-></span>datasize <span class="token operator">=</span> _functionStartsSize<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_swap<span class="token punctuation">)</span>
        <span class="token function">swapStruct</span><span class="token punctuation">(</span><span class="token operator">*</span>dl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      lc <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>linkedit_data_command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Add LC_DATA_IN_CODE if requested.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_file<span class="token punctuation">.</span>generateDataInCodeLoadCommand<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      linkedit_data_command<span class="token operator">*</span> dl <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>linkedit_data_command<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">;</span>
      dl<span class="token operator">-></span>cmd      <span class="token operator">=</span> LC_DATA_IN_CODE<span class="token punctuation">;</span>
      dl<span class="token operator">-></span>cmdsize  <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>linkedit_data_command<span class="token punctuation">)</span><span class="token punctuation">;</span>
      dl<span class="token operator">-></span>dataoff  <span class="token operator">=</span> _startOfDataInCode<span class="token punctuation">;</span>
      dl<span class="token operator">-></span>datasize <span class="token operator">=</span> _dataInCodeSize<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_swap<span class="token punctuation">)</span>
        <span class="token function">swapStruct</span><span class="token punctuation">(</span><span class="token operator">*</span>dl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      lc <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>linkedit_data_command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Final linked images have sections under segments.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_is64<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> ec <span class="token operator">=</span> writeSegmentLoadCommands<span class="token operator">&lt;</span>MachO64Trait<span class="token operator">></span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ec<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> ec <span class="token operator">=</span> writeSegmentLoadCommands<span class="token operator">&lt;</span>MachO32Trait<span class="token operator">></span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ec<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Add LC_ID_DYLIB command for dynamic libraries.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_file<span class="token punctuation">.</span>fileType <span class="token operator">==</span> llvm<span class="token operator">::</span>MachO<span class="token operator">::</span>MH_DYLIB<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      dylib_command <span class="token operator">*</span>dc <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>dylib_command<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">;</span>
      StringRef path <span class="token operator">=</span> _file<span class="token punctuation">.</span>installName<span class="token punctuation">;</span>
      <span class="token class-name">uint32_t</span> size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dylib_command<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">pointerAlign</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      dc<span class="token operator">-></span>cmd                         <span class="token operator">=</span> LC_ID_DYLIB<span class="token punctuation">;</span>
      dc<span class="token operator">-></span>cmdsize                     <span class="token operator">=</span> size<span class="token punctuation">;</span>
      dc<span class="token operator">-></span>dylib<span class="token punctuation">.</span>name                  <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dylib_command<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// offset</span>
      <span class="token comment">// needs to be some constant value different than the one in LC_LOAD_DYLIB</span>
      dc<span class="token operator">-></span>dylib<span class="token punctuation">.</span>timestamp             <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      dc<span class="token operator">-></span>dylib<span class="token punctuation">.</span>current_version       <span class="token operator">=</span> _file<span class="token punctuation">.</span>currentVersion<span class="token punctuation">;</span>
      dc<span class="token operator">-></span>dylib<span class="token punctuation">.</span>compatibility_version <span class="token operator">=</span> _file<span class="token punctuation">.</span>compatVersion<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_swap<span class="token punctuation">)</span>
        <span class="token function">swapStruct</span><span class="token punctuation">(</span><span class="token operator">*</span>dc<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>lc <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dylib_command<span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      lc<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>dylib_command<span class="token punctuation">)</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
      lc <span class="token operator">+=</span> size<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Add LC_DYLD_INFO_ONLY.</span>
    dyld_info_command<span class="token operator">*</span> di <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>dyld_info_command<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    di<span class="token operator">-></span>cmd            <span class="token operator">=</span> LC_DYLD_INFO_ONLY<span class="token punctuation">;</span>
    di<span class="token operator">-></span>cmdsize        <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dyld_info_command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    di<span class="token operator">-></span>rebase_off     <span class="token operator">=</span> _rebaseInfo<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> _startOfRebaseInfo <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    di<span class="token operator">-></span>rebase_size    <span class="token operator">=</span> _rebaseInfo<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    di<span class="token operator">-></span>bind_off       <span class="token operator">=</span> _bindingInfo<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> _startOfBindingInfo <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    di<span class="token operator">-></span>bind_size      <span class="token operator">=</span> _bindingInfo<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    di<span class="token operator">-></span>weak_bind_off  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    di<span class="token operator">-></span>weak_bind_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    di<span class="token operator">-></span>lazy_bind_off  <span class="token operator">=</span> _lazyBindingInfo<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> _startOfLazyBindingInfo <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    di<span class="token operator">-></span>lazy_bind_size <span class="token operator">=</span> _lazyBindingInfo<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    di<span class="token operator">-></span>export_off     <span class="token operator">=</span> _exportTrie<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> _startOfExportTrie <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    di<span class="token operator">-></span>export_size    <span class="token operator">=</span> _exportTrie<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_swap<span class="token punctuation">)</span>
      <span class="token function">swapStruct</span><span class="token punctuation">(</span><span class="token operator">*</span>di<span class="token punctuation">)</span><span class="token punctuation">;</span>
    lc <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dyld_info_command<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add LC_SYMTAB with symbol table info.</span>
    symtab_command<span class="token operator">*</span> st <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>symtab_command<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    st<span class="token operator">-></span>cmd     <span class="token operator">=</span> LC_SYMTAB<span class="token punctuation">;</span>
    st<span class="token operator">-></span>cmdsize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>symtab_command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    st<span class="token operator">-></span>symoff  <span class="token operator">=</span> _startOfSymbols<span class="token punctuation">;</span>
    st<span class="token operator">-></span>nsyms   <span class="token operator">=</span> _file<span class="token punctuation">.</span>stabsSymbols<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> _file<span class="token punctuation">.</span>localSymbols<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                  _file<span class="token punctuation">.</span>globalSymbols<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> _file<span class="token punctuation">.</span>undefinedSymbols<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    st<span class="token operator">-></span>stroff  <span class="token operator">=</span> _startOfSymbolStrings<span class="token punctuation">;</span>
    st<span class="token operator">-></span>strsize <span class="token operator">=</span> _endOfSymbolStrings <span class="token operator">-</span> _startOfSymbolStrings<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_swap<span class="token punctuation">)</span>
      <span class="token function">swapStruct</span><span class="token punctuation">(</span><span class="token operator">*</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>
    lc <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>symtab_command<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add LC_DYSYMTAB</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_file<span class="token punctuation">.</span>fileType <span class="token operator">!=</span> llvm<span class="token operator">::</span>MachO<span class="token operator">::</span>MH_PRELOAD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      dysymtab_command<span class="token operator">*</span> dst <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>dysymtab_command<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">;</span>
      dst<span class="token operator">-></span>cmd            <span class="token operator">=</span> LC_DYSYMTAB<span class="token punctuation">;</span>
      dst<span class="token operator">-></span>cmdsize        <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dysymtab_command<span class="token punctuation">)</span><span class="token punctuation">;</span>
      dst<span class="token operator">-></span>ilocalsym      <span class="token operator">=</span> _symbolTableLocalsStartIndex<span class="token punctuation">;</span>
      dst<span class="token operator">-></span>nlocalsym      <span class="token operator">=</span> _file<span class="token punctuation">.</span>stabsSymbols<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                            _file<span class="token punctuation">.</span>localSymbols<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      dst<span class="token operator">-></span>iextdefsym     <span class="token operator">=</span> _symbolTableGlobalsStartIndex<span class="token punctuation">;</span>
      dst<span class="token operator">-></span>nextdefsym     <span class="token operator">=</span> _file<span class="token punctuation">.</span>globalSymbols<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      dst<span class="token operator">-></span>iundefsym      <span class="token operator">=</span> _symbolTableUndefinesStartIndex<span class="token punctuation">;</span>
      dst<span class="token operator">-></span>nundefsym      <span class="token operator">=</span> _file<span class="token punctuation">.</span>undefinedSymbols<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      dst<span class="token operator">-></span>tocoff         <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      dst<span class="token operator">-></span>ntoc           <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      dst<span class="token operator">-></span>modtaboff      <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      dst<span class="token operator">-></span>nmodtab        <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      dst<span class="token operator">-></span>extrefsymoff   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      dst<span class="token operator">-></span>nextrefsyms    <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      dst<span class="token operator">-></span>indirectsymoff <span class="token operator">=</span> _startOfIndirectSymbols<span class="token punctuation">;</span>
      dst<span class="token operator">-></span>nindirectsyms  <span class="token operator">=</span> _indirectSymbolTableCount<span class="token punctuation">;</span>
      dst<span class="token operator">-></span>extreloff      <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      dst<span class="token operator">-></span>nextrel        <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      dst<span class="token operator">-></span>locreloff      <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      dst<span class="token operator">-></span>nlocrel        <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_swap<span class="token punctuation">)</span>
        <span class="token function">swapStruct</span><span class="token punctuation">(</span><span class="token operator">*</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
      lc <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dysymtab_command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// If main executable, add LC_LOAD_DYLINKER</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_file<span class="token punctuation">.</span>fileType <span class="token operator">==</span> llvm<span class="token operator">::</span>MachO<span class="token operator">::</span>MH_EXECUTE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Build LC_LOAD_DYLINKER load command.</span>
      <span class="token class-name">uint32_t</span> size<span class="token operator">=</span><span class="token function">pointerAlign</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>dylinker_command<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">dyldPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      dylinker_command<span class="token operator">*</span> dl <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>dylinker_command<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">;</span>
      dl<span class="token operator">-></span>cmd              <span class="token operator">=</span> LC_LOAD_DYLINKER<span class="token punctuation">;</span>
      dl<span class="token operator">-></span>cmdsize          <span class="token operator">=</span> size<span class="token punctuation">;</span>
      dl<span class="token operator">-></span>name             <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dylinker_command<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// offset</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_swap<span class="token punctuation">)</span>
        <span class="token function">swapStruct</span><span class="token punctuation">(</span><span class="token operator">*</span>dl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>lc<span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>dylinker_command<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">dyldPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">dyldPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      lc<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>dylinker_command<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">dyldPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
      lc <span class="token operator">+=</span> size<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Add LC_VERSION_MIN_MACOSX, LC_VERSION_MIN_IPHONEOS, LC_VERSION_MIN_WATCHOS,</span>
    <span class="token comment">// LC_VERSION_MIN_TVOS</span>
    <span class="token function">writeVersionMinLoadCommand</span><span class="token punctuation">(</span>_file<span class="token punctuation">,</span> _swap<span class="token punctuation">,</span> lc<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add LC_SOURCE_VERSION</span>
    <span class="token punctuation">&#123;</span>
      <span class="token comment">// Note, using a temporary here to appease UB as we may not be aligned</span>
      <span class="token comment">// enough for a struct containing a uint64_t when emitting a 32-bit binary</span>
      source_version_command sv<span class="token punctuation">;</span>
      sv<span class="token punctuation">.</span>cmd       <span class="token operator">=</span> LC_SOURCE_VERSION<span class="token punctuation">;</span>
      sv<span class="token punctuation">.</span>cmdsize   <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>source_version_command<span class="token punctuation">)</span><span class="token punctuation">;</span>
      sv<span class="token punctuation">.</span>version   <span class="token operator">=</span> _file<span class="token punctuation">.</span>sourceVersion<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_swap<span class="token punctuation">)</span>
        <span class="token function">swapStruct</span><span class="token punctuation">(</span>sv<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>lc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sv<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>source_version_command<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      lc <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>source_version_command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// If main executable, add LC_MAIN.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_file<span class="token punctuation">.</span>fileType <span class="token operator">==</span> llvm<span class="token operator">::</span>MachO<span class="token operator">::</span>MH_EXECUTE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Build LC_MAIN load command.</span>
      <span class="token comment">// Note, using a temporary here to appease UB as we may not be aligned</span>
      <span class="token comment">// enough for a struct containing a uint64_t when emitting a 32-bit binary</span>
      entry_point_command ep<span class="token punctuation">;</span>
      ep<span class="token punctuation">.</span>cmd       <span class="token operator">=</span> LC_MAIN<span class="token punctuation">;</span>
      ep<span class="token punctuation">.</span>cmdsize   <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>entry_point_command<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ep<span class="token punctuation">.</span>entryoff  <span class="token operator">=</span> _file<span class="token punctuation">.</span>entryAddress <span class="token operator">-</span> _seg1addr<span class="token punctuation">;</span>
      ep<span class="token punctuation">.</span>stacksize <span class="token operator">=</span> _file<span class="token punctuation">.</span>stackSize<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_swap<span class="token punctuation">)</span>
        <span class="token function">swapStruct</span><span class="token punctuation">(</span>ep<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>lc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ep<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>entry_point_command<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      lc <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>entry_point_command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Add LC_LOAD_DYLIB commands</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> DependentDylib <span class="token operator">&amp;</span>dep <span class="token operator">:</span> _file<span class="token punctuation">.</span>dependentDylibs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      dylib_command<span class="token operator">*</span> dc <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>dylib_command<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">uint32_t</span> size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dylib_command<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">pointerAlign</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      dc<span class="token operator">-></span>cmd                         <span class="token operator">=</span> dep<span class="token punctuation">.</span>kind<span class="token punctuation">;</span>
      dc<span class="token operator">-></span>cmdsize                     <span class="token operator">=</span> size<span class="token punctuation">;</span>
      dc<span class="token operator">-></span>dylib<span class="token punctuation">.</span>name                  <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dylib_command<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// offset</span>
      <span class="token comment">// needs to be some constant value different than the one in LC_ID_DYLIB</span>
      dc<span class="token operator">-></span>dylib<span class="token punctuation">.</span>timestamp             <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
      dc<span class="token operator">-></span>dylib<span class="token punctuation">.</span>current_version       <span class="token operator">=</span> dep<span class="token punctuation">.</span>currentVersion<span class="token punctuation">;</span>
      dc<span class="token operator">-></span>dylib<span class="token punctuation">.</span>compatibility_version <span class="token operator">=</span> dep<span class="token punctuation">.</span>compatVersion<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_swap<span class="token punctuation">)</span>
        <span class="token function">swapStruct</span><span class="token punctuation">(</span><span class="token operator">*</span>dc<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>lc<span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>dylib_command<span class="token punctuation">)</span><span class="token punctuation">,</span> dep<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dep<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      lc<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>dylib_command<span class="token punctuation">)</span><span class="token operator">+</span>dep<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
      lc <span class="token operator">+=</span> size<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Add LC_RPATH</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> StringRef <span class="token operator">&amp;</span>path <span class="token operator">:</span> _file<span class="token punctuation">.</span>rpaths<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      rpath_command <span class="token operator">*</span>rpc <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>rpath_command <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">uint32_t</span> size <span class="token operator">=</span> <span class="token function">pointerAlign</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>rpath_command<span class="token punctuation">)</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      rpc<span class="token operator">-></span>cmd                         <span class="token operator">=</span> LC_RPATH<span class="token punctuation">;</span>
      rpc<span class="token operator">-></span>cmdsize                     <span class="token operator">=</span> size<span class="token punctuation">;</span>
      rpc<span class="token operator">-></span>path                        <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>rpath_command<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// offset</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_swap<span class="token punctuation">)</span>
        <span class="token function">swapStruct</span><span class="token punctuation">(</span><span class="token operator">*</span>rpc<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>lc<span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>rpath_command<span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      lc<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>rpath_command<span class="token punctuation">)</span><span class="token operator">+</span>path<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
      lc <span class="token operator">+=</span> size<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Add LC_FUNCTION_STARTS if needed.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_functionStartsSize <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      linkedit_data_command<span class="token operator">*</span> dl <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>linkedit_data_command<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">;</span>
      dl<span class="token operator">-></span>cmd      <span class="token operator">=</span> LC_FUNCTION_STARTS<span class="token punctuation">;</span>
      dl<span class="token operator">-></span>cmdsize  <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>linkedit_data_command<span class="token punctuation">)</span><span class="token punctuation">;</span>
      dl<span class="token operator">-></span>dataoff  <span class="token operator">=</span> _startOfFunctionStarts<span class="token punctuation">;</span>
      dl<span class="token operator">-></span>datasize <span class="token operator">=</span> _functionStartsSize<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_swap<span class="token punctuation">)</span>
        <span class="token function">swapStruct</span><span class="token punctuation">(</span><span class="token operator">*</span>dl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      lc <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>linkedit_data_command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Add LC_DATA_IN_CODE if requested.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_file<span class="token punctuation">.</span>generateDataInCodeLoadCommand<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      linkedit_data_command<span class="token operator">*</span> dl <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>linkedit_data_command<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">;</span>
      dl<span class="token operator">-></span>cmd      <span class="token operator">=</span> LC_DATA_IN_CODE<span class="token punctuation">;</span>
      dl<span class="token operator">-></span>cmdsize  <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>linkedit_data_command<span class="token punctuation">)</span><span class="token punctuation">;</span>
      dl<span class="token operator">-></span>dataoff  <span class="token operator">=</span> _startOfDataInCode<span class="token punctuation">;</span>
      dl<span class="token operator">-></span>datasize <span class="token operator">=</span> _dataInCodeSize<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_swap<span class="token punctuation">)</span>
        <span class="token function">swapStruct</span><span class="token punctuation">(</span><span class="token operator">*</span>dl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      lc <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>linkedit_data_command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> llvm<span class="token operator">::</span>Error<span class="token operator">::</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="Data"><a href="#Data" class="headerlink" title="Data"></a>Data</h3><p>Data 由 Segment 的数据组成，是 Mach-O 占比最多的部分，有代码有数据，比如符号表。Data 共三个 Segment，__TEXT、__DATA、__LINKEDIT。其中 __TEXT 和 __DATA 对应一个或多个 Section，__LINKEDIT 没有 Section，需要配合 LC_SYMTAB 来解析 symbol table 和 string table。这些里面是 Mach-O 的主要数据。</p>
<p>生成 __LINKEDIT 的代码如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> MachOFileLayout<span class="token operator">::</span><span class="token function">buildLinkEditInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">buildRebaseInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">buildBindInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">buildLazyBindInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">buildExportTrie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">computeSymbolTableSizes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">computeFunctionStartsSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">computeDataInCodeSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> MachOFileLayout<span class="token operator">::</span><span class="token function">writeLinkEditContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_file<span class="token punctuation">.</span>fileType <span class="token operator">==</span> llvm<span class="token operator">::</span>MachO<span class="token operator">::</span>MH_OBJECT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">writeRelocations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writeFunctionStartsInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writeDataInCodeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writeSymbolTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token function">writeRebaseInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writeBindingInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writeLazyBindingInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO: add weak binding info</span>
    <span class="token function">writeExportInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writeFunctionStartsInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writeDataInCodeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writeSymbolTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>通过生成 __LINKEDIT 的代码可以看出 __LINKEDIT 里包含 dyld 所需各种数据，比如符号表、间接符号表、rebase 操作码、绑定操作码、导出符号、函数启动信息、数据表、代码签名等。</p>
<p>__DATA 包含 lazy 和 non lazy 符号指针，还会包含静态数据和全局变量等。可重定位的 Mach-O 文件还会有一个重定位的区域用来存储重定位信息，如果哪个 section 有重定位字节，就会有一个 relocation table 对应。</p>
<p>生成 relocation 的代码如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> MachOFileLayout<span class="token operator">::</span><span class="token function">writeRelocations</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token class-name">uint32_t</span> relOffset <span class="token operator">=</span> _startOfRelocations<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>Section sect <span class="token operator">:</span> _file<span class="token punctuation">.</span>sections<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Relocation r <span class="token operator">:</span> sect<span class="token punctuation">.</span>relocations<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      any_relocation_info<span class="token operator">*</span> rb <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>any_relocation_info<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>
                                                           <span class="token operator">&amp;</span>_buffer<span class="token punctuation">[</span>relOffset<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">*</span>rb <span class="token operator">=</span> <span class="token function">packRelocation</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> _swap<span class="token punctuation">,</span> _bigEndianArch<span class="token punctuation">)</span><span class="token punctuation">;</span>
      relOffset <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>any_relocation_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>使用 size 命令可以看到内容的分布，使用前面生成的 a.out 来看：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">xcrun size <span class="token operator">-</span>x <span class="token operator">-</span>l <span class="token operator">-</span>m a<span class="token punctuation">.</span>out<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>结果如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Segment __PAGEZERO<span class="token operator">:</span> <span class="token number">0x100000000</span> <span class="token punctuation">(</span>vmaddr <span class="token number">0x0</span> fileoff <span class="token number">0</span><span class="token punctuation">)</span>
Segment __TEXT<span class="token operator">:</span> <span class="token number">0x1000</span> <span class="token punctuation">(</span>vmaddr <span class="token number">0x100000000</span> fileoff <span class="token number">0</span><span class="token punctuation">)</span>
    Section __text<span class="token operator">:</span> <span class="token number">0x41</span> <span class="token punctuation">(</span>addr <span class="token number">0x100000f50</span> offset <span class="token number">3920</span><span class="token punctuation">)</span>
    Section __stubs<span class="token operator">:</span> <span class="token number">0x6</span> <span class="token punctuation">(</span>addr <span class="token number">0x100000f92</span> offset <span class="token number">3986</span><span class="token punctuation">)</span>
    Section __stub_helper<span class="token operator">:</span> <span class="token number">0x1a</span> <span class="token punctuation">(</span>addr <span class="token number">0x100000f98</span> offset <span class="token number">3992</span><span class="token punctuation">)</span>
    Section __cstring<span class="token operator">:</span> <span class="token number">0x4</span> <span class="token punctuation">(</span>addr <span class="token number">0x100000fb2</span> offset <span class="token number">4018</span><span class="token punctuation">)</span>
    Section __unwind_info<span class="token operator">:</span> <span class="token number">0x48</span> <span class="token punctuation">(</span>addr <span class="token number">0x100000fb8</span> offset <span class="token number">4024</span><span class="token punctuation">)</span>
    total <span class="token number">0xad</span>
Segment __DATA_CONST<span class="token operator">:</span> <span class="token number">0x1000</span> <span class="token punctuation">(</span>vmaddr <span class="token number">0x100001000</span> fileoff <span class="token number">4096</span><span class="token punctuation">)</span>
    Section __got<span class="token operator">:</span> <span class="token number">0x8</span> <span class="token punctuation">(</span>addr <span class="token number">0x100001000</span> offset <span class="token number">4096</span><span class="token punctuation">)</span>
    total <span class="token number">0x8</span>
Segment __DATA<span class="token operator">:</span> <span class="token number">0x1000</span> <span class="token punctuation">(</span>vmaddr <span class="token number">0x100002000</span> fileoff <span class="token number">8192</span><span class="token punctuation">)</span>
    Section __la_symbol_ptr<span class="token operator">:</span> <span class="token number">0x8</span> <span class="token punctuation">(</span>addr <span class="token number">0x100002000</span> offset <span class="token number">8192</span><span class="token punctuation">)</span>
    Section __data<span class="token operator">:</span> <span class="token number">0x8</span> <span class="token punctuation">(</span>addr <span class="token number">0x100002008</span> offset <span class="token number">8200</span><span class="token punctuation">)</span>
    total <span class="token number">0x10</span>
Segment __LINKEDIT<span class="token operator">:</span> <span class="token number">0x1000</span> <span class="token punctuation">(</span>vmaddr <span class="token number">0x100003000</span> fileoff <span class="token number">12288</span><span class="token punctuation">)</span>
total <span class="token number">0x100004000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>其中__TEXT Segment 的内容有：</p>
<ul>
<li>Section64(__TEXT,__text)</li>
<li>Section64(__TEXT,__stubs)</li>
<li>Section64(__TEXT,__stub_helper)</li>
<li>Section64(__TEXT,__cstring)</li>
<li>Section64(__TEXT,__unwind_info)</li>
</ul>
<p>__DATA Segment 的内容有：</p>
<ul>
<li>Section64(__DATA,__nl_symbol_ptr)</li>
<li>Section64(__DATA,__la_symbol_ptr)</li>
</ul>
<p>__LINKEDIT 的内容是：</p>
<ul>
<li>Dynamic Loader Info</li>
<li>Function Starts</li>
<li>Symbol Table</li>
<li>Data in Code Entries</li>
<li>Dynamic Symbol Table</li>
<li>String Table</li>
</ul>
<p>如果是 Objective-C 代码生成的 Mach-O 会多出很多和 Objective-C 相关的 Section ，我拿<a target="_blank" rel="noopener" href="https://github.com/ming1016/GCDFetchFeed">已阅</a>项目生成的 Mach-O 来看。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">xcrun size <span class="token operator">-</span>x <span class="token operator">-</span>l <span class="token operator">-</span>m GCDFetchFeed<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>结果如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Segment __PAGEZERO<span class="token operator">:</span> <span class="token number">0x100000000</span> <span class="token punctuation">(</span>vmaddr <span class="token number">0x0</span> fileoff <span class="token number">0</span><span class="token punctuation">)</span>
Segment __TEXT<span class="token operator">:</span> <span class="token number">0xa8000</span> <span class="token punctuation">(</span>vmaddr <span class="token number">0x100000000</span> fileoff <span class="token number">0</span><span class="token punctuation">)</span>
    Section __text<span class="token operator">:</span> <span class="token number">0x89084</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000020e0</span> offset <span class="token number">8416</span><span class="token punctuation">)</span>
    Section __stubs<span class="token operator">:</span> <span class="token number">0x588</span> <span class="token punctuation">(</span>addr <span class="token number">0x10008b164</span> offset <span class="token number">569700</span><span class="token punctuation">)</span>
    Section __stub_helper<span class="token operator">:</span> <span class="token number">0x948</span> <span class="token punctuation">(</span>addr <span class="token number">0x10008b6ec</span> offset <span class="token number">571116</span><span class="token punctuation">)</span>
    Section __gcc_except_tab<span class="token operator">:</span> <span class="token number">0x1318</span> <span class="token punctuation">(</span>addr <span class="token number">0x10008c034</span> offset <span class="token number">573492</span><span class="token punctuation">)</span>
    Section __cstring<span class="token operator">:</span> <span class="token number">0xbebd</span> <span class="token punctuation">(</span>addr <span class="token number">0x10008d34c</span> offset <span class="token number">578380</span><span class="token punctuation">)</span>
    Section __objc_methname<span class="token operator">:</span> <span class="token number">0xa20f</span> <span class="token punctuation">(</span>addr <span class="token number">0x100099209</span> offset <span class="token number">627209</span><span class="token punctuation">)</span>
    Section __objc_classname<span class="token operator">:</span> <span class="token number">0x11d9</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000a3418</span> offset <span class="token number">668696</span><span class="token punctuation">)</span>
    Section __objc_methtype<span class="token operator">:</span> <span class="token number">0x2185</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000a45f1</span> offset <span class="token number">673265</span><span class="token punctuation">)</span>
    Section __const<span class="token operator">:</span> <span class="token number">0x23c</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000a6780</span> offset <span class="token number">681856</span><span class="token punctuation">)</span>
    Section __ustring<span class="token operator">:</span> <span class="token number">0x23e</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000a69bc</span> offset <span class="token number">682428</span><span class="token punctuation">)</span>
    Section __entitlements<span class="token operator">:</span> <span class="token number">0x184</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000a6bfa</span> offset <span class="token number">683002</span><span class="token punctuation">)</span>
    Section __unwind_info<span class="token operator">:</span> <span class="token number">0x1274</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000a6d80</span> offset <span class="token number">683392</span><span class="token punctuation">)</span>
    total <span class="token number">0xa5f08</span>
Segment __DATA<span class="token operator">:</span> <span class="token number">0x2f000</span> <span class="token punctuation">(</span>vmaddr <span class="token number">0x1000a8000</span> fileoff <span class="token number">688128</span><span class="token punctuation">)</span>
    Section __nl_symbol_ptr<span class="token operator">:</span> <span class="token number">0x8</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000a8000</span> offset <span class="token number">688128</span><span class="token punctuation">)</span>
    Section __got<span class="token operator">:</span> <span class="token number">0x258</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000a8008</span> offset <span class="token number">688136</span><span class="token punctuation">)</span>
    Section __la_symbol_ptr<span class="token operator">:</span> <span class="token number">0x760</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000a8260</span> offset <span class="token number">688736</span><span class="token punctuation">)</span>
    Section __const<span class="token operator">:</span> <span class="token number">0x4238</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000a89c0</span> offset <span class="token number">690624</span><span class="token punctuation">)</span>
    Section __cfstring<span class="token operator">:</span> <span class="token number">0x9d80</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000acbf8</span> offset <span class="token number">707576</span><span class="token punctuation">)</span>
    Section __objc_classlist<span class="token operator">:</span> <span class="token number">0x510</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000b6978</span> offset <span class="token number">747896</span><span class="token punctuation">)</span>
    Section __objc_nlclslist<span class="token operator">:</span> <span class="token number">0x40</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000b6e88</span> offset <span class="token number">749192</span><span class="token punctuation">)</span>
    Section __objc_catlist<span class="token operator">:</span> <span class="token number">0x90</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000b6ec8</span> offset <span class="token number">749256</span><span class="token punctuation">)</span>
    Section __objc_nlcatlist<span class="token operator">:</span> <span class="token number">0x10</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000b6f58</span> offset <span class="token number">749400</span><span class="token punctuation">)</span>
    Section __objc_protolist<span class="token operator">:</span> <span class="token number">0x80</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000b6f68</span> offset <span class="token number">749416</span><span class="token punctuation">)</span>
    Section __objc_imageinfo<span class="token operator">:</span> <span class="token number">0x8</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000b6fe8</span> offset <span class="token number">749544</span><span class="token punctuation">)</span>
    Section __objc_const<span class="token operator">:</span> <span class="token number">0x182e8</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000b6ff0</span> offset <span class="token number">749552</span><span class="token punctuation">)</span>
    Section __objc_selrefs<span class="token operator">:</span> <span class="token number">0x2bf8</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000cf2d8</span> offset <span class="token number">848600</span><span class="token punctuation">)</span>
    Section __objc_protorefs<span class="token operator">:</span> <span class="token number">0x8</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000d1ed0</span> offset <span class="token number">859856</span><span class="token punctuation">)</span>
    Section __objc_classrefs<span class="token operator">:</span> <span class="token number">0x858</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000d1ed8</span> offset <span class="token number">859864</span><span class="token punctuation">)</span>
    Section __objc_superrefs<span class="token operator">:</span> <span class="token number">0x370</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000d2730</span> offset <span class="token number">862000</span><span class="token punctuation">)</span>
    Section __objc_ivar<span class="token operator">:</span> <span class="token number">0xb48</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000d2aa0</span> offset <span class="token number">862880</span><span class="token punctuation">)</span>
    Section __objc_data<span class="token operator">:</span> <span class="token number">0x32a0</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000d35e8</span> offset <span class="token number">865768</span><span class="token punctuation">)</span>
    Section __data<span class="token operator">:</span> <span class="token number">0x604</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000d6888</span> offset <span class="token number">878728</span><span class="token punctuation">)</span>
    Section __bss<span class="token operator">:</span> <span class="token number">0x158</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000d6e90</span> offset <span class="token number">0</span><span class="token punctuation">)</span>
    total <span class="token number">0x2efe4</span>
Segment __LINKEDIT<span class="token operator">:</span> <span class="token number">0xae000</span> <span class="token punctuation">(</span>vmaddr <span class="token number">0x1000d7000</span> fileoff <span class="token number">880640</span><span class="token punctuation">)</span>
total <span class="token number">0x100185000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>可以看到 __objc 前缀的都是为了支持 Objective-C 语言新增加的。</p>
<p>那么 Swift 语言代码构建的 Mach-O 是怎样的呢？</p>
<p>使用我做启动优化时用 Swift 写的工具 <a target="_blank" rel="noopener" href="https://github.com/ming1016/MethodTraceAnalyze">MethodTraceAnalyze</a> 看下内容有什么。结果如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Segment __PAGEZERO<span class="token operator">:</span> <span class="token number">0x100000000</span> <span class="token punctuation">(</span>vmaddr <span class="token number">0x0</span> fileoff <span class="token number">0</span><span class="token punctuation">)</span>
Segment __TEXT<span class="token operator">:</span> <span class="token number">0x115000</span> <span class="token punctuation">(</span>vmaddr <span class="token number">0x100000000</span> fileoff <span class="token number">0</span><span class="token punctuation">)</span>
    Section __text<span class="token operator">:</span> <span class="token number">0xfd540</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000019b0</span> offset <span class="token number">6576</span><span class="token punctuation">)</span>
    Section __stubs<span class="token operator">:</span> <span class="token number">0x6f6</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000feef0</span> offset <span class="token number">1044208</span><span class="token punctuation">)</span>
    Section __stub_helper<span class="token operator">:</span> <span class="token number">0xbaa</span> <span class="token punctuation">(</span>addr <span class="token number">0x1000ff5e8</span> offset <span class="token number">1045992</span><span class="token punctuation">)</span>
    Section __swift5_typeref<span class="token operator">:</span> <span class="token number">0xf56</span> <span class="token punctuation">(</span>addr <span class="token number">0x100100192</span> offset <span class="token number">1048978</span><span class="token punctuation">)</span>
    Section __swift5_capture<span class="token operator">:</span> <span class="token number">0x3b4</span> <span class="token punctuation">(</span>addr <span class="token number">0x1001010e8</span> offset <span class="token number">1052904</span><span class="token punctuation">)</span>
    Section __cstring<span class="token operator">:</span> <span class="token number">0x7011</span> <span class="token punctuation">(</span>addr <span class="token number">0x1001014a0</span> offset <span class="token number">1053856</span><span class="token punctuation">)</span>
    Section __const<span class="token operator">:</span> <span class="token number">0x4754</span> <span class="token punctuation">(</span>addr <span class="token number">0x1001084c0</span> offset <span class="token number">1082560</span><span class="token punctuation">)</span>
    Section __swift5_fieldmd<span class="token operator">:</span> <span class="token number">0x2bf4</span> <span class="token punctuation">(</span>addr <span class="token number">0x10010cc14</span> offset <span class="token number">1100820</span><span class="token punctuation">)</span>
    Section __swift5_types<span class="token operator">:</span> <span class="token number">0x1f0</span> <span class="token punctuation">(</span>addr <span class="token number">0x10010f808</span> offset <span class="token number">1112072</span><span class="token punctuation">)</span>
    Section __swift5_builtin<span class="token operator">:</span> <span class="token number">0x78</span> <span class="token punctuation">(</span>addr <span class="token number">0x10010f9f8</span> offset <span class="token number">1112568</span><span class="token punctuation">)</span>
    Section __swift5_reflstr<span class="token operator">:</span> <span class="token number">0x2740</span> <span class="token punctuation">(</span>addr <span class="token number">0x10010fa70</span> offset <span class="token number">1112688</span><span class="token punctuation">)</span>
    Section __swift5_proto<span class="token operator">:</span> <span class="token number">0x154</span> <span class="token punctuation">(</span>addr <span class="token number">0x1001121b0</span> offset <span class="token number">1122736</span><span class="token punctuation">)</span>
    Section __swift5_assocty<span class="token operator">:</span> <span class="token number">0x120</span> <span class="token punctuation">(</span>addr <span class="token number">0x100112304</span> offset <span class="token number">1123076</span><span class="token punctuation">)</span>
    Section __objc_methname<span class="token operator">:</span> <span class="token number">0x7a5</span> <span class="token punctuation">(</span>addr <span class="token number">0x100112424</span> offset <span class="token number">1123364</span><span class="token punctuation">)</span>
    Section __swift5_protos<span class="token operator">:</span> <span class="token number">0x8</span> <span class="token punctuation">(</span>addr <span class="token number">0x100112bcc</span> offset <span class="token number">1125324</span><span class="token punctuation">)</span>
    Section __unwind_info<span class="token operator">:</span> <span class="token number">0x1c70</span> <span class="token punctuation">(</span>addr <span class="token number">0x100112bd4</span> offset <span class="token number">1125332</span><span class="token punctuation">)</span>
    Section __eh_frame<span class="token operator">:</span> <span class="token number">0x7b0</span> <span class="token punctuation">(</span>addr <span class="token number">0x100114848</span> offset <span class="token number">1132616</span><span class="token punctuation">)</span>
    total <span class="token number">0x11362c</span>
Segment __DATA_CONST<span class="token operator">:</span> <span class="token number">0x4000</span> <span class="token punctuation">(</span>vmaddr <span class="token number">0x100115000</span> fileoff <span class="token number">1134592</span><span class="token punctuation">)</span>
    Section __got<span class="token operator">:</span> <span class="token number">0x4a8</span> <span class="token punctuation">(</span>addr <span class="token number">0x100115000</span> offset <span class="token number">1134592</span><span class="token punctuation">)</span>
    Section __const<span class="token operator">:</span> <span class="token number">0x32f8</span> <span class="token punctuation">(</span>addr <span class="token number">0x1001154a8</span> offset <span class="token number">1135784</span><span class="token punctuation">)</span>
    Section __objc_classlist<span class="token operator">:</span> <span class="token number">0xd0</span> <span class="token punctuation">(</span>addr <span class="token number">0x1001187a0</span> offset <span class="token number">1148832</span><span class="token punctuation">)</span>
    Section __objc_protolist<span class="token operator">:</span> <span class="token number">0x10</span> <span class="token punctuation">(</span>addr <span class="token number">0x100118870</span> offset <span class="token number">1149040</span><span class="token punctuation">)</span>
    Section __objc_imageinfo<span class="token operator">:</span> <span class="token number">0x8</span> <span class="token punctuation">(</span>addr <span class="token number">0x100118880</span> offset <span class="token number">1149056</span><span class="token punctuation">)</span>
    total <span class="token number">0x3888</span>
Segment __DATA<span class="token operator">:</span> <span class="token number">0x8000</span> <span class="token punctuation">(</span>vmaddr <span class="token number">0x100119000</span> fileoff <span class="token number">1150976</span><span class="token punctuation">)</span>
    Section __la_symbol_ptr<span class="token operator">:</span> <span class="token number">0x948</span> <span class="token punctuation">(</span>addr <span class="token number">0x100119000</span> offset <span class="token number">1150976</span><span class="token punctuation">)</span>
    Section __objc_const<span class="token operator">:</span> <span class="token number">0x2018</span> <span class="token punctuation">(</span>addr <span class="token number">0x100119948</span> offset <span class="token number">1153352</span><span class="token punctuation">)</span>
    Section __objc_selrefs<span class="token operator">:</span> <span class="token number">0xb0</span> <span class="token punctuation">(</span>addr <span class="token number">0x10011b960</span> offset <span class="token number">1161568</span><span class="token punctuation">)</span>
    Section __objc_protorefs<span class="token operator">:</span> <span class="token number">0x10</span> <span class="token punctuation">(</span>addr <span class="token number">0x10011ba10</span> offset <span class="token number">1161744</span><span class="token punctuation">)</span>
    Section __objc_classrefs<span class="token operator">:</span> <span class="token number">0x38</span> <span class="token punctuation">(</span>addr <span class="token number">0x10011ba20</span> offset <span class="token number">1161760</span><span class="token punctuation">)</span>
    Section __objc_data<span class="token operator">:</span> <span class="token number">0x98</span> <span class="token punctuation">(</span>addr <span class="token number">0x10011ba58</span> offset <span class="token number">1161816</span><span class="token punctuation">)</span>
    Section __data<span class="token operator">:</span> <span class="token number">0x1f88</span> <span class="token punctuation">(</span>addr <span class="token number">0x10011baf0</span> offset <span class="token number">1161968</span><span class="token punctuation">)</span>
    Section __bss<span class="token operator">:</span> <span class="token number">0x2a68</span> <span class="token punctuation">(</span>addr <span class="token number">0x10011da80</span> offset <span class="token number">0</span><span class="token punctuation">)</span>
    Section __common<span class="token operator">:</span> <span class="token number">0x50</span> <span class="token punctuation">(</span>addr <span class="token number">0x1001204e8</span> offset <span class="token number">0</span><span class="token punctuation">)</span>
    total <span class="token number">0x7530</span>
Segment __LINKEDIT<span class="token operator">:</span> <span class="token number">0x152000</span> <span class="token punctuation">(</span>vmaddr <span class="token number">0x100121000</span> fileoff <span class="token number">1171456</span><span class="token punctuation">)</span>
total <span class="token number">0x100273000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>可以看到 __DATA Segment 部分还是有 __objc 前缀的 Section，__TEXT Segment 里已经都是 __swift5 为前缀的 Section 了。</p>
<p>使用 otool 可以查看某个 Section 内容。比如查看 __TEXT Segment 的 __text Section 的内容，使用如下命令：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">xcrun otool <span class="token operator">-</span>s __TEXT __text a<span class="token punctuation">.</span>out<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>使用 otool 可以直接看 Mach-O 汇编内容 ：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">xcrun otool <span class="token operator">-</span>v <span class="token operator">-</span>t a<span class="token punctuation">.</span>out<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>结果如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">a<span class="token punctuation">.</span>out<span class="token operator">:</span>
<span class="token punctuation">(</span>__TEXT<span class="token punctuation">,</span>__text<span class="token punctuation">)</span> section
_main<span class="token operator">:</span>
<span class="token number">0000000100000f</span><span class="token number">50</span>    pushq   <span class="token operator">%</span>rbp
<span class="token number">0000000100000f</span><span class="token number">51</span>    movq    <span class="token operator">%</span>rsp<span class="token punctuation">,</span> <span class="token operator">%</span>rbp
<span class="token number">0000000100000f</span><span class="token number">54</span>    subq    $<span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsp
<span class="token number">0000000100000f</span><span class="token number">58</span>    movl    $<span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0x4</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
<span class="token number">0000000100000f</span><span class="token number">5f</span>    movl    <span class="token operator">%</span>edi<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
<span class="token number">0000000100000f</span><span class="token number">62</span>    movq    <span class="token operator">%</span>rsi<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
<span class="token number">0000000100000f</span><span class="token number">66</span>    movq    <span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rax
<span class="token number">0000000100000f</span><span class="token number">6</span>a    movq    <span class="token number">0x8</span><span class="token punctuation">(</span><span class="token operator">%</span>rax<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rax
<span class="token number">0000000100000f</span><span class="token number">6</span>e    movq    <span class="token operator">%</span>rax<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0x18</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
<span class="token number">0000000100000f</span><span class="token number">72</span>    movq    <span class="token operator">-</span><span class="token number">0x18</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsi
<span class="token number">0000000100000f</span><span class="token number">76</span>    leaq    <span class="token number">0x35</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdi
<span class="token number">0000000100000f</span><span class="token number">7</span>d    movb    $<span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token operator">%</span>al
<span class="token number">0000000100000f</span><span class="token number">7f</span>    callq   <span class="token number">0x100000f92</span>
<span class="token number">0000000100000f</span><span class="token number">84</span>    xorl    <span class="token operator">%</span>ecx<span class="token punctuation">,</span> <span class="token operator">%</span>ecx
<span class="token number">0000000100000f</span><span class="token number">86</span>    movl    <span class="token operator">%</span>eax<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0x1c</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
<span class="token number">0000000100000f</span><span class="token number">89</span>    movl    <span class="token operator">%</span>ecx<span class="token punctuation">,</span> <span class="token operator">%</span>eax
<span class="token number">0000000100000f</span><span class="token number">8</span>b    addq    $<span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsp
<span class="token number">0000000100000f</span><span class="token number">8f</span>    popq    <span class="token operator">%</span>rbp
<span class="token number">0000000100000f</span><span class="token number">90</span>    retq<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>构建中查看代码生成汇编可以使用 clang 以下选项：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">xcrun clang <span class="token operator">-</span>S <span class="token operator">-</span>o <span class="token operator">-</span> main<span class="token punctuation">.</span>c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p> 生成汇编如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">    <span class="token punctuation">.</span>section    __TEXT<span class="token punctuation">,</span>__text<span class="token punctuation">,</span>regular<span class="token punctuation">,</span>pure_instructions
    <span class="token punctuation">.</span>build_version macos<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span>    sdk_version <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">4</span>
    <span class="token punctuation">.</span>globl  _main                   ## <span class="token operator">--</span> Begin function main
    <span class="token punctuation">.</span>p2align    <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0x90</span>
_main<span class="token operator">:</span>                                  ## @main
    <span class="token punctuation">.</span>cfi_startproc
## <span class="token operator">%</span>bb<span class="token punctuation">.</span><span class="token number">0</span><span class="token operator">:</span>
    pushq   <span class="token operator">%</span>rbp
    <span class="token punctuation">.</span>cfi_def_cfa_offset <span class="token number">16</span>
    <span class="token punctuation">.</span>cfi_offset <span class="token operator">%</span>rbp<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">16</span>
    movq    <span class="token operator">%</span>rsp<span class="token punctuation">,</span> <span class="token operator">%</span>rbp
    <span class="token punctuation">.</span>cfi_def_cfa_register <span class="token operator">%</span>rbp
    subq    $<span class="token number">32</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsp
    movl    $<span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
    movl    <span class="token operator">%</span>edi<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
    movq    <span class="token operator">%</span>rsi<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
    movq    <span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rax
    movq    <span class="token number">8</span><span class="token punctuation">(</span><span class="token operator">%</span>rax<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rax
    movq    <span class="token operator">%</span>rax<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">24</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
    movq    <span class="token operator">-</span><span class="token number">24</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsi
    leaq    L_<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdi
    movb    $<span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">%</span>al
    callq   _printf
    xorl    <span class="token operator">%</span>ecx<span class="token punctuation">,</span> <span class="token operator">%</span>ecx
    movl    <span class="token operator">%</span>eax<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">28</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>         ## <span class="token number">4</span><span class="token operator">-</span>byte Spill
    movl    <span class="token operator">%</span>ecx<span class="token punctuation">,</span> <span class="token operator">%</span>eax
    addq    $<span class="token number">32</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsp
    popq    <span class="token operator">%</span>rbp
    retq
    <span class="token punctuation">.</span>cfi_endproc
                                        ## <span class="token operator">--</span> End function
    <span class="token punctuation">.</span>section    __TEXT<span class="token punctuation">,</span>__cstring<span class="token punctuation">,</span>cstring_literals
L_<span class="token punctuation">.</span>str<span class="token operator">:</span>                                 ## @<span class="token punctuation">.</span>str
    <span class="token punctuation">.</span>asciz  <span class="token string">"%s\n"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>可以发现两者汇编逻辑是一样的。点符号开头的都是汇编指令，比如.section 就是告知会执行哪个 segment，.p2align 指令明确后面代码对齐方式，这里是16(2^4) 字节对齐，0x90 补齐。在 __TEXT Segment 的 <em><em>text Section 里会创建一个调用帧堆栈，进行函数调用，callq printf 函数前会用到 L</em>.str(%rip)，L</em>.str 标签会指向字符串，leaq 会把字符串的指针加载到 rdi 寄存器。最后会销毁调用帧堆栈，进行 retq 返回。</p>
<p>主要 Section：</p>
<ul>
<li>__nl_symbol_ptr：包含 non-lazy 符号指针，mach-o&#x2F;loader.h 里有详细说明。服务 dyld_stub_binder 处理的符号。</li>
<li>__la_symbol_ptr：__stubs 第一个 jump 目标地址。动态库的符号指针地址。</li>
<li>__got：二进制文件的全局偏移表 GOT，也包含 S_NON_LAZY_SYMBOL_POINTERS 标记的 non-lazy 符号指针。服务于 __TEXT Segment 里的符号。可以将__got 看作一个表，里面每项都是一个地址值。__got 的每项在加载期间都会被 dyld 重写，所以会在 __DATA Segment 中。__got 用来存放 non-lazy 符号最终地址，为 dyld 所用。dylib 外部符号对于全局变量和常量引用地址会指到 __got。</li>
<li>__lazy_symbol：包含 lazy 符号，首次使用时绑定。</li>
<li>__stubs：跳转表，重定向到 lazy 和 non-lazy 符号的 section。被标记为 S_SYMBOL_STUBS。__TEXT Segment 里代码和 dylib 外部符号的引用地址对函数符号的引用都指向了 __stubs。其中每项都是 jmp 代码间接寻址，可跳到 __la_symbol_ptr Section 中。</li>
<li>__stub_helper：lazy 动态绑定符号的辅助函数。可跳到 __nl_symbol_ptr Section 中。</li>
<li>__text：机器码，也是实际代码，包含所有功能。</li>
<li>__cstring：常量。只读 C 字符串。</li>
<li>__const：初始化过的常量。</li>
<li>__objc_：Objective-C 语言 runtime 的支持。</li>
<li>__data：初始化过的变量。</li>
<li>__bss：未初始化的静态变量。</li>
<li>__unwind_info：生成异常处理信息。</li>
<li>__eh_frame：DWARF2 unwind 可执行文件代码信息，用于调试。</li>
<li>string table：以空值终止的字符串序列。</li>
<li>symbol table：通过 LC_SYMTAB 命令找到 symbol table，其包含所有用到的符号信息。结构体 nlist_64描述了符号的基本信息。nlist_64 结构体中 n_type 字段是一个8位复合字段，其中bit[0:1]表示是外部符号，bit[5:8]表调试符号，bit[4:5]表示私有 external 符号，bit[1:4]是符号类型，有 N_UNDF 未定义、N_ABS 绝对地址、N_SECT 本地符号、N_PBUD 预绑定符号、N_INDR 同名符号几种类型。</li>
<li>indirect symbol table：每项都是一个 index 值，指向 symbol table 中的项。由 LC_DYSYMTAB 定义，和__nl_symbol_ptr 和 __lazy_symbol 一起为 __stubs 和 __got 等 Section 服务。</li>
</ul>
<p>生成 Section 的代码如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> MachOFileLayout<span class="token operator">::</span><span class="token function">writeSectionContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Section <span class="token operator">&amp;</span>s <span class="token operator">:</span> _file<span class="token punctuation">.</span>sections<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Copy all section content to output buffer.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isZeroFillSection</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> offset <span class="token operator">=</span> _sectInfo<span class="token punctuation">[</span><span class="token operator">&amp;</span>s<span class="token punctuation">]</span><span class="token punctuation">.</span>fileOffset<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token operator">&amp;</span>_buffer<span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">.</span>content<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p <span class="token operator">+=</span> s<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>其中 symble table 生成的代码如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> MachOFileLayout<span class="token operator">::</span><span class="token function">writeSymbolTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Write symbol table and symbol strings in parallel.</span>
  <span class="token class-name">uint32_t</span> symOffset <span class="token operator">=</span> _startOfSymbols<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> strOffset <span class="token operator">=</span> _startOfSymbolStrings<span class="token punctuation">;</span>
  <span class="token comment">// Reserve n_strx offset of zero to mean no name.</span>
  _buffer<span class="token punctuation">[</span>strOffset<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">' '</span><span class="token punctuation">;</span>
  _buffer<span class="token punctuation">[</span>strOffset<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
  <span class="token function">appendSymbols</span><span class="token punctuation">(</span>_file<span class="token punctuation">.</span>stabsSymbols<span class="token punctuation">,</span> symOffset<span class="token punctuation">,</span> strOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">appendSymbols</span><span class="token punctuation">(</span>_file<span class="token punctuation">.</span>localSymbols<span class="token punctuation">,</span> symOffset<span class="token punctuation">,</span> strOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">appendSymbols</span><span class="token punctuation">(</span>_file<span class="token punctuation">.</span>globalSymbols<span class="token punctuation">,</span> symOffset<span class="token punctuation">,</span> strOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">appendSymbols</span><span class="token punctuation">(</span>_file<span class="token punctuation">.</span>undefinedSymbols<span class="token punctuation">,</span> symOffset<span class="token punctuation">,</span> strOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Write indirect symbol table array.</span>
  <span class="token class-name">uint32_t</span> <span class="token operator">*</span>indirects <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">uint32_t</span><span class="token operator">*</span><span class="token operator">></span>
                                            <span class="token punctuation">(</span><span class="token operator">&amp;</span>_buffer<span class="token punctuation">[</span>_startOfIndirectSymbols<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_file<span class="token punctuation">.</span>fileType <span class="token operator">==</span> llvm<span class="token operator">::</span>MachO<span class="token operator">::</span>MH_OBJECT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Object files have sections in same order as input normalized file.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Section <span class="token operator">&amp;</span>section <span class="token operator">:</span> _file<span class="token punctuation">.</span>sections<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> index <span class="token operator">:</span> section<span class="token punctuation">.</span>indirectSymbols<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_swap<span class="token punctuation">)</span>
          <span class="token operator">*</span>indirects<span class="token operator">++</span> <span class="token operator">=</span> llvm<span class="token operator">::</span>sys<span class="token operator">::</span><span class="token function">getSwappedBytes</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
          <span class="token operator">*</span>indirects<span class="token operator">++</span> <span class="token operator">=</span> index<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Final linked images must sort sections from normalized file.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Segment <span class="token operator">&amp;</span>seg <span class="token operator">:</span> _file<span class="token punctuation">.</span>segments<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      SegExtraInfo <span class="token operator">&amp;</span>segInfo <span class="token operator">=</span> _segInfo<span class="token punctuation">[</span><span class="token operator">&amp;</span>seg<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Section <span class="token operator">*</span>section <span class="token operator">:</span> segInfo<span class="token punctuation">.</span>sections<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> index <span class="token operator">:</span> section<span class="token operator">-></span>indirectSymbols<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>_swap<span class="token punctuation">)</span>
            <span class="token operator">*</span>indirects<span class="token operator">++</span> <span class="token operator">=</span> llvm<span class="token operator">::</span>sys<span class="token operator">::</span><span class="token function">getSwappedBytes</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">else</span>
            <span class="token operator">*</span>indirects<span class="token operator">++</span> <span class="token operator">=</span> index<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>获取 Segment 信息的代码如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">segmentWalk</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>segment_command<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token class-name">uint32_t</span> nsects<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>section<span class="token punctuation">;</span>

  section <span class="token operator">=</span> segment_command <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">segment_command</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  nsects <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">segment_command</span> <span class="token operator">*</span><span class="token punctuation">)</span> segment_command<span class="token punctuation">)</span><span class="token operator">-></span>nsects<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>nsects<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    section <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">s_section</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>获取对应符号的方法代码如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 定义参看 &lt;mach-o/nlist.h></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N_UNDF</span>  <span class="token expression"><span class="token number">0x0</span>  </span><span class="token comment">// 未定义</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N_ABS</span> <span class="token expression"><span class="token number">0x2</span>    </span><span class="token comment">// 绝对地址</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N_SECT</span> <span class="token expression"><span class="token number">0xe</span>   </span><span class="token comment">// 本地符号</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N_PBUD</span> <span class="token expression"><span class="token number">0xc</span>   </span><span class="token comment">// 预定义符号</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N_INDR</span> <span class="token expression"><span class="token number">0xa</span>   </span><span class="token comment">// 同名符号</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N_STAB</span> <span class="token expression"><span class="token number">0xe0</span>  </span><span class="token comment">// 调试符号</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N_PEXT</span> <span class="token expression"><span class="token number">0x10</span>  </span><span class="token comment">// 私有 external 符号</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N_TYPE</span> <span class="token expression"><span class="token number">0x0e</span>  </span><span class="token comment">// 类型位的掩码</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N_EXT</span> <span class="token expression"><span class="token number">0x01</span>   </span><span class="token comment">// external 符号</span></span>

<span class="token keyword">char</span> <span class="token function">symbolical</span><span class="token punctuation">(</span>sym<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>N_STAB <span class="token operator">&amp;</span> sym<span class="token operator">-></span>type<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token char">'-'</span><span class="token punctuation">;</span> 
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>N_TYPE <span class="token operator">&amp;</span> sym<span class="token operator">-></span>type<span class="token punctuation">)</span> <span class="token operator">==</span> N_UNDF<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sym<span class="token operator">-></span>name_not_found<span class="token punctuation">)</span>
     <span class="token keyword">return</span> <span class="token char">'C'</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sym<span class="token operator">-></span>type <span class="token operator">&amp;</span> N_EXT<span class="token punctuation">)</span>
     <span class="token keyword">return</span> <span class="token operator">=</span> <span class="token char">'U'</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
     <span class="token keyword">return</span> <span class="token operator">=</span> <span class="token char">'?'</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>N_TYPE <span class="token operator">&amp;</span> sym<span class="token operator">-></span>type<span class="token punctuation">)</span> <span class="token operator">==</span> N_SECT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">matched</span><span class="token punctuation">(</span>saved_sections<span class="token punctuation">,</span> sym<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>N_TYPE <span class="token operator">&amp;</span> sym<span class="token operator">-></span>type<span class="token punctuation">)</span> <span class="token operator">==</span> N_ABS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token operator">=</span> <span class="token char">'A'</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>N_TYPE <span class="token operator">&amp;</span> sym<span class="token operator">-></span>type<span class="token punctuation">)</span> <span class="token operator">==</span> N_INDR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token operator">=</span> <span class="token char">'I'</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">char</span> <span class="token function">matched</span><span class="token punctuation">(</span>saved_sections<span class="token punctuation">,</span> symbol<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sect <span class="token operator">=</span> <span class="token function">find_mysection</span><span class="token punctuation">(</span>saved_sections<span class="token punctuation">,</span> symbol<span class="token operator">-></span>n_sect<span class="token punctuation">)</span><span class="token punctuation">)</span> # 
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ft_strcmp</span><span class="token punctuation">(</span>sect<span class="token operator">-></span>name<span class="token punctuation">,</span> SECT_TEXT<span class="token punctuation">)</span><span class="token punctuation">)</span>
      ret <span class="token operator">=</span> <span class="token char">'T'</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ft_strcmp</span><span class="token punctuation">(</span>sect<span class="token operator">-></span>name<span class="token punctuation">,</span> SECT_DATA<span class="token punctuation">)</span><span class="token punctuation">)</span>
      ret <span class="token operator">=</span> <span class="token char">'D'</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ft_strcmp</span><span class="token punctuation">(</span>sect<span class="token operator">-></span>name<span class="token punctuation">,</span> SECT_BSS<span class="token punctuation">)</span><span class="token punctuation">)</span>
      ret <span class="token operator">=</span> <span class="token char">'B'</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      ret <span class="token operator">=</span> <span class="token char">'S'</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>mysym<span class="token operator">-></span>type <span class="token operator">&amp;</span> N_EXT<span class="token punctuation">)</span><span class="token punctuation">)</span>
       ret <span class="token operator">-=</span> <span class="token char">'A'</span> <span class="token operator">-</span> <span class="token char">'a'</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="加载运行"><a href="#加载运行" class="headerlink" title="加载运行"></a>加载运行</h2><p>程序要和其他库还有模块一起运行，需要在运行时对这些库和模块的符号引用进行解析，运行时，你应用程序使用的模块符号都在共享名称空间。macOS 使用的是两级名称空间来确保不同模块符号名不会冲突，同时增强向前兼容。</p>
<p>选择要加载的 Mach-O 后，系统内核会先确定该文件是否是 Mach-O 文件。</p>
<p>文件的第一个字节是魔数，通过魔数可以推断是不是 Mach-O，mach-o&#x2F;loader.h 里定义了四个魔数标识。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MH_MAGIC</span>    <span class="token expression"><span class="token number">0xfeedface</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MH_CIGAM</span>    <span class="token expression"><span class="token function">NXSwapInt</span><span class="token punctuation">(</span>MH_MAGIC<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MH_MAGIC_64</span> <span class="token expression"><span class="token number">0xfeedfacf</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MH_CIGAM_64</span> <span class="token expression"><span class="token function">NXSwapInt</span><span class="token punctuation">(</span>MH_MAGIC_64<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<p>以上四个魔数标识是 Mach-O 文件。</p>
<p>然后内核系统会用 fork 函数创建一个进程，然后通过 execve 函数开始程序加载过程，execve 有多个种类，比如 execl、execv 等，只是在参数和环境变量上有不同，最终都会到内核的 execve 函数。</p>
<p>接着会检查 Mach-O header，加载 dyld 和程序到 Load Command 指定的地址空间。执行动态链接器。动态链接器通过 dyld_stub_binder 调用，这个函数的参数不直接指定要绑定的符号，而是通过给 dyld_stub_binder 偏移量到 dyld 解释的特殊字节码 Segment 中。dyld_stub_binder 函数的代码在这里：<a target="_blank" rel="noopener" href="https://opensource.apple.com/source/dyld/dyld-635.2/src/dyld_stub_binder.s.auto.html">dyld_stub_binder.s</a>。dyld 分为 rebase、binding、lazy binding、导出几个部分。dyld 可以 hook，使用 DYLD_INSERT_LIBRARIES，类似 ld 的 LD_PRELOAD 还有 DYLD_LIBRARY_PATH。</p>
<p>__text 里需要被 lazy binding 的符号引用，访问时回到 stub 中，目标地址在 __la_symbol_ptr，对应 __la_symbol_ptr 的内容会指向 __stub_helper，其中逻辑会调到 dyld_stub_binder 函数，这个函数会通过 dyld 找到符号的真实地址，最后 dyld_stub_binder 会把得到的地址写入 __la_symbol_ptr 里后，会跳转到符号的真实地址。由于地址已经在 __la_symbol_ptr 里了，所以再访问符号时会通过 stub 的 jum 指令直接跳转到真实地址。</p>
<p>通过 dyld 加载主程序链接到的所有依赖库，执行符号绑定也就是non lazy binding。绑定解析其他模块的功能和数据的引用过程，也叫导入符号。</p>
<h3 id="导入导出符号"><a href="#导入导出符号" class="headerlink" title="导入导出符号"></a>导入导出符号</h3><p>执行绑定时，链接程序会用实际定义的地址替换程序的每个导入引用。通过构建时的选项设置，dyld 可以即时绑定，也叫延迟绑定，首次使用引用时的绑定，在使用符号前不会将程序的引用绑定到共享库的符号。使用 -bind_at_load 可以加载时绑定，动态链接程序在加载程序时立即绑定所有导入的引用，如果没有设置这个选项，默认按即时绑定来。设置 -prebind，程序引用的共享库都会在指定的地址预先绑定。</p>
<p>根据 Code Fragment Manager 设计的弱引用允许程序有选择的绑定到指定的共享库，如果 dyld 找不到弱引用的定义，会设置为 NULL，然后可以继续加载程序。代码上可以写判断，如果引用为空进行相应的处理。</p>
<p>过程链接表 PLT，会在运行时确定函数地址。callq 指令在 dyld_stub 调用 PLT 条目，符号 stub 位于 __TEXT Segment 的 __stubs Section 中。每个 Mach-O 符号 stub 都是一个 jumpq 指令，它会调用 dyld 找到符号，然后执行。</p>
<p>Mach-O 的导入和导出都会存在 __LINKEDIT 里。使用 FSA 接受 Leb128 参数，也就是绑定操作码。LEB 会把整数值编码成可变长度的字节序列，最后一个字节才设置最高有效位。</p>
<p>当 FSA 循环或递归时，会用0xF0对其进行掩码获得操作码，所有导入绑定操作码都会对应有宏名称和对应的功能。比如 0xb0 对应宏是 BIND_OPCODE_DO_BIND_ADD_ADDR_IMM_SCALED，功能是将记录放到导入堆栈中，然后把当前记录的地址偏移量设为 seg_offset &#x3D; seg_offset + (scale * sizeofptr) + sizeofptr ，其中 scale 是立即数中包含的值，sizeofptr 是指针对应平台的大小。</p>
<p>Mach-O 导出符号是 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Trie">trie</a> 的数据结构，trie 节点最多有一个终端字符串信息，如果没有终端信息，就以0x00字节标记。有的化，就用 Leb128 代替该节点的终端字符串信息大小。节点导出信息后，类型信息类型使用0x3对标志进行位掩码获得。0x00表示常规符号，0x01表示线程本地符号，0x02标识绝对符号，0x4表示弱引用符号，0x8表示重新导出，0x10是 stub，具有 Leb128的 stub 偏移量。大部分符号都是常规符号，会将 Mach-O 的偏移量给符号。</p>
<p>生成 trie 数据结构的代码如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> MachOFileLayout<span class="token operator">::</span><span class="token function">buildExportTrie</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_file<span class="token punctuation">.</span>exportInfo<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token comment">// For all temporary strings and objects used building trie.</span>
  BumpPtrAllocator allocator<span class="token punctuation">;</span>

  <span class="token comment">// Build trie of all exported symbols.</span>
  <span class="token keyword">auto</span> <span class="token operator">*</span>rootNode <span class="token operator">=</span> <span class="token function">new</span> <span class="token punctuation">(</span>allocator<span class="token punctuation">)</span> <span class="token function">TrieNode</span><span class="token punctuation">(</span><span class="token function">StringRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>TrieNode<span class="token operator">*</span><span class="token operator">></span> allNodes<span class="token punctuation">;</span>
  allNodes<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>_file<span class="token punctuation">.</span>exportInfo<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  allNodes<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>rootNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Export<span class="token operator">&amp;</span> entry <span class="token operator">:</span> _file<span class="token punctuation">.</span>exportInfo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    rootNode<span class="token operator">-></span><span class="token function">addSymbol</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> allocator<span class="token punctuation">,</span> allNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>TrieNode<span class="token operator">*</span><span class="token operator">></span> orderedNodes<span class="token punctuation">;</span>
  orderedNodes<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>allNodes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Export<span class="token operator">&amp;</span> entry <span class="token operator">:</span> _file<span class="token punctuation">.</span>exportInfo<span class="token punctuation">)</span>
    rootNode<span class="token operator">-></span><span class="token function">addOrderedNodes</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> orderedNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Assign each node in the vector an offset in the trie stream, iterating</span>
  <span class="token comment">// until all uleb128 sizes have stabilized.</span>
  bool more<span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">uint32_t</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    more <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>TrieNode<span class="token operator">*</span> node <span class="token operator">:</span> orderedNodes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token operator">-></span><span class="token function">updateOffset</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">)</span>
        more <span class="token operator">=</span> true<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>more<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Serialize trie to ByteBuffer.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>TrieNode<span class="token operator">*</span> node <span class="token operator">:</span> orderedNodes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    node<span class="token operator">-></span><span class="token function">appendToByteBuffer</span><span class="token punctuation">(</span>_exportTrie<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  _exportTrie<span class="token punctuation">.</span><span class="token function">align</span><span class="token punctuation">(</span>_is64 <span class="token operator">?</span> <span class="token number">8</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Trie 也叫数字树或前缀树，是一种搜索树。查找复杂度 O(m)，m 是字符串的长度。和散列表相比，散列最差复杂度是 O(N)，一般都是 O(1)，用 O(m)时间评估 hash。散列缺点是会分配一大块内存，内容越多所占内存越大。Trie 不仅查找快，插入和删除都很快，适合存储预测性文本或自动完成词典。为了进一步优化所占空间，可以将 Trie 这种树形的确定性有限自动机压缩成确定性非循环有限状态自动体（DAFSA），其空间小，做法是会压缩相同分支。对于更大内容，还可以做更进一步的优化，比如使用字母缩减的实现技术，把原来的字符串重新解释为较长的字符串；使用单链式列表，节点设计为由符号、子节点、下一个节点来表示；将字母表数组存储为代表 ASCII 字母表的256位的位图。</p>
<p>对于动态库，有几个易于理解的公共符号比导出所有符号更易于使用，让公共符号集少，私有符号集丰富，维护起来更加方便。更新时也不会影响较早版本。导出最少数量的符号，还能够优化动态加载程序到进程的时间，动态库导出符号越少，dyld 加载就越快。</p>
<p>静态存储类是表明不想导出符号的最简单的方法。将可见性属性放置在实现文件中的符号定义里，设置符号可见性也能够更精确的控制哪些符号是公共符号还是私有符号。在编译选项 -fvisbility 可以指定未指定可见性符号的可见性。使用 -weak_library 选项会告诉编译器将库里所有导出符号都设为弱链接符号。使用 nm 的 -gm 选项可以查看 Mach-O 导出的符号：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">nm <span class="token operator">-</span>gm header<span class="token punctuation">.</span>dylib<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>结果如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">(</span>undefined<span class="token punctuation">)</span> external <span class="token function">___cxa_atexit</span> <span class="token punctuation">(</span>from libSystem<span class="token punctuation">)</span>
<span class="token punctuation">(</span>undefined<span class="token punctuation">)</span> external <span class="token function">_printf</span> <span class="token punctuation">(</span>from libSystem<span class="token punctuation">)</span>
<span class="token punctuation">(</span>undefined<span class="token punctuation">)</span> external <span class="token function">dyld_stub_binder</span> <span class="token punctuation">(</span>from libSystem<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


<p>另外可以通过导出的符号文件，列出要导出的符号来控制导出符号数量，其他符号都会被隐藏。导出符号文件 list 如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">_foo
_header<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<p>使用 -exported_symbols_list 选项编译就可以仅导出文件中指定的符号：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">clang <span class="token operator">-</span>dynamiclib header<span class="token punctuation">.</span>c <span class="token operator">-</span>exported_symbols_list list <span class="token operator">-</span>o header<span class="token punctuation">.</span>dylib<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<h3 id="符号绑定范围"><a href="#符号绑定范围" class="headerlink" title="符号绑定范围"></a>符号绑定范围</h3><p>符号可能存在与多个作用域级别。未定义的外部符号是在当前文件之外的文件中，如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">extern</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<p>私有定义符号，其他模块不可见</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>私有外部符号可以使用 __private_extern__关键字：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">__private_extern__ <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>指定一个函数为弱引用，可以使用 weak_import 属性：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>weak_import<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>在符号声明中添加 weak 属性来指定将符号设置为合并的弱引用：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>weak<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<h3 id="入口点"><a href="#入口点" class="headerlink" title="入口点"></a>入口点</h3><p>符号绑定结果放到 LC_DYSYMTAB 指定的 section，解析后的地址会放到 __DATA segment 的 __nl_symbol_ptr 和 __got 里。dyld 使用 Load Command 指定 Mach-O 中的数据以各种方式链接依赖项。Mach-O 的 Segment 按照 Load Command 中指定映射到内存中。 初始化后，会调用 LC_MAIN 指定的入口点，这个点是 __TEXT Segment 的 __text Section 的开始。使用 __stubs 将 __la_symbol_ptr 指向 __stub_helpers，dyld_stub_binder 执行解析，然后更新 __la_symbol_ptr 的地址。</p>
<p>Mach-O 和链接器之间是通过 assembly trampoline 进行的桥接，Mach-O 接口的 ABI 和 ELF 相同，但策略不同。macOS 在调用 dyld 前后都会保存和恢复 SSE 寄存器。</p>
<h3 id="动态库构造函数和析构函数"><a href="#动态库构造函数和析构函数" class="headerlink" title="动态库构造函数和析构函数"></a>动态库构造函数和析构函数</h3><p>动态库加载可能需要执行特殊的初始化或者需要做些准备工作，这里可以使用初始化函数也就是构造函数。结束的时候可以加析构函数。</p>
<p>举个例子，先定义一个 header.c，在里面加上构造函数和析构函数：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token string">"prepare"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>destructor<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token string">"end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">showHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token string">"header"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>将 header.c 构建成一个动态库 header.dylib。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">xcrun clang <span class="token operator">-</span>dynamiclib header<span class="token punctuation">.</span>c <span class="token operator">-</span>fvisibility<span class="token operator">=</span>hidden <span class="token operator">-</span>o header<span class="token punctuation">.</span>dylib<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>将 header.dylib 和 main.c 构建成一个中间目标文件 main.o。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">xcrun clang main<span class="token punctuation">.</span>c header<span class="token punctuation">.</span>dylib <span class="token operator">-</span>o main<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>运行看结果</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">ming@mingdeMacBook<span class="token operator">-</span>Pro macho_demo <span class="token operator">%</span> <span class="token punctuation">.</span><span class="token operator">/</span>main <span class="token string">"hi"</span>
prepare
hi
end<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<p>可以看到，动态库的构造函数 prepare 和析构函数 end 都执行了。</p>

  </div>
  <div>
  
  <div class="post-note note-warning copyright" style="margin-top: 42px">
    <p><span style="font-weight: bold;">作者：</span><a target="_blank" rel="nofollow noopener noreferrer" href="https://starming.com/about">戴铭</a></p>
    <p><span style="font-weight: bold;">文章链接：</span><a target="_blank" rel="nofollow noopener noreferrer" href="https://starming.com/2020/03/29/apple-system-executable-file-macho/">https://starming.com/2020/03/29/apple-system-executable-file-macho/</a></p>
    <p><span style="font-weight: bold;">版权声明：</span>本博客所有文章除特别声明外，均采用<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0 协议</a>。转载请注明出处！</p>
  </div>
  
  </div>
</article>
<div class="nav">
  
  <div class="nav-item-prev">
    <a href="/2020/04/12/why_write_study_ios_programming_with_daiming_book_and_draw_recently/" class="nav-link">
      <i class="iconfont icon-left nav-prev-icon"></i>
      <div>
        <div class="nav-label">Prev</div>
        
        <div class="nav-title">我为什么写了《跟戴铭学iOS编程》这本书 </div>
        
      </div>
    </a>
  </div>
  
  
  <div class="nav-item-next">
    <a href="/2020/01/05/kuaishou-unused-class-swiftui-note-binary-tree-interview/" class="nav-link">
      <div>
        <div class="nav-label">Next</div>
        
        <div class="nav-title">在快手做分享、无用类检查、在广州做 SwiftUI 学习笔记分享、InfoQ二叉树视频 </div>
        
      </div>
      <i class="iconfont icon-right nav-next-icon"></i>
    </a>
  </div>
  
</div>

<div class="card card-content toc-card" id="mobiletoc">
  <div class="toc-header"><i class="iconfont icon-menu" style="padding-right: 2px;"></i>TOC</div>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">构建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E6%88%90"><span class="toc-number">3.</span> <span class="toc-text">组成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Header"><span class="toc-number">3.1.</span> <span class="toc-text">Header</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Load-Command"><span class="toc-number">3.2.</span> <span class="toc-text">Load Command</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Data"><span class="toc-number">3.3.</span> <span class="toc-text">Data</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E8%BF%90%E8%A1%8C"><span class="toc-number">4.</span> <span class="toc-text">加载运行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA%E7%AC%A6%E5%8F%B7"><span class="toc-number">4.1.</span> <span class="toc-text">导入导出符号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E7%BB%91%E5%AE%9A%E8%8C%83%E5%9B%B4"><span class="toc-number">4.2.</span> <span class="toc-text">符号绑定范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E5%8F%A3%E7%82%B9"><span class="toc-number">4.3.</span> <span class="toc-text">入口点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%BA%93%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E5%92%8C%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0"><span class="toc-number">4.4.</span> <span class="toc-text">动态库构造函数和析构函数</span></a></li></ol></li></ol>
</div></main>
          <aside class="left-column">
            
            <div class="card card-author">
              
<img src="/img/ming.jpeg" class="author-img">

<p class="author-name">戴铭</p>
<p class="author-description">极客时间《iOS开发高手课》和纸书《跟戴铭学iOS编程》作者</p>
<div class="author-message">
  <a class="author-posts-count" href="/archives">
    <span>80</span>
    <span>Posts</span>
  </a>
  <a class="author-categories-count" href="/categories">
    <span>9</span>
    <span>Categories</span>
  </a>
  <a class="author-tags-count" href="/tags">
    <span>45</span>
    <span>Tags</span>
  </a>
</div>

<div class="author-card-society">
  
    <div class="author-card-society-icon">
      <a target="_blank" rel="noopener" href="https://weibo.com/allstarming">
        <i class="iconfont icon-sina society-icon"></i>
      </a>
    </div>
  
    <div class="author-card-society-icon">
      <a target="_blank" rel="noopener" href="https://github.com/ming1016">
        <i class="iconfont icon-github society-icon"></i>
      </a>
    </div>
  
    <div class="author-card-society-icon">
      <a href="mailto:ming1016@foxmail.com">
        <i class="iconfont icon-mail society-icon"></i>
      </a>
    </div>
  
    <div class="author-card-society-icon">
      <a href="/atom.xml">
        <i class="iconfont icon-chrome society-icon"></i>
      </a>
    </div>
  
</div>

            </div>
            
            <div class="sticky-tablet">
  
  
  <article class="display-when-two-columns spacer">
    <div class="card card-content toc-card">
      <div class="toc-header"><i class="iconfont icon-menu" style="padding-right: 2px;"></i>TOC</div>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">构建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E6%88%90"><span class="toc-number">3.</span> <span class="toc-text">组成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Header"><span class="toc-number">3.1.</span> <span class="toc-text">Header</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Load-Command"><span class="toc-number">3.2.</span> <span class="toc-text">Load Command</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Data"><span class="toc-number">3.3.</span> <span class="toc-text">Data</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E8%BF%90%E8%A1%8C"><span class="toc-number">4.</span> <span class="toc-text">加载运行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA%E7%AC%A6%E5%8F%B7"><span class="toc-number">4.1.</span> <span class="toc-text">导入导出符号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E7%BB%91%E5%AE%9A%E8%8C%83%E5%9B%B4"><span class="toc-number">4.2.</span> <span class="toc-text">符号绑定范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E5%8F%A3%E7%82%B9"><span class="toc-number">4.3.</span> <span class="toc-text">入口点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%BA%93%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E5%92%8C%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0"><span class="toc-number">4.4.</span> <span class="toc-text">动态库构造函数和析构函数</span></a></li></ol></li></ol>
    </div>
  </article>
  
  
  <article class="card card-content">
    <div class="categories-card">
  <div class="categories-header"><i class="iconfont icon-fenlei" style="padding-right: 2px;"></i>Categories</div>
  <div class="categories-list">
    
      <a href="/categories/Programming">
        <div class="categories-list-item">
          Programming
          <span class="categories-list-item-badge">50</span>
        </div>
      </a>
    
      <a href="/categories/My-novel">
        <div class="categories-list-item">
          My-novel
          <span class="categories-list-item-badge">4</span>
        </div>
      </a>
    
      <a href="/categories/My-painting">
        <div class="categories-list-item">
          My-painting
          <span class="categories-list-item-badge">8</span>
        </div>
      </a>
    
      <a href="/categories/Podcast">
        <div class="categories-list-item">
          Podcast
          <span class="categories-list-item-badge">3</span>
        </div>
      </a>
    
      <a href="/categories/App">
        <div class="categories-list-item">
          App
          <span class="categories-list-item-badge">11</span>
        </div>
      </a>
    
      <a href="/categories/travel">
        <div class="categories-list-item">
          travel
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/AI">
        <div class="categories-list-item">
          AI
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/macOS">
        <div class="categories-list-item">
          macOS
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/Game">
        <div class="categories-list-item">
          Game
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
  </div>
</div>
  </article>
  
  <article class="card card-content">
    <div class="tags-card">
  <div class="tags-header"><i class="iconfont icon-biaoqian" style="padding-right: 2px;"></i>hot tags</div>
  <div class="tags-list">
    
    <a href="\tags\iOS" title="iOS"><div class="tags-list-item">iOS</div></a>
    
    <a href="\tags\Swift" title="Swift"><div class="tags-list-item">Swift</div></a>
    
    <a href="\tags\Apple" title="Apple"><div class="tags-list-item">Apple</div></a>
    
    <a href="\tags\SwiftUI" title="SwiftUI"><div class="tags-list-item">SwiftUI</div></a>
    
    <a href="\tags\Painting" title="Painting"><div class="tags-list-item">Painting</div></a>
    
    <a href="\tags\Slides" title="Slides"><div class="tags-list-item">Slides</div></a>
    
    <a href="\tags\App" title="App"><div class="tags-list-item">App</div></a>
    
    <a href="\tags\iPad" title="iPad"><div class="tags-list-item">iPad</div></a>
    
    <a href="\tags\Procreate" title="Procreate"><div class="tags-list-item">Procreate</div></a>
    
    <a href="\tags\LLVM" title="LLVM"><div class="tags-list-item">LLVM</div></a>
    
    <a href="\tags\Performance optimization" title="Performance optimization"><div class="tags-list-item">Performance optimization</div></a>
    
    <a href="\tags\Web" title="Web"><div class="tags-list-item">Web</div></a>
    
    <a href="\tags\Novel" title="Novel"><div class="tags-list-item">Novel</div></a>
    
    <a href="\tags\Manga" title="Manga"><div class="tags-list-item">Manga</div></a>
    
    <a href="\tags\Podcast" title="Podcast"><div class="tags-list-item">Podcast</div></a>
    
    <a href="\tags\macOS" title="macOS"><div class="tags-list-item">macOS</div></a>
    
  </div>
</div>
  </article>
  
  
</div>
          </aside>
          <aside class="right-column">
            <div class="sticky-widescreen">
  
  
  <article class="card card-content toc-card">
    <div class="toc-header"><i class="iconfont icon-menu" style="padding-right: 2px;"></i>TOC</div>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">构建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E6%88%90"><span class="toc-number">3.</span> <span class="toc-text">组成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Header"><span class="toc-number">3.1.</span> <span class="toc-text">Header</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Load-Command"><span class="toc-number">3.2.</span> <span class="toc-text">Load Command</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Data"><span class="toc-number">3.3.</span> <span class="toc-text">Data</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E8%BF%90%E8%A1%8C"><span class="toc-number">4.</span> <span class="toc-text">加载运行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA%E7%AC%A6%E5%8F%B7"><span class="toc-number">4.1.</span> <span class="toc-text">导入导出符号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E7%BB%91%E5%AE%9A%E8%8C%83%E5%9B%B4"><span class="toc-number">4.2.</span> <span class="toc-text">符号绑定范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E5%8F%A3%E7%82%B9"><span class="toc-number">4.3.</span> <span class="toc-text">入口点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%BA%93%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E5%92%8C%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0"><span class="toc-number">4.4.</span> <span class="toc-text">动态库构造函数和析构函数</span></a></li></ol></li></ol>
  </article>
  
  
  <article class="card card-content">
    <div class="recent-posts-card">
  <div class="recent-posts-header"><i class="iconfont icon-wenzhang_huaban" style="padding-right: 2px;"></i>Recent Posts</div>
  <div class="recent-posts-list">
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2025-05-23</div>
        <a href="/2025/05/23/in-depth-analysis-pokemon-universe/"><div class="recent-posts-item-content">宝可梦宇宙全揭秘：从皮卡丘到千种精灵，入门玩法、进化对战与全球现象深度解析</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2025-05-05</div>
        <a href="/2025/05/05/pamphlet-app667/"><div class="recent-posts-item-content">憋了个大招！《戴铭的小册子》6.6.7 版：不止搞开发，这次玩儿大了！</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2025-03-06</div>
        <a href="/2025/03/06/letsvision25-ai-improve-ios-skill/"><div class="recent-posts-item-content">使用 AI 突破 iOS 开发者能力边界</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2025-02-18</div>
        <a href="/2025/02/18/macos-app-i-used/"><div class="recent-posts-item-content">2025 年我正在使用的 macOS 应用</div></a>
      </div>
    
  </div>
</div>
  </article>
  
  
</div>
          </aside>
        </div>
      </div>
    </div>
  </div>
  
  <footer class="footer">
  <div class="footer-container">
    <div>
      <div class="footer-dsc">
        <span>Copyright ©
          
          2014 -
          
          2025
        </span>
        <a href="/" class="footer-link">戴铭的博客 </a>
      </div>
    </div>

    
    
    
    <div class="BbeiAn-info">
      <a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">京ICP备2024068292号-1 </a>
    </div>
    
    <div class="BbeiAn-info">
      <span style="padding-left: 25px;background: url(/img/beian.png) no-repeat left center"></span>
      <a target="_blank" rel="noopener" href="https://beian.mps.gov.cn/#/query/webSearch?code=11010802044427 ">京公网安备11010802044427
      </a>
      <br />
    </div>
    
    
    
      <div class="footer-dsc">
        
        本站总访问量<span id="busuanzi_value_site_pv"></span>次
        
        
        <span>&nbsp;|&nbsp;</span>
        
        
        本站总访客数<span id="busuanzi_value_site_uv"></span>次
        
      </div>
      
    
</footer>
  <a role="button" id="scrollbutton" class="basebutton" >
  <i class="iconfont icon-arrowleft button-icon"></i>
</a>
<a role="button" id="menubutton" class="basebutton">
  <i class="iconfont icon-menu button-icon"></i>
</a>
<a role="button" id="popbutton" class="basebutton">
  <i class="iconfont icon-expand button-icon"></i>
</a>
<a role="button" id="darkbutton" class="basebutton darkwidget">
  <i class="iconfont icon-weather button-icon"></i>
</a>

  
  
  
  <script>
  var addImgLayout = function () {
    var img = document.querySelectorAll('.post-content img');
    var i;
    for (i = 0; i < img.length; i++) {
      var wrapper = document.createElement('a');
      wrapper.setAttribute('data-fslightbox', 'gallery');
      wrapper.setAttribute('href', img[i].getAttribute('data-src'));
      wrapper.setAttribute('style', 'width: 100%; display: flex; justify-content: center;');
      img[i].parentElement.insertBefore(wrapper, img[i]);
      wrapper.appendChild(img[i]);
    }
    refreshFsLightbox();
  }
</script>
<script>loadScript("//cdn.jsdelivr.net/npm/fslightbox@3.1.0/index.min.js", addImgLayout)</script>
  
  
  
<script src="/js/main.js"></script>

  
  <script>loadScript("/js/lib/busuanzi.min.js")</script>
  
  
  <script>
    var addLazyload = function () {
      var observer = lozad('.lozad', {
        load: function (el) {
          el.srcset = el.getAttribute('data-src');
        },
        loaded: function (el) {
          el.classList.add('loaded');
        }
      });
      observer.observe();
    }
  </script>
  <script>loadScript("/js/lib/lozad.min.js", addLazyload)</script>
  
  
</body>

</html>