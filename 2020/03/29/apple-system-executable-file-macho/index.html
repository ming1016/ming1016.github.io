<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="iOS,Apple,Mach-O," />





  <link rel="alternate" href="/atom.xml" title="星光社 - 戴铭的博客" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/uploads/logo.png?v=5.1.1" />






<meta name="description" content="介绍Mach-O 的全称是 Mach Object File Format。可以是可执行文件，目标代码或共享库，动态库。Mach 内核的操作系统比如 macOS，iPadOS 和 iOS 都是用的 Mach-O。Mach-O 包含程序的核心逻辑，以及入口点主要功能。 通过学习 Mach-O，可以了解应用程序是如何加载到系统的，如何执行的。还能了解符号查找，函数调用堆栈符号化等。更重要的是能够了解如">
<meta name="keywords" content="iOS,Apple,Mach-O">
<meta property="og:type" content="article">
<meta property="og:title" content="Apple 操作系统可执行文件 Mach-O">
<meta property="og:url" content="http://ming1016.github.io/2020/03/29/apple-system-executable-file-macho/index.html">
<meta property="og:site_name" content="星光社 - 戴铭的博客">
<meta property="og:description" content="介绍Mach-O 的全称是 Mach Object File Format。可以是可执行文件，目标代码或共享库，动态库。Mach 内核的操作系统比如 macOS，iPadOS 和 iOS 都是用的 Mach-O。Mach-O 包含程序的核心逻辑，以及入口点主要功能。 通过学习 Mach-O，可以了解应用程序是如何加载到系统的，如何执行的。还能了解符号查找，函数调用堆栈符号化等。更重要的是能够了解如">
<meta property="og:updated_time" content="2020-03-29T08:15:48.226Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Apple 操作系统可执行文件 Mach-O">
<meta name="twitter:description" content="介绍Mach-O 的全称是 Mach Object File Format。可以是可执行文件，目标代码或共享库，动态库。Mach 内核的操作系统比如 macOS，iPadOS 和 iOS 都是用的 Mach-O。Mach-O 包含程序的核心逻辑，以及入口点主要功能。 通过学习 Mach-O，可以了解应用程序是如何加载到系统的，如何执行的。还能了解符号查找，函数调用堆栈符号化等。更重要的是能够了解如">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://ming1016.github.io/2020/03/29/apple-system-executable-file-macho/"/>





  <title>Apple 操作系统可执行文件 Mach-O | 星光社 - 戴铭的博客</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">星光社 - 戴铭的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ming1016.github.io/2020/03/29/apple-system-executable-file-macho/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="戴铭">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/251980?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="星光社 - 戴铭的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Apple 操作系统可执行文件 Mach-O</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-29T16:13:45+08:00">
                2020-03-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Programming/" itemprop="url" rel="index">
                    <span itemprop="name">Programming</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Mach-O 的全称是 Mach Object File Format。可以是可执行文件，目标代码或共享库，动态库。Mach 内核的操作系统比如 macOS，iPadOS 和 iOS 都是用的 Mach-O。Mach-O 包含程序的核心逻辑，以及入口点主要功能。</p>
<p>通过学习 Mach-O，可以了解应用程序是如何加载到系统的，如何执行的。还能了解符号查找，函数调用堆栈符号化等。更重要的是能够了解如何设计数据结构，这对于日后开发生涯的收益是长期的。了解这些对于了解编译和逆向工程都会有帮助，你还会了解到动态链接器的内部工作原理以及字节码格式的信息，Leb128字节流，Mach 导出时 Trie 二进制 image 压缩。</p>
<p>对于 Mach-O，你一定不陌生，但是对于它内部逻辑你一定会好奇，比如它是怎么构建出来的，组织方式如何，怎么加载的，如何工作，谁让它工作的，怎样导入和导出符号的。</p>
<p>接下来我们先看看怎么构建一个 Mach-O 文件的吧。</p>
<h2 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h2><p>构建 Mach-O 文件，主要需要用到编译器和静态链接器，编译器可以将编写的高级语言代码转成中间目标文件，然后用静态链接器把中间目标文件组合成 Mach-O。</p>
<p>编译器驱动程序使用的是 clang，有编译、组装和链接的能力，调用 Xcode Tools 里的其他工具来实现源码到 Mach-O 文件生成。其他工具包括将汇编代码创建为中间目标文件的 as 汇编程序，组合中间目标文件成 Mach-O 文件的静态链接器 ld，还有创建静态库或共享库的 libtool。</p>
<p>构建成 Mach-O 包括中间对象文件、动态共享库、框架、静态库、Bundle、内核扩展这几种类型。其中框架会包含共享库和图片、文档、接口等相关资源。</p>
<p>写个 main.c 文件代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123; </div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name = argv[<span class="number">1</span>];</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, name);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过 clang 构建成 Mach-O 文件 a.out。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xcrun clang main.c</div></pre></td></tr></table></figure>
<p>如果有多个文件，先将多个文件生成中间目标文件，后缀是.o，使用 clang 的选项 -c。每个目标文件都是模块。使用静态链接器可以把多个模块组合成一个动态共享库。通过 ld 可以完成这个操作。使用 libtool 的选项 -static 可以构建静态库。</p>
<p>组合成动态库可以使用 clang 的 -dynamiclib 选项，命令如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xcrun clang -dynamiclib command.c header.c -fvisibility=hidden -o mac.dylib</div></pre></td></tr></table></figure>
<p>静态链接就是把各个模块组合成一个整体，生成新的 Mach-O，链接的内容就是把各个模块间相互的引用能够正确的链接好，原理就是把一些指令对其他符号的地址引用进行修正。过程包含地址和空间分配，符号解析和围绕符号进行的重定位。核心是重定位，X86-64寻址方式是 RIP-relative 寻址，就是基于 RIP 来计算目标地址，通过 jumpq 跳转目标地址，就是当前指令下一条指令地址来加偏移量。</p>
<p>构建完 Mach-O。那你一定好奇 Mach-O 里面都有什么呢？分析 Mach-O 的工具有分析体系结构的 lipo，显式文件类型的 file，列 Data 内容的 otool，分析 image 每个逻辑信息符号的 pagestuff，符号表显示的 nm。</p>
<h2 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h2><p>Mach-O 会将数据流分组，每组都会有自己的意义，主要分三大部分，分别是 Mach Header、Load Command、Data。</p>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>Mach Header 里会有 Mach-O 的 CPU 信息，以及 Load Command 的信息。可以使用 otool 查看内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">otool -v -h a.out</div></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Mach header</div><div class="line">      magic cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags</div><div class="line">MH_MAGIC_64  X86_64        ALL  <span class="number">0x00</span>     EXECUTE    <span class="number">16</span>       <span class="number">1368</span>   NOUNDEFS DYLDLINK TWOLEVEL PIE</div></pre></td></tr></table></figure>
<p>通过 _dyld_get_image_header 函数可以获取 mach_header 结构体。<a href="https://github.com/ming1016/GCDFetchFeed/blob/master/GCDFetchFeed/GCDFetchFeed/Lib/SMLagMonitor/SMCallStack.m" target="_blank" rel="external">GCDFetchFeed/SMCallStack.m at master · ming1016/GCDFetchFeed · GitHub</a> 里这段代码里有判断 Mach Header 结构体魔数的函数 smCmdFirstPointerFromMachHeader，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">uintptr_t</span> smCmdFirstPointerFromMachHeader(<span class="keyword">const</span> struct mach_header* <span class="keyword">const</span> machHeader) &#123;</div><div class="line">    <span class="keyword">switch</span> (machHeader-&gt;magic) &#123;</div><div class="line">        <span class="keyword">case</span> MH_MAGIC:</div><div class="line">        <span class="keyword">case</span> MH_CIGAM:</div><div class="line">        <span class="keyword">case</span> MH_MAGIC_64:</div><div class="line">        <span class="keyword">case</span> MH_CIGAM_64:</div><div class="line">            <span class="keyword">return</span> (<span class="keyword">uintptr_t</span>)(((machHeaderByCPU*)machHeader) + <span class="number">1</span>);</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// Header 不合法</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>还有 Fat Header，里面会包含多个架构的 Header。</p>
<p>LLVM 中生成 Mach Header 的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> MachOFileLayout::writeMachHeader() &#123;</div><div class="line">  <span class="keyword">auto</span> cpusubtype = MachOLinkingContext::cpuSubtypeFromArch(_file.arch);</div><div class="line">  <span class="comment">// dynamic x86 executables on newer OS version should also set the</span></div><div class="line">  <span class="comment">// CPU_SUBTYPE_LIB64 mask in the CPU subtype.</span></div><div class="line">  <span class="comment">// <span class="doctag">FIXME:</span> Check that this is a dynamic executable, not a static one.</span></div><div class="line">  <span class="keyword">if</span> (_file.fileType == llvm::MachO::MH_EXECUTE &amp;&amp;</div><div class="line">      cpusubtype == CPU_SUBTYPE_X86_64_ALL &amp;&amp;</div><div class="line">      _file.os == MachOLinkingContext::OS::macOSX) &#123;</div><div class="line">    <span class="keyword">uint32_t</span> version;</div><div class="line">    <span class="keyword">bool</span> failed = MachOLinkingContext::parsePackedVersion(<span class="string">"10.5"</span>, version);</div><div class="line">    <span class="keyword">if</span> (!failed &amp;&amp; _file.minOSverson &gt;= version)</div><div class="line">      cpusubtype |= CPU_SUBTYPE_LIB64;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  mach_header *mh = <span class="keyword">reinterpret_cast</span>&lt;mach_header*&gt;(_buffer);</div><div class="line">  mh-&gt;magic = _is64 ? llvm::MachO::MH_MAGIC_64 : llvm::MachO::MH_MAGIC;</div><div class="line">  mh-&gt;cputype =  MachOLinkingContext::cpuTypeFromArch(_file.arch);</div><div class="line">  mh-&gt;cpusubtype = cpusubtype;</div><div class="line">  mh-&gt;filetype = _file.fileType;</div><div class="line">  mh-&gt;ncmds = _countOfLoadCommands;</div><div class="line">  mh-&gt;sizeofcmds = _endOfLoadCommands - _startOfLoadCommands;</div><div class="line">  mh-&gt;flags = _file.flags;</div><div class="line">  <span class="keyword">if</span> (_swap)</div><div class="line">    swapStruct(*mh);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Load-Command"><a href="#Load-Command" class="headerlink" title="Load Command"></a>Load Command</h3><p>Load Command 包含 Mach-O 里命令类型信息，名称和二进制文件的位置。</p>
<p>使用 otool 命令可以查看详细：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">otool -v -l a.out</div></pre></td></tr></table></figure>
<p>遍历 Mach Header 里的 ncmds 可以取到所有 Load Command。代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">uint32_t</span> iCmd = <span class="number">0</span>; iCmd &lt; machHeader-&gt;ncmds; iCmd++) &#123;</div><div class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">load_command</span>* <span class="title">loadCmd</span> = (<span class="title">struct</span> <span class="title">load_command</span>*)<span class="title">cmdPointer</span>;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>load<em>command 里的 cmd 是以 LC</em> 开头定义的宏，可以参看 loader.h 里的定义，有50多个，主要的是：</p>
<ul>
<li>LC_SEGMENT_64(_PAGEZERO)</li>
<li>LC_SEGMENT_64(_TEXT)</li>
<li>LC_SEGMENT_64(_DATA)</li>
<li>LC_SEGMENT_64(_LINKEDIT)</li>
<li>LC_DYLD_INFO_ONLY</li>
<li>LC_SYMTAB</li>
<li>LC_DYSYMTAB</li>
<li>LC_LOAD_DYLINKER</li>
<li>LC_UUID</li>
<li>LC_BUILD_VERSION</li>
<li>LC_SOURCE_VERSION</li>
<li>LC_MAIN</li>
<li>LC_LOAD_DYLIB(libSystem.B.dylib)</li>
<li>LC_FUNCTION_STARTS</li>
<li>LC_DATA_IN_CODE</li>
</ul>
<p>每个 command 的结构都是独立的，前两个字段 cmd 和 cmdsize 是一样的。</p>
<p>根据 Load Command 可以得到 Segment 的偏移量。</p>
<p>生成 Load Command 的代码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div></pre></td><td class="code"><pre><div class="line">llvm::Error MachOFileLayout::writeLoadCommands() &#123;</div><div class="line">  <span class="keyword">uint8_t</span> *lc = &amp;_buffer[_startOfLoadCommands];</div><div class="line">  <span class="keyword">if</span> (_file.fileType == llvm::MachO::MH_OBJECT) &#123;</div><div class="line">    <span class="comment">// Object files have one unnamed segment which holds all sections.</span></div><div class="line">    <span class="keyword">if</span> (_is64) &#123;</div><div class="line">     <span class="keyword">if</span> (<span class="keyword">auto</span> ec = writeSingleSegmentLoadCommand&lt;MachO64Trait&gt;(lc))</div><div class="line">       <span class="keyword">return</span> ec;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">auto</span> ec = writeSingleSegmentLoadCommand&lt;MachO32Trait&gt;(lc))</div><div class="line">        <span class="keyword">return</span> ec;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Add LC_SYMTAB with symbol table info</span></div><div class="line">    symtab_command* st = <span class="keyword">reinterpret_cast</span>&lt;symtab_command*&gt;(lc);</div><div class="line">    st-&gt;cmd     = LC_SYMTAB;</div><div class="line">    st-&gt;cmdsize = <span class="keyword">sizeof</span>(symtab_command);</div><div class="line">    st-&gt;symoff  = _startOfSymbols;</div><div class="line">    st-&gt;nsyms   = _file.stabsSymbols.size() + _file.localSymbols.size() +</div><div class="line">                  _file.globalSymbols.size() + _file.undefinedSymbols.size();</div><div class="line">    st-&gt;stroff  = _startOfSymbolStrings;</div><div class="line">    st-&gt;strsize = _endOfSymbolStrings - _startOfSymbolStrings;</div><div class="line">    <span class="keyword">if</span> (_swap)</div><div class="line">      swapStruct(*st);</div><div class="line">    lc += <span class="keyword">sizeof</span>(symtab_command);</div><div class="line"></div><div class="line">    <span class="comment">// Add LC_VERSION_MIN_MACOSX, LC_VERSION_MIN_IPHONEOS,</span></div><div class="line">    <span class="comment">// LC_VERSION_MIN_WATCHOS, LC_VERSION_MIN_TVOS</span></div><div class="line">    writeVersionMinLoadCommand(_file, _swap, lc);</div><div class="line"></div><div class="line">    <span class="comment">// Add LC_FUNCTION_STARTS if needed.</span></div><div class="line">    <span class="keyword">if</span> (_functionStartsSize != <span class="number">0</span>) &#123;</div><div class="line">      linkedit_data_command* dl = <span class="keyword">reinterpret_cast</span>&lt;linkedit_data_command*&gt;(lc);</div><div class="line">      dl-&gt;cmd      = LC_FUNCTION_STARTS;</div><div class="line">      dl-&gt;cmdsize  = <span class="keyword">sizeof</span>(linkedit_data_command);</div><div class="line">      dl-&gt;dataoff  = _startOfFunctionStarts;</div><div class="line">      dl-&gt;datasize = _functionStartsSize;</div><div class="line">      <span class="keyword">if</span> (_swap)</div><div class="line">        swapStruct(*dl);</div><div class="line">      lc += <span class="keyword">sizeof</span>(linkedit_data_command);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Add LC_DATA_IN_CODE if requested.</span></div><div class="line">    <span class="keyword">if</span> (_file.generateDataInCodeLoadCommand) &#123;</div><div class="line">      linkedit_data_command* dl = <span class="keyword">reinterpret_cast</span>&lt;linkedit_data_command*&gt;(lc);</div><div class="line">      dl-&gt;cmd      = LC_DATA_IN_CODE;</div><div class="line">      dl-&gt;cmdsize  = <span class="keyword">sizeof</span>(linkedit_data_command);</div><div class="line">      dl-&gt;dataoff  = _startOfDataInCode;</div><div class="line">      dl-&gt;datasize = _dataInCodeSize;</div><div class="line">      <span class="keyword">if</span> (_swap)</div><div class="line">        swapStruct(*dl);</div><div class="line">      lc += <span class="keyword">sizeof</span>(linkedit_data_command);</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// Final linked images have sections under segments.</span></div><div class="line">    <span class="keyword">if</span> (_is64) &#123;</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">auto</span> ec = writeSegmentLoadCommands&lt;MachO64Trait&gt;(lc))</div><div class="line">        <span class="keyword">return</span> ec;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">auto</span> ec = writeSegmentLoadCommands&lt;MachO32Trait&gt;(lc))</div><div class="line">        <span class="keyword">return</span> ec;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Add LC_ID_DYLIB command for dynamic libraries.</span></div><div class="line">    <span class="keyword">if</span> (_file.fileType == llvm::MachO::MH_DYLIB) &#123;</div><div class="line">      dylib_command *dc = <span class="keyword">reinterpret_cast</span>&lt;dylib_command*&gt;(lc);</div><div class="line">      StringRef path = _file.installName;</div><div class="line">      <span class="keyword">uint32_t</span> size = <span class="keyword">sizeof</span>(dylib_command) + pointerAlign(path.size() + <span class="number">1</span>);</div><div class="line">      dc-&gt;cmd                         = LC_ID_DYLIB;</div><div class="line">      dc-&gt;cmdsize                     = size;</div><div class="line">      dc-&gt;dylib.name                  = <span class="keyword">sizeof</span>(dylib_command); <span class="comment">// offset</span></div><div class="line">      <span class="comment">// needs to be some constant value different than the one in LC_LOAD_DYLIB</span></div><div class="line">      dc-&gt;dylib.timestamp             = <span class="number">1</span>;</div><div class="line">      dc-&gt;dylib.current_version       = _file.currentVersion;</div><div class="line">      dc-&gt;dylib.compatibility_version = _file.compatVersion;</div><div class="line">      <span class="keyword">if</span> (_swap)</div><div class="line">        swapStruct(*dc);</div><div class="line">      <span class="built_in">memcpy</span>(lc + <span class="keyword">sizeof</span>(dylib_command), path.begin(), path.size());</div><div class="line">      lc[<span class="keyword">sizeof</span>(dylib_command) + path.size()] = <span class="string">'\0'</span>;</div><div class="line">      lc += size;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Add LC_DYLD_INFO_ONLY.</span></div><div class="line">    dyld_info_command* di = <span class="keyword">reinterpret_cast</span>&lt;dyld_info_command*&gt;(lc);</div><div class="line">    di-&gt;cmd            = LC_DYLD_INFO_ONLY;</div><div class="line">    di-&gt;cmdsize        = <span class="keyword">sizeof</span>(dyld_info_command);</div><div class="line">    di-&gt;rebase_off     = _rebaseInfo.size() ? _startOfRebaseInfo : <span class="number">0</span>;</div><div class="line">    di-&gt;rebase_size    = _rebaseInfo.size();</div><div class="line">    di-&gt;bind_off       = _bindingInfo.size() ? _startOfBindingInfo : <span class="number">0</span>;</div><div class="line">    di-&gt;bind_size      = _bindingInfo.size();</div><div class="line">    di-&gt;weak_bind_off  = <span class="number">0</span>;</div><div class="line">    di-&gt;weak_bind_size = <span class="number">0</span>;</div><div class="line">    di-&gt;lazy_bind_off  = _lazyBindingInfo.size() ? _startOfLazyBindingInfo : <span class="number">0</span>;</div><div class="line">    di-&gt;lazy_bind_size = _lazyBindingInfo.size();</div><div class="line">    di-&gt;export_off     = _exportTrie.size() ? _startOfExportTrie : <span class="number">0</span>;</div><div class="line">    di-&gt;export_size    = _exportTrie.size();</div><div class="line">    <span class="keyword">if</span> (_swap)</div><div class="line">      swapStruct(*di);</div><div class="line">    lc += <span class="keyword">sizeof</span>(dyld_info_command);</div><div class="line"></div><div class="line">    <span class="comment">// Add LC_SYMTAB with symbol table info.</span></div><div class="line">    symtab_command* st = <span class="keyword">reinterpret_cast</span>&lt;symtab_command*&gt;(lc);</div><div class="line">    st-&gt;cmd     = LC_SYMTAB;</div><div class="line">    st-&gt;cmdsize = <span class="keyword">sizeof</span>(symtab_command);</div><div class="line">    st-&gt;symoff  = _startOfSymbols;</div><div class="line">    st-&gt;nsyms   = _file.stabsSymbols.size() + _file.localSymbols.size() +</div><div class="line">                  _file.globalSymbols.size() + _file.undefinedSymbols.size();</div><div class="line">    st-&gt;stroff  = _startOfSymbolStrings;</div><div class="line">    st-&gt;strsize = _endOfSymbolStrings - _startOfSymbolStrings;</div><div class="line">    <span class="keyword">if</span> (_swap)</div><div class="line">      swapStruct(*st);</div><div class="line">    lc += <span class="keyword">sizeof</span>(symtab_command);</div><div class="line"></div><div class="line">    <span class="comment">// Add LC_DYSYMTAB</span></div><div class="line">    <span class="keyword">if</span> (_file.fileType != llvm::MachO::MH_PRELOAD) &#123;</div><div class="line">      dysymtab_command* dst = <span class="keyword">reinterpret_cast</span>&lt;dysymtab_command*&gt;(lc);</div><div class="line">      dst-&gt;cmd            = LC_DYSYMTAB;</div><div class="line">      dst-&gt;cmdsize        = <span class="keyword">sizeof</span>(dysymtab_command);</div><div class="line">      dst-&gt;ilocalsym      = _symbolTableLocalsStartIndex;</div><div class="line">      dst-&gt;nlocalsym      = _file.stabsSymbols.size() +</div><div class="line">                            _file.localSymbols.size();</div><div class="line">      dst-&gt;iextdefsym     = _symbolTableGlobalsStartIndex;</div><div class="line">      dst-&gt;nextdefsym     = _file.globalSymbols.size();</div><div class="line">      dst-&gt;iundefsym      = _symbolTableUndefinesStartIndex;</div><div class="line">      dst-&gt;nundefsym      = _file.undefinedSymbols.size();</div><div class="line">      dst-&gt;tocoff         = <span class="number">0</span>;</div><div class="line">      dst-&gt;ntoc           = <span class="number">0</span>;</div><div class="line">      dst-&gt;modtaboff      = <span class="number">0</span>;</div><div class="line">      dst-&gt;nmodtab        = <span class="number">0</span>;</div><div class="line">      dst-&gt;extrefsymoff   = <span class="number">0</span>;</div><div class="line">      dst-&gt;nextrefsyms    = <span class="number">0</span>;</div><div class="line">      dst-&gt;indirectsymoff = _startOfIndirectSymbols;</div><div class="line">      dst-&gt;nindirectsyms  = _indirectSymbolTableCount;</div><div class="line">      dst-&gt;extreloff      = <span class="number">0</span>;</div><div class="line">      dst-&gt;nextrel        = <span class="number">0</span>;</div><div class="line">      dst-&gt;locreloff      = <span class="number">0</span>;</div><div class="line">      dst-&gt;nlocrel        = <span class="number">0</span>;</div><div class="line">      <span class="keyword">if</span> (_swap)</div><div class="line">        swapStruct(*dst);</div><div class="line">      lc += <span class="keyword">sizeof</span>(dysymtab_command);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// If main executable, add LC_LOAD_DYLINKER</span></div><div class="line">    <span class="keyword">if</span> (_file.fileType == llvm::MachO::MH_EXECUTE) &#123;</div><div class="line">      <span class="comment">// Build LC_LOAD_DYLINKER load command.</span></div><div class="line">      <span class="keyword">uint32_t</span> size=pointerAlign(<span class="keyword">sizeof</span>(dylinker_command)+dyldPath().size()+<span class="number">1</span>);</div><div class="line">      dylinker_command* dl = <span class="keyword">reinterpret_cast</span>&lt;dylinker_command*&gt;(lc);</div><div class="line">      dl-&gt;cmd              = LC_LOAD_DYLINKER;</div><div class="line">      dl-&gt;cmdsize          = size;</div><div class="line">      dl-&gt;name             = <span class="keyword">sizeof</span>(dylinker_command); <span class="comment">// offset</span></div><div class="line">      <span class="keyword">if</span> (_swap)</div><div class="line">        swapStruct(*dl);</div><div class="line">      <span class="built_in">memcpy</span>(lc+<span class="keyword">sizeof</span>(dylinker_command), dyldPath().data(), dyldPath().size());</div><div class="line">      lc[<span class="keyword">sizeof</span>(dylinker_command)+dyldPath().size()] = <span class="string">'\0'</span>;</div><div class="line">      lc += size;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Add LC_VERSION_MIN_MACOSX, LC_VERSION_MIN_IPHONEOS, LC_VERSION_MIN_WATCHOS,</span></div><div class="line">    <span class="comment">// LC_VERSION_MIN_TVOS</span></div><div class="line">    writeVersionMinLoadCommand(_file, _swap, lc);</div><div class="line"></div><div class="line">    <span class="comment">// Add LC_SOURCE_VERSION</span></div><div class="line">    &#123;</div><div class="line">      <span class="comment">// Note, using a temporary here to appease UB as we may not be aligned</span></div><div class="line">      <span class="comment">// enough for a struct containing a uint64_t when emitting a 32-bit binary</span></div><div class="line">      source_version_command sv;</div><div class="line">      sv.cmd       = LC_SOURCE_VERSION;</div><div class="line">      sv.cmdsize   = <span class="keyword">sizeof</span>(source_version_command);</div><div class="line">      sv.version   = _file.sourceVersion;</div><div class="line">      <span class="keyword">if</span> (_swap)</div><div class="line">        swapStruct(sv);</div><div class="line">      <span class="built_in">memcpy</span>(lc, &amp;sv, <span class="keyword">sizeof</span>(source_version_command));</div><div class="line">      lc += <span class="keyword">sizeof</span>(source_version_command);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// If main executable, add LC_MAIN.</span></div><div class="line">    <span class="keyword">if</span> (_file.fileType == llvm::MachO::MH_EXECUTE) &#123;</div><div class="line">      <span class="comment">// Build LC_MAIN load command.</span></div><div class="line">      <span class="comment">// Note, using a temporary here to appease UB as we may not be aligned</span></div><div class="line">      <span class="comment">// enough for a struct containing a uint64_t when emitting a 32-bit binary</span></div><div class="line">      entry_point_command ep;</div><div class="line">      ep.cmd       = LC_MAIN;</div><div class="line">      ep.cmdsize   = <span class="keyword">sizeof</span>(entry_point_command);</div><div class="line">      ep.entryoff  = _file.entryAddress - _seg1addr;</div><div class="line">      ep.stacksize = _file.stackSize;</div><div class="line">      <span class="keyword">if</span> (_swap)</div><div class="line">        swapStruct(ep);</div><div class="line">      <span class="built_in">memcpy</span>(lc, &amp;ep, <span class="keyword">sizeof</span>(entry_point_command));</div><div class="line">      lc += <span class="keyword">sizeof</span>(entry_point_command);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Add LC_LOAD_DYLIB commands</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> DependentDylib &amp;dep : _file.dependentDylibs) &#123;</div><div class="line">      dylib_command* dc = <span class="keyword">reinterpret_cast</span>&lt;dylib_command*&gt;(lc);</div><div class="line">      <span class="keyword">uint32_t</span> size = <span class="keyword">sizeof</span>(dylib_command) + pointerAlign(dep.path.size()+<span class="number">1</span>);</div><div class="line">      dc-&gt;cmd                         = dep.kind;</div><div class="line">      dc-&gt;cmdsize                     = size;</div><div class="line">      dc-&gt;dylib.name                  = <span class="keyword">sizeof</span>(dylib_command); <span class="comment">// offset</span></div><div class="line">      <span class="comment">// needs to be some constant value different than the one in LC_ID_DYLIB</span></div><div class="line">      dc-&gt;dylib.timestamp             = <span class="number">2</span>;</div><div class="line">      dc-&gt;dylib.current_version       = dep.currentVersion;</div><div class="line">      dc-&gt;dylib.compatibility_version = dep.compatVersion;</div><div class="line">      <span class="keyword">if</span> (_swap)</div><div class="line">        swapStruct(*dc);</div><div class="line">      <span class="built_in">memcpy</span>(lc+<span class="keyword">sizeof</span>(dylib_command), dep.path.begin(), dep.path.size());</div><div class="line">      lc[<span class="keyword">sizeof</span>(dylib_command)+dep.path.size()] = <span class="string">'\0'</span>;</div><div class="line">      lc += size;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Add LC_RPATH</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> StringRef &amp;path : _file.rpaths) &#123;</div><div class="line">      rpath_command *rpc = <span class="keyword">reinterpret_cast</span>&lt;rpath_command *&gt;(lc);</div><div class="line">      <span class="keyword">uint32_t</span> size = pointerAlign(<span class="keyword">sizeof</span>(rpath_command) + path.size() + <span class="number">1</span>);</div><div class="line">      rpc-&gt;cmd                         = LC_RPATH;</div><div class="line">      rpc-&gt;cmdsize                     = size;</div><div class="line">      rpc-&gt;path                        = <span class="keyword">sizeof</span>(rpath_command); <span class="comment">// offset</span></div><div class="line">      <span class="keyword">if</span> (_swap)</div><div class="line">        swapStruct(*rpc);</div><div class="line">      <span class="built_in">memcpy</span>(lc+<span class="keyword">sizeof</span>(rpath_command), path.begin(), path.size());</div><div class="line">      lc[<span class="keyword">sizeof</span>(rpath_command)+path.size()] = <span class="string">'\0'</span>;</div><div class="line">      lc += size;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Add LC_FUNCTION_STARTS if needed.</span></div><div class="line">    <span class="keyword">if</span> (_functionStartsSize != <span class="number">0</span>) &#123;</div><div class="line">      linkedit_data_command* dl = <span class="keyword">reinterpret_cast</span>&lt;linkedit_data_command*&gt;(lc);</div><div class="line">      dl-&gt;cmd      = LC_FUNCTION_STARTS;</div><div class="line">      dl-&gt;cmdsize  = <span class="keyword">sizeof</span>(linkedit_data_command);</div><div class="line">      dl-&gt;dataoff  = _startOfFunctionStarts;</div><div class="line">      dl-&gt;datasize = _functionStartsSize;</div><div class="line">      <span class="keyword">if</span> (_swap)</div><div class="line">        swapStruct(*dl);</div><div class="line">      lc += <span class="keyword">sizeof</span>(linkedit_data_command);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Add LC_DATA_IN_CODE if requested.</span></div><div class="line">    <span class="keyword">if</span> (_file.generateDataInCodeLoadCommand) &#123;</div><div class="line">      linkedit_data_command* dl = <span class="keyword">reinterpret_cast</span>&lt;linkedit_data_command*&gt;(lc);</div><div class="line">      dl-&gt;cmd      = LC_DATA_IN_CODE;</div><div class="line">      dl-&gt;cmdsize  = <span class="keyword">sizeof</span>(linkedit_data_command);</div><div class="line">      dl-&gt;dataoff  = _startOfDataInCode;</div><div class="line">      dl-&gt;datasize = _dataInCodeSize;</div><div class="line">      <span class="keyword">if</span> (_swap)</div><div class="line">        swapStruct(*dl);</div><div class="line">      lc += <span class="keyword">sizeof</span>(linkedit_data_command);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> llvm::Error::success();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Data"><a href="#Data" class="headerlink" title="Data"></a>Data</h3><p>Data 由 Segment 的数据组成，是 Mach-O 占比最多的部分，有代码有数据，比如符号表。Data 共三个 Segment，<strong>TEXT、</strong>DATA、<strong>LINKEDIT。其中 </strong>TEXT 和 <strong>DATA 对应一个或多个 Section，</strong>LINKEDIT 没有 Section，需要配合 LC_SYMTAB 来解析 symbol table 和 string table。这些里面是 Mach-O 的主要数据。</p>
<p>生成 __LINKEDIT 的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> MachOFileLayout::buildLinkEditInfo() &#123;</div><div class="line">  buildRebaseInfo();</div><div class="line">  buildBindInfo();</div><div class="line">  buildLazyBindInfo();</div><div class="line">  buildExportTrie();</div><div class="line">  computeSymbolTableSizes();</div><div class="line">  computeFunctionStartsSize();</div><div class="line">  computeDataInCodeSize();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> MachOFileLayout::writeLinkEditContent() &#123;</div><div class="line">  <span class="keyword">if</span> (_file.fileType == llvm::MachO::MH_OBJECT) &#123;</div><div class="line">    writeRelocations();</div><div class="line">    writeFunctionStartsInfo();</div><div class="line">    writeDataInCodeInfo();</div><div class="line">    writeSymbolTable();</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    writeRebaseInfo();</div><div class="line">    writeBindingInfo();</div><div class="line">    writeLazyBindingInfo();</div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> add weak binding info</span></div><div class="line">    writeExportInfo();</div><div class="line">    writeFunctionStartsInfo();</div><div class="line">    writeDataInCodeInfo();</div><div class="line">    writeSymbolTable();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过生成 <strong>LINKEDIT 的代码可以看出 </strong>LINKEDIT 里包含 dyld 所需各种数据，比如符号表、间接符号表、rebase 操作码、绑定操作码、导出符号、函数启动信息、数据表、代码签名等。</p>
<p>__DATA 包含 lazy 和 non lazy 符号指针，还会包含静态数据和全局变量等。可重定位的 Mach-O 文件还会有一个重定位的区域用来存储重定位信息，如果哪个 section 有重定位字节，就会有一个 relocation table 对应。</p>
<p>生成 relocation 的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> MachOFileLayout::writeRelocations() &#123;</div><div class="line">  <span class="keyword">uint32_t</span> relOffset = _startOfRelocations;</div><div class="line">  <span class="keyword">for</span> (Section sect : _file.sections) &#123;</div><div class="line">    <span class="keyword">for</span> (Relocation r : sect.relocations) &#123;</div><div class="line">      any_relocation_info* rb = <span class="keyword">reinterpret_cast</span>&lt;any_relocation_info*&gt;(</div><div class="line">                                                           &amp;_buffer[relOffset]);</div><div class="line">      *rb = packRelocation(r, _swap, _bigEndianArch);</div><div class="line">      relOffset += <span class="keyword">sizeof</span>(any_relocation_info);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用 size 命令可以看到内容的分布，使用前面生成的 a.out 来看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xcrun size -x -l -m a.out</div></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Segment __PAGEZERO: <span class="number">0x100000000</span> (vmaddr <span class="number">0x0</span> fileoff <span class="number">0</span>)</div><div class="line">Segment __TEXT: <span class="number">0x1000</span> (vmaddr <span class="number">0x100000000</span> fileoff <span class="number">0</span>)</div><div class="line">    Section __text: <span class="number">0x41</span> (addr <span class="number">0x100000f50</span> offset <span class="number">3920</span>)</div><div class="line">    Section __stubs: <span class="number">0x6</span> (addr <span class="number">0x100000f92</span> offset <span class="number">3986</span>)</div><div class="line">    Section __stub_helper: <span class="number">0x1a</span> (addr <span class="number">0x100000f98</span> offset <span class="number">3992</span>)</div><div class="line">    Section __cstring: <span class="number">0x4</span> (addr <span class="number">0x100000fb2</span> offset <span class="number">4018</span>)</div><div class="line">    Section __unwind_info: <span class="number">0x48</span> (addr <span class="number">0x100000fb8</span> offset <span class="number">4024</span>)</div><div class="line">    total <span class="number">0xad</span></div><div class="line">Segment __DATA_CONST: <span class="number">0x1000</span> (vmaddr <span class="number">0x100001000</span> fileoff <span class="number">4096</span>)</div><div class="line">    Section __got: <span class="number">0x8</span> (addr <span class="number">0x100001000</span> offset <span class="number">4096</span>)</div><div class="line">    total <span class="number">0x8</span></div><div class="line">Segment __DATA: <span class="number">0x1000</span> (vmaddr <span class="number">0x100002000</span> fileoff <span class="number">8192</span>)</div><div class="line">    Section __la_symbol_ptr: <span class="number">0x8</span> (addr <span class="number">0x100002000</span> offset <span class="number">8192</span>)</div><div class="line">    Section __data: <span class="number">0x8</span> (addr <span class="number">0x100002008</span> offset <span class="number">8200</span>)</div><div class="line">    total <span class="number">0x10</span></div><div class="line">Segment __LINKEDIT: <span class="number">0x1000</span> (vmaddr <span class="number">0x100003000</span> fileoff <span class="number">12288</span>)</div><div class="line">total <span class="number">0x100004000</span></div></pre></td></tr></table></figure>
<p>其中__TEXT Segment 的内容有：</p>
<ul>
<li>Section64(<strong>TEXT,</strong>text)</li>
<li>Section64(<strong>TEXT,</strong>stubs)</li>
<li>Section64(<strong>TEXT,</strong>stub_helper)</li>
<li>Section64(<strong>TEXT,</strong>cstring)</li>
<li>Section64(<strong>TEXT,</strong>unwind_info)</li>
</ul>
<p>__DATA Segment 的内容有：</p>
<ul>
<li>Section64(<strong>DATA,</strong>nl_symbol_ptr)</li>
<li>Section64(<strong>DATA,</strong>la_symbol_ptr)</li>
</ul>
<p>__LINKEDIT 的内容是：</p>
<ul>
<li>Dynamic Loader Info</li>
<li>Function Starts</li>
<li>Symbol Table</li>
<li>Data in Code Entries</li>
<li>Dynamic Symbol Table</li>
<li>String Table</li>
</ul>
<p>如果是 Objective-C 代码生成的 Mach-O 会多出很多和 Objective-C 相关的 Section ，我拿<a href="https://github.com/ming1016/GCDFetchFeed" target="_blank" rel="external">已阅</a>项目生成的 Mach-O 来看。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xcrun size -x -l -m GCDFetchFeed</div></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">Segment __PAGEZERO: <span class="number">0x100000000</span> (vmaddr <span class="number">0x0</span> fileoff <span class="number">0</span>)</div><div class="line">Segment __TEXT: <span class="number">0xa8000</span> (vmaddr <span class="number">0x100000000</span> fileoff <span class="number">0</span>)</div><div class="line">    Section __text: <span class="number">0x89084</span> (addr <span class="number">0x1000020e0</span> offset <span class="number">8416</span>)</div><div class="line">    Section __stubs: <span class="number">0x588</span> (addr <span class="number">0x10008b164</span> offset <span class="number">569700</span>)</div><div class="line">    Section __stub_helper: <span class="number">0x948</span> (addr <span class="number">0x10008b6ec</span> offset <span class="number">571116</span>)</div><div class="line">    Section __gcc_except_tab: <span class="number">0x1318</span> (addr <span class="number">0x10008c034</span> offset <span class="number">573492</span>)</div><div class="line">    Section __cstring: <span class="number">0xbebd</span> (addr <span class="number">0x10008d34c</span> offset <span class="number">578380</span>)</div><div class="line">    Section __objc_methname: <span class="number">0xa20f</span> (addr <span class="number">0x100099209</span> offset <span class="number">627209</span>)</div><div class="line">    Section __objc_classname: <span class="number">0x11d9</span> (addr <span class="number">0x1000a3418</span> offset <span class="number">668696</span>)</div><div class="line">    Section __objc_methtype: <span class="number">0x2185</span> (addr <span class="number">0x1000a45f1</span> offset <span class="number">673265</span>)</div><div class="line">    Section __const: <span class="number">0x23c</span> (addr <span class="number">0x1000a6780</span> offset <span class="number">681856</span>)</div><div class="line">    Section __ustring: <span class="number">0x23e</span> (addr <span class="number">0x1000a69bc</span> offset <span class="number">682428</span>)</div><div class="line">    Section __entitlements: <span class="number">0x184</span> (addr <span class="number">0x1000a6bfa</span> offset <span class="number">683002</span>)</div><div class="line">    Section __unwind_info: <span class="number">0x1274</span> (addr <span class="number">0x1000a6d80</span> offset <span class="number">683392</span>)</div><div class="line">    total <span class="number">0xa5f08</span></div><div class="line">Segment __DATA: <span class="number">0x2f000</span> (vmaddr <span class="number">0x1000a8000</span> fileoff <span class="number">688128</span>)</div><div class="line">    Section __nl_symbol_ptr: <span class="number">0x8</span> (addr <span class="number">0x1000a8000</span> offset <span class="number">688128</span>)</div><div class="line">    Section __got: <span class="number">0x258</span> (addr <span class="number">0x1000a8008</span> offset <span class="number">688136</span>)</div><div class="line">    Section __la_symbol_ptr: <span class="number">0x760</span> (addr <span class="number">0x1000a8260</span> offset <span class="number">688736</span>)</div><div class="line">    Section __const: <span class="number">0x4238</span> (addr <span class="number">0x1000a89c0</span> offset <span class="number">690624</span>)</div><div class="line">    Section __cfstring: <span class="number">0x9d80</span> (addr <span class="number">0x1000acbf8</span> offset <span class="number">707576</span>)</div><div class="line">    Section __objc_classlist: <span class="number">0x510</span> (addr <span class="number">0x1000b6978</span> offset <span class="number">747896</span>)</div><div class="line">    Section __objc_nlclslist: <span class="number">0x40</span> (addr <span class="number">0x1000b6e88</span> offset <span class="number">749192</span>)</div><div class="line">    Section __objc_catlist: <span class="number">0x90</span> (addr <span class="number">0x1000b6ec8</span> offset <span class="number">749256</span>)</div><div class="line">    Section __objc_nlcatlist: <span class="number">0x10</span> (addr <span class="number">0x1000b6f58</span> offset <span class="number">749400</span>)</div><div class="line">    Section __objc_protolist: <span class="number">0x80</span> (addr <span class="number">0x1000b6f68</span> offset <span class="number">749416</span>)</div><div class="line">    Section __objc_imageinfo: <span class="number">0x8</span> (addr <span class="number">0x1000b6fe8</span> offset <span class="number">749544</span>)</div><div class="line">    Section __objc_const: <span class="number">0x182e8</span> (addr <span class="number">0x1000b6ff0</span> offset <span class="number">749552</span>)</div><div class="line">    Section __objc_selrefs: <span class="number">0x2bf8</span> (addr <span class="number">0x1000cf2d8</span> offset <span class="number">848600</span>)</div><div class="line">    Section __objc_protorefs: <span class="number">0x8</span> (addr <span class="number">0x1000d1ed0</span> offset <span class="number">859856</span>)</div><div class="line">    Section __objc_classrefs: <span class="number">0x858</span> (addr <span class="number">0x1000d1ed8</span> offset <span class="number">859864</span>)</div><div class="line">    Section __objc_superrefs: <span class="number">0x370</span> (addr <span class="number">0x1000d2730</span> offset <span class="number">862000</span>)</div><div class="line">    Section __objc_ivar: <span class="number">0xb48</span> (addr <span class="number">0x1000d2aa0</span> offset <span class="number">862880</span>)</div><div class="line">    Section __objc_data: <span class="number">0x32a0</span> (addr <span class="number">0x1000d35e8</span> offset <span class="number">865768</span>)</div><div class="line">    Section __data: <span class="number">0x604</span> (addr <span class="number">0x1000d6888</span> offset <span class="number">878728</span>)</div><div class="line">    Section __bss: <span class="number">0x158</span> (addr <span class="number">0x1000d6e90</span> offset <span class="number">0</span>)</div><div class="line">    total <span class="number">0x2efe4</span></div><div class="line">Segment __LINKEDIT: <span class="number">0xae000</span> (vmaddr <span class="number">0x1000d7000</span> fileoff <span class="number">880640</span>)</div><div class="line">total <span class="number">0x100185000</span></div></pre></td></tr></table></figure>
<p>可以看到 __objc 前缀的都是为了支持 Objective-C 语言新增加的。</p>
<p>那么 Swift 语言代码构建的 Mach-O 是怎样的呢？</p>
<p>使用我做启动优化时用 Swift 写的工具 <a href="https://github.com/ming1016/MethodTraceAnalyze" target="_blank" rel="external">MethodTraceAnalyze</a> 看下内容有什么。结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">Segment __PAGEZERO: <span class="number">0x100000000</span> (vmaddr <span class="number">0x0</span> fileoff <span class="number">0</span>)</div><div class="line">Segment __TEXT: <span class="number">0x115000</span> (vmaddr <span class="number">0x100000000</span> fileoff <span class="number">0</span>)</div><div class="line">    Section __text: <span class="number">0xfd540</span> (addr <span class="number">0x1000019b0</span> offset <span class="number">6576</span>)</div><div class="line">    Section __stubs: <span class="number">0x6f6</span> (addr <span class="number">0x1000feef0</span> offset <span class="number">1044208</span>)</div><div class="line">    Section __stub_helper: <span class="number">0xbaa</span> (addr <span class="number">0x1000ff5e8</span> offset <span class="number">1045992</span>)</div><div class="line">    Section __swift5_typeref: <span class="number">0xf56</span> (addr <span class="number">0x100100192</span> offset <span class="number">1048978</span>)</div><div class="line">    Section __swift5_capture: <span class="number">0x3b4</span> (addr <span class="number">0x1001010e8</span> offset <span class="number">1052904</span>)</div><div class="line">    Section __cstring: <span class="number">0x7011</span> (addr <span class="number">0x1001014a0</span> offset <span class="number">1053856</span>)</div><div class="line">    Section __const: <span class="number">0x4754</span> (addr <span class="number">0x1001084c0</span> offset <span class="number">1082560</span>)</div><div class="line">    Section __swift5_fieldmd: <span class="number">0x2bf4</span> (addr <span class="number">0x10010cc14</span> offset <span class="number">1100820</span>)</div><div class="line">    Section __swift5_types: <span class="number">0x1f0</span> (addr <span class="number">0x10010f808</span> offset <span class="number">1112072</span>)</div><div class="line">    Section __swift5_builtin: <span class="number">0x78</span> (addr <span class="number">0x10010f9f8</span> offset <span class="number">1112568</span>)</div><div class="line">    Section __swift5_reflstr: <span class="number">0x2740</span> (addr <span class="number">0x10010fa70</span> offset <span class="number">1112688</span>)</div><div class="line">    Section __swift5_proto: <span class="number">0x154</span> (addr <span class="number">0x1001121b0</span> offset <span class="number">1122736</span>)</div><div class="line">    Section __swift5_assocty: <span class="number">0x120</span> (addr <span class="number">0x100112304</span> offset <span class="number">1123076</span>)</div><div class="line">    Section __objc_methname: <span class="number">0x7a5</span> (addr <span class="number">0x100112424</span> offset <span class="number">1123364</span>)</div><div class="line">    Section __swift5_protos: <span class="number">0x8</span> (addr <span class="number">0x100112bcc</span> offset <span class="number">1125324</span>)</div><div class="line">    Section __unwind_info: <span class="number">0x1c70</span> (addr <span class="number">0x100112bd4</span> offset <span class="number">1125332</span>)</div><div class="line">    Section __eh_frame: <span class="number">0x7b0</span> (addr <span class="number">0x100114848</span> offset <span class="number">1132616</span>)</div><div class="line">    total <span class="number">0x11362c</span></div><div class="line">Segment __DATA_CONST: <span class="number">0x4000</span> (vmaddr <span class="number">0x100115000</span> fileoff <span class="number">1134592</span>)</div><div class="line">    Section __got: <span class="number">0x4a8</span> (addr <span class="number">0x100115000</span> offset <span class="number">1134592</span>)</div><div class="line">    Section __const: <span class="number">0x32f8</span> (addr <span class="number">0x1001154a8</span> offset <span class="number">1135784</span>)</div><div class="line">    Section __objc_classlist: <span class="number">0xd0</span> (addr <span class="number">0x1001187a0</span> offset <span class="number">1148832</span>)</div><div class="line">    Section __objc_protolist: <span class="number">0x10</span> (addr <span class="number">0x100118870</span> offset <span class="number">1149040</span>)</div><div class="line">    Section __objc_imageinfo: <span class="number">0x8</span> (addr <span class="number">0x100118880</span> offset <span class="number">1149056</span>)</div><div class="line">    total <span class="number">0x3888</span></div><div class="line">Segment __DATA: <span class="number">0x8000</span> (vmaddr <span class="number">0x100119000</span> fileoff <span class="number">1150976</span>)</div><div class="line">    Section __la_symbol_ptr: <span class="number">0x948</span> (addr <span class="number">0x100119000</span> offset <span class="number">1150976</span>)</div><div class="line">    Section __objc_const: <span class="number">0x2018</span> (addr <span class="number">0x100119948</span> offset <span class="number">1153352</span>)</div><div class="line">    Section __objc_selrefs: <span class="number">0xb0</span> (addr <span class="number">0x10011b960</span> offset <span class="number">1161568</span>)</div><div class="line">    Section __objc_protorefs: <span class="number">0x10</span> (addr <span class="number">0x10011ba10</span> offset <span class="number">1161744</span>)</div><div class="line">    Section __objc_classrefs: <span class="number">0x38</span> (addr <span class="number">0x10011ba20</span> offset <span class="number">1161760</span>)</div><div class="line">    Section __objc_data: <span class="number">0x98</span> (addr <span class="number">0x10011ba58</span> offset <span class="number">1161816</span>)</div><div class="line">    Section __data: <span class="number">0x1f88</span> (addr <span class="number">0x10011baf0</span> offset <span class="number">1161968</span>)</div><div class="line">    Section __bss: <span class="number">0x2a68</span> (addr <span class="number">0x10011da80</span> offset <span class="number">0</span>)</div><div class="line">    Section __common: <span class="number">0x50</span> (addr <span class="number">0x1001204e8</span> offset <span class="number">0</span>)</div><div class="line">    total <span class="number">0x7530</span></div><div class="line">Segment __LINKEDIT: <span class="number">0x152000</span> (vmaddr <span class="number">0x100121000</span> fileoff <span class="number">1171456</span>)</div><div class="line">total <span class="number">0x100273000</span></div></pre></td></tr></table></figure>
<p>可以看到 <strong>DATA Segment 部分还是有 </strong>objc 前缀的 Section，<strong>TEXT Segment 里已经都是 </strong>swift5 为前缀的 Section 了。</p>
<p>使用 otool 可以查看某个 Section 内容。比如查看 <strong>TEXT Segment 的 </strong>text Section 的内容，使用如下命令：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xcrun otool -s __TEXT __text a.out</div></pre></td></tr></table></figure>
<p>使用 otool 可以直接看 Mach-O 汇编内容 ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xcrun otool -v -t a.out</div></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">a.out:</div><div class="line">(__TEXT,__text) section</div><div class="line">_main:</div><div class="line"><span class="number">0000000100000f</span>50    pushq   %rbp</div><div class="line"><span class="number">0000000100000f</span>51    movq    %rsp, %rbp</div><div class="line"><span class="number">0000000100000f</span>54    subq    $<span class="number">0x20</span>, %rsp</div><div class="line"><span class="number">0000000100000f</span>58    movl    $<span class="number">0x0</span>, <span class="number">-0x4</span>(%rbp)</div><div class="line"><span class="number">0000000100000f</span>5f    movl    %edi, <span class="number">-0x8</span>(%rbp)</div><div class="line"><span class="number">0000000100000f</span>62    movq    %rsi, <span class="number">-0x10</span>(%rbp)</div><div class="line"><span class="number">0000000100000f</span>66    movq    <span class="number">-0x10</span>(%rbp), %rax</div><div class="line"><span class="number">0000000100000f</span>6a    movq    <span class="number">0x8</span>(%rax), %rax</div><div class="line"><span class="number">0000000100000f</span>6e    movq    %rax, <span class="number">-0x18</span>(%rbp)</div><div class="line"><span class="number">0000000100000f</span>72    movq    <span class="number">-0x18</span>(%rbp), %rsi</div><div class="line"><span class="number">0000000100000f</span>76    leaq    <span class="number">0x35</span>(%rip), %rdi</div><div class="line"><span class="number">0000000100000f</span>7d    movb    $<span class="number">0x0</span>, %al</div><div class="line"><span class="number">0000000100000f</span>7f    callq   <span class="number">0x100000f92</span></div><div class="line"><span class="number">0000000100000f</span>84    xorl    %ecx, %ecx</div><div class="line"><span class="number">0000000100000f</span>86    movl    %eax, <span class="number">-0x1c</span>(%rbp)</div><div class="line"><span class="number">0000000100000f</span>89    movl    %ecx, %eax</div><div class="line"><span class="number">0000000100000f</span>8b    addq    $<span class="number">0x20</span>, %rsp</div><div class="line"><span class="number">0000000100000f</span>8f    popq    %rbp</div><div class="line"><span class="number">0000000100000f</span>90    retq</div></pre></td></tr></table></figure>
<p>构建中查看代码生成汇编可以使用 clang 以下选项：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xcrun clang -S -o - main.c</div></pre></td></tr></table></figure>
<p> 生成汇编如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">    .section    __TEXT,__text,regular,pure_instructions</div><div class="line">    .build_version macos, <span class="number">10</span>, <span class="number">15</span>    sdk_version <span class="number">10</span>, <span class="number">15</span>, <span class="number">4</span></div><div class="line">    .globl  _main                   ## -- Begin function main</div><div class="line">    .p2align    <span class="number">4</span>, <span class="number">0x90</span></div><div class="line">_main:                                  ## @main</div><div class="line">    .cfi_startproc</div><div class="line">## %bb<span class="number">.0</span>:</div><div class="line">    pushq   %rbp</div><div class="line">    .cfi_def_cfa_offset <span class="number">16</span></div><div class="line">    .cfi_offset %rbp, <span class="number">-16</span></div><div class="line">    movq    %rsp, %rbp</div><div class="line">    .cfi_def_cfa_register %rbp</div><div class="line">    subq    $<span class="number">32</span>, %rsp</div><div class="line">    movl    $<span class="number">0</span>, <span class="number">-4</span>(%rbp)</div><div class="line">    movl    %edi, <span class="number">-8</span>(%rbp)</div><div class="line">    movq    %rsi, <span class="number">-16</span>(%rbp)</div><div class="line">    movq    <span class="number">-16</span>(%rbp), %rax</div><div class="line">    movq    <span class="number">8</span>(%rax), %rax</div><div class="line">    movq    %rax, <span class="number">-24</span>(%rbp)</div><div class="line">    movq    <span class="number">-24</span>(%rbp), %rsi</div><div class="line">    leaq    L_.str(%rip), %rdi</div><div class="line">    movb    $<span class="number">0</span>, %al</div><div class="line">    callq   _printf</div><div class="line">    xorl    %ecx, %ecx</div><div class="line">    movl    %eax, <span class="number">-28</span>(%rbp)         ## <span class="number">4</span>-byte Spill</div><div class="line">    movl    %ecx, %eax</div><div class="line">    addq    $<span class="number">32</span>, %rsp</div><div class="line">    popq    %rbp</div><div class="line">    retq</div><div class="line">    .cfi_endproc</div><div class="line">                                        ## -- End function</div><div class="line">    .section    __TEXT,__cstring,cstring_literals</div><div class="line">L_.str:                                 ## @.str</div><div class="line">    .asciz  <span class="string">"%s\n"</span></div></pre></td></tr></table></figure>
<p>可以发现两者汇编逻辑是一样的。点符号开头的都是汇编指令，比如.section 就是告知会执行哪个 segment，.p2align 指令明确后面代码对齐方式，这里是16(2^4) 字节对齐，0x90 补齐。在 <strong>TEXT Segment 的 </strong>text Section 里会创建一个调用帧堆栈，进行函数调用，callq printf 函数前会用到 L<em>.str(%rip)，L</em>.str 标签会指向字符串，leaq 会把字符串的指针加载到 rdi 寄存器。最后会销毁调用帧堆栈，进行 retq 返回。</p>
<p>主要 Section：</p>
<ul>
<li>__nl_symbol_ptr：包含 non-lazy 符号指针，mach-o/loader.h 里有详细说明。服务 dyld_stub_binder 处理的符号。</li>
<li><strong>la_symbol_ptr：</strong>stubs 第一个 jump 目标地址。动态库的符号指针地址。</li>
<li><strong>got：二进制文件的全局偏移表 GOT，也包含 S_NON_LAZY_SYMBOL_POINTERS 标记的 non-lazy 符号指针。服务于 </strong>TEXT Segment 里的符号。可以将<strong>got 看作一个表，里面每项都是一个地址值。</strong>got 的每项在加载期间都会被 dyld 重写，所以会在 <strong>DATA Segment 中。</strong>got 用来存放 non-lazy 符号最终地址，为 dyld 所用。dylib 外部符号对于全局变量和常量引用地址会指到 __got。</li>
<li>__lazy_symbol：包含 lazy 符号，首次使用时绑定。</li>
<li><strong>stubs：跳转表，重定向到 lazy 和 non-lazy 符号的 section。被标记为 S_SYMBOL_STUBS。</strong>TEXT Segment 里代码和 dylib 外部符号的引用地址对函数符号的引用都指向了 <strong>stubs。其中每项都是 jmp 代码间接寻址，可跳到 </strong>la_symbol_ptr Section 中。</li>
<li><strong>stub_helper：lazy 动态绑定符号的辅助函数。可跳到 </strong>nl_symbol_ptr Section 中。</li>
<li>__text：机器码，也是实际代码，包含所有功能。</li>
<li>__cstring：常量。只读 C 字符串。</li>
<li>__const：初始化过的常量。</li>
<li>_<em>objc</em>：Objective-C 语言 runtime 的支持。</li>
<li>__data：初始化过的变量。</li>
<li>__bss：未初始化的静态变量。</li>
<li>__unwind_info：生成异常处理信息。</li>
<li>__eh_frame：DWARF2 unwind 可执行文件代码信息，用于调试。</li>
<li>string table：以空值终止的字符串序列。</li>
<li>symbol table：通过 LC_SYMTAB 命令找到 symbol table，其包含所有用到的符号信息。结构体 nlist_64描述了符号的基本信息。nlist_64 结构体中 n_type 字段是一个8位复合字段，其中bit[0:1]表示是外部符号，bit[5:8]表调试符号，bit[4:5]表示私有 external 符号，bit[1:4]是符号类型，有 N_UNDF 未定义、N_ABS 绝对地址、N_SECT 本地符号、N_PBUD 预绑定符号、N_INDR 同名符号几种类型。</li>
<li>indirect symbol table：每项都是一个 index 值，指向 symbol table 中的项。由 LC_DYSYMTAB 定义，和<strong>nl_symbol_ptr 和 </strong>lazy_symbol 一起为 <strong>stubs 和 </strong>got 等 Section 服务。</li>
</ul>
<p>生成 Section 的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> MachOFileLayout::writeSectionContent() &#123;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> Section &amp;s : _file.sections) &#123;</div><div class="line">    <span class="comment">// Copy all section content to output buffer.</span></div><div class="line">    <span class="keyword">if</span> (isZeroFillSection(s.type))</div><div class="line">      <span class="keyword">continue</span>;</div><div class="line">    <span class="keyword">if</span> (s.content.empty())</div><div class="line">      <span class="keyword">continue</span>;</div><div class="line">    <span class="keyword">uint32_t</span> offset = _sectInfo[&amp;s].fileOffset;</div><div class="line">    <span class="keyword">uint8_t</span> *p = &amp;_buffer[offset];</div><div class="line">    <span class="built_in">memcpy</span>(p, &amp;s.content[<span class="number">0</span>], s.content.size());</div><div class="line">    p += s.content.size();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 symble table 生成的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> MachOFileLayout::writeSymbolTable() &#123;</div><div class="line">  <span class="comment">// Write symbol table and symbol strings in parallel.</span></div><div class="line">  <span class="keyword">uint32_t</span> symOffset = _startOfSymbols;</div><div class="line">  <span class="keyword">uint32_t</span> strOffset = _startOfSymbolStrings;</div><div class="line">  <span class="comment">// Reserve n_strx offset of zero to mean no name.</span></div><div class="line">  _buffer[strOffset++] = <span class="string">' '</span>;</div><div class="line">  _buffer[strOffset++] = <span class="string">'\0'</span>;</div><div class="line">  appendSymbols(_file.stabsSymbols, symOffset, strOffset);</div><div class="line">  appendSymbols(_file.localSymbols, symOffset, strOffset);</div><div class="line">  appendSymbols(_file.globalSymbols, symOffset, strOffset);</div><div class="line">  appendSymbols(_file.undefinedSymbols, symOffset, strOffset);</div><div class="line">  <span class="comment">// Write indirect symbol table array.</span></div><div class="line">  <span class="keyword">uint32_t</span> *indirects = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uint32_t</span>*&gt;</div><div class="line">                                            (&amp;_buffer[_startOfIndirectSymbols]);</div><div class="line">  <span class="keyword">if</span> (_file.fileType == llvm::MachO::MH_OBJECT) &#123;</div><div class="line">    <span class="comment">// Object files have sections in same order as input normalized file.</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> Section &amp;section : _file.sections) &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">uint32_t</span> index : section.indirectSymbols) &#123;</div><div class="line">        <span class="keyword">if</span> (_swap)</div><div class="line">          *indirects++ = llvm::sys::getSwappedBytes(index);</div><div class="line">        <span class="keyword">else</span></div><div class="line">          *indirects++ = index;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// Final linked images must sort sections from normalized file.</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> Segment &amp;seg : _file.segments) &#123;</div><div class="line">      SegExtraInfo &amp;segInfo = _segInfo[&amp;seg];</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> Section *section : segInfo.sections) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">uint32_t</span> index : section-&gt;indirectSymbols) &#123;</div><div class="line">          <span class="keyword">if</span> (_swap)</div><div class="line">            *indirects++ = llvm::sys::getSwappedBytes(index);</div><div class="line">          <span class="keyword">else</span></div><div class="line">            *indirects++ = index;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>获取 Segment 信息的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">segmentWalk</span><span class="params">(<span class="keyword">void</span> *segment_command)</span> </span>&#123;</div><div class="line">  <span class="keyword">uint32_t</span> nsects;</div><div class="line">  <span class="keyword">void</span> *section;</div><div class="line"></div><div class="line">  section = segment_command + <span class="keyword">sizeof</span>(struct segment_command);</div><div class="line">  nsects = ((struct segment_command *) segment_command)-&gt;nsects;</div><div class="line"></div><div class="line">  <span class="keyword">while</span> (nsects--) &#123;</div><div class="line">    section += <span class="keyword">sizeof</span>(struct s_section);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>获取对应符号的方法代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 定义参看 &lt;mach-o/nlist.h&gt;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> N_UNDF  0x0  <span class="comment">// 未定义</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> N_ABS 0x2    <span class="comment">// 绝对地址</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> N_SECT 0xe   <span class="comment">// 本地符号</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> N_PBUD 0xc   <span class="comment">// 预定义符号</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> N_INDR 0xa   <span class="comment">// 同名符号</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> N_STAB 0xe0  <span class="comment">// 调试符号</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> N_PEXT 0x10  <span class="comment">// 私有 external 符号</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> N_TYPE 0x0e  <span class="comment">// 类型位的掩码</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> N_EXT 0x01   <span class="comment">// external 符号</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">char</span> <span class="title">symbolical</span><span class="params">(sym)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (N_STAB &amp; sym-&gt;type)</div><div class="line">    <span class="keyword">return</span> <span class="string">'-'</span>; </div><div class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ((N_TYPE &amp; sym-&gt;type) == N_UNDF) &#123;</div><div class="line">    <span class="keyword">if</span> (sym-&gt;name_not_found)</div><div class="line">     <span class="keyword">return</span> <span class="string">'C'</span>;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (sym-&gt;type &amp; N_EXT)</div><div class="line">     <span class="keyword">return</span> = <span class="string">'U'</span>;</div><div class="line">    <span class="keyword">else</span></div><div class="line">     <span class="keyword">return</span> = <span class="string">'?'</span>;</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((N_TYPE &amp; sym-&gt;type) == N_SECT) &#123;</div><div class="line">    <span class="keyword">return</span> matched(saved_sections, sym);</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((N_TYPE &amp; sym-&gt;type) == N_ABS) &#123;</div><div class="line">    <span class="keyword">return</span> = <span class="string">'A'</span>;</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((N_TYPE &amp; sym-&gt;type) == N_INDR) &#123;</div><div class="line">    <span class="keyword">return</span> = <span class="string">'I'</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">char</span> <span class="title">matched</span><span class="params">(saved_sections, symbol)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">if</span> (sect = find_mysection(saved_sections, symbol-&gt;n_sect)) # </div><div class="line">  &#123;</div><div class="line">    <span class="keyword">if</span> (!ft_strcmp(sect-&gt;name, SECT_TEXT))</div><div class="line">      ret = <span class="string">'T'</span>;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!ft_strcmp(sect-&gt;name, SECT_DATA))</div><div class="line">      ret = <span class="string">'D'</span>;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!ft_strcmp(sect-&gt;name, SECT_BSS))</div><div class="line">      ret = <span class="string">'B'</span>;</div><div class="line">    <span class="keyword">else</span></div><div class="line">      ret = <span class="string">'S'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!(mysym-&gt;type &amp; N_EXT))</div><div class="line">       ret -= <span class="string">'A'</span> - <span class="string">'a'</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="加载运行"><a href="#加载运行" class="headerlink" title="加载运行"></a>加载运行</h2><p>程序要和其他库还有模块一起运行，需要在运行时对这些库和模块的符号引用进行解析，运行时，你应用程序使用的模块符号都在共享名称空间。macOS 使用的是两级名称空间来确保不同模块符号名不会冲突，同时增强向前兼容。</p>
<p>选择要加载的 Mach-O 后，系统内核会先确定该文件是否是 Mach-O 文件。</p>
<p>文件的第一个字节是魔数，通过魔数可以推断是不是 Mach-O，mach-o/loader.h 里定义了四个魔数标识。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_MAGIC    0xfeedface</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_CIGAM    NXSwapInt(MH_MAGIC)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_MAGIC_64 0xfeedfacf</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_CIGAM_64 NXSwapInt(MH_MAGIC_64)</span></div></pre></td></tr></table></figure>
<p>以上四个魔数标识是 Mach-O 文件。</p>
<p>然后内核系统会用 fork 函数创建一个进程，然后通过 execve 函数开始程序加载过程，execve 有多个种类，比如 execl、execv 等，只是在参数和环境变量上有不同，最终都会到内核的 execve 函数。</p>
<p>接着会检查 Mach-O header，加载 dyld 和程序到 Load Command 指定的地址空间。执行动态链接器。动态链接器通过 dyld_stub_binder 调用，这个函数的参数不直接指定要绑定的符号，而是通过给 dyld_stub_binder 偏移量到 dyld 解释的特殊字节码 Segment 中。dyld_stub_binder 函数的代码在这里：<a href="https://opensource.apple.com/source/dyld/dyld-635.2/src/dyld_stub_binder.s.auto.html" target="_blank" rel="external">dyld_stub_binder.s</a>。dyld 分为 rebase、binding、lazy binding、导出几个部分。dyld 可以 hook，使用 DYLD_INSERT_LIBRARIES，类似 ld 的 LD_PRELOAD 还有 DYLD_LIBRARY_PATH。</p>
<p><strong>text 里需要被 lazy binding 的符号引用，访问时回到 stub 中，目标地址在 </strong>la_symbol_ptr，对应 <strong>la_symbol_ptr 的内容会指向 </strong>stub_helper，其中逻辑会调到 dyld_stub_binder 函数，这个函数会通过 dyld 找到符号的真实地址，最后 dyld_stub_binder 会把得到的地址写入 <strong>la_symbol_ptr 里后，会跳转到符号的真实地址。由于地址已经在 </strong>la_symbol_ptr 里了，所以再访问符号时会通过 stub 的 jum 指令直接跳转到真实地址。</p>
<p>通过 dyld 加载主程序链接到的所有依赖库，执行符号绑定也就是non lazy binding。绑定解析其他模块的功能和数据的引用过程，也叫导入符号。</p>
<h3 id="导入导出符号"><a href="#导入导出符号" class="headerlink" title="导入导出符号"></a>导入导出符号</h3><p>执行绑定时，链接程序会用实际定义的地址替换程序的每个导入引用。通过构建时的选项设置，dyld 可以即时绑定，也叫延迟绑定，首次使用引用时的绑定，在使用符号前不会将程序的引用绑定到共享库的符号。使用 -bind_at_load 可以加载时绑定，动态链接程序在加载程序时立即绑定所有导入的引用，如果没有设置这个选项，默认按即时绑定来。设置 -prebind，程序引用的共享库都会在指定的地址预先绑定。</p>
<p>根据 Code Fragment Manager 设计的弱引用允许程序有选择的绑定到指定的共享库，如果 dyld 找不到弱引用的定义，会设置为 NULL，然后可以继续加载程序。代码上可以写判断，如果引用为空进行相应的处理。</p>
<p>过程链接表 PLT，会在运行时确定函数地址。callq 指令在 dyld_stub 调用 PLT 条目，符号 stub 位于 <strong>TEXT Segment 的 </strong>stubs Section 中。每个 Mach-O 符号 stub 都是一个 jumpq 指令，它会调用 dyld 找到符号，然后执行。</p>
<p>Mach-O 的导入和导出都会存在 __LINKEDIT 里。使用 FSA 接受 Leb128 参数，也就是绑定操作码。LEB 会把整数值编码成可变长度的字节序列，最后一个字节才设置最高有效位。</p>
<p>当 FSA 循环或递归时，会用0xF0对其进行掩码获得操作码，所有导入绑定操作码都会对应有宏名称和对应的功能。比如 0xb0 对应宏是 BIND_OPCODE_DO_BIND_ADD_ADDR_IMM_SCALED，功能是将记录放到导入堆栈中，然后把当前记录的地址偏移量设为 seg_offset = seg_offset + (scale * sizeofptr) + sizeofptr ，其中 scale 是立即数中包含的值，sizeofptr 是指针对应平台的大小。</p>
<p>Mach-O 导出符号是 <a href="https://en.wikipedia.org/wiki/Trie" target="_blank" rel="external">trie</a> 的数据结构，trie 节点最多有一个终端字符串信息，如果没有终端信息，就以0x00字节标记。有的化，就用 Leb128 代替该节点的终端字符串信息大小。节点导出信息后，类型信息类型使用0x3对标志进行位掩码获得。0x00表示常规符号，0x01表示线程本地符号，0x02标识绝对符号，0x4表示弱引用符号，0x8表示重新导出，0x10是 stub，具有 Leb128的 stub 偏移量。大部分符号都是常规符号，会将 Mach-O 的偏移量给符号。</p>
<p>生成 trie 数据结构的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> MachOFileLayout::buildExportTrie() &#123;</div><div class="line">  <span class="keyword">if</span> (_file.exportInfo.empty())</div><div class="line">    <span class="keyword">return</span>;</div><div class="line"></div><div class="line">  <span class="comment">// For all temporary strings and objects used building trie.</span></div><div class="line">  BumpPtrAllocator allocator;</div><div class="line"></div><div class="line">  <span class="comment">// Build trie of all exported symbols.</span></div><div class="line">  <span class="keyword">auto</span> *rootNode = <span class="keyword">new</span> (allocator) TrieNode(StringRef());</div><div class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;TrieNode*&gt; allNodes;</div><div class="line">  allNodes.reserve(_file.exportInfo.size()*<span class="number">2</span>);</div><div class="line">  allNodes.push_back(rootNode);</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> Export&amp; entry : _file.exportInfo) &#123;</div><div class="line">    rootNode-&gt;addSymbol(entry, allocator, allNodes);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;TrieNode*&gt; orderedNodes;</div><div class="line">  orderedNodes.reserve(allNodes.size());</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> Export&amp; entry : _file.exportInfo)</div><div class="line">    rootNode-&gt;addOrderedNodes(entry, orderedNodes);</div><div class="line"></div><div class="line">  <span class="comment">// Assign each node in the vector an offset in the trie stream, iterating</span></div><div class="line">  <span class="comment">// until all uleb128 sizes have stabilized.</span></div><div class="line">  <span class="keyword">bool</span> more;</div><div class="line">  <span class="keyword">do</span> &#123;</div><div class="line">    <span class="keyword">uint32_t</span> offset = <span class="number">0</span>;</div><div class="line">    more = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">for</span> (TrieNode* node : orderedNodes) &#123;</div><div class="line">      <span class="keyword">if</span> (node-&gt;updateOffset(offset))</div><div class="line">        more = <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">while</span> (more);</div><div class="line"></div><div class="line">  <span class="comment">// Serialize trie to ByteBuffer.</span></div><div class="line">  <span class="keyword">for</span> (TrieNode* node : orderedNodes) &#123;</div><div class="line">    node-&gt;appendToByteBuffer(_exportTrie);</div><div class="line">  &#125;</div><div class="line">  _exportTrie.align(_is64 ? <span class="number">8</span> : <span class="number">4</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于动态库，有几个易于理解的公共符号比导出所有符号更易于使用，让公共符号集少，私有符号集丰富，维护起来更加方便。更新时也不会影响较早版本。导出最少数量的符号，还能够优化动态加载程序到进程的时间，动态库导出符号越少，dyld 加载就越快。</p>
<p>静态存储类是表明不想导出符号的最简单的方法。将可见性属性放置在实现文件中的符号定义里，设置符号可见性也能够更精确的控制哪些符号是公共符号还是私有符号。在编译选项 -fvisbility 可以指定未指定可见性符号的可见性。使用 -weak_library 选项会告诉编译器将库里所有导出符号都设为弱链接符号。使用 nm 的 -gm 选项可以查看 Mach-O 导出的符号：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nm -gm header.dylib</div></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(undefined) external ___cxa_atexit (from libSystem)</div><div class="line">(undefined) external _printf (from libSystem)</div><div class="line">(undefined) <span class="function">external <span class="title">dyld_stub_binder</span> <span class="params">(from libSystem)</span></span></div></pre></td></tr></table></figure>
<p>另外可以通过导出的符号文件，列出要导出的符号来控制导出符号数量，其他符号都会被隐藏。导出符号文件 list 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">_foo</div><div class="line">_header</div></pre></td></tr></table></figure>
<p>使用 -exported_symbols_list 选项编译就可以仅导出文件中指定的符号：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -dynamiclib header.c -exported_symbols_list <span class="built_in">list</span> -o header.dylib</div></pre></td></tr></table></figure>
<h3 id="符号绑定范围"><a href="#符号绑定范围" class="headerlink" title="符号绑定范围"></a>符号绑定范围</h3><p>符号可能存在与多个作用域级别。未定义的外部符号是在当前文件之外的文件中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">extern</span> <span class="keyword">int</span> count;</div><div class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">void</span>)</span></span>;</div></pre></td></tr></table></figure>
<p>私有定义符号，其他模块不可见</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> count;</div></pre></td></tr></table></figure>
<p>私有外部符号可以使用 <strong>private_extern</strong>关键字：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">__private_extern__ <span class="keyword">int</span> count = <span class="number">0</span>;</div></pre></td></tr></table></figure>
<p>指定一个函数为弱引用，可以使用 weak_import 属性：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void foo(void) __attribute__((weak_import));</div></pre></td></tr></table></figure>
<p>在符号声明中添加 weak 属性来指定将符号设置为合并的弱引用：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void foo(void) __attribute__((weak));</div></pre></td></tr></table></figure>
<h3 id="入口点"><a href="#入口点" class="headerlink" title="入口点"></a>入口点</h3><p>符号绑定结果放到 LC_DYSYMTAB 指定的 section，解析后的地址会放到 <strong>DATA segment 的 </strong>nl_symbol_ptr 和 <strong>got 里。dyld 使用 Load Command 指定 Mach-O 中的数据以各种方式链接依赖项。Mach-O 的 Segment 按照 Load Command 中指定映射到内存中。 初始化后，会调用 LC_MAIN 指定的入口点，这个点是 </strong>TEXT Segment 的 <strong>text Section 的开始。使用 </strong>stubs 将 <strong>la_symbol_ptr 指向 </strong>stub_helpers，dyld_stub_binder 执行解析，然后更新 __la_symbol_ptr 的地址。</p>
<p>Mach-O 和链接器之间是通过 assembly trampoline 进行的桥接，Mach-O 接口的 ABI 和 ELF 相同，但策略不同。macOS 在调用 dyld 前后都会保存和恢复 SSE 寄存器。</p>
<h3 id="动态库构造函数和析构函数"><a href="#动态库构造函数和析构函数" class="headerlink" title="动态库构造函数和析构函数"></a>动态库构造函数和析构函数</h3><p>动态库加载可能需要执行特殊的初始化或者需要做些准备工作，这里可以使用初始化函数也就是构造函数。结束的时候可以加析构函数。</p>
<p>举个例子，先定义一个 header.c，在里面加上构造函数和析构函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line">__attribute__((constructor))</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, <span class="string">"prepare"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">__attribute__((destructor))</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, <span class="string">"end"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">showHeader</span><span class="params">()</span> </span>&#123; </div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, <span class="string">"header"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>将 header.c 构建成一个动态库 header.dylib。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xcrun clang -dynamiclib header.c -fvisibility=hidden -o header.dylib</div></pre></td></tr></table></figure>
<p>将 header.dylib 和 main.c 构建成一个中间目标文件 main.o。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xcrun clang main.c header.dylib -o main</div></pre></td></tr></table></figure>
<p>运行看结果</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ming@mingdeMacBook-Pro macho_demo % ./main <span class="string">"hi"</span></div><div class="line">prepare</div><div class="line">hi</div><div class="line">end</div></pre></td></tr></table></figure>
<p>可以看到，动态库的构造函数 prepare 和析构函数 end 都执行了。</p>

      
    </div>

    <div>
      
        
<div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/uploads/wechat-qcode.jpg" alt="戴铭 wechat" style="width: 200px; max-width: 100%;"/>
    <div>扫一扫戴铭博客官方公众号starming-weixin，关注最新文章</div>
</div>


      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>本文作者：</strong>
      戴铭
    </li>
    <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://ming1016.github.io/2020/03/29/apple-system-executable-file-macho/" title="Apple 操作系统可执行文件 Mach-O">http://ming1016.github.io/2020/03/29/apple-system-executable-file-macho/</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
    </li>
  </ul>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
            <a href="/tags/Apple/" rel="tag"># Apple</a>
          
            <a href="/tags/Mach-O/" rel="tag"># Mach-O</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/01/05/kuaishou-unused-class-swiftui-note-binary-tree-interview/" rel="next" title="在快手做分享、无用类检查、在广州做 SwiftUI 学习笔记分享、InfoQ二叉树视频">
                <i class="fa fa-chevron-left"></i> 在快手做分享、无用类检查、在广州做 SwiftUI 学习笔记分享、InfoQ二叉树视频
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars0.githubusercontent.com/u/251980?v=3&s=460"
               alt="戴铭" />
          <p class="site-author-name" itemprop="name">戴铭</p>
           
              <p class="site-description motion-element" itemprop="description">阿里巴巴高级技术专家，滴滴出行前技术专家。极客时间《iOS开发高手课》作者。有大量亿级APP工程架构，性能优化相关实战经验。个人博客：戴铭的博客。微信公共号：starming-weixin。微博：@戴铭</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">42</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">34</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ming1016" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/allstarming" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/ming1016" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#介绍"><span class="nav-number">1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#构建"><span class="nav-number">2.</span> <span class="nav-text">构建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#组成"><span class="nav-number">3.</span> <span class="nav-text">组成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Header"><span class="nav-number">3.1.</span> <span class="nav-text">Header</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Load-Command"><span class="nav-number">3.2.</span> <span class="nav-text">Load Command</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Data"><span class="nav-number">3.3.</span> <span class="nav-text">Data</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#加载运行"><span class="nav-number">4.</span> <span class="nav-text">加载运行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#导入导出符号"><span class="nav-number">4.1.</span> <span class="nav-text">导入导出符号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#符号绑定范围"><span class="nav-number">4.2.</span> <span class="nav-text">符号绑定范围</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#入口点"><span class="nav-number">4.3.</span> <span class="nav-text">入口点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态库构造函数和析构函数"><span class="nav-number">4.4.</span> <span class="nav-text">动态库构造函数和析构函数</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">戴铭</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  

  

</body>
</html>
