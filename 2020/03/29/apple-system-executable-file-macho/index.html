<!DOCTYPE html>
<html lang="zh-Hans">
    <!-- title -->




<!-- keywords -->




<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" >
    <meta name="author" content="戴铭">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="戴铭">
    
    <meta name="keywords" content="戴铭,戴铭的博客,iOS,Swift,移动开发,JavaScript,编译">
    
    <meta name="description" content="前滴滴出行技术专家。极客时间《iOS开发高手课》和纸书《跟戴铭学iOS编程》作者。个人博客：戴铭的博客。微信公共号：starming-weixin。微博：@戴铭">
    <meta name="description" content="介绍Mach-O 的全称是 Mach Object File Format。可以是可执行文件，目标代码或共享库，动态库。Mach 内核的操作系统比如 macOS，iPadOS 和 iOS 都是用的 Mach-O。Mach-O 包含程序的核心逻辑，以及入口点主要功能。 通过学习 Mach-O，可以了解应用程序是如何加载到系统的，如何执行的。还能了解符号查找，函数调用堆栈符号化等。更重要的是能够了解如">
<meta property="og:type" content="article">
<meta property="og:title" content="Apple 操作系统可执行文件 Mach-O">
<meta property="og:url" content="http://ming1016.github.io/2020/03/29/apple-system-executable-file-macho/index.html">
<meta property="og:site_name" content="戴铭的博客 - 星光社">
<meta property="og:description" content="介绍Mach-O 的全称是 Mach Object File Format。可以是可执行文件，目标代码或共享库，动态库。Mach 内核的操作系统比如 macOS，iPadOS 和 iOS 都是用的 Mach-O。Mach-O 包含程序的核心逻辑，以及入口点主要功能。 通过学习 Mach-O，可以了解应用程序是如何加载到系统的，如何执行的。还能了解符号查找，函数调用堆栈符号化等。更重要的是能够了解如">
<meta property="og:locale">
<meta property="article:published_time" content="2020-03-29T08:13:45.000Z">
<meta property="article:modified_time" content="2021-04-11T14:42:09.902Z">
<meta property="article:author" content="戴铭">
<meta property="article:tag" content="iOS">
<meta property="article:tag" content="Apple">
<meta property="article:tag" content="Mach-O">
<meta name="twitter:card" content="summary">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    
    <title>Apple 操作系统可执行文件 Mach-O · 戴铭的博客 - 星光社</title>
    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }

</style>

    <link rel="preload" href= "/css/style.css?v=20210204" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <link rel="stylesheet" href= "/css/mobile.css?v=20210204" media="(max-width: 980px)">
    
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
(function( w ){
	"use strict";
	// rel=preload support test
	if( !w.loadCSS ){
		w.loadCSS = function(){};
	}
	// define on the loadCSS obj
	var rp = loadCSS.relpreload = {};
	// rel=preload feature support test
	// runs once and returns a function for compat purposes
	rp.support = (function(){
		var ret;
		try {
			ret = w.document.createElement( "link" ).relList.supports( "preload" );
		} catch (e) {
			ret = false;
		}
		return function(){
			return ret;
		};
	})();

	// if preload isn't supported, get an asynchronous load by using a non-matching media attribute
	// then change that media back to its intended value on load
	rp.bindMediaToggle = function( link ){
		// remember existing media attr for ultimate state, or default to 'all'
		var finalMedia = link.media || "all";

		function enableStylesheet(){
			link.media = finalMedia;
		}

		// bind load handlers to enable media
		if( link.addEventListener ){
			link.addEventListener( "load", enableStylesheet );
		} else if( link.attachEvent ){
			link.attachEvent( "onload", enableStylesheet );
		}

		// Set rel and non-applicable media type to start an async request
		// note: timeout allows this to happen async to let rendering continue in IE
		setTimeout(function(){
			link.rel = "stylesheet";
			link.media = "only x";
		});
		// also enable media after 3 seconds,
		// which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
		setTimeout( enableStylesheet, 3000 );
	};

	// loop through link elements in DOM
	rp.poly = function(){
		// double check this to prevent external calls from running
		if( rp.support() ){
			return;
		}
		var links = w.document.getElementsByTagName( "link" );
		for( var i = 0; i < links.length; i++ ){
			var link = links[ i ];
			// qualify links to those with rel=preload and as=style attrs
			if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
				// prevent rerunning on link
				link.setAttribute( "data-loadcss", true );
				// bind listeners to toggle media back
				rp.bindMediaToggle( link );
			}
		}
	};

	// if unsupported, run the polyfill
	if( !rp.support() ){
		// run once at least
		rp.poly();

		// rerun poly on an interval until onload
		var run = w.setInterval( rp.poly, 500 );
		if( w.addEventListener ){
			w.addEventListener( "load", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		} else if( w.attachEvent ){
			w.attachEvent( "onload", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		}
	}


	// commonjs
	if( typeof exports !== "undefined" ){
		exports.loadCSS = loadCSS;
	}
	else {
		w.loadCSS = loadCSS;
	}
}( typeof global !== "undefined" ? global : this ) );
</script>

    <link rel="icon" href= "/assets/logo.png" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js" as="script" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" as="script" />
    <link rel="preload" href="/scripts/main.js?v=20210204" as="script" />
    <link rel="preload" as="font" href="/font/Oswald-Regular.ttf" crossorigin>
    <link rel="preload" as="font" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" crossorigin>
    <script src="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.3/js/all.min.js"  data-auto-replace-svg="nest" ></script>
    
    <!-- fancybox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script>
    <!-- 百度统计  -->
    
    <!-- 谷歌统计  -->
    
<meta name="generator" content="Hexo 5.4.0"></head>

    
        <body class="post-body">
    
    
<header class="header">

    <div class="read-progress"></div>
    <div class="header-sidebar-menu">&#xe775;</div>
    <!-- post页的toggle banner  -->
    
    <div class="banner">
            <div class="blog-title">
                <a href="/" >戴铭的博客 - 星光社</a>
            </div>
            <div class="post-title">
                <a href="#" class="post-name">Apple 操作系统可执行文件 Mach-O</a>
            </div>
    </div>
    
    <a class="home-link" href=/>戴铭的博客 - 星光社</a>
</header>
    <div class="wrapper">
        <div class="site-intro" style="







height:55vh;
">
    
    <!-- 主页  -->
    
    
    <!-- 404页  -->
            
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.jpg)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
            Apple 操作系统可执行文件 Mach-O
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
            
            <!-- 404 -->
            
        </p>
        <!-- 文章页meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                    <div class= post-intro-tags >
    
        <a class="post-tag" href="javascript:void(0);" data-tags = "iOS">iOS</a>
    
        <a class="post-tag" href="javascript:void(0);" data-tags = "Apple">Apple</a>
    
        <a class="post-tag" href="javascript:void(0);" data-tags = "Mach-O">Mach-O</a>
    
</div>
                
                
                    <div class="post-intro-read">
                        <span>字数统计: <span class="post-count word-count">7.6k</span>阅读时长: <span class="post-count reading-time">35 min</span></span>
                    </div>
                
                <div class="post-intro-meta">
                    <span class="post-intro-calander iconfont-archer">&#xe676;</span>
                    <span class="post-intro-time">2020/03/29</span>
                    
                    <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                        <span class="iconfont-archer">&#xe602;</span>
                        <span id="busuanzi_value_page_pv"></span>
                    </span>
                    
                    <span class="shareWrapper">
                        <span class="iconfont-archer shareIcon">&#xe71d;</span>
                        <span class="shareText">Share</span>
                        <ul class="shareList">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
        
    </div>
</div>
        <script>
 
  // get user agent
  var browser = {
    versions: function () {
      var u = window.navigator.userAgent;
      return {
        userAgent: u,
        trident: u.indexOf('Trident') > -1, //IE内核
        presto: u.indexOf('Presto') > -1, //opera内核
        webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
        gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
        mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
        ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
        android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
        iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
        iPad: u.indexOf('iPad') > -1, //是否为iPad
        webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
        weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
        uc: u.indexOf('UCBrowser') > -1 //是否为android下的UC浏览器
      };
    }()
  }
  console.log("userAgent:" + browser.versions.userAgent);

  // callback
  function fontLoaded() {
    console.log('font loaded');
    if (document.getElementsByClassName('site-intro-meta')) {
      document.getElementsByClassName('intro-title')[0].classList.add('intro-fade-in');
      document.getElementsByClassName('intro-subtitle')[0].classList.add('intro-fade-in');
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in');
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb(){
    if (browser.versions.uc) {
      console.log("UCBrowser");
      fontLoaded();
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular']
        },
        loading: function () {  //所有字体开始加载
          // console.log('loading');
        },
        active: function () {  //所有字体已渲染
          fontLoaded();
        },
        inactive: function () { //字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout');
          fontLoaded();
        },
        timeout: 5000 // Set the timeout to two seconds
      });
    }
  }

  function asyncErr(){
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (cb) { o.addEventListener('load', function (e) { cb(null, e); }, false); }
    if (err) { o.addEventListener('error', function (e) { err(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }

  var asyncLoadWithFallBack = function(arr, success, reject) {
      var currReject = function(){
        reject()
        arr.shift()
        if(arr.length)
          async(arr[0], success, currReject)
        }

      async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack([
    "https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js", 
    "https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js",
    "/lib/webfontloader.min.js"
  ], asyncCb, asyncErr)
</script>        
        <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
        <div class="container container-unloaded">
            <main class="main post-page">
    <article class="article-entry">
        <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Mach-O 的全称是 Mach Object File Format。可以是可执行文件，目标代码或共享库，动态库。Mach 内核的操作系统比如 macOS，iPadOS 和 iOS 都是用的 Mach-O。Mach-O 包含程序的核心逻辑，以及入口点主要功能。</p>
<p>通过学习 Mach-O，可以了解应用程序是如何加载到系统的，如何执行的。还能了解符号查找，函数调用堆栈符号化等。更重要的是能够了解如何设计数据结构，这对于日后开发生涯的收益是长期的。了解这些对于了解编译和逆向工程都会有帮助，你还会了解到动态链接器的内部工作原理以及字节码格式的信息，Leb128字节流，Mach 导出时 Trie 二进制 image 压缩。</p>
<p>对于 Mach-O，你一定不陌生，但是对于它内部逻辑你一定会好奇，比如它是怎么构建出来的，组织方式如何，怎么加载的，如何工作，谁让它工作的，怎样导入和导出符号的。</p>
<p>接下来我们先看看怎么构建一个 Mach-O 文件的吧。</p>
<h2 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h2><p>构建 Mach-O 文件，主要需要用到编译器和静态链接器，编译器可以将编写的高级语言代码转成中间目标文件，然后用静态链接器把中间目标文件组合成 Mach-O。</p>
<p>编译器驱动程序使用的是 clang，有编译、组装和链接的能力，调用 Xcode Tools 里的其他工具来实现源码到 Mach-O 文件生成。其他工具包括将汇编代码创建为中间目标文件的 as 汇编程序，组合中间目标文件成 Mach-O 文件的静态链接器 ld，还有创建静态库或共享库的 libtool。</p>
<p>构建成 Mach-O 包括中间对象文件（MH_OBJECT）、可执行二进制（MH_EXECUTE）、VM 共享库文件（MH_FVMLIB）、Crash 产生的 Core 文件（MH_CORE）、preload（MH_PRELOAD）、动态共享库（MH_DYLIB）、动态链接器（MH_DYLINKER）、静态链接文件（MH_DYLIB_STUB）、符号文件和调试信息（MH_DSYM）这几种类型。其中框架会包含Mach-O和图片、文档、接口等相关资源。</p>
<p>写个 main.c 文件代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123; </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, name);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 clang 构建成 Mach-O 文件 a.out。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun clang main.c</span><br></pre></td></tr></table></figure>
<p>如果有多个文件，先将多个文件生成中间目标文件，后缀是.o，使用 clang 的选项 -c。每个目标文件都是模块。使用静态链接器可以把多个模块组合成一个动态共享库。通过 ld 可以完成这个操作。使用 libtool 的选项 -static 可以构建静态库。</p>
<p>组合成动态库可以使用 clang 的 -dynamiclib 选项，命令如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun clang -dynamiclib command.c header.c -fvisibility=hidden -o mac.dylib</span><br></pre></td></tr></table></figure>
<p>静态链接就是把各个模块组合成一个整体，生成新的 Mach-O，链接的内容就是把各个模块间相互的引用能够正确的链接好，原理就是把一些指令对其他符号的地址引用进行修正。过程包含地址和空间分配，符号解析和围绕符号进行的重定位。核心是重定位，X86-64寻址方式是 RIP-relative 寻址，就是基于 RIP 来计算目标地址，通过 jumpq 跳转目标地址，就是当前指令下一条指令地址来加偏移量。</p>
<p>构建完 Mach-O。那你一定好奇 Mach-O 里面都有什么呢？分析 Mach-O 的工具有分析体系结构的 lipo，显式文件类型的 file，列 Data 内容的 otool，分析 image 每个逻辑信息符号的 pagestuff，符号表显示的 nm。</p>
<h2 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h2><p>Mach-O 会将数据流分组，每组都会有自己的意义，主要分三大部分，分别是 Mach Header、Load Command、Data。</p>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>Mach Header 里会有 Mach-O 的 CPU 信息，以及 Load Command 的信息。可以使用 otool 查看内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">otool -v -h a.out</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Mach header</span><br><span class="line">      magic cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags</span><br><span class="line">MH_MAGIC_64  X86_64        ALL  <span class="number">0x00</span>     EXECUTE    <span class="number">16</span>       <span class="number">1368</span>   NOUNDEFS DYLDLINK TWOLEVEL PIE</span><br></pre></td></tr></table></figure>
<p>通过 _dyld_get_image_header 函数可以获取 mach_header 结构体。<a target="_blank" rel="noopener" href="https://github.com/ming1016/GCDFetchFeed/blob/master/GCDFetchFeed/GCDFetchFeed/Lib/SMLagMonitor/SMCallStack.m">GCDFetchFeed/SMCallStack.m at master · ming1016/GCDFetchFeed · GitHub</a> 里这段代码里有判断 Mach Header 结构体魔数的函数 smCmdFirstPointerFromMachHeader，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uintptr_t</span> <span class="title">smCmdFirstPointerFromMachHeader</span><span class="params">(<span class="keyword">const</span> struct mach_header* <span class="keyword">const</span> machHeader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (machHeader-&gt;magic) &#123;</span><br><span class="line">        <span class="keyword">case</span> MH_MAGIC:</span><br><span class="line">        <span class="keyword">case</span> MH_CIGAM:</span><br><span class="line">        <span class="keyword">case</span> MH_MAGIC_64:</span><br><span class="line">        <span class="keyword">case</span> MH_CIGAM_64:</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">uintptr_t</span>)(((machHeaderByCPU*)machHeader) + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// Header 不合法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还有 Fat Header，里面会包含多个架构的 Header。</p>
<p>LLVM 中生成 Mach Header 的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MachOFileLayout::writeMachHeader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> cpusubtype = MachOLinkingContext::cpuSubtypeFromArch(_file.arch);</span><br><span class="line">  <span class="comment">// dynamic x86 executables on newer OS version should also set the</span></span><br><span class="line">  <span class="comment">// CPU_SUBTYPE_LIB64 mask in the CPU subtype.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">FIXME:</span> Check that this is a dynamic executable, not a static one.</span></span><br><span class="line">  <span class="keyword">if</span> (_file.fileType == llvm::MachO::MH_EXECUTE &amp;&amp;</span><br><span class="line">      cpusubtype == CPU_SUBTYPE_X86_64_ALL &amp;&amp;</span><br><span class="line">      _file.os == MachOLinkingContext::OS::macOSX) &#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> version;</span><br><span class="line">    <span class="keyword">bool</span> failed = MachOLinkingContext::parsePackedVersion(<span class="string">&quot;10.5&quot;</span>, version);</span><br><span class="line">    <span class="keyword">if</span> (!failed &amp;&amp; _file.minOSverson &gt;= version)</span><br><span class="line">      cpusubtype |= CPU_SUBTYPE_LIB64;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  mach_header *mh = <span class="keyword">reinterpret_cast</span>&lt;mach_header*&gt;(_buffer);</span><br><span class="line">  mh-&gt;magic = _is64 ? llvm::MachO::MH_MAGIC_64 : llvm::MachO::MH_MAGIC;</span><br><span class="line">  mh-&gt;cputype =  MachOLinkingContext::cpuTypeFromArch(_file.arch);</span><br><span class="line">  mh-&gt;cpusubtype = cpusubtype;</span><br><span class="line">  mh-&gt;filetype = _file.fileType;</span><br><span class="line">  mh-&gt;ncmds = _countOfLoadCommands;</span><br><span class="line">  mh-&gt;sizeofcmds = _endOfLoadCommands - _startOfLoadCommands;</span><br><span class="line">  mh-&gt;flags = _file.flags;</span><br><span class="line">  <span class="keyword">if</span> (_swap)</span><br><span class="line">    swapStruct(*mh);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Load-Command"><a href="#Load-Command" class="headerlink" title="Load Command"></a>Load Command</h3><p>Load Command 包含 Mach-O 里命令类型信息，名称和二进制文件的位置。</p>
<p>使用 otool 命令可以查看详细：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">otool -v -l a.out</span><br></pre></td></tr></table></figure>
<p>遍历 Mach Header 里的 ncmds 可以取到所有 Load Command。代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">uint32_t</span> iCmd = <span class="number">0</span>; iCmd &lt; machHeader-&gt;ncmds; iCmd++) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">load_command</span>* <span class="title">loadCmd</span> =</span> (struct load_command*)cmdPointer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>load<em>command 里的 cmd 是以 LC</em> 开头定义的宏，可以参看 loader.h 里的定义，有50多个，主要的是：</p>
<ul>
<li>LC_SEGMENT_64(_PAGEZERO)</li>
<li>LC_SEGMENT_64(_TEXT)</li>
<li>LC_SEGMENT_64(_DATA)</li>
<li>LC_SEGMENT_64(_LINKEDIT)</li>
<li>LC_DYLD_INFO_ONLY</li>
<li>LC_SYMTAB</li>
<li>LC_DYSYMTAB</li>
<li>LC_LOAD_DYLINKER</li>
<li>LC_UUID</li>
<li>LC_BUILD_VERSION</li>
<li>LC_SOURCE_VERSION</li>
<li>LC_MAIN</li>
<li>LC_LOAD_DYLIB(libSystem.B.dylib)</li>
<li>LC_FUNCTION_STARTS</li>
<li>LC_DATA_IN_CODE</li>
</ul>
<p>每个 command 的结构都是独立的，前两个字段 cmd 和 cmdsize 是一样的。</p>
<p>根据 Load Command 可以得到 Segment 的偏移量。</p>
<p>生成 Load Command 的代码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">llvm::Error <span class="title">MachOFileLayout::writeLoadCommands</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">uint8_t</span> *lc = &amp;_buffer[_startOfLoadCommands];</span><br><span class="line">  <span class="keyword">if</span> (_file.fileType == llvm::MachO::MH_OBJECT) &#123;</span><br><span class="line">    <span class="comment">// Object files have one unnamed segment which holds all sections.</span></span><br><span class="line">    <span class="keyword">if</span> (_is64) &#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">auto</span> ec = writeSingleSegmentLoadCommand&lt;MachO64Trait&gt;(lc))</span><br><span class="line">       <span class="keyword">return</span> ec;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">auto</span> ec = writeSingleSegmentLoadCommand&lt;MachO32Trait&gt;(lc))</span><br><span class="line">        <span class="keyword">return</span> ec;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Add LC_SYMTAB with symbol table info</span></span><br><span class="line">    symtab_command* st = <span class="keyword">reinterpret_cast</span>&lt;symtab_command*&gt;(lc);</span><br><span class="line">    st-&gt;cmd     = LC_SYMTAB;</span><br><span class="line">    st-&gt;cmdsize = <span class="keyword">sizeof</span>(symtab_command);</span><br><span class="line">    st-&gt;symoff  = _startOfSymbols;</span><br><span class="line">    st-&gt;nsyms   = _file.stabsSymbols.size() + _file.localSymbols.size() +</span><br><span class="line">                  _file.globalSymbols.size() + _file.undefinedSymbols.size();</span><br><span class="line">    st-&gt;stroff  = _startOfSymbolStrings;</span><br><span class="line">    st-&gt;strsize = _endOfSymbolStrings - _startOfSymbolStrings;</span><br><span class="line">    <span class="keyword">if</span> (_swap)</span><br><span class="line">      swapStruct(*st);</span><br><span class="line">    lc += <span class="keyword">sizeof</span>(symtab_command);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add LC_VERSION_MIN_MACOSX, LC_VERSION_MIN_IPHONEOS,</span></span><br><span class="line">    <span class="comment">// LC_VERSION_MIN_WATCHOS, LC_VERSION_MIN_TVOS</span></span><br><span class="line">    writeVersionMinLoadCommand(_file, _swap, lc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add LC_FUNCTION_STARTS if needed.</span></span><br><span class="line">    <span class="keyword">if</span> (_functionStartsSize != <span class="number">0</span>) &#123;</span><br><span class="line">      linkedit_data_command* dl = <span class="keyword">reinterpret_cast</span>&lt;linkedit_data_command*&gt;(lc);</span><br><span class="line">      dl-&gt;cmd      = LC_FUNCTION_STARTS;</span><br><span class="line">      dl-&gt;cmdsize  = <span class="keyword">sizeof</span>(linkedit_data_command);</span><br><span class="line">      dl-&gt;dataoff  = _startOfFunctionStarts;</span><br><span class="line">      dl-&gt;datasize = _functionStartsSize;</span><br><span class="line">      <span class="keyword">if</span> (_swap)</span><br><span class="line">        swapStruct(*dl);</span><br><span class="line">      lc += <span class="keyword">sizeof</span>(linkedit_data_command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add LC_DATA_IN_CODE if requested.</span></span><br><span class="line">    <span class="keyword">if</span> (_file.generateDataInCodeLoadCommand) &#123;</span><br><span class="line">      linkedit_data_command* dl = <span class="keyword">reinterpret_cast</span>&lt;linkedit_data_command*&gt;(lc);</span><br><span class="line">      dl-&gt;cmd      = LC_DATA_IN_CODE;</span><br><span class="line">      dl-&gt;cmdsize  = <span class="keyword">sizeof</span>(linkedit_data_command);</span><br><span class="line">      dl-&gt;dataoff  = _startOfDataInCode;</span><br><span class="line">      dl-&gt;datasize = _dataInCodeSize;</span><br><span class="line">      <span class="keyword">if</span> (_swap)</span><br><span class="line">        swapStruct(*dl);</span><br><span class="line">      lc += <span class="keyword">sizeof</span>(linkedit_data_command);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Final linked images have sections under segments.</span></span><br><span class="line">    <span class="keyword">if</span> (_is64) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">auto</span> ec = writeSegmentLoadCommands&lt;MachO64Trait&gt;(lc))</span><br><span class="line">        <span class="keyword">return</span> ec;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">auto</span> ec = writeSegmentLoadCommands&lt;MachO32Trait&gt;(lc))</span><br><span class="line">        <span class="keyword">return</span> ec;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add LC_ID_DYLIB command for dynamic libraries.</span></span><br><span class="line">    <span class="keyword">if</span> (_file.fileType == llvm::MachO::MH_DYLIB) &#123;</span><br><span class="line">      dylib_command *dc = <span class="keyword">reinterpret_cast</span>&lt;dylib_command*&gt;(lc);</span><br><span class="line">      StringRef path = _file.installName;</span><br><span class="line">      <span class="keyword">uint32_t</span> size = <span class="keyword">sizeof</span>(dylib_command) + pointerAlign(path.size() + <span class="number">1</span>);</span><br><span class="line">      dc-&gt;cmd                         = LC_ID_DYLIB;</span><br><span class="line">      dc-&gt;cmdsize                     = size;</span><br><span class="line">      dc-&gt;dylib.name                  = <span class="keyword">sizeof</span>(dylib_command); <span class="comment">// offset</span></span><br><span class="line">      <span class="comment">// needs to be some constant value different than the one in LC_LOAD_DYLIB</span></span><br><span class="line">      dc-&gt;dylib.timestamp             = <span class="number">1</span>;</span><br><span class="line">      dc-&gt;dylib.current_version       = _file.currentVersion;</span><br><span class="line">      dc-&gt;dylib.compatibility_version = _file.compatVersion;</span><br><span class="line">      <span class="keyword">if</span> (_swap)</span><br><span class="line">        swapStruct(*dc);</span><br><span class="line">      <span class="built_in">memcpy</span>(lc + <span class="keyword">sizeof</span>(dylib_command), path.begin(), path.size());</span><br><span class="line">      lc[<span class="keyword">sizeof</span>(dylib_command) + path.size()] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">      lc += size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add LC_DYLD_INFO_ONLY.</span></span><br><span class="line">    dyld_info_command* di = <span class="keyword">reinterpret_cast</span>&lt;dyld_info_command*&gt;(lc);</span><br><span class="line">    di-&gt;cmd            = LC_DYLD_INFO_ONLY;</span><br><span class="line">    di-&gt;cmdsize        = <span class="keyword">sizeof</span>(dyld_info_command);</span><br><span class="line">    di-&gt;rebase_off     = _rebaseInfo.size() ? _startOfRebaseInfo : <span class="number">0</span>;</span><br><span class="line">    di-&gt;rebase_size    = _rebaseInfo.size();</span><br><span class="line">    di-&gt;bind_off       = _bindingInfo.size() ? _startOfBindingInfo : <span class="number">0</span>;</span><br><span class="line">    di-&gt;bind_size      = _bindingInfo.size();</span><br><span class="line">    di-&gt;weak_bind_off  = <span class="number">0</span>;</span><br><span class="line">    di-&gt;weak_bind_size = <span class="number">0</span>;</span><br><span class="line">    di-&gt;lazy_bind_off  = _lazyBindingInfo.size() ? _startOfLazyBindingInfo : <span class="number">0</span>;</span><br><span class="line">    di-&gt;lazy_bind_size = _lazyBindingInfo.size();</span><br><span class="line">    di-&gt;export_off     = _exportTrie.size() ? _startOfExportTrie : <span class="number">0</span>;</span><br><span class="line">    di-&gt;export_size    = _exportTrie.size();</span><br><span class="line">    <span class="keyword">if</span> (_swap)</span><br><span class="line">      swapStruct(*di);</span><br><span class="line">    lc += <span class="keyword">sizeof</span>(dyld_info_command);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add LC_SYMTAB with symbol table info.</span></span><br><span class="line">    symtab_command* st = <span class="keyword">reinterpret_cast</span>&lt;symtab_command*&gt;(lc);</span><br><span class="line">    st-&gt;cmd     = LC_SYMTAB;</span><br><span class="line">    st-&gt;cmdsize = <span class="keyword">sizeof</span>(symtab_command);</span><br><span class="line">    st-&gt;symoff  = _startOfSymbols;</span><br><span class="line">    st-&gt;nsyms   = _file.stabsSymbols.size() + _file.localSymbols.size() +</span><br><span class="line">                  _file.globalSymbols.size() + _file.undefinedSymbols.size();</span><br><span class="line">    st-&gt;stroff  = _startOfSymbolStrings;</span><br><span class="line">    st-&gt;strsize = _endOfSymbolStrings - _startOfSymbolStrings;</span><br><span class="line">    <span class="keyword">if</span> (_swap)</span><br><span class="line">      swapStruct(*st);</span><br><span class="line">    lc += <span class="keyword">sizeof</span>(symtab_command);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add LC_DYSYMTAB</span></span><br><span class="line">    <span class="keyword">if</span> (_file.fileType != llvm::MachO::MH_PRELOAD) &#123;</span><br><span class="line">      dysymtab_command* dst = <span class="keyword">reinterpret_cast</span>&lt;dysymtab_command*&gt;(lc);</span><br><span class="line">      dst-&gt;cmd            = LC_DYSYMTAB;</span><br><span class="line">      dst-&gt;cmdsize        = <span class="keyword">sizeof</span>(dysymtab_command);</span><br><span class="line">      dst-&gt;ilocalsym      = _symbolTableLocalsStartIndex;</span><br><span class="line">      dst-&gt;nlocalsym      = _file.stabsSymbols.size() +</span><br><span class="line">                            _file.localSymbols.size();</span><br><span class="line">      dst-&gt;iextdefsym     = _symbolTableGlobalsStartIndex;</span><br><span class="line">      dst-&gt;nextdefsym     = _file.globalSymbols.size();</span><br><span class="line">      dst-&gt;iundefsym      = _symbolTableUndefinesStartIndex;</span><br><span class="line">      dst-&gt;nundefsym      = _file.undefinedSymbols.size();</span><br><span class="line">      dst-&gt;tocoff         = <span class="number">0</span>;</span><br><span class="line">      dst-&gt;ntoc           = <span class="number">0</span>;</span><br><span class="line">      dst-&gt;modtaboff      = <span class="number">0</span>;</span><br><span class="line">      dst-&gt;nmodtab        = <span class="number">0</span>;</span><br><span class="line">      dst-&gt;extrefsymoff   = <span class="number">0</span>;</span><br><span class="line">      dst-&gt;nextrefsyms    = <span class="number">0</span>;</span><br><span class="line">      dst-&gt;indirectsymoff = _startOfIndirectSymbols;</span><br><span class="line">      dst-&gt;nindirectsyms  = _indirectSymbolTableCount;</span><br><span class="line">      dst-&gt;extreloff      = <span class="number">0</span>;</span><br><span class="line">      dst-&gt;nextrel        = <span class="number">0</span>;</span><br><span class="line">      dst-&gt;locreloff      = <span class="number">0</span>;</span><br><span class="line">      dst-&gt;nlocrel        = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (_swap)</span><br><span class="line">        swapStruct(*dst);</span><br><span class="line">      lc += <span class="keyword">sizeof</span>(dysymtab_command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If main executable, add LC_LOAD_DYLINKER</span></span><br><span class="line">    <span class="keyword">if</span> (_file.fileType == llvm::MachO::MH_EXECUTE) &#123;</span><br><span class="line">      <span class="comment">// Build LC_LOAD_DYLINKER load command.</span></span><br><span class="line">      <span class="keyword">uint32_t</span> size=pointerAlign(<span class="keyword">sizeof</span>(dylinker_command)+dyldPath().size()+<span class="number">1</span>);</span><br><span class="line">      dylinker_command* dl = <span class="keyword">reinterpret_cast</span>&lt;dylinker_command*&gt;(lc);</span><br><span class="line">      dl-&gt;cmd              = LC_LOAD_DYLINKER;</span><br><span class="line">      dl-&gt;cmdsize          = size;</span><br><span class="line">      dl-&gt;name             = <span class="keyword">sizeof</span>(dylinker_command); <span class="comment">// offset</span></span><br><span class="line">      <span class="keyword">if</span> (_swap)</span><br><span class="line">        swapStruct(*dl);</span><br><span class="line">      <span class="built_in">memcpy</span>(lc+<span class="keyword">sizeof</span>(dylinker_command), dyldPath().data(), dyldPath().size());</span><br><span class="line">      lc[<span class="keyword">sizeof</span>(dylinker_command)+dyldPath().size()] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">      lc += size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add LC_VERSION_MIN_MACOSX, LC_VERSION_MIN_IPHONEOS, LC_VERSION_MIN_WATCHOS,</span></span><br><span class="line">    <span class="comment">// LC_VERSION_MIN_TVOS</span></span><br><span class="line">    writeVersionMinLoadCommand(_file, _swap, lc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add LC_SOURCE_VERSION</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Note, using a temporary here to appease UB as we may not be aligned</span></span><br><span class="line">      <span class="comment">// enough for a struct containing a uint64_t when emitting a 32-bit binary</span></span><br><span class="line">      source_version_command sv;</span><br><span class="line">      sv.cmd       = LC_SOURCE_VERSION;</span><br><span class="line">      sv.cmdsize   = <span class="keyword">sizeof</span>(source_version_command);</span><br><span class="line">      sv.version   = _file.sourceVersion;</span><br><span class="line">      <span class="keyword">if</span> (_swap)</span><br><span class="line">        swapStruct(sv);</span><br><span class="line">      <span class="built_in">memcpy</span>(lc, &amp;sv, <span class="keyword">sizeof</span>(source_version_command));</span><br><span class="line">      lc += <span class="keyword">sizeof</span>(source_version_command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If main executable, add LC_MAIN.</span></span><br><span class="line">    <span class="keyword">if</span> (_file.fileType == llvm::MachO::MH_EXECUTE) &#123;</span><br><span class="line">      <span class="comment">// Build LC_MAIN load command.</span></span><br><span class="line">      <span class="comment">// Note, using a temporary here to appease UB as we may not be aligned</span></span><br><span class="line">      <span class="comment">// enough for a struct containing a uint64_t when emitting a 32-bit binary</span></span><br><span class="line">      entry_point_command ep;</span><br><span class="line">      ep.cmd       = LC_MAIN;</span><br><span class="line">      ep.cmdsize   = <span class="keyword">sizeof</span>(entry_point_command);</span><br><span class="line">      ep.entryoff  = _file.entryAddress - _seg1addr;</span><br><span class="line">      ep.stacksize = _file.stackSize;</span><br><span class="line">      <span class="keyword">if</span> (_swap)</span><br><span class="line">        swapStruct(ep);</span><br><span class="line">      <span class="built_in">memcpy</span>(lc, &amp;ep, <span class="keyword">sizeof</span>(entry_point_command));</span><br><span class="line">      lc += <span class="keyword">sizeof</span>(entry_point_command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add LC_LOAD_DYLIB commands</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> DependentDylib &amp;dep : _file.dependentDylibs) &#123;</span><br><span class="line">      dylib_command* dc = <span class="keyword">reinterpret_cast</span>&lt;dylib_command*&gt;(lc);</span><br><span class="line">      <span class="keyword">uint32_t</span> size = <span class="keyword">sizeof</span>(dylib_command) + pointerAlign(dep.path.size()+<span class="number">1</span>);</span><br><span class="line">      dc-&gt;cmd                         = dep.kind;</span><br><span class="line">      dc-&gt;cmdsize                     = size;</span><br><span class="line">      dc-&gt;dylib.name                  = <span class="keyword">sizeof</span>(dylib_command); <span class="comment">// offset</span></span><br><span class="line">      <span class="comment">// needs to be some constant value different than the one in LC_ID_DYLIB</span></span><br><span class="line">      dc-&gt;dylib.timestamp             = <span class="number">2</span>;</span><br><span class="line">      dc-&gt;dylib.current_version       = dep.currentVersion;</span><br><span class="line">      dc-&gt;dylib.compatibility_version = dep.compatVersion;</span><br><span class="line">      <span class="keyword">if</span> (_swap)</span><br><span class="line">        swapStruct(*dc);</span><br><span class="line">      <span class="built_in">memcpy</span>(lc+<span class="keyword">sizeof</span>(dylib_command), dep.path.begin(), dep.path.size());</span><br><span class="line">      lc[<span class="keyword">sizeof</span>(dylib_command)+dep.path.size()] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">      lc += size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add LC_RPATH</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> StringRef &amp;path : _file.rpaths) &#123;</span><br><span class="line">      rpath_command *rpc = <span class="keyword">reinterpret_cast</span>&lt;rpath_command *&gt;(lc);</span><br><span class="line">      <span class="keyword">uint32_t</span> size = pointerAlign(<span class="keyword">sizeof</span>(rpath_command) + path.size() + <span class="number">1</span>);</span><br><span class="line">      rpc-&gt;cmd                         = LC_RPATH;</span><br><span class="line">      rpc-&gt;cmdsize                     = size;</span><br><span class="line">      rpc-&gt;path                        = <span class="keyword">sizeof</span>(rpath_command); <span class="comment">// offset</span></span><br><span class="line">      <span class="keyword">if</span> (_swap)</span><br><span class="line">        swapStruct(*rpc);</span><br><span class="line">      <span class="built_in">memcpy</span>(lc+<span class="keyword">sizeof</span>(rpath_command), path.begin(), path.size());</span><br><span class="line">      lc[<span class="keyword">sizeof</span>(rpath_command)+path.size()] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">      lc += size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add LC_FUNCTION_STARTS if needed.</span></span><br><span class="line">    <span class="keyword">if</span> (_functionStartsSize != <span class="number">0</span>) &#123;</span><br><span class="line">      linkedit_data_command* dl = <span class="keyword">reinterpret_cast</span>&lt;linkedit_data_command*&gt;(lc);</span><br><span class="line">      dl-&gt;cmd      = LC_FUNCTION_STARTS;</span><br><span class="line">      dl-&gt;cmdsize  = <span class="keyword">sizeof</span>(linkedit_data_command);</span><br><span class="line">      dl-&gt;dataoff  = _startOfFunctionStarts;</span><br><span class="line">      dl-&gt;datasize = _functionStartsSize;</span><br><span class="line">      <span class="keyword">if</span> (_swap)</span><br><span class="line">        swapStruct(*dl);</span><br><span class="line">      lc += <span class="keyword">sizeof</span>(linkedit_data_command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add LC_DATA_IN_CODE if requested.</span></span><br><span class="line">    <span class="keyword">if</span> (_file.generateDataInCodeLoadCommand) &#123;</span><br><span class="line">      linkedit_data_command* dl = <span class="keyword">reinterpret_cast</span>&lt;linkedit_data_command*&gt;(lc);</span><br><span class="line">      dl-&gt;cmd      = LC_DATA_IN_CODE;</span><br><span class="line">      dl-&gt;cmdsize  = <span class="keyword">sizeof</span>(linkedit_data_command);</span><br><span class="line">      dl-&gt;dataoff  = _startOfDataInCode;</span><br><span class="line">      dl-&gt;datasize = _dataInCodeSize;</span><br><span class="line">      <span class="keyword">if</span> (_swap)</span><br><span class="line">        swapStruct(*dl);</span><br><span class="line">      lc += <span class="keyword">sizeof</span>(linkedit_data_command);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> llvm::Error::success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Data"><a href="#Data" class="headerlink" title="Data"></a>Data</h3><p>Data 由 Segment 的数据组成，是 Mach-O 占比最多的部分，有代码有数据，比如符号表。Data 共三个 Segment，<strong>TEXT、</strong>DATA、<strong>LINKEDIT。其中 </strong>TEXT 和 <strong>DATA 对应一个或多个 Section，</strong>LINKEDIT 没有 Section，需要配合 LC_SYMTAB 来解析 symbol table 和 string table。这些里面是 Mach-O 的主要数据。</p>
<p>生成 __LINKEDIT 的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MachOFileLayout::buildLinkEditInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  buildRebaseInfo();</span><br><span class="line">  buildBindInfo();</span><br><span class="line">  buildLazyBindInfo();</span><br><span class="line">  buildExportTrie();</span><br><span class="line">  computeSymbolTableSizes();</span><br><span class="line">  computeFunctionStartsSize();</span><br><span class="line">  computeDataInCodeSize();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MachOFileLayout::writeLinkEditContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (_file.fileType == llvm::MachO::MH_OBJECT) &#123;</span><br><span class="line">    writeRelocations();</span><br><span class="line">    writeFunctionStartsInfo();</span><br><span class="line">    writeDataInCodeInfo();</span><br><span class="line">    writeSymbolTable();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    writeRebaseInfo();</span><br><span class="line">    writeBindingInfo();</span><br><span class="line">    writeLazyBindingInfo();</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> add weak binding info</span></span><br><span class="line">    writeExportInfo();</span><br><span class="line">    writeFunctionStartsInfo();</span><br><span class="line">    writeDataInCodeInfo();</span><br><span class="line">    writeSymbolTable();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>通过生成 <strong>LINKEDIT 的代码可以看出 </strong>LINKEDIT 里包含 dyld 所需各种数据，比如符号表、间接符号表、rebase 操作码、绑定操作码、导出符号、函数启动信息、数据表、代码签名等。</p>
<p>__DATA 包含 lazy 和 non lazy 符号指针，还会包含静态数据和全局变量等。可重定位的 Mach-O 文件还会有一个重定位的区域用来存储重定位信息，如果哪个 section 有重定位字节，就会有一个 relocation table 对应。</p>
<p>生成 relocation 的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MachOFileLayout::writeRelocations</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> relOffset = _startOfRelocations;</span><br><span class="line">  <span class="keyword">for</span> (Section sect : _file.sections) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Relocation r : sect.relocations) &#123;</span><br><span class="line">      any_relocation_info* rb = <span class="keyword">reinterpret_cast</span>&lt;any_relocation_info*&gt;(</span><br><span class="line">                                                           &amp;_buffer[relOffset]);</span><br><span class="line">      *rb = packRelocation(r, _swap, _bigEndianArch);</span><br><span class="line">      relOffset += <span class="keyword">sizeof</span>(any_relocation_info);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 size 命令可以看到内容的分布，使用前面生成的 a.out 来看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun size -x -l -m a.out</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Segment __PAGEZERO: <span class="number">0x100000000</span> (vmaddr <span class="number">0x0</span> fileoff <span class="number">0</span>)</span><br><span class="line">Segment __TEXT: <span class="number">0x1000</span> (vmaddr <span class="number">0x100000000</span> fileoff <span class="number">0</span>)</span><br><span class="line">    Section __text: <span class="number">0x41</span> (addr <span class="number">0x100000f50</span> offset <span class="number">3920</span>)</span><br><span class="line">    Section __stubs: <span class="number">0x6</span> (addr <span class="number">0x100000f92</span> offset <span class="number">3986</span>)</span><br><span class="line">    Section __stub_helper: <span class="number">0x1a</span> (addr <span class="number">0x100000f98</span> offset <span class="number">3992</span>)</span><br><span class="line">    Section __cstring: <span class="number">0x4</span> (addr <span class="number">0x100000fb2</span> offset <span class="number">4018</span>)</span><br><span class="line">    Section __unwind_info: <span class="number">0x48</span> (addr <span class="number">0x100000fb8</span> offset <span class="number">4024</span>)</span><br><span class="line">    total <span class="number">0xad</span></span><br><span class="line">Segment __DATA_CONST: <span class="number">0x1000</span> (vmaddr <span class="number">0x100001000</span> fileoff <span class="number">4096</span>)</span><br><span class="line">    Section __got: <span class="number">0x8</span> (addr <span class="number">0x100001000</span> offset <span class="number">4096</span>)</span><br><span class="line">    total <span class="number">0x8</span></span><br><span class="line">Segment __DATA: <span class="number">0x1000</span> (vmaddr <span class="number">0x100002000</span> fileoff <span class="number">8192</span>)</span><br><span class="line">    Section __la_symbol_ptr: <span class="number">0x8</span> (addr <span class="number">0x100002000</span> offset <span class="number">8192</span>)</span><br><span class="line">    Section __data: <span class="number">0x8</span> (addr <span class="number">0x100002008</span> offset <span class="number">8200</span>)</span><br><span class="line">    total <span class="number">0x10</span></span><br><span class="line">Segment __LINKEDIT: <span class="number">0x1000</span> (vmaddr <span class="number">0x100003000</span> fileoff <span class="number">12288</span>)</span><br><span class="line">total <span class="number">0x100004000</span></span><br></pre></td></tr></table></figure>
<p>其中__TEXT Segment 的内容有：</p>
<ul>
<li>Section64(<strong>TEXT,</strong>text)</li>
<li>Section64(<strong>TEXT,</strong>stubs)</li>
<li>Section64(<strong>TEXT,</strong>stub_helper)</li>
<li>Section64(<strong>TEXT,</strong>cstring)</li>
<li>Section64(<strong>TEXT,</strong>unwind_info)</li>
</ul>
<p>__DATA Segment 的内容有：</p>
<ul>
<li>Section64(<strong>DATA,</strong>nl_symbol_ptr)</li>
<li>Section64(<strong>DATA,</strong>la_symbol_ptr)</li>
</ul>
<p>__LINKEDIT 的内容是：</p>
<ul>
<li>Dynamic Loader Info</li>
<li>Function Starts</li>
<li>Symbol Table</li>
<li>Data in Code Entries</li>
<li>Dynamic Symbol Table</li>
<li>String Table</li>
</ul>
<p>如果是 Objective-C 代码生成的 Mach-O 会多出很多和 Objective-C 相关的 Section ，我拿<a target="_blank" rel="noopener" href="https://github.com/ming1016/GCDFetchFeed">已阅</a>项目生成的 Mach-O 来看。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun size -x -l -m GCDFetchFeed</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Segment __PAGEZERO: <span class="number">0x100000000</span> (vmaddr <span class="number">0x0</span> fileoff <span class="number">0</span>)</span><br><span class="line">Segment __TEXT: <span class="number">0xa8000</span> (vmaddr <span class="number">0x100000000</span> fileoff <span class="number">0</span>)</span><br><span class="line">    Section __text: <span class="number">0x89084</span> (addr <span class="number">0x1000020e0</span> offset <span class="number">8416</span>)</span><br><span class="line">    Section __stubs: <span class="number">0x588</span> (addr <span class="number">0x10008b164</span> offset <span class="number">569700</span>)</span><br><span class="line">    Section __stub_helper: <span class="number">0x948</span> (addr <span class="number">0x10008b6ec</span> offset <span class="number">571116</span>)</span><br><span class="line">    Section __gcc_except_tab: <span class="number">0x1318</span> (addr <span class="number">0x10008c034</span> offset <span class="number">573492</span>)</span><br><span class="line">    Section __cstring: <span class="number">0xbebd</span> (addr <span class="number">0x10008d34c</span> offset <span class="number">578380</span>)</span><br><span class="line">    Section __objc_methname: <span class="number">0xa20f</span> (addr <span class="number">0x100099209</span> offset <span class="number">627209</span>)</span><br><span class="line">    Section __objc_classname: <span class="number">0x11d9</span> (addr <span class="number">0x1000a3418</span> offset <span class="number">668696</span>)</span><br><span class="line">    Section __objc_methtype: <span class="number">0x2185</span> (addr <span class="number">0x1000a45f1</span> offset <span class="number">673265</span>)</span><br><span class="line">    Section __const: <span class="number">0x23c</span> (addr <span class="number">0x1000a6780</span> offset <span class="number">681856</span>)</span><br><span class="line">    Section __ustring: <span class="number">0x23e</span> (addr <span class="number">0x1000a69bc</span> offset <span class="number">682428</span>)</span><br><span class="line">    Section __entitlements: <span class="number">0x184</span> (addr <span class="number">0x1000a6bfa</span> offset <span class="number">683002</span>)</span><br><span class="line">    Section __unwind_info: <span class="number">0x1274</span> (addr <span class="number">0x1000a6d80</span> offset <span class="number">683392</span>)</span><br><span class="line">    total <span class="number">0xa5f08</span></span><br><span class="line">Segment __DATA: <span class="number">0x2f000</span> (vmaddr <span class="number">0x1000a8000</span> fileoff <span class="number">688128</span>)</span><br><span class="line">    Section __nl_symbol_ptr: <span class="number">0x8</span> (addr <span class="number">0x1000a8000</span> offset <span class="number">688128</span>)</span><br><span class="line">    Section __got: <span class="number">0x258</span> (addr <span class="number">0x1000a8008</span> offset <span class="number">688136</span>)</span><br><span class="line">    Section __la_symbol_ptr: <span class="number">0x760</span> (addr <span class="number">0x1000a8260</span> offset <span class="number">688736</span>)</span><br><span class="line">    Section __const: <span class="number">0x4238</span> (addr <span class="number">0x1000a89c0</span> offset <span class="number">690624</span>)</span><br><span class="line">    Section __cfstring: <span class="number">0x9d80</span> (addr <span class="number">0x1000acbf8</span> offset <span class="number">707576</span>)</span><br><span class="line">    Section __objc_classlist: <span class="number">0x510</span> (addr <span class="number">0x1000b6978</span> offset <span class="number">747896</span>)</span><br><span class="line">    Section __objc_nlclslist: <span class="number">0x40</span> (addr <span class="number">0x1000b6e88</span> offset <span class="number">749192</span>)</span><br><span class="line">    Section __objc_catlist: <span class="number">0x90</span> (addr <span class="number">0x1000b6ec8</span> offset <span class="number">749256</span>)</span><br><span class="line">    Section __objc_nlcatlist: <span class="number">0x10</span> (addr <span class="number">0x1000b6f58</span> offset <span class="number">749400</span>)</span><br><span class="line">    Section __objc_protolist: <span class="number">0x80</span> (addr <span class="number">0x1000b6f68</span> offset <span class="number">749416</span>)</span><br><span class="line">    Section __objc_imageinfo: <span class="number">0x8</span> (addr <span class="number">0x1000b6fe8</span> offset <span class="number">749544</span>)</span><br><span class="line">    Section __objc_const: <span class="number">0x182e8</span> (addr <span class="number">0x1000b6ff0</span> offset <span class="number">749552</span>)</span><br><span class="line">    Section __objc_selrefs: <span class="number">0x2bf8</span> (addr <span class="number">0x1000cf2d8</span> offset <span class="number">848600</span>)</span><br><span class="line">    Section __objc_protorefs: <span class="number">0x8</span> (addr <span class="number">0x1000d1ed0</span> offset <span class="number">859856</span>)</span><br><span class="line">    Section __objc_classrefs: <span class="number">0x858</span> (addr <span class="number">0x1000d1ed8</span> offset <span class="number">859864</span>)</span><br><span class="line">    Section __objc_superrefs: <span class="number">0x370</span> (addr <span class="number">0x1000d2730</span> offset <span class="number">862000</span>)</span><br><span class="line">    Section __objc_ivar: <span class="number">0xb48</span> (addr <span class="number">0x1000d2aa0</span> offset <span class="number">862880</span>)</span><br><span class="line">    Section __objc_data: <span class="number">0x32a0</span> (addr <span class="number">0x1000d35e8</span> offset <span class="number">865768</span>)</span><br><span class="line">    Section __data: <span class="number">0x604</span> (addr <span class="number">0x1000d6888</span> offset <span class="number">878728</span>)</span><br><span class="line">    Section __bss: <span class="number">0x158</span> (addr <span class="number">0x1000d6e90</span> offset <span class="number">0</span>)</span><br><span class="line">    total <span class="number">0x2efe4</span></span><br><span class="line">Segment __LINKEDIT: <span class="number">0xae000</span> (vmaddr <span class="number">0x1000d7000</span> fileoff <span class="number">880640</span>)</span><br><span class="line">total <span class="number">0x100185000</span></span><br></pre></td></tr></table></figure>
<p>可以看到 __objc 前缀的都是为了支持 Objective-C 语言新增加的。</p>
<p>那么 Swift 语言代码构建的 Mach-O 是怎样的呢？</p>
<p>使用我做启动优化时用 Swift 写的工具 <a target="_blank" rel="noopener" href="https://github.com/ming1016/MethodTraceAnalyze">MethodTraceAnalyze</a> 看下内容有什么。结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Segment __PAGEZERO: <span class="number">0x100000000</span> (vmaddr <span class="number">0x0</span> fileoff <span class="number">0</span>)</span><br><span class="line">Segment __TEXT: <span class="number">0x115000</span> (vmaddr <span class="number">0x100000000</span> fileoff <span class="number">0</span>)</span><br><span class="line">    Section __text: <span class="number">0xfd540</span> (addr <span class="number">0x1000019b0</span> offset <span class="number">6576</span>)</span><br><span class="line">    Section __stubs: <span class="number">0x6f6</span> (addr <span class="number">0x1000feef0</span> offset <span class="number">1044208</span>)</span><br><span class="line">    Section __stub_helper: <span class="number">0xbaa</span> (addr <span class="number">0x1000ff5e8</span> offset <span class="number">1045992</span>)</span><br><span class="line">    Section __swift5_typeref: <span class="number">0xf56</span> (addr <span class="number">0x100100192</span> offset <span class="number">1048978</span>)</span><br><span class="line">    Section __swift5_capture: <span class="number">0x3b4</span> (addr <span class="number">0x1001010e8</span> offset <span class="number">1052904</span>)</span><br><span class="line">    Section __cstring: <span class="number">0x7011</span> (addr <span class="number">0x1001014a0</span> offset <span class="number">1053856</span>)</span><br><span class="line">    Section __const: <span class="number">0x4754</span> (addr <span class="number">0x1001084c0</span> offset <span class="number">1082560</span>)</span><br><span class="line">    Section __swift5_fieldmd: <span class="number">0x2bf4</span> (addr <span class="number">0x10010cc14</span> offset <span class="number">1100820</span>)</span><br><span class="line">    Section __swift5_types: <span class="number">0x1f0</span> (addr <span class="number">0x10010f808</span> offset <span class="number">1112072</span>)</span><br><span class="line">    Section __swift5_builtin: <span class="number">0x78</span> (addr <span class="number">0x10010f9f8</span> offset <span class="number">1112568</span>)</span><br><span class="line">    Section __swift5_reflstr: <span class="number">0x2740</span> (addr <span class="number">0x10010fa70</span> offset <span class="number">1112688</span>)</span><br><span class="line">    Section __swift5_proto: <span class="number">0x154</span> (addr <span class="number">0x1001121b0</span> offset <span class="number">1122736</span>)</span><br><span class="line">    Section __swift5_assocty: <span class="number">0x120</span> (addr <span class="number">0x100112304</span> offset <span class="number">1123076</span>)</span><br><span class="line">    Section __objc_methname: <span class="number">0x7a5</span> (addr <span class="number">0x100112424</span> offset <span class="number">1123364</span>)</span><br><span class="line">    Section __swift5_protos: <span class="number">0x8</span> (addr <span class="number">0x100112bcc</span> offset <span class="number">1125324</span>)</span><br><span class="line">    Section __unwind_info: <span class="number">0x1c70</span> (addr <span class="number">0x100112bd4</span> offset <span class="number">1125332</span>)</span><br><span class="line">    Section __eh_frame: <span class="number">0x7b0</span> (addr <span class="number">0x100114848</span> offset <span class="number">1132616</span>)</span><br><span class="line">    total <span class="number">0x11362c</span></span><br><span class="line">Segment __DATA_CONST: <span class="number">0x4000</span> (vmaddr <span class="number">0x100115000</span> fileoff <span class="number">1134592</span>)</span><br><span class="line">    Section __got: <span class="number">0x4a8</span> (addr <span class="number">0x100115000</span> offset <span class="number">1134592</span>)</span><br><span class="line">    Section __const: <span class="number">0x32f8</span> (addr <span class="number">0x1001154a8</span> offset <span class="number">1135784</span>)</span><br><span class="line">    Section __objc_classlist: <span class="number">0xd0</span> (addr <span class="number">0x1001187a0</span> offset <span class="number">1148832</span>)</span><br><span class="line">    Section __objc_protolist: <span class="number">0x10</span> (addr <span class="number">0x100118870</span> offset <span class="number">1149040</span>)</span><br><span class="line">    Section __objc_imageinfo: <span class="number">0x8</span> (addr <span class="number">0x100118880</span> offset <span class="number">1149056</span>)</span><br><span class="line">    total <span class="number">0x3888</span></span><br><span class="line">Segment __DATA: <span class="number">0x8000</span> (vmaddr <span class="number">0x100119000</span> fileoff <span class="number">1150976</span>)</span><br><span class="line">    Section __la_symbol_ptr: <span class="number">0x948</span> (addr <span class="number">0x100119000</span> offset <span class="number">1150976</span>)</span><br><span class="line">    Section __objc_const: <span class="number">0x2018</span> (addr <span class="number">0x100119948</span> offset <span class="number">1153352</span>)</span><br><span class="line">    Section __objc_selrefs: <span class="number">0xb0</span> (addr <span class="number">0x10011b960</span> offset <span class="number">1161568</span>)</span><br><span class="line">    Section __objc_protorefs: <span class="number">0x10</span> (addr <span class="number">0x10011ba10</span> offset <span class="number">1161744</span>)</span><br><span class="line">    Section __objc_classrefs: <span class="number">0x38</span> (addr <span class="number">0x10011ba20</span> offset <span class="number">1161760</span>)</span><br><span class="line">    Section __objc_data: <span class="number">0x98</span> (addr <span class="number">0x10011ba58</span> offset <span class="number">1161816</span>)</span><br><span class="line">    Section __data: <span class="number">0x1f88</span> (addr <span class="number">0x10011baf0</span> offset <span class="number">1161968</span>)</span><br><span class="line">    Section __bss: <span class="number">0x2a68</span> (addr <span class="number">0x10011da80</span> offset <span class="number">0</span>)</span><br><span class="line">    Section __common: <span class="number">0x50</span> (addr <span class="number">0x1001204e8</span> offset <span class="number">0</span>)</span><br><span class="line">    total <span class="number">0x7530</span></span><br><span class="line">Segment __LINKEDIT: <span class="number">0x152000</span> (vmaddr <span class="number">0x100121000</span> fileoff <span class="number">1171456</span>)</span><br><span class="line">total <span class="number">0x100273000</span></span><br></pre></td></tr></table></figure>
<p>可以看到 <strong>DATA Segment 部分还是有 </strong>objc 前缀的 Section，<strong>TEXT Segment 里已经都是 </strong>swift5 为前缀的 Section 了。</p>
<p>使用 otool 可以查看某个 Section 内容。比如查看 <strong>TEXT Segment 的 </strong>text Section 的内容，使用如下命令：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun otool -s __TEXT __text a.out</span><br></pre></td></tr></table></figure>
<p>使用 otool 可以直接看 Mach-O 汇编内容 ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun otool -v -t a.out</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">a.out:</span><br><span class="line">(__TEXT,__text) section</span><br><span class="line">_main:</span><br><span class="line"><span class="number">0000000100000f</span>50    pushq   %rbp</span><br><span class="line"><span class="number">0000000100000f</span>51    movq    %rsp, %rbp</span><br><span class="line"><span class="number">0000000100000f</span>54    subq    $<span class="number">0x20</span>, %rsp</span><br><span class="line"><span class="number">0000000100000f</span>58    movl    $<span class="number">0x0</span>, <span class="number">-0x4</span>(%rbp)</span><br><span class="line"><span class="number">0000000100000f</span>5f    movl    %edi, <span class="number">-0x8</span>(%rbp)</span><br><span class="line"><span class="number">0000000100000f</span>62    movq    %rsi, <span class="number">-0x10</span>(%rbp)</span><br><span class="line"><span class="number">0000000100000f</span>66    movq    <span class="number">-0x10</span>(%rbp), %rax</span><br><span class="line"><span class="number">0000000100000f</span>6a    movq    <span class="number">0x8</span>(%rax), %rax</span><br><span class="line"><span class="number">0000000100000f</span>6e    movq    %rax, <span class="number">-0x18</span>(%rbp)</span><br><span class="line"><span class="number">0000000100000f</span>72    movq    <span class="number">-0x18</span>(%rbp), %rsi</span><br><span class="line"><span class="number">0000000100000f</span>76    leaq    <span class="number">0x35</span>(%rip), %rdi</span><br><span class="line"><span class="number">0000000100000f</span>7d    movb    $<span class="number">0x0</span>, %al</span><br><span class="line"><span class="number">0000000100000f</span>7f    callq   <span class="number">0x100000f92</span></span><br><span class="line"><span class="number">0000000100000f</span>84    xorl    %ecx, %ecx</span><br><span class="line"><span class="number">0000000100000f</span>86    movl    %eax, <span class="number">-0x1c</span>(%rbp)</span><br><span class="line"><span class="number">0000000100000f</span>89    movl    %ecx, %eax</span><br><span class="line"><span class="number">0000000100000f</span>8b    addq    $<span class="number">0x20</span>, %rsp</span><br><span class="line"><span class="number">0000000100000f</span>8f    popq    %rbp</span><br><span class="line"><span class="number">0000000100000f</span>90    retq</span><br></pre></td></tr></table></figure>
<p>构建中查看代码生成汇编可以使用 clang 以下选项：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun clang -S -o - main.c</span><br></pre></td></tr></table></figure>
<p> 生成汇编如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">    .section    __TEXT,__text,regular,pure_instructions</span><br><span class="line">    .build_version macos, <span class="number">10</span>, <span class="number">15</span>    sdk_version <span class="number">10</span>, <span class="number">15</span>, <span class="number">4</span></span><br><span class="line">    .globl  _main                   ## -- Begin function main</span><br><span class="line">    .p2align    <span class="number">4</span>, <span class="number">0x90</span></span><br><span class="line">_main:                                  ## @main</span><br><span class="line">    .cfi_startproc</span><br><span class="line">## %bb<span class="number">.0</span>:</span><br><span class="line">    pushq   %rbp</span><br><span class="line">    .cfi_def_cfa_offset <span class="number">16</span></span><br><span class="line">    .cfi_offset %rbp, <span class="number">-16</span></span><br><span class="line">    movq    %rsp, %rbp</span><br><span class="line">    .cfi_def_cfa_register %rbp</span><br><span class="line">    subq    $<span class="number">32</span>, %rsp</span><br><span class="line">    movl    $<span class="number">0</span>, <span class="number">-4</span>(%rbp)</span><br><span class="line">    movl    %edi, <span class="number">-8</span>(%rbp)</span><br><span class="line">    movq    %rsi, <span class="number">-16</span>(%rbp)</span><br><span class="line">    movq    <span class="number">-16</span>(%rbp), %rax</span><br><span class="line">    movq    <span class="number">8</span>(%rax), %rax</span><br><span class="line">    movq    %rax, <span class="number">-24</span>(%rbp)</span><br><span class="line">    movq    <span class="number">-24</span>(%rbp), %rsi</span><br><span class="line">    leaq    L_.str(%rip), %rdi</span><br><span class="line">    movb    $<span class="number">0</span>, %al</span><br><span class="line">    callq   _printf</span><br><span class="line">    xorl    %ecx, %ecx</span><br><span class="line">    movl    %eax, <span class="number">-28</span>(%rbp)         ## <span class="number">4</span>-byte Spill</span><br><span class="line">    movl    %ecx, %eax</span><br><span class="line">    addq    $<span class="number">32</span>, %rsp</span><br><span class="line">    popq    %rbp</span><br><span class="line">    retq</span><br><span class="line">    .cfi_endproc</span><br><span class="line">                                        ## -- End function</span><br><span class="line">    .section    __TEXT,__cstring,cstring_literals</span><br><span class="line">L_.str:                                 ## @.str</span><br><span class="line">    .asciz  <span class="string">&quot;%s\n&quot;</span></span><br></pre></td></tr></table></figure>
<p>可以发现两者汇编逻辑是一样的。点符号开头的都是汇编指令，比如.section 就是告知会执行哪个 segment，.p2align 指令明确后面代码对齐方式，这里是16(2^4) 字节对齐，0x90 补齐。在 <strong>TEXT Segment 的 </strong>text Section 里会创建一个调用帧堆栈，进行函数调用，callq printf 函数前会用到 L<em>.str(%rip)，L</em>.str 标签会指向字符串，leaq 会把字符串的指针加载到 rdi 寄存器。最后会销毁调用帧堆栈，进行 retq 返回。</p>
<p>主要 Section：</p>
<ul>
<li>__nl_symbol_ptr：包含 non-lazy 符号指针，mach-o/loader.h 里有详细说明。服务 dyld_stub_binder 处理的符号。</li>
<li><strong>la_symbol_ptr：</strong>stubs 第一个 jump 目标地址。动态库的符号指针地址。</li>
<li><strong>got：二进制文件的全局偏移表 GOT，也包含 S_NON_LAZY_SYMBOL_POINTERS 标记的 non-lazy 符号指针。服务于 </strong>TEXT Segment 里的符号。可以将<strong>got 看作一个表，里面每项都是一个地址值。</strong>got 的每项在加载期间都会被 dyld 重写，所以会在 <strong>DATA Segment 中。</strong>got 用来存放 non-lazy 符号最终地址，为 dyld 所用。dylib 外部符号对于全局变量和常量引用地址会指到 __got。</li>
<li>__lazy_symbol：包含 lazy 符号，首次使用时绑定。</li>
<li><strong>stubs：跳转表，重定向到 lazy 和 non-lazy 符号的 section。被标记为 S_SYMBOL_STUBS。</strong>TEXT Segment 里代码和 dylib 外部符号的引用地址对函数符号的引用都指向了 <strong>stubs。其中每项都是 jmp 代码间接寻址，可跳到 </strong>la_symbol_ptr Section 中。</li>
<li><strong>stub_helper：lazy 动态绑定符号的辅助函数。可跳到 </strong>nl_symbol_ptr Section 中。</li>
<li>__text：机器码，也是实际代码，包含所有功能。</li>
<li>__cstring：常量。只读 C 字符串。</li>
<li>__const：初始化过的常量。</li>
<li>_<em>objc</em>：Objective-C 语言 runtime 的支持。</li>
<li>__data：初始化过的变量。</li>
<li>__bss：未初始化的静态变量。</li>
<li>__unwind_info：生成异常处理信息。</li>
<li>__eh_frame：DWARF2 unwind 可执行文件代码信息，用于调试。</li>
<li>string table：以空值终止的字符串序列。</li>
<li>symbol table：通过 LC_SYMTAB 命令找到 symbol table，其包含所有用到的符号信息。结构体 nlist_64描述了符号的基本信息。nlist_64 结构体中 n_type 字段是一个8位复合字段，其中bit[0:1]表示是外部符号，bit[5:8]表调试符号，bit[4:5]表示私有 external 符号，bit[1:4]是符号类型，有 N_UNDF 未定义、N_ABS 绝对地址、N_SECT 本地符号、N_PBUD 预绑定符号、N_INDR 同名符号几种类型。</li>
<li>indirect symbol table：每项都是一个 index 值，指向 symbol table 中的项。由 LC_DYSYMTAB 定义，和<strong>nl_symbol_ptr 和 </strong>lazy_symbol 一起为 <strong>stubs 和 </strong>got 等 Section 服务。</li>
</ul>
<p>生成 Section 的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MachOFileLayout::writeSectionContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> Section &amp;s : _file.sections) &#123;</span><br><span class="line">    <span class="comment">// Copy all section content to output buffer.</span></span><br><span class="line">    <span class="keyword">if</span> (isZeroFillSection(s.type))</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (s.content.empty())</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> offset = _sectInfo[&amp;s].fileOffset;</span><br><span class="line">    <span class="keyword">uint8_t</span> *p = &amp;_buffer[offset];</span><br><span class="line">    <span class="built_in">memcpy</span>(p, &amp;s.content[<span class="number">0</span>], s.content.size());</span><br><span class="line">    p += s.content.size();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 symble table 生成的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MachOFileLayout::writeSymbolTable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Write symbol table and symbol strings in parallel.</span></span><br><span class="line">  <span class="keyword">uint32_t</span> symOffset = _startOfSymbols;</span><br><span class="line">  <span class="keyword">uint32_t</span> strOffset = _startOfSymbolStrings;</span><br><span class="line">  <span class="comment">// Reserve n_strx offset of zero to mean no name.</span></span><br><span class="line">  _buffer[strOffset++] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">  _buffer[strOffset++] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  appendSymbols(_file.stabsSymbols, symOffset, strOffset);</span><br><span class="line">  appendSymbols(_file.localSymbols, symOffset, strOffset);</span><br><span class="line">  appendSymbols(_file.globalSymbols, symOffset, strOffset);</span><br><span class="line">  appendSymbols(_file.undefinedSymbols, symOffset, strOffset);</span><br><span class="line">  <span class="comment">// Write indirect symbol table array.</span></span><br><span class="line">  <span class="keyword">uint32_t</span> *indirects = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uint32_t</span>*&gt;</span><br><span class="line">                                            (&amp;_buffer[_startOfIndirectSymbols]);</span><br><span class="line">  <span class="keyword">if</span> (_file.fileType == llvm::MachO::MH_OBJECT) &#123;</span><br><span class="line">    <span class="comment">// Object files have sections in same order as input normalized file.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> Section &amp;section : _file.sections) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">uint32_t</span> index : section.indirectSymbols) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_swap)</span><br><span class="line">          *indirects++ = llvm::sys::getSwappedBytes(index);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          *indirects++ = index;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Final linked images must sort sections from normalized file.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> Segment &amp;seg : _file.segments) &#123;</span><br><span class="line">      SegExtraInfo &amp;segInfo = _segInfo[&amp;seg];</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> Section *section : segInfo.sections) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">uint32_t</span> index : section-&gt;indirectSymbols) &#123;</span><br><span class="line">          <span class="keyword">if</span> (_swap)</span><br><span class="line">            *indirects++ = llvm::sys::getSwappedBytes(index);</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            *indirects++ = index;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取 Segment 信息的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">segmentWalk</span><span class="params">(<span class="keyword">void</span> *segment_command)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> nsects;</span><br><span class="line">  <span class="keyword">void</span> *section;</span><br><span class="line"></span><br><span class="line">  section = segment_command + <span class="keyword">sizeof</span>(struct segment_command);</span><br><span class="line">  nsects = ((struct segment_command *) segment_command)-&gt;nsects;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (nsects--) &#123;</span><br><span class="line">    section += <span class="keyword">sizeof</span>(struct s_section);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取对应符号的方法代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义参看 &lt;mach-o/nlist.h&gt;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_UNDF  0x0  <span class="comment">// 未定义</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_ABS 0x2    <span class="comment">// 绝对地址</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_SECT 0xe   <span class="comment">// 本地符号</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_PBUD 0xc   <span class="comment">// 预定义符号</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_INDR 0xa   <span class="comment">// 同名符号</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_STAB 0xe0  <span class="comment">// 调试符号</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_PEXT 0x10  <span class="comment">// 私有 external 符号</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_TYPE 0x0e  <span class="comment">// 类型位的掩码</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_EXT 0x01   <span class="comment">// external 符号</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">symbolical</span><span class="params">(sym)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (N_STAB &amp; sym-&gt;type)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;-&#x27;</span>; </span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ((N_TYPE &amp; sym-&gt;type) == N_UNDF) &#123;</span><br><span class="line">    <span class="keyword">if</span> (sym-&gt;name_not_found)</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&#x27;C&#x27;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (sym-&gt;type &amp; N_EXT)</span><br><span class="line">     <span class="keyword">return</span> = <span class="string">&#x27;U&#x27;</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">     <span class="keyword">return</span> = <span class="string">&#x27;?&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((N_TYPE &amp; sym-&gt;type) == N_SECT) &#123;</span><br><span class="line">    <span class="keyword">return</span> matched(saved_sections, sym);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((N_TYPE &amp; sym-&gt;type) == N_ABS) &#123;</span><br><span class="line">    <span class="keyword">return</span> = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((N_TYPE &amp; sym-&gt;type) == N_INDR) &#123;</span><br><span class="line">    <span class="keyword">return</span> = <span class="string">&#x27;I&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">matched</span><span class="params">(saved_sections, symbol)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (sect = find_mysection(saved_sections, symbol-&gt;n_sect)) # </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (!ft_strcmp(sect-&gt;name, SECT_TEXT))</span><br><span class="line">      ret = <span class="string">&#x27;T&#x27;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!ft_strcmp(sect-&gt;name, SECT_DATA))</span><br><span class="line">      ret = <span class="string">&#x27;D&#x27;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!ft_strcmp(sect-&gt;name, SECT_BSS))</span><br><span class="line">      ret = <span class="string">&#x27;B&#x27;</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      ret = <span class="string">&#x27;S&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(mysym-&gt;type &amp; N_EXT))</span><br><span class="line">       ret -= <span class="string">&#x27;A&#x27;</span> - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="加载运行"><a href="#加载运行" class="headerlink" title="加载运行"></a>加载运行</h2><p>程序要和其他库还有模块一起运行，需要在运行时对这些库和模块的符号引用进行解析，运行时，你应用程序使用的模块符号都在共享名称空间。macOS 使用的是两级名称空间来确保不同模块符号名不会冲突，同时增强向前兼容。</p>
<p>选择要加载的 Mach-O 后，系统内核会先确定该文件是否是 Mach-O 文件。</p>
<p>文件的第一个字节是魔数，通过魔数可以推断是不是 Mach-O，mach-o/loader.h 里定义了四个魔数标识。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_MAGIC    0xfeedface</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_CIGAM    NXSwapInt(MH_MAGIC)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_MAGIC_64 0xfeedfacf</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_CIGAM_64 NXSwapInt(MH_MAGIC_64)</span></span><br></pre></td></tr></table></figure>
<p>以上四个魔数标识是 Mach-O 文件。</p>
<p>然后内核系统会用 fork 函数创建一个进程，然后通过 execve 函数开始程序加载过程，execve 有多个种类，比如 execl、execv 等，只是在参数和环境变量上有不同，最终都会到内核的 execve 函数。</p>
<p>接着会检查 Mach-O header，加载 dyld 和程序到 Load Command 指定的地址空间。执行动态链接器。动态链接器通过 dyld_stub_binder 调用，这个函数的参数不直接指定要绑定的符号，而是通过给 dyld_stub_binder 偏移量到 dyld 解释的特殊字节码 Segment 中。dyld_stub_binder 函数的代码在这里：<a target="_blank" rel="noopener" href="https://opensource.apple.com/source/dyld/dyld-635.2/src/dyld_stub_binder.s.auto.html">dyld_stub_binder.s</a>。dyld 分为 rebase、binding、lazy binding、导出几个部分。dyld 可以 hook，使用 DYLD_INSERT_LIBRARIES，类似 ld 的 LD_PRELOAD 还有 DYLD_LIBRARY_PATH。</p>
<p><strong>text 里需要被 lazy binding 的符号引用，访问时回到 stub 中，目标地址在 </strong>la_symbol_ptr，对应 <strong>la_symbol_ptr 的内容会指向 </strong>stub_helper，其中逻辑会调到 dyld_stub_binder 函数，这个函数会通过 dyld 找到符号的真实地址，最后 dyld_stub_binder 会把得到的地址写入 <strong>la_symbol_ptr 里后，会跳转到符号的真实地址。由于地址已经在 </strong>la_symbol_ptr 里了，所以再访问符号时会通过 stub 的 jum 指令直接跳转到真实地址。</p>
<p>通过 dyld 加载主程序链接到的所有依赖库，执行符号绑定也就是non lazy binding。绑定解析其他模块的功能和数据的引用过程，也叫导入符号。</p>
<h3 id="导入导出符号"><a href="#导入导出符号" class="headerlink" title="导入导出符号"></a>导入导出符号</h3><p>执行绑定时，链接程序会用实际定义的地址替换程序的每个导入引用。通过构建时的选项设置，dyld 可以即时绑定，也叫延迟绑定，首次使用引用时的绑定，在使用符号前不会将程序的引用绑定到共享库的符号。使用 -bind_at_load 可以加载时绑定，动态链接程序在加载程序时立即绑定所有导入的引用，如果没有设置这个选项，默认按即时绑定来。设置 -prebind，程序引用的共享库都会在指定的地址预先绑定。</p>
<p>根据 Code Fragment Manager 设计的弱引用允许程序有选择的绑定到指定的共享库，如果 dyld 找不到弱引用的定义，会设置为 NULL，然后可以继续加载程序。代码上可以写判断，如果引用为空进行相应的处理。</p>
<p>过程链接表 PLT，会在运行时确定函数地址。callq 指令在 dyld_stub 调用 PLT 条目，符号 stub 位于 <strong>TEXT Segment 的 </strong>stubs Section 中。每个 Mach-O 符号 stub 都是一个 jumpq 指令，它会调用 dyld 找到符号，然后执行。</p>
<p>Mach-O 的导入和导出都会存在 __LINKEDIT 里。使用 FSA 接受 Leb128 参数，也就是绑定操作码。LEB 会把整数值编码成可变长度的字节序列，最后一个字节才设置最高有效位。</p>
<p>当 FSA 循环或递归时，会用0xF0对其进行掩码获得操作码，所有导入绑定操作码都会对应有宏名称和对应的功能。比如 0xb0 对应宏是 BIND_OPCODE_DO_BIND_ADD_ADDR_IMM_SCALED，功能是将记录放到导入堆栈中，然后把当前记录的地址偏移量设为 seg_offset = seg_offset + (scale * sizeofptr) + sizeofptr ，其中 scale 是立即数中包含的值，sizeofptr 是指针对应平台的大小。</p>
<p>Mach-O 导出符号是 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Trie">trie</a> 的数据结构，trie 节点最多有一个终端字符串信息，如果没有终端信息，就以0x00字节标记。有的化，就用 Leb128 代替该节点的终端字符串信息大小。节点导出信息后，类型信息类型使用0x3对标志进行位掩码获得。0x00表示常规符号，0x01表示线程本地符号，0x02标识绝对符号，0x4表示弱引用符号，0x8表示重新导出，0x10是 stub，具有 Leb128的 stub 偏移量。大部分符号都是常规符号，会将 Mach-O 的偏移量给符号。</p>
<p>生成 trie 数据结构的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MachOFileLayout::buildExportTrie</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (_file.exportInfo.empty())</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// For all temporary strings and objects used building trie.</span></span><br><span class="line">  BumpPtrAllocator allocator;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Build trie of all exported symbols.</span></span><br><span class="line">  <span class="keyword">auto</span> *rootNode = <span class="keyword">new</span> (allocator) TrieNode(StringRef());</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;TrieNode*&gt; allNodes;</span><br><span class="line">  allNodes.reserve(_file.exportInfo.size()*<span class="number">2</span>);</span><br><span class="line">  allNodes.push_back(rootNode);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> Export&amp; entry : _file.exportInfo) &#123;</span><br><span class="line">    rootNode-&gt;addSymbol(entry, allocator, allNodes);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;TrieNode*&gt; orderedNodes;</span><br><span class="line">  orderedNodes.reserve(allNodes.size());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> Export&amp; entry : _file.exportInfo)</span><br><span class="line">    rootNode-&gt;addOrderedNodes(entry, orderedNodes);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Assign each node in the vector an offset in the trie stream, iterating</span></span><br><span class="line">  <span class="comment">// until all uleb128 sizes have stabilized.</span></span><br><span class="line">  <span class="keyword">bool</span> more;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> offset = <span class="number">0</span>;</span><br><span class="line">    more = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (TrieNode* node : orderedNodes) &#123;</span><br><span class="line">      <span class="keyword">if</span> (node-&gt;updateOffset(offset))</span><br><span class="line">        more = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (more);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Serialize trie to ByteBuffer.</span></span><br><span class="line">  <span class="keyword">for</span> (TrieNode* node : orderedNodes) &#123;</span><br><span class="line">    node-&gt;appendToByteBuffer(_exportTrie);</span><br><span class="line">  &#125;</span><br><span class="line">  _exportTrie.align(_is64 ? <span class="number">8</span> : <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Trie 也叫数字树或前缀树，是一种搜索树。查找复杂度 O(m)，m 是字符串的长度。和散列表相比，散列最差复杂度是 O(N)，一般都是 O(1)，用 O(m)时间评估 hash。散列缺点是会分配一大块内存，内容越多所占内存越大。Trie 不仅查找快，插入和删除都很快，适合存储预测性文本或自动完成词典。为了进一步优化所占空间，可以将 Trie 这种树形的确定性有限自动机压缩成确定性非循环有限状态自动体（DAFSA），其空间小，做法是会压缩相同分支。对于更大内容，还可以做更进一步的优化，比如使用字母缩减的实现技术，把原来的字符串重新解释为较长的字符串；使用单链式列表，节点设计为由符号、子节点、下一个节点来表示；将字母表数组存储为代表 ASCII 字母表的256位的位图。</p>
<p>对于动态库，有几个易于理解的公共符号比导出所有符号更易于使用，让公共符号集少，私有符号集丰富，维护起来更加方便。更新时也不会影响较早版本。导出最少数量的符号，还能够优化动态加载程序到进程的时间，动态库导出符号越少，dyld 加载就越快。</p>
<p>静态存储类是表明不想导出符号的最简单的方法。将可见性属性放置在实现文件中的符号定义里，设置符号可见性也能够更精确的控制哪些符号是公共符号还是私有符号。在编译选项 -fvisbility 可以指定未指定可见性符号的可见性。使用 -weak_library 选项会告诉编译器将库里所有导出符号都设为弱链接符号。使用 nm 的 -gm 选项可以查看 Mach-O 导出的符号：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nm -gm header.dylib</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(undefined) external ___cxa_atexit (from libSystem)</span><br><span class="line">(undefined) external _printf (from libSystem)</span><br><span class="line">(undefined) <span class="function">external <span class="title">dyld_stub_binder</span> <span class="params">(from libSystem)</span></span></span><br></pre></td></tr></table></figure>
<p>另外可以通过导出的符号文件，列出要导出的符号来控制导出符号数量，其他符号都会被隐藏。导出符号文件 list 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_foo</span><br><span class="line">_header</span><br></pre></td></tr></table></figure>
<p>使用 -exported_symbols_list 选项编译就可以仅导出文件中指定的符号：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -dynamiclib header.c -exported_symbols_list <span class="built_in">list</span> -o header.dylib</span><br></pre></td></tr></table></figure>
<h3 id="符号绑定范围"><a href="#符号绑定范围" class="headerlink" title="符号绑定范围"></a>符号绑定范围</h3><p>符号可能存在与多个作用域级别。未定义的外部符号是在当前文件之外的文件中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> count;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>私有定义符号，其他模块不可见</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> count;</span><br></pre></td></tr></table></figure>
<p>私有外部符号可以使用 <strong>private_extern</strong>关键字：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__private_extern__ <span class="keyword">int</span> count = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>指定一个函数为弱引用，可以使用 weak_import 属性：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">void</span>)</span> __<span class="title">attribute__</span><span class="params">((weak_import))</span></span>;</span><br></pre></td></tr></table></figure>
<p>在符号声明中添加 weak 属性来指定将符号设置为合并的弱引用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">void</span>)</span> __<span class="title">attribute__</span><span class="params">((weak))</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="入口点"><a href="#入口点" class="headerlink" title="入口点"></a>入口点</h3><p>符号绑定结果放到 LC_DYSYMTAB 指定的 section，解析后的地址会放到 <strong>DATA segment 的 </strong>nl_symbol_ptr 和 <strong>got 里。dyld 使用 Load Command 指定 Mach-O 中的数据以各种方式链接依赖项。Mach-O 的 Segment 按照 Load Command 中指定映射到内存中。 初始化后，会调用 LC_MAIN 指定的入口点，这个点是 </strong>TEXT Segment 的 <strong>text Section 的开始。使用 </strong>stubs 将 <strong>la_symbol_ptr 指向 </strong>stub_helpers，dyld_stub_binder 执行解析，然后更新 __la_symbol_ptr 的地址。</p>
<p>Mach-O 和链接器之间是通过 assembly trampoline 进行的桥接，Mach-O 接口的 ABI 和 ELF 相同，但策略不同。macOS 在调用 dyld 前后都会保存和恢复 SSE 寄存器。</p>
<h3 id="动态库构造函数和析构函数"><a href="#动态库构造函数和析构函数" class="headerlink" title="动态库构造函数和析构函数"></a>动态库构造函数和析构函数</h3><p>动态库加载可能需要执行特殊的初始化或者需要做些准备工作，这里可以使用初始化函数也就是构造函数。结束的时候可以加析构函数。</p>
<p>举个例子，先定义一个 header.c，在里面加上构造函数和析构函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__((constructor))</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, <span class="string">&quot;prepare&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((destructor))</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, <span class="string">&quot;end&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">showHeader</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, <span class="string">&quot;header&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 header.c 构建成一个动态库 header.dylib。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun clang -dynamiclib header.c -fvisibility=hidden -o header.dylib</span><br></pre></td></tr></table></figure>
<p>将 header.dylib 和 main.c 构建成一个中间目标文件 main.o。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun clang main.c header.dylib -o main</span><br></pre></td></tr></table></figure>
<p>运行看结果</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ming@mingdeMacBook-Pro macho_demo % ./main <span class="string">&quot;hi&quot;</span></span><br><span class="line">prepare</span><br><span class="line">hi</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>可以看到，动态库的构造函数 prepare 和析构函数 end 都执行了。</p>

    </article>
    <!-- license  -->
    
        <div class="license-wrapper">
            <p>原文作者：<a href="http://ming1016.github.io">戴铭</a>
            <p>原文链接：<a href="http://ming1016.github.io/2020/03/29/apple-system-executable-file-macho/">http://ming1016.github.io/2020/03/29/apple-system-executable-file-macho/</a>
            <p>发表日期：<a href="http://ming1016.github.io/2020/03/29/apple-system-executable-file-macho/">March 29th 2020, 4:13:45 pm</a>
            <p>更新日期：<a href="http://ming1016.github.io/2020/03/29/apple-system-executable-file-macho/">April 11th 2021, 10:42:09 pm</a>
            <p>版权声明：本文采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
        </div>
    
    <!-- paginator  -->
    <ul class="post-paginator">
        <li class="next">
            
                <div class="nextSlogan">Next Post</div>
                <a href= "/2020/04/12/why_write_study_ios_programming_with_daiming_book_and_draw_recently/" title= "我为什么写了《跟戴铭学iOS编程》这本书">
                    <div class="nextTitle">我为什么写了《跟戴铭学iOS编程》这本书</div>
                </a>
            
        </li>
        <li class="previous">
            
                <div class="prevSlogan">Previous Post</div>
                <a href= "/2020/01/05/kuaishou-unused-class-swiftui-note-binary-tree-interview/" title= "在快手做分享、无用类检查、在广州做 SwiftUI 学习笔记分享、InfoQ二叉树视频">
                    <div class="prevTitle">在快手做分享、无用类检查、在广州做 SwiftUI 学习笔记分享、InfoQ二叉树视频</div>
                </a>
            
        </li>
    </ul>
    <!-- 评论插件 -->
    <!-- 来必力City版安装代码 -->

<!-- City版安装代码已完成 -->
    
    
    <!-- gitalk评论 -->

    <!-- utteranc评论 -->

    <!-- partial('_partial/comment/changyan') -->
    <!--PC版-->


    
    

    <!-- 评论 -->

    <!-- idea from: https://hexo.fluid-dev.com/posts/hexo-injector/#%E6%96%87%E7%AB%A0%E6%97%B6%E6%95%88%E6%80%A7%E6%8F%90%E7%A4%BA -->
    
</main>

            <!-- profile -->
            
        </div>
        <footer class="footer footer-unloaded">
    <!-- social  -->
    
    <div class="social">
        
    
        
            
                <a href="mailto:ming1016@foxmail.com" class="iconfont-archer email" title=email ></a>
            
        
    
        
            
                <a href="//github.com/ming1016" class="iconfont-archer github" target="_blank" title=github></a>
            
        
    
        
            
                <span class="iconfont-archer wechat" title=wechat>
                  
                  <img class="profile-qr" src="/assets/wechat-qcode.jpeg" />
                </span>
            
        
    
        
    
        
    
        
            
                <a href="https://weibo.com/allstarming" class="iconfont-archer weibo" target="_blank" title=weibo></a>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            
                <a href="/atom.xml" class="iconfont-archer rss" target="_blank" title=rss></a>
            
        
    

    </div>
    
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
        <div><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">鄂ICP备17011999号</a></div>
    </div>
    <!-- 不蒜子  -->
    
    <div class="busuanzi-container">
    
     
    <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
    
    </div>
    

</footer>
    </div>
    <!-- toc -->
    
    <div class="toc-wrapper" style=
    







top:55vh;

    >
        <div class="toc-catalog">
            <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
        </div>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">构建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E6%88%90"><span class="toc-number">3.</span> <span class="toc-text">组成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Header"><span class="toc-number">3.1.</span> <span class="toc-text">Header</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Load-Command"><span class="toc-number">3.2.</span> <span class="toc-text">Load Command</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Data"><span class="toc-number">3.3.</span> <span class="toc-text">Data</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E8%BF%90%E8%A1%8C"><span class="toc-number">4.</span> <span class="toc-text">加载运行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA%E7%AC%A6%E5%8F%B7"><span class="toc-number">4.1.</span> <span class="toc-text">导入导出符号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E7%BB%91%E5%AE%9A%E8%8C%83%E5%9B%B4"><span class="toc-number">4.2.</span> <span class="toc-text">符号绑定范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E5%8F%A3%E7%82%B9"><span class="toc-number">4.3.</span> <span class="toc-text">入口点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%BA%93%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E5%92%8C%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0"><span class="toc-number">4.4.</span> <span class="toc-text">动态库构造函数和析构函数</span></a></li></ol></li></ol>
    </div>
    
    <div class="back-top iconfont-archer">&#xe639;</div>
    <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
          <div class="sidebar-panel-archives">
    <!-- 在ejs中将archive按照时间排序 -->
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 51
        </div>
        <!-- search  -->
        
    </div>
    
    <div class="post-archive">
    
    
    
    
    <div class="archive-year"> 2021 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/23</span><a class="archive-post-title" href= "/2021/11/23/daiming-swift-pamphlet/" >戴铭的 Swift 小册子</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/24</span><a class="archive-post-title" href= "/2021/07/24/my-little-idea-about-writing-technical-article/" >我写技术文章的一点心得</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/13</span><a class="archive-post-title" href= "/2021/07/13/deeply-analyse-autolayout-slides/" >深入剖析Auto Layout的幻灯片</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/08</span><a class="archive-post-title" href= "/2021/06/08/wwdc2021-day1-note/" >WWDC 2021 Day1 笔记</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/22</span><a class="archive-post-title" href= "/2021/05/22/acfun-swift-practice/" >A站 的 Swift 实践</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/21</span><a class="archive-post-title" href= "/2021/02/21/deeply-analyse-quickjs/" >深入剖析 JavaScript 编译器/解释器引擎 QuickJS - 多了解些 JavaScript 语言</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2020 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/18</span><a class="archive-post-title" href= "/2020/12/18/thinking-in-how-to-speed-up-app/" >App 启动提速实践和一些想法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/04</span><a class="archive-post-title" href= "/2020/05/04/draw-in-2020/" >2020年涂图</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/12</span><a class="archive-post-title" href= "/2020/04/12/why_write_study_ios_programming_with_daiming_book_and_draw_recently/" >我为什么写了《跟戴铭学iOS编程》这本书</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/29</span><a class="archive-post-title" href= "/2020/03/29/apple-system-executable-file-macho/" >Apple 操作系统可执行文件 Mach-O</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/05</span><a class="archive-post-title" href= "/2020/01/05/kuaishou-unused-class-swiftui-note-binary-tree-interview/" >在快手做分享、无用类检查、在广州做 SwiftUI 学习笔记分享、InfoQ二叉树视频</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2019 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/28</span><a class="archive-post-title" href= "/2019/12/28/japan-travel/" >日本游玩</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/07</span><a class="archive-post-title" href= "/2019/12/07/how-to-analyze-startup-time-cost-in-ios/" >如何对 iOS 启动阶段耗时进行分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/06</span><a class="archive-post-title" href= "/2019/12/06/draw-in-2019/" >2019年涂图</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/29</span><a class="archive-post-title" href= "/2019/07/29/ios-map/" >iOS 开发舆图</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/19</span><a class="archive-post-title" href= "/2019/06/19/white-dragon-class/" >白龙班</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2018 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/17</span><a class="archive-post-title" href= "/2018/09/17/produce-slides-of-third-at-swift-conference/" >这次swift大会分享准备的幻灯片和 demo</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/14</span><a class="archive-post-title" href= "/2018/09/14/draw-with-procreate-in-ipad-during-pre-half-in-20182/" >18年上半年procreate的练习图图</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/21</span><a class="archive-post-title" href= "/2018/04/21/deeply-analyse-javascriptcore/" >深入剖析 JavaScriptCore</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/07</span><a class="archive-post-title" href= "/2018/04/07/read-snapkit-and-masonry-source-code/" >读 SnapKit 和 Masonry 自动布局框架源码</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/02</span><a class="archive-post-title" href= "/2018/04/02/record-and-think-about-swift-project-jsondecoder-networking-and-pop/" >Swift 项目中涉及到 JSONDecoder，网络请求，泛型协议式编程的一些记录和想法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/24</span><a class="archive-post-title" href= "/2018/01/24/why-swift/" >Why Swift? Generics(泛型), Collection(集合类型), POP(协议式编程), Memory Management(内存管理)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/10</span><a class="archive-post-title" href= "/2018/01/10/slides-of-giac-how-to-use-swift-transfer-web-to-60-frame-native-code/" >GIAC 大会上分享的《Swift 将 Web 代码转成60帧满帧原生应用的方案及实践》的幻灯片</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/04</span><a class="archive-post-title" href= "/2018/01/04/baimi/" >白芈</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/04</span><a class="archive-post-title" href= "/2018/01/04/huaye/" >花野</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2017 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/24</span><a class="archive-post-title" href= "/2017/10/24/how-do-i-improve-the-development/" >在滴滴，我是如何指数级提升开发技术的？</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/16</span><a class="archive-post-title" href= "/2017/10/16/html-to-native-htn-development-record/" >HTML 转原生 HTN 项目开发记录</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/11</span><a class="archive-post-title" href= "/2017/10/11/deeply-analyse-webkit/" >深入剖析 WebKit</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/20</span><a class="archive-post-title" href= "/2017/06/20/deeply-ios-performance-optimization/" >深入剖析 iOS 性能优化</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/12</span><a class="archive-post-title" href= "/2017/06/12/gmtc-ios-slimming-practice/" >GMTC 上分享滴滴出行 iOS 端瘦身实践的 Slides</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/27</span><a class="archive-post-title" href= "/2017/05/27/slides-of-learn-what-interesting-things-you-can-do-with-iOS-compilation/" >atSwift大会上分享《学习iOS编译原理能做哪些有意思的事情》的 Slides</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/01</span><a class="archive-post-title" href= "/2017/04/01/build-static-analysis-program-smck-use-swift/" >用 Swift 编写的工程代码静态分析命令行工具 smck</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/01</span><a class="archive-post-title" href= "/2017/04/01/slides-of-deeply-analyse-llvm/" >深入剖析 iOS 编译 Clang / LLVM 直播的 Slides</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/01</span><a class="archive-post-title" href= "/2017/03/01/deeply-analyse-llvm/" >深入剖析 iOS 编译 Clang / LLVM</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2016 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/22</span><a class="archive-post-title" href= "/2016/11/22/how-to-preload-web-in-ios/" >iOS预加载Web页面方案</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/17</span><a class="archive-post-title" href= "/2016/11/17/use-swift3-build-macos-program-to-clear-unuse-method/" >使用Swift3开发了个macOS的程序可以检测出objc项目中无用方法，然后一键全部清理</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/20</span><a class="archive-post-title" href= "/2016/09/20/draw-with-procreate-in-ipad-during-15-to-16/" >15，16年iPad上使用Procreate画的</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/02</span><a class="archive-post-title" href= "/2016/09/02/develop-rss-reader/" >使用ReactiveCocoa开发RSS阅读器</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/09</span><a class="archive-post-title" href= "/2016/08/09/how-to-use-reactivecocoa/" >iOS函数响应式编程以及ReactiveCocoa的使用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/21</span><a class="archive-post-title" href= "/2016/07/21/assembleview/" >制作一个类似苹果VFL(Visual Format Language)的格式化语言来描述类似UIStackView那种布局思路，并解析生成页面</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/30</span><a class="archive-post-title" href= "/2016/05/30/what-learn-from-reactivecocoa/" >从 ReactiveCocoa 中能学到什么？不用此库也能学以致用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/23</span><a class="archive-post-title" href= "/2016/05/23/try-to-decouple-with-demo/" >竭尽全力的去解耦的一次实践，封装一个TableView和一些功能组合的控件</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/04</span><a class="archive-post-title" href= "/2016/04/04/tenth-middle-school/" >十中</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/13</span><a class="archive-post-title" href= "/2016/01/13/how-to-use-gcd/" >细说 GCD（Grand Central Dispatch）如何用</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2015 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/03</span><a class="archive-post-title" href= "/2015/11/03/deeply-analyse-autolayout/" >深入剖析Auto Layout，分析iOS各版本新增特性</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/02</span><a class="archive-post-title" href= "/2015/11/02/draw-with-note-in-ipad-during-15/" >15年用iPad上的备忘录画的</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/28</span><a class="archive-post-title" href= "/2015/05/28/macos-app-i-used/" >我用过的 macOS 应用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/02</span><a class="archive-post-title" href= "/2015/04/02/draw-game-of-thrones-with-pencil-during-14/" >整理了画的权利的游戏里的角色，有龙女，小恶魔等等</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/01</span><a class="archive-post-title" href= "/2015/04/01/objc-runtime/" >Objc Runtime 总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/12</span><a class="archive-post-title" href= "/2015/03/12/draw-practice-with-pencil-during-14-to-15/" >14和15年间的铅笔画练习</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2014 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/01</span><a class="archive-post-title" href= "/2014/03/01/black-star-blue-map/" >黑星蓝图</a>
        </li>
    
    </div>
  </div>
        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
    
        <span class="sidebar-tag-name" data-tags="AssembleView"><span class="iconfont-archer">&#xe606;</span>AssembleView</span>
    
        <span class="sidebar-tag-name" data-tags="iOS"><span class="iconfont-archer">&#xe606;</span>iOS</span>
    
        <span class="sidebar-tag-name" data-tags="Novel"><span class="iconfont-archer">&#xe606;</span>Novel</span>
    
        <span class="sidebar-tag-name" data-tags="smck"><span class="iconfont-archer">&#xe606;</span>smck</span>
    
        <span class="sidebar-tag-name" data-tags="Swift"><span class="iconfont-archer">&#xe606;</span>Swift</span>
    
        <span class="sidebar-tag-name" data-tags="RSSReader"><span class="iconfont-archer">&#xe606;</span>RSSReader</span>
    
        <span class="sidebar-tag-name" data-tags="Painting"><span class="iconfont-archer">&#xe606;</span>Painting</span>
    
        <span class="sidebar-tag-name" data-tags="iPad"><span class="iconfont-archer">&#xe606;</span>iPad</span>
    
        <span class="sidebar-tag-name" data-tags="Procreate"><span class="iconfont-archer">&#xe606;</span>Procreate</span>
    
        <span class="sidebar-tag-name" data-tags="Pencil"><span class="iconfont-archer">&#xe606;</span>Pencil</span>
    
        <span class="sidebar-tag-name" data-tags="GOT"><span class="iconfont-archer">&#xe606;</span>GOT</span>
    
        <span class="sidebar-tag-name" data-tags="Slides"><span class="iconfont-archer">&#xe606;</span>Slides</span>
    
        <span class="sidebar-tag-name" data-tags="Study"><span class="iconfont-archer">&#xe606;</span>Study</span>
    
        <span class="sidebar-tag-name" data-tags="UIWebView"><span class="iconfont-archer">&#xe606;</span>UIWebView</span>
    
        <span class="sidebar-tag-name" data-tags="NSURLProtocol"><span class="iconfont-archer">&#xe606;</span>NSURLProtocol</span>
    
        <span class="sidebar-tag-name" data-tags="Web"><span class="iconfont-archer">&#xe606;</span>Web</span>
    
        <span class="sidebar-tag-name" data-tags="Japan"><span class="iconfont-archer">&#xe606;</span>Japan</span>
    
        <span class="sidebar-tag-name" data-tags="macOS"><span class="iconfont-archer">&#xe606;</span>macOS</span>
    
        <span class="sidebar-tag-name" data-tags="APP"><span class="iconfont-archer">&#xe606;</span>APP</span>
    
        <span class="sidebar-tag-name" data-tags="swift"><span class="iconfont-archer">&#xe606;</span>swift</span>
    
        <span class="sidebar-tag-name" data-tags="编译"><span class="iconfont-archer">&#xe606;</span>编译</span>
    
        <span class="sidebar-tag-name" data-tags="LLVM"><span class="iconfont-archer">&#xe606;</span>LLVM</span>
    
        <span class="sidebar-tag-name" data-tags="Pattern"><span class="iconfont-archer">&#xe606;</span>Pattern</span>
    
        <span class="sidebar-tag-name" data-tags="ReactiveCocoa"><span class="iconfont-archer">&#xe606;</span>ReactiveCocoa</span>
    
        <span class="sidebar-tag-name" data-tags="book"><span class="iconfont-archer">&#xe606;</span>book</span>
    
        <span class="sidebar-tag-name" data-tags="Autolayout"><span class="iconfont-archer">&#xe606;</span>Autolayout</span>
    
        <span class="sidebar-tag-name" data-tags="SwiftUI"><span class="iconfont-archer">&#xe606;</span>SwiftUI</span>
    
        <span class="sidebar-tag-name" data-tags="Apple"><span class="iconfont-archer">&#xe606;</span>Apple</span>
    
        <span class="sidebar-tag-name" data-tags="Mach-O"><span class="iconfont-archer">&#xe606;</span>Mach-O</span>
    
        <span class="sidebar-tag-name" data-tags="JavaScript"><span class="iconfont-archer">&#xe606;</span>JavaScript</span>
    
        <span class="sidebar-tag-name" data-tags="Performance optimization"><span class="iconfont-archer">&#xe606;</span>Performance optimization</span>
    
        <span class="sidebar-tag-name" data-tags="GCD"><span class="iconfont-archer">&#xe606;</span>GCD</span>
    
        <span class="sidebar-tag-name" data-tags="runtime"><span class="iconfont-archer">&#xe606;</span>runtime</span>
    
        <span class="sidebar-tag-name" data-tags="Clang"><span class="iconfont-archer">&#xe606;</span>Clang</span>
    
        <span class="sidebar-tag-name" data-tags="WebKit"><span class="iconfont-archer">&#xe606;</span>WebKit</span>
    
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
    缺失模块。<br/>
    1、请确保node版本大于6.2<br/>
    2、在博客根目录（注意不是archer根目录）执行以下命令：<br/>
    <span style="color: #f75357; font-size: 1rem; line-height: 2rem;">npm i hexo-generator-json-content --save</span><br/>
    3、在根目录_config.yml里添加配置：
    <pre style="color: #787878; font-size: 0.6rem;">
jsonContent:
  meta: false
  pages: false
  posts:
    title: true
    date: true
    path: true
    text: false
    raw: false
    content: false
    slug: false
    updated: false
    comments: false
    link: false
    permalink: false
    excerpt: false
    categories: true
    tags: true</pre>
    </div> 
    <div class="sidebar-tags-list"></div>
</div>
        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
        <span class="sidebar-category-name" data-categories="Programming"><span class="iconfont-archer">&#xe60a;</span>Programming</span>
    
        <span class="sidebar-category-name" data-categories="My-novel"><span class="iconfont-archer">&#xe60a;</span>My-novel</span>
    
        <span class="sidebar-category-name" data-categories="My-painting"><span class="iconfont-archer">&#xe60a;</span>My-painting</span>
    
        <span class="sidebar-category-name" data-categories="travel"><span class="iconfont-archer">&#xe60a;</span>travel</span>
    
        <span class="sidebar-category-name" data-categories="APP"><span class="iconfont-archer">&#xe60a;</span>APP</span>
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>
    </div>
</div> 
    <script>
    var siteMeta = {
        root: "/",
        author: "戴铭"
    }
</script>
    <!-- CDN failover -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ === 'undefined')
        {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js">\x3C/script>')
        }
    </script>
    <script src="/scripts/main.js"></script>
    <!-- algolia -->
    
    <!-- busuanzi  -->
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    <!-- CNZZ  -->
    
    </div>
    <!-- async load share.js -->
    
        <script src="/scripts/share.js" async></script>    
     
    </body>
</html>


