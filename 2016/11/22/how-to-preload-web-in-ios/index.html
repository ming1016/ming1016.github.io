<!DOCTYPE html>
<html>
<meta  lang="zh-Hans" >
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#fff" id="theme-color">
  <link rel="icon" href="/img/logo-starming.png">
  <title>戴铭的博客</title>
  <script>
    // control reverse button
    var reverseDarkList = {
      dark: 'light',
      light: 'dark'
    };
    var themeColor = {
      dark: '#1c1c1e',
      light: '#fff'
    }
    // get the data of css prefers-color-scheme
    var getCssMediaQuery = function() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };
    // reverse current darkmode setting function
    var reverseDarkModeSetting = function() {
      var setting = localStorage.getItem('user-color-scheme');
      if(reverseDarkList[setting]) {
        setting = reverseDarkList[setting];
      } else if(setting === null) {
        setting = reverseDarkList[getCssMediaQuery()];
      } else {
        return;
      }
      localStorage.setItem('user-color-scheme', setting);
      return setting;
    };
    // apply current darkmode setting
    var setDarkmode = function(mode) {
      var setting = mode || localStorage.getItem('user-color-scheme');
      if(setting === getCssMediaQuery()) {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[setting];
      } else if(reverseDarkList[setting]) {
        document.documentElement.setAttribute('data-user-color-scheme', setting);
        document.getElementById('theme-color').content = themeColor[setting];
      } else {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[getCssMediaQuery()];
      }
    };
    setDarkmode();
  </script>
  <script>
    function loadScript(url, cb) {
      var script = document.createElement('script');
      script.src = url;
      if (cb) script.onload = cb;
      script.async = true;
      document.body.appendChild(script);
    }
  </script>
  
  <link rel="preload" href="//at.alicdn.com/t/font_1946621_vpj3dq9ceqa.css" as="style" >
  <link rel="preload" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css" as="style" >
  
  <link rel="preload" href="//cdn.jsdelivr.net/npm/fslightbox@3.1.0/index.min.js" as="script">
  
  
  <link rel="preload" href="/js/lib/lozad.min.js" as="script">
  
  
  
  
  
  
  
  
<link rel="stylesheet" href="/css/main.css">

  
  
<link rel="stylesheet" href="//at.alicdn.com/t/font_1946621_vpj3dq9ceqa.css">

  
  
<link rel="stylesheet" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css">

  
  
  
  
  
  <link href="/js/lib/prism/prism.min.css" rel="stylesheet" data-prism="prism">
  
  
  
<link rel="stylesheet" href="/js/lib/prism/prism-line-numbers.min.css">

  
  
  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  <div class="wrapper">
    
    <nav class="navbar">
  <div class="navbar-logo">
    <span class="navbar-logo-main">
      
      <img class="navbar-logo-img" src="/img/logo-starming.png">
      
      <span class="navbar-logo-dsc">戴铭的博客</span>
    </span>
  </div>
  <div class="navbar-menu">
    
    <a href="/" class="navbar-menu-item">首页 </a>
    
    <a href="/archives" class="navbar-menu-item">归档 </a>
    
    <a href="/tags" class="navbar-menu-item">标签 </a>
    
    <a href="/categories" class="navbar-menu-item">分类 </a>
    
    <a href="/about" class="navbar-menu-item">关于 </a>
    
    <a href="/friends" class="navbar-menu-item">友链 </a>
    
    <a class="navbar-menu-item darknavbar" id="dark"><i class="iconfont icon-weather"></i></a>
  </div>
</nav>
    
    <div class="section-wrap">
      <div class="container">
        <div class="columns">
          <main class="main-column">
<article class="card card-content">
  <header>
    <h1 class="post-title">
      iOS预加载Web页面方案
    </h1>
  </header>
  <div class="post-meta post-show-meta">
    <time datetime="2016-11-22T13:55:35.000Z" style="display: flex; align-items: center;">
      <i class="iconfont icon-calendar" style="margin-right: 2px;"></i>
      <span>2016-11-22</span>
    </time>
    
    <span class="dot"></span>
    
    <a href="/categories/Programming/" class="post-meta-link">Programming</a>
    
    
    
    <span class="dot"></span>
    <span>1.5k 字</span>
    
  </div>
  
  <div class="post-meta post-show-meta" style="margin-top: -10px;">
    <div style="display: flex; align-items: center;">
      <i class="iconfont icon-biaoqian" style="margin-right: 2px; font-size: 1.15rem;"></i>
      
      
        <a href="/tags/iOS/" class="post-meta-link">iOS</a>
      
      
      <span class="dot"></span>
      
        <a href="/tags/UIWebView/" class="post-meta-link">UIWebView</a>
      
      
      <span class="dot"></span>
      
        <a href="/tags/NSURLProtocol/" class="post-meta-link">NSURLProtocol</a>
      
    </div>
  </div>
  
  </header>
  <div id="section" class="post-content">
    <p>可以先下载Demo看看效果，Github地址：&lt; <a target="_blank" rel="noopener" href="https://github.com/ming1016/STMURLCache">GitHub - ming1016&#x2F;STMURLCache: iOS预加载Web页面方案</a> &gt;<br>可以预加载多个网址，然后在离线状态去显示那几个网址，看看是不是都完全缓存下来了。</p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p>在需要开启预加载的地方创建</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token keyword">self</span><span class="token punctuation">.</span>sCache <span class="token operator">=</span> <span class="token punctuation">[</span>STMURLCache create<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span>mk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    mk<span class="token punctuation">.</span><span class="token function">whiteListsHost</span><span class="token punctuation">(</span>whiteLists<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whiteUserAgent</span><span class="token punctuation">(</span><span class="token string">@"starming"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这里是所有可设置项目，默认设置可以查看 model 的 get 方法</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSUInteger<span class="token punctuation">)</span><span class="token punctuation">)</span> memoryCapacity<span class="token punctuation">;</span>   <span class="token comment">//内存容量</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSUInteger<span class="token punctuation">)</span><span class="token punctuation">)</span> diskCapacity<span class="token punctuation">;</span>     <span class="token comment">//本地存储容量</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSUInteger<span class="token punctuation">)</span><span class="token punctuation">)</span> cacheTime<span class="token punctuation">;</span>        <span class="token comment">//缓存时间</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> subDirectory<span class="token punctuation">;</span>     <span class="token comment">//子目录</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span><span class="token punctuation">)</span> isDownloadMode<span class="token punctuation">;</span>         <span class="token comment">//是否启动下载模式</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSArray <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> whiteListsHost<span class="token punctuation">;</span>    <span class="token comment">//域名白名单</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> whiteUserAgent<span class="token punctuation">;</span>   <span class="token comment">//WebView的user-agent白名单</span>

<span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> addHostWhiteList<span class="token punctuation">;</span>        <span class="token comment">//添加一个域名白名单</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> addRequestUrlWhiteList<span class="token punctuation">;</span>  <span class="token comment">//添加请求白名单</span>

<span class="token comment">//NSURLProtocol相关设置</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span><span class="token punctuation">)</span> isUsingURLProtocol<span class="token punctuation">;</span> <span class="token comment">//是否使用NSURLProtocol，默认使用NSURLCache</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>也可以随时更新这些设置项</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>sCache update<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span>mk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    mk<span class="token punctuation">.</span><span class="token function">isDownloadMode</span><span class="token punctuation">(</span>YES<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>预加载名单可以按照整个 web 页面请求进行预加载</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>sCache preLoadByWebViewWithUrls<span class="token punctuation">:</span><span class="token operator">@</span><span class="token punctuation">[</span><span class="token string">@"http://www.v2ex.com"</span><span class="token punctuation">,</span><span class="token string">@"http://www.github.com"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果需要按照单个资源列表进行预加载可以使用 <em>preLoadByRequestWithUrls</em> 这个方法。</p>
<h2 id="白名单设置"><a href="#白名单设置" class="headerlink" title="白名单设置"></a>白名单设置</h2><p>对于只希望缓存特定域名或者地址的可以通过白名单进行设置，可以在创建时进行设置或者更新时设置。</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec">NSString <span class="token operator">*</span>whiteListStr <span class="token operator">=</span> <span class="token string">@"www.starming.com|www.github.com|www.v2ex.com|www.baidu.com"</span><span class="token punctuation">;</span>
NSMutableArray <span class="token operator">*</span>whiteLists <span class="token operator">=</span> <span class="token punctuation">[</span>NSMutableArray arrayWithArray<span class="token punctuation">:</span><span class="token punctuation">[</span>whiteListStr componentsSeparatedByString<span class="token punctuation">:</span><span class="token string">@"|"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">self</span><span class="token punctuation">.</span>sCache <span class="token operator">=</span> <span class="token punctuation">[</span>STMURLCache create<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span>mk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    mk<span class="token punctuation">.</span><span class="token function">whiteListsHost</span><span class="token punctuation">(</span>whiteLists<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whiteUserAgent</span><span class="token punctuation">(</span><span class="token string">@"starming"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的 <em>whiteUserAgent</em> 的设置会设置 webview 的 UserAgent，这样能够让webview以外的网络请求被过滤掉。</p>
<h2 id="基本加载缓存实现原理"><a href="#基本加载缓存实现原理" class="headerlink" title="基本加载缓存实现原理"></a>基本加载缓存实现原理</h2><p>创建 <em>STMURLCache</em> 后设置 <em>NSURLCache</em> 的 <em>URLCache</em> ，在 <em>cachedResponseForRequest</em> 方法中获取 <em>NSURLRequest</em> 判断白名单，检验是否有与之对应的 Cache ，有就使用本地数据返回 <em>NSCachedURLResponse</em> ，没有就通过网络获取数据数据缓存。 <em>STMURLCache</em> 对象释放时将 <em>NSURLCache</em> 设置为不缓存，表示这次预加载完成不需要再缓存。当缓存空间超出设置大小会将其清空。</p>
<p>使用 <em>NSURLProtocol</em> 这种原理基本类似。</p>
<h2 id="白名单实现原理"><a href="#白名单实现原理" class="headerlink" title="白名单实现原理"></a>白名单实现原理</h2><p>创建域名列表设置项 <em>whiteListsHost</em> 和 <em>userAgent</em> 设置项，在创建和更新时对其进行设置。在网络请求开始通过设置项进行过滤。具体实现如下</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token comment">//对于域名白名单的过滤</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>whiteListsHost<span class="token punctuation">.</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    id isExist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>whiteListsHost objectForKey<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token keyword">self</span> hostFromRequest<span class="token punctuation">:</span>request<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isExist<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//User-Agent来过滤</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>whiteUserAgent<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    NSString <span class="token operator">*</span>uAgent <span class="token operator">=</span> <span class="token punctuation">[</span>request<span class="token punctuation">.</span>allHTTPHeaderFields objectForKey<span class="token punctuation">:</span><span class="token string">@"User-Agent"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>uAgent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span>uAgent hasSuffix<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>whiteUserAgent<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="具体缓存实现"><a href="#具体缓存实现" class="headerlink" title="具体缓存实现"></a>具体缓存实现</h2><p>缓存的实现有两种，一种是 <em>NSURLCache</em> 另一种是 <em>NSURLProtocol</em> ， <em>STMURLCache</em> 同时支持了这两种，通过 <em>STMURLCacheModel</em> 里的 <em>isUsingURLProtocol</em> 设置项来选择使用哪个。</p>
<h3 id="NSURLCache的实现"><a href="#NSURLCache的实现" class="headerlink" title="NSURLCache的实现"></a>NSURLCache的实现</h3><p>没有缓存的 request 会对其进行请求将获取数据按照hash地址存两份于本地，一份是数据，一份记录时间和类型，时间记录可以用于判断失效时间。对于判断是否有缓存可以根据请求地址对应的文件进行判断。具体实现如下：</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span>NSCachedURLResponse <span class="token operator">*</span><span class="token punctuation">)</span>localCacheResponeWithRequest<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLRequest <span class="token operator">*</span><span class="token punctuation">)</span>request <span class="token punctuation">&#123;</span>
    __block NSCachedURLResponse <span class="token operator">*</span>cachedResponse <span class="token operator">=</span> nil<span class="token punctuation">;</span>
    NSString <span class="token operator">*</span>filePath <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span> filePathFromRequest<span class="token punctuation">:</span>request isInfo<span class="token punctuation">:</span>NO<span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSString <span class="token operator">*</span>otherInfoPath <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span> filePathFromRequest<span class="token punctuation">:</span>request isInfo<span class="token punctuation">:</span>YES<span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSDate <span class="token operator">*</span>date <span class="token operator">=</span> <span class="token punctuation">[</span>NSDate date<span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSFileManager <span class="token operator">*</span>fm <span class="token operator">=</span> <span class="token punctuation">[</span>NSFileManager defaultManager<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>fm fileExistsAtPath<span class="token punctuation">:</span>filePath<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//有缓存文件的情况</span>
        BOOL expire <span class="token operator">=</span> false<span class="token punctuation">;</span>
        NSDictionary <span class="token operator">*</span>otherInfo <span class="token operator">=</span> <span class="token punctuation">[</span>NSDictionary dictionaryWithContentsOfFile<span class="token punctuation">:</span>otherInfoPath<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>cacheTime <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            NSInteger createTime <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>otherInfo objectForKey<span class="token punctuation">:</span><span class="token string">@"time"</span><span class="token punctuation">]</span> integerValue<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>createTime <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>cacheTime <span class="token operator">&lt;</span> <span class="token punctuation">[</span>date timeIntervalSince1970<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                expire <span class="token operator">=</span> true<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expire <span class="token operator">==</span> false<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//从缓存里读取数据</span>
            NSData <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">[</span>NSData dataWithContentsOfFile<span class="token punctuation">:</span>filePath<span class="token punctuation">]</span><span class="token punctuation">;</span>
            NSURLResponse <span class="token operator">*</span>response <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSURLResponse alloc<span class="token punctuation">]</span> initWithURL<span class="token punctuation">:</span>request<span class="token punctuation">.</span>URL MIMEType<span class="token punctuation">:</span><span class="token punctuation">[</span>otherInfo objectForKey<span class="token punctuation">:</span><span class="token string">@"MIMEType"</span><span class="token punctuation">]</span> expectedContentLength<span class="token punctuation">:</span>data<span class="token punctuation">.</span>length textEncodingName<span class="token punctuation">:</span><span class="token punctuation">[</span>otherInfo objectForKey<span class="token punctuation">:</span><span class="token string">@"textEncodingName"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            NSCachedURLResponse <span class="token operator">*</span>cachedResponse <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSCachedURLResponse alloc<span class="token punctuation">]</span> initWithResponse<span class="token punctuation">:</span>response data<span class="token punctuation">:</span>data<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> cachedResponse<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//cache失效了</span>
            <span class="token punctuation">[</span>fm removeItemAtPath<span class="token punctuation">:</span>filePath error<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment">//清除缓存data</span>
            <span class="token punctuation">[</span>fm removeItemAtPath<span class="token punctuation">:</span>otherInfoPath error<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//清除缓存其它信息</span>
            <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//从网络读取</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>isSavedOnDisk <span class="token operator">=</span> NO<span class="token punctuation">;</span>
        id isExist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>responseDic objectForKey<span class="token punctuation">:</span>request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>absoluteString<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isExist <span class="token operator">==</span> nil<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>responseDic setValue<span class="token punctuation">:</span><span class="token punctuation">[</span>NSNumber numberWithBool<span class="token punctuation">:</span>TRUE<span class="token punctuation">]</span> forKey<span class="token punctuation">:</span>request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>absoluteString<span class="token punctuation">]</span><span class="token punctuation">;</span>
            NSURLSession <span class="token operator">*</span>session <span class="token operator">=</span> <span class="token punctuation">[</span>NSURLSession sharedSession<span class="token punctuation">]</span><span class="token punctuation">;</span>
            NSURLSessionDataTask <span class="token operator">*</span>task <span class="token operator">=</span> <span class="token punctuation">[</span>session dataTaskWithRequest<span class="token punctuation">:</span>request completionHandler<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>NSData <span class="token operator">*</span> _Nullable data<span class="token punctuation">,</span> NSURLResponse <span class="token operator">*</span> _Nullable response<span class="token punctuation">,</span> NSError <span class="token operator">*</span> _Nullable error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    cachedResponse <span class="token operator">=</span> nil<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    NSDictionary <span class="token operator">*</span>dic <span class="token operator">=</span> <span class="token punctuation">[</span>NSDictionary dictionaryWithObjectsAndKeys<span class="token punctuation">:</span><span class="token punctuation">[</span>NSString stringWithFormat<span class="token punctuation">:</span><span class="token string">@"%f"</span><span class="token punctuation">,</span><span class="token punctuation">[</span>date timeIntervalSince1970<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">@"time"</span><span class="token punctuation">,</span>response<span class="token punctuation">.</span>MIMEType<span class="token punctuation">,</span><span class="token string">@"MIMEType"</span><span class="token punctuation">,</span>response<span class="token punctuation">.</span>textEncodingName<span class="token punctuation">,</span><span class="token string">@"textEncodingName"</span><span class="token punctuation">,</span> nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    BOOL resultO <span class="token operator">=</span> <span class="token punctuation">[</span>dic writeToFile<span class="token punctuation">:</span>otherInfoPath atomically<span class="token punctuation">:</span>YES<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    BOOL result <span class="token operator">=</span> <span class="token punctuation">[</span>data writeToFile<span class="token punctuation">:</span>filePath atomically<span class="token punctuation">:</span>YES<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>resultO <span class="token operator">==</span> NO <span class="token operator">||</span> result <span class="token operator">==</span> NO<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token punctuation">&#125;</span>
                    cachedResponse <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSCachedURLResponse alloc<span class="token punctuation">]</span> initWithResponse<span class="token punctuation">:</span>response data<span class="token punctuation">:</span>data<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span>task resume<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> cachedResponse<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="NSURLProtocol的实现"><a href="#NSURLProtocol的实现" class="headerlink" title="NSURLProtocol的实现"></a>NSURLProtocol的实现</h3><p>在设置配置项和更新配置项时需要创建一个 <em>STMURLCacheModel</em> 的单例来进行设置和更新配置项给 NSURLProtocol 的实现来使用。通过 isUsingURLProtocol 设置项区分， NSURLProtocol 是通过registerClass方式将protocol实现的进行注册。</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCache <span class="token operator">*</span><span class="token punctuation">)</span>configWithMk <span class="token punctuation">&#123;</span>

    <span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>isSavedOnDisk <span class="token operator">=</span> YES<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>isUsingURLProtocol<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        STMURLCacheModel <span class="token operator">*</span>sModel <span class="token operator">=</span> <span class="token punctuation">[</span>STMURLCacheModel shareInstance<span class="token punctuation">]</span><span class="token punctuation">;</span>
        sModel<span class="token punctuation">.</span>cacheTime <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>cacheTime<span class="token punctuation">;</span>
        sModel<span class="token punctuation">.</span>diskCapacity <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>diskCapacity<span class="token punctuation">;</span>
        sModel<span class="token punctuation">.</span>diskPath <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>diskPath<span class="token punctuation">;</span>
        sModel<span class="token punctuation">.</span>cacheFolder <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>cacheFolder<span class="token punctuation">;</span>
        sModel<span class="token punctuation">.</span>subDirectory <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>subDirectory<span class="token punctuation">;</span>
        sModel<span class="token punctuation">.</span>whiteUserAgent <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>whiteUserAgent<span class="token punctuation">;</span>
        sModel<span class="token punctuation">.</span>whiteListsHost <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>whiteListsHost<span class="token punctuation">;</span>
        <span class="token punctuation">[</span>NSURLProtocol registerClass<span class="token punctuation">:</span><span class="token punctuation">[</span>STMURLProtocol class<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">[</span>NSURLCache setSharedURLCache<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>关闭时两者也是不同的，通过设置项进行区分</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>stop <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>isUsingURLProtocol<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">[</span>NSURLProtocol unregisterClass<span class="token punctuation">:</span><span class="token punctuation">[</span>STMURLProtocol class<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        NSURLCache <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSURLCache alloc<span class="token punctuation">]</span> initWithMemoryCapacity<span class="token punctuation">:</span><span class="token number">0</span> diskCapacity<span class="token punctuation">:</span><span class="token number">0</span> diskPath<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>NSURLCache setSharedURLCache<span class="token punctuation">:</span>c<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel checkCapacity<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>白名单处理还有读取缓存和前者都类似，但是在缓存Data时 <em>NSURLCached</em> 的方案里是通过发起一次新的请求来获取数据，而 <em>NSURLProtocol</em> 在 <em>NSURLConnection</em> 的 Delegate 里可以获取到，少了一次网络的请求，这里需要注意的是在 - (void) connection:(NSURLConnection *)connection didReceiveData:(NSData *)data 每次从这个回调里获取的数据不是完整的，要在 - (void) connectionDidFinishLoading:(NSURLConnection *)connection 这个会调里将分段数据拼接成完整的数据保存下来。具体完整的代码实现可以看 STMURLProtocol 里的代码实现。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>通过 <em>map</em> 网络请求可以缓存请求，也可以 <em>mock</em> 接口请求进行测试。</p>
<p>完整代码：&lt; <a target="_blank" rel="noopener" href="https://github.com/ming1016/STMURLCache">GitHub - ming1016&#x2F;STMURLCache: iOS预加载Web页面方案</a> &gt;</p>

  </div>
  <div>
  
  <div class="post-note note-warning copyright" style="margin-top: 42px">
    <p><span style="font-weight: bold;">作者：</span><a target="_blank" rel="nofollow noopener noreferrer" href="https://starming.com/about">戴铭</a></p>
    <p><span style="font-weight: bold;">文章链接：</span><a target="_blank" rel="nofollow noopener noreferrer" href="https://starming.com/2016/11/22/how-to-preload-web-in-ios/">https://starming.com/2016/11/22/how-to-preload-web-in-ios/</a></p>
    <p><span style="font-weight: bold;">版权声明：</span>本博客所有文章除特别声明外，均采用<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0 协议</a>。转载请注明出处！</p>
  </div>
  
  </div>
</article>
<div class="nav">
  
  <div class="nav-item-prev">
    <a href="/2017/03/01/deeply-analyse-llvm/" class="nav-link">
      <i class="iconfont icon-left nav-prev-icon"></i>
      <div>
        <div class="nav-label">上一篇</div>
        
        <div class="nav-title">深入剖析 iOS 编译 Clang / LLVM </div>
        
      </div>
    </a>
  </div>
  
  
  <div class="nav-item-next">
    <a href="/2016/11/17/use-swift3-build-macos-program-to-clear-unuse-method/" class="nav-link">
      <div>
        <div class="nav-label">下一篇</div>
        
        <div class="nav-title">使用Swift3开发了个macOS的程序可以检测出objc项目中无用方法，然后一键全部清理 </div>
        
      </div>
      <i class="iconfont icon-right nav-next-icon"></i>
    </a>
  </div>
  
</div>

<div class="card card-content toc-card" id="mobiletoc">
  <div class="toc-header"><i class="iconfont icon-menu" style="padding-right: 2px;"></i>目录</div>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.</span> <span class="toc-text">使用方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E5%90%8D%E5%8D%95%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">白名单设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%8A%A0%E8%BD%BD%E7%BC%93%E5%AD%98%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">基本加载缓存实现原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E5%90%8D%E5%8D%95%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">白名单实现原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E7%BC%93%E5%AD%98%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">具体缓存实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NSURLCache%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.1.</span> <span class="toc-text">NSURLCache的实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSURLProtocol%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.2.</span> <span class="toc-text">NSURLProtocol的实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-number">6.</span> <span class="toc-text">后记</span></a></li></ol>
</div></main>
          <aside class="left-column">
            
            <div class="card card-author">
              
<img src="/img/ming.jpeg" class="author-img">

<p class="author-name">戴铭</p>
<p class="author-description">极客时间《iOS开发高手课》和纸书《跟戴铭学iOS编程》作者</p>
<div class="author-message">
  <a class="author-posts-count" href="/archives">
    <span>80</span>
    <span>文章</span>
  </a>
  <a class="author-categories-count" href="/categories">
    <span>9</span>
    <span>分类</span>
  </a>
  <a class="author-tags-count" href="/tags">
    <span>45</span>
    <span>标签</span>
  </a>
</div>

<div class="author-card-society">
  
    <div class="author-card-society-icon">
      <a target="_blank" rel="noopener" href="https://weibo.com/allstarming">
        <i class="iconfont icon-sina society-icon"></i>
      </a>
    </div>
  
    <div class="author-card-society-icon">
      <a target="_blank" rel="noopener" href="https://github.com/ming1016">
        <i class="iconfont icon-github society-icon"></i>
      </a>
    </div>
  
    <div class="author-card-society-icon">
      <a href="mailto:ming1016@foxmail.com">
        <i class="iconfont icon-mail society-icon"></i>
      </a>
    </div>
  
    <div class="author-card-society-icon">
      <a href="/atom.xml">
        <i class="iconfont icon-chrome society-icon"></i>
      </a>
    </div>
  
</div>

            </div>
            
            <div class="sticky-tablet">
  
  
  <article class="display-when-two-columns spacer">
    <div class="card card-content toc-card">
      <div class="toc-header"><i class="iconfont icon-menu" style="padding-right: 2px;"></i>目录</div>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.</span> <span class="toc-text">使用方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E5%90%8D%E5%8D%95%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">白名单设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%8A%A0%E8%BD%BD%E7%BC%93%E5%AD%98%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">基本加载缓存实现原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E5%90%8D%E5%8D%95%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">白名单实现原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E7%BC%93%E5%AD%98%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">具体缓存实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NSURLCache%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.1.</span> <span class="toc-text">NSURLCache的实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSURLProtocol%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.2.</span> <span class="toc-text">NSURLProtocol的实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-number">6.</span> <span class="toc-text">后记</span></a></li></ol>
    </div>
  </article>
  
  
  <article class="card card-content">
    <div class="categories-card">
  <div class="categories-header"><i class="iconfont icon-fenlei" style="padding-right: 2px;"></i>分类</div>
  <div class="categories-list">
    
      <a href="/categories/Programming">
        <div class="categories-list-item">
          Programming
          <span class="categories-list-item-badge">50</span>
        </div>
      </a>
    
      <a href="/categories/My-novel">
        <div class="categories-list-item">
          My-novel
          <span class="categories-list-item-badge">4</span>
        </div>
      </a>
    
      <a href="/categories/My-painting">
        <div class="categories-list-item">
          My-painting
          <span class="categories-list-item-badge">8</span>
        </div>
      </a>
    
      <a href="/categories/Podcast">
        <div class="categories-list-item">
          Podcast
          <span class="categories-list-item-badge">3</span>
        </div>
      </a>
    
      <a href="/categories/App">
        <div class="categories-list-item">
          App
          <span class="categories-list-item-badge">11</span>
        </div>
      </a>
    
      <a href="/categories/travel">
        <div class="categories-list-item">
          travel
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/AI">
        <div class="categories-list-item">
          AI
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/macOS">
        <div class="categories-list-item">
          macOS
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/Game">
        <div class="categories-list-item">
          Game
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
  </div>
</div>
  </article>
  
  <article class="card card-content">
    <div class="tags-card">
  <div class="tags-header"><i class="iconfont icon-biaoqian" style="padding-right: 2px;"></i>热门标签</div>
  <div class="tags-list">
    
    <a href="\tags\iOS" title="iOS"><div class="tags-list-item">iOS</div></a>
    
    <a href="\tags\Swift" title="Swift"><div class="tags-list-item">Swift</div></a>
    
    <a href="\tags\Apple" title="Apple"><div class="tags-list-item">Apple</div></a>
    
    <a href="\tags\SwiftUI" title="SwiftUI"><div class="tags-list-item">SwiftUI</div></a>
    
    <a href="\tags\Painting" title="Painting"><div class="tags-list-item">Painting</div></a>
    
    <a href="\tags\Slides" title="Slides"><div class="tags-list-item">Slides</div></a>
    
    <a href="\tags\App" title="App"><div class="tags-list-item">App</div></a>
    
    <a href="\tags\iPad" title="iPad"><div class="tags-list-item">iPad</div></a>
    
    <a href="\tags\Procreate" title="Procreate"><div class="tags-list-item">Procreate</div></a>
    
    <a href="\tags\LLVM" title="LLVM"><div class="tags-list-item">LLVM</div></a>
    
    <a href="\tags\Performance optimization" title="Performance optimization"><div class="tags-list-item">Performance optimization</div></a>
    
    <a href="\tags\Web" title="Web"><div class="tags-list-item">Web</div></a>
    
    <a href="\tags\Novel" title="Novel"><div class="tags-list-item">Novel</div></a>
    
    <a href="\tags\Manga" title="Manga"><div class="tags-list-item">Manga</div></a>
    
    <a href="\tags\Podcast" title="Podcast"><div class="tags-list-item">Podcast</div></a>
    
    <a href="\tags\macOS" title="macOS"><div class="tags-list-item">macOS</div></a>
    
  </div>
</div>
  </article>
  
  
</div>
          </aside>
          <aside class="right-column">
            <div class="sticky-widescreen">
  
  
  <article class="card card-content toc-card">
    <div class="toc-header"><i class="iconfont icon-menu" style="padding-right: 2px;"></i>目录</div>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.</span> <span class="toc-text">使用方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E5%90%8D%E5%8D%95%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">白名单设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%8A%A0%E8%BD%BD%E7%BC%93%E5%AD%98%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">基本加载缓存实现原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E5%90%8D%E5%8D%95%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">白名单实现原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E7%BC%93%E5%AD%98%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">具体缓存实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NSURLCache%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.1.</span> <span class="toc-text">NSURLCache的实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSURLProtocol%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.2.</span> <span class="toc-text">NSURLProtocol的实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-number">6.</span> <span class="toc-text">后记</span></a></li></ol>
  </article>
  
  
  <article class="card card-content">
    <div class="recent-posts-card">
  <div class="recent-posts-header"><i class="iconfont icon-wenzhang_huaban" style="padding-right: 2px;"></i>最近文章</div>
  <div class="recent-posts-list">
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2025-05-23</div>
        <a href="/2025/05/23/in-depth-analysis-pokemon-universe/"><div class="recent-posts-item-content">宝可梦宇宙全揭秘：从皮卡丘到千种精灵，入门玩法、进化对战与全球现象深度解析</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2025-05-05</div>
        <a href="/2025/05/05/pamphlet-app667/"><div class="recent-posts-item-content">憋了个大招！《戴铭的小册子》6.6.7 版：不止搞开发，这次玩儿大了！</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2025-03-06</div>
        <a href="/2025/03/06/letsvision25-ai-improve-ios-skill/"><div class="recent-posts-item-content">使用 AI 突破 iOS 开发者能力边界</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2025-02-18</div>
        <a href="/2025/02/18/macos-app-i-used/"><div class="recent-posts-item-content">2025 年我正在使用的 macOS 应用</div></a>
      </div>
    
  </div>
</div>
  </article>
  
  
</div>
          </aside>
        </div>
      </div>
    </div>
  </div>
  
  <footer class="footer">
  <div class="footer-container">
    <div>
      <div class="footer-dsc">
        <span>Copyright ©
          
          2014 -
          
          2025
        </span>
        <a href="/" class="footer-link">戴铭的博客 </a>
      </div>
    </div>

    
    
    
    <div class="BbeiAn-info">
      <a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">京ICP备2024068292号-1 </a>
    </div>
    
    <div class="BbeiAn-info">
      <span style="padding-left: 25px;background: url(/img/beian.png) no-repeat left center"></span>
      <a target="_blank" rel="noopener" href="https://beian.mps.gov.cn/#/query/webSearch?code=11010802044427 ">京公网安备11010802044427
      </a>
      <br />
    </div>
    
    
    
      <div class="footer-dsc">
        
        本站总访问量<span id="busuanzi_value_site_pv"></span>次
        
        
        <span>&nbsp;|&nbsp;</span>
        
        
        本站总访客数<span id="busuanzi_value_site_uv"></span>次
        
      </div>
      
    
</footer>
  <a role="button" id="scrollbutton" class="basebutton" >
  <i class="iconfont icon-arrowleft button-icon"></i>
</a>
<a role="button" id="menubutton" class="basebutton">
  <i class="iconfont icon-menu button-icon"></i>
</a>
<a role="button" id="popbutton" class="basebutton">
  <i class="iconfont icon-expand button-icon"></i>
</a>
<a role="button" id="darkbutton" class="basebutton darkwidget">
  <i class="iconfont icon-weather button-icon"></i>
</a>

  
  
  
  <script>
  var addImgLayout = function () {
    var img = document.querySelectorAll('.post-content img');
    var i;
    for (i = 0; i < img.length; i++) {
      var wrapper = document.createElement('a');
      wrapper.setAttribute('data-fslightbox', 'gallery');
      wrapper.setAttribute('href', img[i].getAttribute('data-src'));
      wrapper.setAttribute('style', 'width: 100%; display: flex; justify-content: center;');
      img[i].parentElement.insertBefore(wrapper, img[i]);
      wrapper.appendChild(img[i]);
    }
    refreshFsLightbox();
  }
</script>
<script>loadScript("//cdn.jsdelivr.net/npm/fslightbox@3.1.0/index.min.js", addImgLayout)</script>
  
  
  
<script src="/js/main.js"></script>

  
  <script>loadScript("/js/lib/busuanzi.min.js")</script>
  
  
  <script>
    var addLazyload = function () {
      var observer = lozad('.lozad', {
        load: function (el) {
          el.srcset = el.getAttribute('data-src');
        },
        loaded: function (el) {
          el.classList.add('loaded');
        }
      });
      observer.observe();
    }
  </script>
  <script>loadScript("/js/lib/lozad.min.js", addLazyload)</script>
  
  
</body>

</html>