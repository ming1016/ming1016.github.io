<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="前滴滴出行技术专家。极客时间《iOS开发高手课》和纸书《跟戴铭学iOS编程》作者。个人博客：戴铭的博客。微信公共号：starming-weixin。微博：@戴铭">
    <meta name="author" content="戴铭">
    
    <title>
        
            iOS预加载Web页面方案 |
        
        戴铭的博客
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/img/logo-starming.png">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"ming1016.github.io","root":"/","language":"zh-Hans"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/img/ming.jpeg","favicon":"/img/logo-starming.png","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":null,"description":"混乱中的有序"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":false,"preload":false},"code_copy":{"enable":false,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                戴铭的博客
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                CATEGORIES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                </ul>
            </div>
            <div class="mobile">
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">CATEGORIES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">iOS预加载Web页面方案</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/img/ming.jpeg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">戴铭</span>
                        
                            <span class="author-label">Lv4</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2016-11-22 21:55:35</span>
        <span class="mobile">2016-11-22 21:55</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Programming/">Programming</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/iOS/">iOS</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/UIWebView/">UIWebView</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/NSURLProtocol/">NSURLProtocol</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>1.5k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>6 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p>可以先下载Demo看看效果，Github地址：&lt; <a target="_blank" rel="noopener" href="https://github.com/ming1016/STMURLCache">GitHub - ming1016&#x2F;STMURLCache: iOS预加载Web页面方案</a> &gt;<br>可以预加载多个网址，然后在离线状态去显示那几个网址，看看是不是都完全缓存下来了。</p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p>在需要开启预加载的地方创建</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token keyword">self</span><span class="token punctuation">.</span>sCache <span class="token operator">=</span> <span class="token punctuation">[</span>STMURLCache create<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span>mk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    mk<span class="token punctuation">.</span><span class="token function">whiteListsHost</span><span class="token punctuation">(</span>whiteLists<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whiteUserAgent</span><span class="token punctuation">(</span><span class="token string">@"starming"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这里是所有可设置项目，默认设置可以查看 model 的 get 方法</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSUInteger<span class="token punctuation">)</span><span class="token punctuation">)</span> memoryCapacity<span class="token punctuation">;</span>   <span class="token comment">//内存容量</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSUInteger<span class="token punctuation">)</span><span class="token punctuation">)</span> diskCapacity<span class="token punctuation">;</span>     <span class="token comment">//本地存储容量</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSUInteger<span class="token punctuation">)</span><span class="token punctuation">)</span> cacheTime<span class="token punctuation">;</span>        <span class="token comment">//缓存时间</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> subDirectory<span class="token punctuation">;</span>     <span class="token comment">//子目录</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span><span class="token punctuation">)</span> isDownloadMode<span class="token punctuation">;</span>         <span class="token comment">//是否启动下载模式</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSArray <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> whiteListsHost<span class="token punctuation">;</span>    <span class="token comment">//域名白名单</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> whiteUserAgent<span class="token punctuation">;</span>   <span class="token comment">//WebView的user-agent白名单</span>

<span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> addHostWhiteList<span class="token punctuation">;</span>        <span class="token comment">//添加一个域名白名单</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> addRequestUrlWhiteList<span class="token punctuation">;</span>  <span class="token comment">//添加请求白名单</span>

<span class="token comment">//NSURLProtocol相关设置</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span><span class="token punctuation">)</span> isUsingURLProtocol<span class="token punctuation">;</span> <span class="token comment">//是否使用NSURLProtocol，默认使用NSURLCache</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>也可以随时更新这些设置项</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>sCache update<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span>mk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    mk<span class="token punctuation">.</span><span class="token function">isDownloadMode</span><span class="token punctuation">(</span>YES<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>预加载名单可以按照整个 web 页面请求进行预加载</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>sCache preLoadByWebViewWithUrls<span class="token punctuation">:</span><span class="token operator">@</span><span class="token punctuation">[</span><span class="token string">@"http://www.v2ex.com"</span><span class="token punctuation">,</span><span class="token string">@"http://www.github.com"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果需要按照单个资源列表进行预加载可以使用 <em>preLoadByRequestWithUrls</em> 这个方法。</p>
<h2 id="白名单设置"><a href="#白名单设置" class="headerlink" title="白名单设置"></a>白名单设置</h2><p>对于只希望缓存特定域名或者地址的可以通过白名单进行设置，可以在创建时进行设置或者更新时设置。</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec">NSString <span class="token operator">*</span>whiteListStr <span class="token operator">=</span> <span class="token string">@"www.starming.com|www.github.com|www.v2ex.com|www.baidu.com"</span><span class="token punctuation">;</span>
NSMutableArray <span class="token operator">*</span>whiteLists <span class="token operator">=</span> <span class="token punctuation">[</span>NSMutableArray arrayWithArray<span class="token punctuation">:</span><span class="token punctuation">[</span>whiteListStr componentsSeparatedByString<span class="token punctuation">:</span><span class="token string">@"|"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">self</span><span class="token punctuation">.</span>sCache <span class="token operator">=</span> <span class="token punctuation">[</span>STMURLCache create<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>STMURLCacheMk <span class="token operator">*</span>mk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    mk<span class="token punctuation">.</span><span class="token function">whiteListsHost</span><span class="token punctuation">(</span>whiteLists<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whiteUserAgent</span><span class="token punctuation">(</span><span class="token string">@"starming"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的 <em>whiteUserAgent</em> 的设置会设置 webview 的 UserAgent，这样能够让webview以外的网络请求被过滤掉。</p>
<h2 id="基本加载缓存实现原理"><a href="#基本加载缓存实现原理" class="headerlink" title="基本加载缓存实现原理"></a>基本加载缓存实现原理</h2><p>创建 <em>STMURLCache</em> 后设置 <em>NSURLCache</em> 的 <em>URLCache</em> ，在 <em>cachedResponseForRequest</em> 方法中获取 <em>NSURLRequest</em> 判断白名单，检验是否有与之对应的 Cache ，有就使用本地数据返回 <em>NSCachedURLResponse</em> ，没有就通过网络获取数据数据缓存。 <em>STMURLCache</em> 对象释放时将 <em>NSURLCache</em> 设置为不缓存，表示这次预加载完成不需要再缓存。当缓存空间超出设置大小会将其清空。</p>
<p>使用 <em>NSURLProtocol</em> 这种原理基本类似。</p>
<h2 id="白名单实现原理"><a href="#白名单实现原理" class="headerlink" title="白名单实现原理"></a>白名单实现原理</h2><p>创建域名列表设置项 <em>whiteListsHost</em> 和 <em>userAgent</em> 设置项，在创建和更新时对其进行设置。在网络请求开始通过设置项进行过滤。具体实现如下</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token comment">//对于域名白名单的过滤</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>whiteListsHost<span class="token punctuation">.</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    id isExist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>whiteListsHost objectForKey<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token keyword">self</span> hostFromRequest<span class="token punctuation">:</span>request<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isExist<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//User-Agent来过滤</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>whiteUserAgent<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    NSString <span class="token operator">*</span>uAgent <span class="token operator">=</span> <span class="token punctuation">[</span>request<span class="token punctuation">.</span>allHTTPHeaderFields objectForKey<span class="token punctuation">:</span><span class="token string">@"User-Agent"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>uAgent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span>uAgent hasSuffix<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>whiteUserAgent<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="具体缓存实现"><a href="#具体缓存实现" class="headerlink" title="具体缓存实现"></a>具体缓存实现</h2><p>缓存的实现有两种，一种是 <em>NSURLCache</em> 另一种是 <em>NSURLProtocol</em> ， <em>STMURLCache</em> 同时支持了这两种，通过 <em>STMURLCacheModel</em> 里的 <em>isUsingURLProtocol</em> 设置项来选择使用哪个。</p>
<h3 id="NSURLCache的实现"><a href="#NSURLCache的实现" class="headerlink" title="NSURLCache的实现"></a>NSURLCache的实现</h3><p>没有缓存的 request 会对其进行请求将获取数据按照hash地址存两份于本地，一份是数据，一份记录时间和类型，时间记录可以用于判断失效时间。对于判断是否有缓存可以根据请求地址对应的文件进行判断。具体实现如下：</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span>NSCachedURLResponse <span class="token operator">*</span><span class="token punctuation">)</span>localCacheResponeWithRequest<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLRequest <span class="token operator">*</span><span class="token punctuation">)</span>request <span class="token punctuation">&#123;</span>
    __block NSCachedURLResponse <span class="token operator">*</span>cachedResponse <span class="token operator">=</span> nil<span class="token punctuation">;</span>
    NSString <span class="token operator">*</span>filePath <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span> filePathFromRequest<span class="token punctuation">:</span>request isInfo<span class="token punctuation">:</span>NO<span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSString <span class="token operator">*</span>otherInfoPath <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span> filePathFromRequest<span class="token punctuation">:</span>request isInfo<span class="token punctuation">:</span>YES<span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSDate <span class="token operator">*</span>date <span class="token operator">=</span> <span class="token punctuation">[</span>NSDate date<span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSFileManager <span class="token operator">*</span>fm <span class="token operator">=</span> <span class="token punctuation">[</span>NSFileManager defaultManager<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>fm fileExistsAtPath<span class="token punctuation">:</span>filePath<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//有缓存文件的情况</span>
        BOOL expire <span class="token operator">=</span> false<span class="token punctuation">;</span>
        NSDictionary <span class="token operator">*</span>otherInfo <span class="token operator">=</span> <span class="token punctuation">[</span>NSDictionary dictionaryWithContentsOfFile<span class="token punctuation">:</span>otherInfoPath<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>cacheTime <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            NSInteger createTime <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>otherInfo objectForKey<span class="token punctuation">:</span><span class="token string">@"time"</span><span class="token punctuation">]</span> integerValue<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>createTime <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>cacheTime <span class="token operator">&lt;</span> <span class="token punctuation">[</span>date timeIntervalSince1970<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                expire <span class="token operator">=</span> true<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expire <span class="token operator">==</span> false<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//从缓存里读取数据</span>
            NSData <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">[</span>NSData dataWithContentsOfFile<span class="token punctuation">:</span>filePath<span class="token punctuation">]</span><span class="token punctuation">;</span>
            NSURLResponse <span class="token operator">*</span>response <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSURLResponse alloc<span class="token punctuation">]</span> initWithURL<span class="token punctuation">:</span>request<span class="token punctuation">.</span>URL MIMEType<span class="token punctuation">:</span><span class="token punctuation">[</span>otherInfo objectForKey<span class="token punctuation">:</span><span class="token string">@"MIMEType"</span><span class="token punctuation">]</span> expectedContentLength<span class="token punctuation">:</span>data<span class="token punctuation">.</span>length textEncodingName<span class="token punctuation">:</span><span class="token punctuation">[</span>otherInfo objectForKey<span class="token punctuation">:</span><span class="token string">@"textEncodingName"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            NSCachedURLResponse <span class="token operator">*</span>cachedResponse <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSCachedURLResponse alloc<span class="token punctuation">]</span> initWithResponse<span class="token punctuation">:</span>response data<span class="token punctuation">:</span>data<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> cachedResponse<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//cache失效了</span>
            <span class="token punctuation">[</span>fm removeItemAtPath<span class="token punctuation">:</span>filePath error<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment">//清除缓存data</span>
            <span class="token punctuation">[</span>fm removeItemAtPath<span class="token punctuation">:</span>otherInfoPath error<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//清除缓存其它信息</span>
            <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//从网络读取</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>isSavedOnDisk <span class="token operator">=</span> NO<span class="token punctuation">;</span>
        id isExist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>responseDic objectForKey<span class="token punctuation">:</span>request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>absoluteString<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isExist <span class="token operator">==</span> nil<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>responseDic setValue<span class="token punctuation">:</span><span class="token punctuation">[</span>NSNumber numberWithBool<span class="token punctuation">:</span>TRUE<span class="token punctuation">]</span> forKey<span class="token punctuation">:</span>request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>absoluteString<span class="token punctuation">]</span><span class="token punctuation">;</span>
            NSURLSession <span class="token operator">*</span>session <span class="token operator">=</span> <span class="token punctuation">[</span>NSURLSession sharedSession<span class="token punctuation">]</span><span class="token punctuation">;</span>
            NSURLSessionDataTask <span class="token operator">*</span>task <span class="token operator">=</span> <span class="token punctuation">[</span>session dataTaskWithRequest<span class="token punctuation">:</span>request completionHandler<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>NSData <span class="token operator">*</span> _Nullable data<span class="token punctuation">,</span> NSURLResponse <span class="token operator">*</span> _Nullable response<span class="token punctuation">,</span> NSError <span class="token operator">*</span> _Nullable error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    cachedResponse <span class="token operator">=</span> nil<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    NSDictionary <span class="token operator">*</span>dic <span class="token operator">=</span> <span class="token punctuation">[</span>NSDictionary dictionaryWithObjectsAndKeys<span class="token punctuation">:</span><span class="token punctuation">[</span>NSString stringWithFormat<span class="token punctuation">:</span><span class="token string">@"%f"</span><span class="token punctuation">,</span><span class="token punctuation">[</span>date timeIntervalSince1970<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">@"time"</span><span class="token punctuation">,</span>response<span class="token punctuation">.</span>MIMEType<span class="token punctuation">,</span><span class="token string">@"MIMEType"</span><span class="token punctuation">,</span>response<span class="token punctuation">.</span>textEncodingName<span class="token punctuation">,</span><span class="token string">@"textEncodingName"</span><span class="token punctuation">,</span> nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    BOOL resultO <span class="token operator">=</span> <span class="token punctuation">[</span>dic writeToFile<span class="token punctuation">:</span>otherInfoPath atomically<span class="token punctuation">:</span>YES<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    BOOL result <span class="token operator">=</span> <span class="token punctuation">[</span>data writeToFile<span class="token punctuation">:</span>filePath atomically<span class="token punctuation">:</span>YES<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>resultO <span class="token operator">==</span> NO <span class="token operator">||</span> result <span class="token operator">==</span> NO<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token punctuation">&#125;</span>
                    cachedResponse <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSCachedURLResponse alloc<span class="token punctuation">]</span> initWithResponse<span class="token punctuation">:</span>response data<span class="token punctuation">:</span>data<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span>task resume<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> cachedResponse<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="NSURLProtocol的实现"><a href="#NSURLProtocol的实现" class="headerlink" title="NSURLProtocol的实现"></a>NSURLProtocol的实现</h3><p>在设置配置项和更新配置项时需要创建一个 <em>STMURLCacheModel</em> 的单例来进行设置和更新配置项给 NSURLProtocol 的实现来使用。通过 isUsingURLProtocol 设置项区分， NSURLProtocol 是通过registerClass方式将protocol实现的进行注册。</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span>STMURLCache <span class="token operator">*</span><span class="token punctuation">)</span>configWithMk <span class="token punctuation">&#123;</span>

    <span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>isSavedOnDisk <span class="token operator">=</span> YES<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>isUsingURLProtocol<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        STMURLCacheModel <span class="token operator">*</span>sModel <span class="token operator">=</span> <span class="token punctuation">[</span>STMURLCacheModel shareInstance<span class="token punctuation">]</span><span class="token punctuation">;</span>
        sModel<span class="token punctuation">.</span>cacheTime <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>cacheTime<span class="token punctuation">;</span>
        sModel<span class="token punctuation">.</span>diskCapacity <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>diskCapacity<span class="token punctuation">;</span>
        sModel<span class="token punctuation">.</span>diskPath <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>diskPath<span class="token punctuation">;</span>
        sModel<span class="token punctuation">.</span>cacheFolder <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>cacheFolder<span class="token punctuation">;</span>
        sModel<span class="token punctuation">.</span>subDirectory <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>subDirectory<span class="token punctuation">;</span>
        sModel<span class="token punctuation">.</span>whiteUserAgent <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>whiteUserAgent<span class="token punctuation">;</span>
        sModel<span class="token punctuation">.</span>whiteListsHost <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>whiteListsHost<span class="token punctuation">;</span>
        <span class="token punctuation">[</span>NSURLProtocol registerClass<span class="token punctuation">:</span><span class="token punctuation">[</span>STMURLProtocol class<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">[</span>NSURLCache setSharedURLCache<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>关闭时两者也是不同的，通过设置项进行区分</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>stop <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel<span class="token punctuation">.</span>isUsingURLProtocol<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">[</span>NSURLProtocol unregisterClass<span class="token punctuation">:</span><span class="token punctuation">[</span>STMURLProtocol class<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        NSURLCache <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSURLCache alloc<span class="token punctuation">]</span> initWithMemoryCapacity<span class="token punctuation">:</span><span class="token number">0</span> diskCapacity<span class="token punctuation">:</span><span class="token number">0</span> diskPath<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>NSURLCache setSharedURLCache<span class="token punctuation">:</span>c<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>mk<span class="token punctuation">.</span>cModel checkCapacity<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>白名单处理还有读取缓存和前者都类似，但是在缓存Data时 <em>NSURLCached</em> 的方案里是通过发起一次新的请求来获取数据，而 <em>NSURLProtocol</em> 在 <em>NSURLConnection</em> 的 Delegate 里可以获取到，少了一次网络的请求，这里需要注意的是在 - (void) connection:(NSURLConnection *)connection didReceiveData:(NSData *)data 每次从这个回调里获取的数据不是完整的，要在 - (void) connectionDidFinishLoading:(NSURLConnection *)connection 这个会调里将分段数据拼接成完整的数据保存下来。具体完整的代码实现可以看 STMURLProtocol 里的代码实现。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>通过 <em>map</em> 网络请求可以缓存请求，也可以 <em>mock</em> 接口请求进行测试。</p>
<p>完整代码：&lt; <a target="_blank" rel="noopener" href="https://github.com/ming1016/STMURLCache">GitHub - ming1016&#x2F;STMURLCache: iOS预加载Web页面方案</a> &gt;</p>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li>Post title：iOS预加载Web页面方案</li>
        <li>Post author：戴铭</li>
        <li>Create time：2016-11-22 21:55:35</li>
        <li>
            Post link：https://ming1016.github.io/2016/11/22/how-to-preload-web-in-ios/
        </li>
        <li>
            Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/iOS/">#iOS</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/UIWebView/">#UIWebView</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/NSURLProtocol/">#NSURLProtocol</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2017/03/01/deeply-analyse-llvm/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">深入剖析 iOS 编译 Clang / LLVM</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2016/11/17/use-swift3-build-macos-program-to-clear-unuse-method/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">使用Swift3开发了个macOS的程序可以检测出objc项目中无用方法，然后一键全部清理</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2014</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">戴铭</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
            <div class="icp-info info-item"><a target="_blank" rel="nofollow" href="https://beian.miit.gov.cn">鄂ICP备17011999号 京公网安备 7011999号</a></div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-number">1.</span> <span class="nav-text">使用方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%99%BD%E5%90%8D%E5%8D%95%E8%AE%BE%E7%BD%AE"><span class="nav-number">2.</span> <span class="nav-text">白名单设置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%8A%A0%E8%BD%BD%E7%BC%93%E5%AD%98%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="nav-number">3.</span> <span class="nav-text">基本加载缓存实现原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%99%BD%E5%90%8D%E5%8D%95%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="nav-number">4.</span> <span class="nav-text">白名单实现原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E7%BC%93%E5%AD%98%E5%AE%9E%E7%8E%B0"><span class="nav-number">5.</span> <span class="nav-text">具体缓存实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NSURLCache%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">5.1.</span> <span class="nav-text">NSURLCache的实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSURLProtocol%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">5.2.</span> <span class="nav-text">NSURLProtocol的实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8E%E8%AE%B0"><span class="nav-number">6.</span> <span class="nav-text">后记</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>








<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
