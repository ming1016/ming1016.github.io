<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
  <meta charset="UTF-8">
  <meta 
    name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta 
    http-equiv="X-UA-Compatible" 
    content="ie=edge">
  <meta 
    name="theme-color" 
    content="#fff" 
    id="theme-color">
  <meta 
    name="description" 
    content="前滴滴出行技术专家。极客时间《iOS开发高手课》和纸书《跟戴铭学iOS编程》作者。个人博客：戴铭的博客。微信公共号：starming-weixin。微博：@戴铭">
  <link 
    rel="icon" 
    href="/img/logo-starming.png">
  <title>深入剖析 iOS 性能优化</title>
  
    
      <meta 
        property="og:title" 
        content="深入剖析 iOS 性能优化">
    
    
      <meta 
        property="og:url" 
        content="http://ming1016.github.io/2017/06/20/deeply-ios-performance-optimization/index.html">
    
    
      <meta 
        property="og:img" 
        content="/img/ming.jpeg">
    
    
      <meta 
        property="og:img" 
        content="前滴滴出行技术专家。极客时间《iOS开发高手课》和纸书《跟戴铭学iOS编程》作者。个人博客：戴铭的博客。微信公共号：starming-weixin。微博：@戴铭">
    
    
      <meta 
        property="og:type" 
        content="article">
      <meta 
        property="og:article:published_time" 
        content="2017-06-20">
      <meta 
        property="og:article:modified_time" 
        content="2021-04-11">
      <meta 
        property="og:article:author" 
        content="戴铭">
      
        
          <meta 
            property="og:article:tag" 
            content="iOS">
        
          <meta 
            property="og:article:tag" 
            content="Performance optimization">
        
      
    
  
  
  <link rel="preload" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css" as="style" >
  <link rel="preload" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css" as="style" >
  <link rel="preload" href="/css/main.css" as="style" >
  
  <link rel="modulepreload" href="//instant.page/5.1.0">
  
  <link rel="stylesheet" href="/css/main.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css">
  
  
  
    <link rel="stylesheet" href="/js/lib/lightbox/baguetteBox.min.css">
  
  <script>
    function loadScript(url, cb) {
      var script = document.createElement('script');
      script.src = url;
      if (cb) script.onload = cb;
      script.async = true;
      document.body.appendChild(script);
    }
    function loadCSS(href, data, attr) {
      var sheet = document.createElement('link');
      sheet.ref = 'stylesheet';
      sheet.href = href;
      sheet.dataset[data] = attr;
      document.head.appendChild(sheet);
    }
    function changeCSS(cssFile, data, attr) {
      var oldlink = document.querySelector(data);
      var newlink = document.createElement("link");
      newlink.setAttribute("rel", "stylesheet");
      newlink.setAttribute("href", cssFile);
      newlink.dataset.prism = attr;
      document.head.replaceChild(newlink, oldlink);
    }
  </script>
  
    
      
      
      
      
        
        
        
        <script>
          function prismThemeChange() {
            if(document.getElementById('theme-color').dataset.mode === 'dark') {
              if(document.querySelector('[data-prism]')) {
                changeCSS('/js/lib/prism/prism-tomorrow.min.css', '[data-prism]', 'prism-tomorrow');
              } else {
                loadCSS('/js/lib/prism/prism-tomorrow.min.css', 'prism', 'prism-tomorrow');
              }
            } else {
              if(document.querySelector('[data-prism]')) {
                changeCSS('/js/lib/prism/prism.min.css', '[data-prism]', 'prism');
              } else {
                loadCSS('/js/lib/prism/prism.min.css', 'prism', 'prism');
              }
            }
          }
          prismThemeChange()
        </script>
      
      
        
        <link rel="stylesheet" href="/js/lib/prism/prism-line-numbers.min.css">
      
    
  
  <script>
    // control reverse button
    var reverseDarkList = {
      dark: 'light',
      light: 'dark'
    };
    var themeColor = {
      dark: '#1c1c1e',
      light: '#fff'
    }
    // get the data of css prefers-color-scheme
    var getCssMediaQuery = function() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };
    // reverse current darkmode setting function
    var reverseDarkModeSetting = function() {
      var setting = localStorage.getItem('user-color-scheme');
      if(reverseDarkList[setting]) {
        setting = reverseDarkList[setting];
      } else if(setting === null) {
        setting = reverseDarkList[getCssMediaQuery()];
      } else {
        return;
      }
      localStorage.setItem('user-color-scheme', setting);
      return setting;
    };
    // apply current darkmode setting
  </script>
  
    <script>
      var setDarkmode = function(mode) {
      var setting = mode || localStorage.getItem('user-color-scheme');
      if(setting === getCssMediaQuery()) {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[setting];
        document.getElementById('theme-color').dataset.mode = setting;
        prismThemeChange();
      } else if(reverseDarkList[setting]) {
        document.documentElement.setAttribute('data-user-color-scheme', setting);
        document.getElementById('theme-color').content = themeColor[setting];
        document.getElementById('theme-color').dataset.mode = setting;
        prismThemeChange();
      } else {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[getCssMediaQuery()];
        document.getElementById('theme-color').dataset.mode = getCssMediaQuery();
        prismThemeChange();
      }
    };
    setDarkmode();
    </script>
  
  
  
    <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.js" as="script">
    <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.css" as="style" >
  
  
    <link rel="preload" href="/js/lib/lozad.min.js" as="script">
  
  
  
  
  
  
<meta name="generator" content="Hexo 5.4.2"></head>

  <body>
    <div class="wrapper">
       
      <nav class="navbar">
  <div class="navbar-logo">
    <a class="navbar-logo-main" href="/">
      
        <img 
          class="navbar-logo-img"
          width="32"
          height="32"
          src="/img/logo-starming.png" 
          alt="blog logo">
      
      <span class="navbar-logo-dsc">戴铭的博客</span>
      </a>
  </div>
  <div class="navbar-menu">
    
      <a 
        href="/" 
        class="navbar-menu-item">
        
          首頁
        
      </a>
    
      <a 
        href="/archives" 
        class="navbar-menu-item">
        
          存檔
        
      </a>
    
      <a 
        href="/tags" 
        class="navbar-menu-item">
        
          標籤
        
      </a>
    
      <a 
        href="/categories" 
        class="navbar-menu-item">
        
          分類
        
      </a>
    
      <a 
        href="/about" 
        class="navbar-menu-item">
        
          關於
        
      </a>
    
      <a 
        href="/null" 
        class="navbar-menu-item">
        
          友鏈
        
      </a>
    
    <button 
      class="navbar-menu-item darknavbar navbar-menu-btn" 
      aria-label="Toggle dark mode"
      id="dark">
      <i class="iconfont icon-weather"></i>
    </button>
    <button 
      class="navbar-menu-item searchnavbar navbar-menu-btn" 
      aria-label="Toggle search"
      id="search">
      <!-- <i 
        class="iconfont icon-search" 
        style="font-size: 1.2rem; font-weight: 400;">
      </i> -->
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img"
        class="iconify iconify--ion" width="28" height="28" preserveAspectRatio="xMidYMid meet" viewBox="0 0 512 512">
        <path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="28"
          d="M256 80a176 176 0 1 0 176 176A176 176 0 0 0 256 80Z"></path>
        <path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="28"
          d="M232 160a72 72 0 1 0 72 72a72 72 0 0 0-72-72Z"></path>
        <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="28"
          d="M283.64 283.64L336 336"></path>
      </svg>
    </button>
  </div>
</nav> 
      
      <div 
        id="local-search" 
        style="display: none">
        <input
          class="navbar-menu-item"
          id="search-input"
          placeholder="请输入搜索内容..." />
        <div id="search-content"></div>
      </div>
      
      <div class="section-wrap">
        <div class="container">
          <div class="columns">
            <aside class="left-column">
              
              <div class="card card-author">
                
  <img 
    src="/img/ming.jpeg" 
    class="author-img"
    width="88"
    height="88"
    alt="author avatar">

<p class="author-name">戴铭</p>
<p class="author-description">极客时间《iOS开发高手课》和纸书《跟戴铭学iOS编程》作者</p>
<div class="author-message">
  <a 
    class="author-posts-count" 
    href="/archives">
    <span>57</span>
    <span>文章</span>
  </a>
  <a 
    class="author-categories-count" 
    href="/categories">
    <span>5</span>
    <span>分類</span>
  </a>
  <a 
    class="author-tags-count" 
    href="/tags">
    <span>38</span>
    <span>標籤</span>
  </a>
</div>

  <div class="author-card-society">
    
      <div class="author-card-society-icon">
        <a target="_blank" rel="noopener" href="https://weibo.com/allstarming">
          <i class="iconfont icon-sina society-icon"></i>
        </a>
      </div>
    
      <div class="author-card-society-icon">
        <a target="_blank" rel="noopener" href="https://github.com/ming1016">
          <i class="iconfont icon-github society-icon"></i>
        </a>
      </div>
    
      <div class="author-card-society-icon">
        <a href="mailto:ming1016@foxmail.com">
          <i class="iconfont icon-mail society-icon"></i>
        </a>
      </div>
    
      <div class="author-card-society-icon">
        <a href="/atom.xml">
          <i class="iconfont icon-chrome society-icon"></i>
        </a>
      </div>
    
  </div>

              </div>
               <div class="sticky-tablet">
  
  
    <article class="display-when-two-columns spacer">
      <div class="card card-content toc-card">
        <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>目錄
</div>
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E7%A7%8D%E7%B1%BB"><span class="toc-number">1.</span> <span class="toc-text">问题种类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6"><span class="toc-number">1.1.</span> <span class="toc-text">时间复杂度</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NSArray-x2F-NSMutableArray"><span class="toc-number">1.1.1.</span> <span class="toc-text">NSArray &#x2F; NSMutableArray</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSSet-x2F-NSMutableSet-x2F-NSCountedSet"><span class="toc-number">1.1.2.</span> <span class="toc-text">NSSet &#x2F; NSMutableSet &#x2F; NSCountedSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSDictionary-x2F-NSMutableDictionary"><span class="toc-number">1.1.3.</span> <span class="toc-text">NSDictionary &#x2F; NSMutableDictionary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#containsObject-%E6%96%B9%E6%B3%95%E5%9C%A8%E6%95%B0%E7%BB%84%E5%92%8C-Set-%E9%87%8C%E4%B8%8D%E5%90%8C%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.4.</span> <span class="toc-text">containsObject 方法在数组和 Set 里不同的实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8-GCD-%E6%9D%A5%E5%81%9A%E4%BC%98%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text">用 GCD 来做优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.2.1.</span> <span class="toc-text">异步处理事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E8%80%97%E6%97%B6%E9%95%BF%E7%9A%84%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.2.2.</span> <span class="toc-text">需要耗时长的任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E7%BA%BF%E7%A8%8B%E7%88%86%E7%82%B8"><span class="toc-number">1.2.3.</span> <span class="toc-text">避免线程爆炸</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GCD-%E7%9B%B8%E5%85%B3-Crash-%E6%97%A5%E5%BF%97"><span class="toc-number">1.2.4.</span> <span class="toc-text">GCD 相关 Crash 日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#I-x2F-O-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">1.3.</span> <span class="toc-text">I&#x2F;O 性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NSCache"><span class="toc-number">1.3.1.</span> <span class="toc-text">NSCache</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6-App-%E7%9A%84-Wake-%E6%AC%A1%E6%95%B0"><span class="toc-number">1.4.</span> <span class="toc-text">控制 App 的 Wake 次数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%AF%B9%E4%BA%8E%E6%80%A7%E8%83%BD%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-number">1.5.</span> <span class="toc-text">内存对于性能的影响</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%A2%84%E9%98%B2%E8%BF%99%E4%BA%9B%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%EF%BC%8C%E9%9C%80%E8%A6%81%E5%88%BB%E6%84%8F%E9%A2%84%E9%98%B2%E4%B9%88"><span class="toc-number">2.</span> <span class="toc-text">如何预防这些性能问题，需要刻意预防么</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%A3%80%E6%9F%A5"><span class="toc-number">3.</span> <span class="toc-text">如何检查</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E7%9B%91%E5%90%AC%E4%B8%BB%E7%BA%BF%E7%A8%8B%E6%96%B9%E5%BC%8F%E6%9D%A5%E7%9B%91%E5%AF%9F"><span class="toc-number">4.</span> <span class="toc-text">通过监听主线程方式来监察</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%89%93%E5%8D%B0%E5%A0%86%E6%A0%88%E4%BF%A1%E6%81%AF%EF%BC%8C%E4%BF%9D%E5%AD%98%E7%8E%B0%E5%9C%BA"><span class="toc-number">5.</span> <span class="toc-text">如何打印堆栈信息，保存现场</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-number">5.1.</span> <span class="toc-text">获取线程的信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%BA%BF%E7%A8%8B%E9%87%8C%E6%89%80%E6%9C%89%E6%A0%88%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-number">5.2.</span> <span class="toc-text">获取线程里所有栈的信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E5%8C%96"><span class="toc-number">5.3.</span> <span class="toc-text">符号化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%9C%B0%E6%96%B9"><span class="toc-number">5.4.</span> <span class="toc-text">需要注意的地方</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%83%BD%E5%A4%9F%E8%8E%B7%E5%8F%96%E6%9B%B4%E5%A4%9A%E4%BF%A1%E6%81%AF%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">6.</span> <span class="toc-text">能够获取更多信息的方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%A0%91%E7%BB%93%E6%9E%84"><span class="toc-number">6.1.</span> <span class="toc-text">获取方法调用树结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E8%AF%BB%E5%8F%96-ThreadCallStack"><span class="toc-number">6.2.</span> <span class="toc-text">存储读取 ThreadCallStack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%B7%B1%E5%BA%A6"><span class="toc-number">6.3.</span> <span class="toc-text">记录方法调用深度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8-objc-msgSend-%E5%89%8D%E5%90%8E%E6%8F%92%E5%85%A5%E6%89%A7%E8%A1%8C%E6%96%B9%E6%B3%95"><span class="toc-number">6.4.</span> <span class="toc-text">在 objc_msgSend 前后插入执行方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E6%97%B6%E9%97%B4%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">6.5.</span> <span class="toc-text">记录时间的方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95-hook-msgsend-%E6%96%B9%E6%B3%95"><span class="toc-number">7.</span> <span class="toc-text">如何 hook msgsend 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%8D%E5%8E%86-dyld"><span class="toc-number">7.1.</span> <span class="toc-text">遍历 dyld</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%BE%E5%87%BA%E7%AC%A6%E5%8F%B7%E8%A1%A8%E7%9B%B8%E5%85%B3-Command"><span class="toc-number">7.2.</span> <span class="toc-text">找出符号表相关 Command</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%BE%97-base-%E5%92%8C-indirect-%E7%AC%A6%E5%8F%B7%E8%A1%A8"><span class="toc-number">7.3.</span> <span class="toc-text">获得 base 和 indirect 符号表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E8%A1%8C%E6%96%B9%E6%B3%95%E6%9B%BF%E6%8D%A2"><span class="toc-number">7.4.</span> <span class="toc-text">进行方法替换</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%9F%E8%AE%A1%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E9%A2%91%E6%AC%A1"><span class="toc-number">8.</span> <span class="toc-text">统计方法调用频次</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E9%A2%91%E6%AC%A1%E8%AE%B0%E5%BD%95%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-number">8.1.</span> <span class="toc-text">设计方法调用频次记录的结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BC%E8%A3%85%E6%96%B9%E6%B3%95%E8%B7%AF%E5%BE%84"><span class="toc-number">8.2.</span> <span class="toc-text">拼装方法路径</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E9%A2%91%E6%AC%A1%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">8.3.</span> <span class="toc-text">记录方法调用频次数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">8.3.1.</span> <span class="toc-text">创建数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%AE%B0%E5%BD%95"><span class="toc-number">8.3.2.</span> <span class="toc-text">添加记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E7%B4%A2%E8%AE%B0%E5%BD%95"><span class="toc-number">8.3.3.</span> <span class="toc-text">检索记录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%BE%E5%87%BA-CPU-%E4%BD%BF%E7%94%A8%E5%A4%A7%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%A0%86%E6%A0%88"><span class="toc-number">9.</span> <span class="toc-text">找出 CPU 使用大的线程堆栈</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Demo"><span class="toc-number">10.</span> <span class="toc-text">Demo</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B5%84%E6%96%99"><span class="toc-number">11.</span> <span class="toc-text">资料</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WWDC"><span class="toc-number">11.1.</span> <span class="toc-text">WWDC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PS"><span class="toc-number">12.</span> <span class="toc-text">PS:</span></a></li></ol>
      </div>
    </article>
  
  
  <article class="card card-content categories-widget">
    <div class="categories-card">
  <div class="categories-header">
    <i 
      class="iconfont icon-fenlei" 
      style="padding-right: 2px;">
    </i>分類
  </div>
  <div class="categories-list">
    
      <a href="/categories/Programming/">
        <div class="categories-list-item">
          Programming
          <span class="categories-list-item-badge">43</span>
        </div>
      </a>
    
      <a href="/categories/My-novel/">
        <div class="categories-list-item">
          My-novel
          <span class="categories-list-item-badge">4</span>
        </div>
      </a>
    
      <a href="/categories/My-painting/">
        <div class="categories-list-item">
          My-painting
          <span class="categories-list-item-badge">8</span>
        </div>
      </a>
    
      <a href="/categories/travel/">
        <div class="categories-list-item">
          travel
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/APP/">
        <div class="categories-list-item">
          APP
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
  </div>
</div>
  </article>
  
  <article class="card card-content tags-widget">
    <div class="tags-card">
  <div class="tags-header">
    <i 
      class="iconfont icon-biaoqian" 
      style="padding-right: 2px;">
    </i>熱門標籤
  </div>
  <div class="tags-list">
    
      <a 
        href="/tags/iOS/" 
        title="iOS">
        <div class="tags-list-item">iOS</div>
      </a>
    
      <a 
        href="/tags/Swift/" 
        title="Swift">
        <div class="tags-list-item">Swift</div>
      </a>
    
      <a 
        href="/tags/Apple/" 
        title="Apple">
        <div class="tags-list-item">Apple</div>
      </a>
    
      <a 
        href="/tags/Painting/" 
        title="Painting">
        <div class="tags-list-item">Painting</div>
      </a>
    
      <a 
        href="/tags/Slides/" 
        title="Slides">
        <div class="tags-list-item">Slides</div>
      </a>
    
      <a 
        href="/tags/iPad/" 
        title="iPad">
        <div class="tags-list-item">iPad</div>
      </a>
    
      <a 
        href="/tags/Procreate/" 
        title="Procreate">
        <div class="tags-list-item">Procreate</div>
      </a>
    
      <a 
        href="/tags/LLVM/" 
        title="LLVM">
        <div class="tags-list-item">LLVM</div>
      </a>
    
      <a 
        href="/tags/Web/" 
        title="Web">
        <div class="tags-list-item">Web</div>
      </a>
    
      <a 
        href="/tags/Novel/" 
        title="Novel">
        <div class="tags-list-item">Novel</div>
      </a>
    
      <a 
        href="/tags/SwiftUI/" 
        title="SwiftUI">
        <div class="tags-list-item">SwiftUI</div>
      </a>
    
      <a 
        href="/tags/macOS/" 
        title="macOS">
        <div class="tags-list-item">macOS</div>
      </a>
    
      <a 
        href="/tags/%E7%BC%96%E8%AF%91/" 
        title="编译">
        <div class="tags-list-item">编译</div>
      </a>
    
      <a 
        href="/tags/WWDC/" 
        title="WWDC">
        <div class="tags-list-item">WWDC</div>
      </a>
    
      <a 
        href="/tags/ReactiveCocoa/" 
        title="ReactiveCocoa">
        <div class="tags-list-item">ReactiveCocoa</div>
      </a>
    
      <a 
        href="/tags/GOT/" 
        title="GOT">
        <div class="tags-list-item">GOT</div>
      </a>
    
  </div>
</div>
  </article>
  
  
</div>
            </aside>
            <main class="main-column">
              
<article class="card card-content">
  <header>
    <h1 class="post-title">
      深入剖析 iOS 性能优化
    </h1>
  </header>
  <div class="post-meta post-show-meta">
    <time datetime="2017-06-20T02:25:42.000Z">
      <i 
        class="iconfont icon-calendar" 
        style="margin-right: 2px;">
      </i>
      <span>2017-06-20</span>
    </time>
    
      <span class="dot"></span>
      
        <a 
          href="/categories/Programming/" 
          class="post-meta-link">
          Programming
        </a>
      
    
    
      <span class="dot"></span>
      <span>8.7k 個字</span>
    
  </div>
  
    <div 
      class="post-meta post-show-meta" 
      style="margin-top: -10px;">
      <div style="display: flex; align-items: center;">
        <i 
          class="iconfont icon-biaoqian" 
          style="margin-right: 2px; font-size: 1.15rem;">
        </i>
        
          
          <a 
            href="/tags/iOS/" 
            class="post-meta-link">
            iOS
          </a>
        
          
            <span class="dot"></span>
          
          <a 
            href="/tags/Performance-optimization/" 
            class="post-meta-link">
            Performance optimization
          </a>
        
      </div>
    </div>
  
  </header>
  <div 
    id="section" 
    class="post-content">
    <h1 id="问题种类"><a href="#问题种类" class="headerlink" title="问题种类"></a>问题种类</h1><h2 id="时间复杂度"><a href="#时间复杂度" class="headerlink" title="时间复杂度"></a>时间复杂度</h2><p>在集合里数据量小的情况下时间复杂度对于性能的影响看起来微乎其微。但如果某个开发的功能是一个公共功能，无法预料调用者传入数据的量时，这个复杂度的优化显得非常重要了。<br><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/uploads/deeply-ios-performance-optimization/01.png" class="lozad post-image"src="/uploads/deeply-ios-performance-optimization/01.png"><br>上图列出了各种情况的时间复杂度，比如高效的排序算法一般都是 O(n log n)。接下来看看下图：<br><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/uploads/deeply-ios-performance-optimization/02.png" class="lozad post-image"src="/uploads/deeply-ios-performance-optimization/02.png"><br>图中可以看出 O(n) 是个分水岭，大于它对于性能就具有很大的潜在影响，如果是个公共的接口一定要加上说明，自己调用也要做到心中有数。当然最好是通过算法优化或者使用合适的系统接口方法，权衡内存消耗争取通过空间来换取时间。</p>
<p>下面通过集合里是否有某个值来举个例子：</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token comment">//O(1)</span>
<span class="token keyword">return</span> array<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">==</span> value<span class="token punctuation">;</span>

<span class="token comment">//O(n)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> YES<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">return</span> NO<span class="token punctuation">;</span>

<span class="token comment">//O(n2) 找重复的值</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> i <span class="token operator">!=</span> j <span class="token operator">&amp;&amp;</span> array<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> array<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> YES<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">return</span> NO<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么 OC 里几种常用集合对象提供的接口方法时间复杂度是怎么样的。</p>
<h3 id="NSArray-x2F-NSMutableArray"><a href="#NSArray-x2F-NSMutableArray" class="headerlink" title="NSArray &#x2F; NSMutableArray"></a>NSArray &#x2F; NSMutableArray</h3><p>首先我们发现他们是有排序，并允许重复元素存在的，那么这么设计就表明了集合存储没法使用里面的元素做 hash table 的 key 进行相关的快速操作，。所以不同功能接口方法性能是会有很大的差异。</p>
<ul>
<li>containsObject:，containsObject:，indexOfObject*，removeObject: 会遍历里面元素查看是否与之匹对，所以复杂度等于或大于 O(n)</li>
<li>objectAtIndex:，firstObject:，lastObject:，addObject:，removeLastObject: 这些只针对栈顶栈底操作的时间复杂度都是 O(1)</li>
<li>indexOfObject:inSortedRange:options:usingComparator: 使用的是二分查找，时间复杂度是 O(log n)</li>
</ul>
<h3 id="NSSet-x2F-NSMutableSet-x2F-NSCountedSet"><a href="#NSSet-x2F-NSMutableSet-x2F-NSCountedSet" class="headerlink" title="NSSet &#x2F; NSMutableSet &#x2F; NSCountedSet"></a>NSSet &#x2F; NSMutableSet &#x2F; NSCountedSet</h3><p>这些集合类型是无序没有重复元素。这样就可以通过 hash table 进行快速的操作。比如 addObject:, removeObject:, containsObject: 都是按照 O(1) 来的。需要注意的是将数组转成 Set 时会将重复元素合成一个，同时失去排序。</p>
<h3 id="NSDictionary-x2F-NSMutableDictionary"><a href="#NSDictionary-x2F-NSMutableDictionary" class="headerlink" title="NSDictionary &#x2F; NSMutableDictionary"></a>NSDictionary &#x2F; NSMutableDictionary</h3><p>和 Set 差不多，多了键值对应。添加删除和查找都是 O(1) 的。需要注意的是 Keys 必须是符合 NSCopying。</p>
<h3 id="containsObject-方法在数组和-Set-里不同的实现"><a href="#containsObject-方法在数组和-Set-里不同的实现" class="headerlink" title="containsObject 方法在数组和 Set 里不同的实现"></a>containsObject 方法在数组和 Set 里不同的实现</h3><p>在数组中的实现</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span> containsObject<span class="token punctuation">:</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>anObject
<span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">self</span> indexOfObject<span class="token punctuation">:</span> anObject<span class="token punctuation">]</span> <span class="token operator">!=</span> NSNotFound<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>NSUInteger<span class="token punctuation">)</span> indexOfObject<span class="token punctuation">:</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>anObject
<span class="token punctuation">&#123;</span>
  <span class="token keyword">unsigned</span>	c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span> count<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> anObject <span class="token operator">!=</span> nil<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">unsigned</span>	i<span class="token punctuation">;</span>
      IMP	get <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span> methodForSelector<span class="token punctuation">:</span> oaiSel<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">BOOL</span>	<span class="token punctuation">(</span><span class="token operator">*</span>eq<span class="token punctuation">)</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> SEL<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
	<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">BOOL</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> SEL<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span>anObject methodForSelector<span class="token punctuation">:</span> eqSel<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> c<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>eq<span class="token punctuation">)</span><span class="token punctuation">(</span>anObject<span class="token punctuation">,</span> eqSel<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>get<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> oaiSel<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> YES<span class="token punctuation">)</span>
	  <span class="token keyword">return</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> NSNotFound<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到会遍历所有元素在查找到后才进行返回.</p>
<p>接下来可以看看 containsObject 在 Set 里的实现：</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span> containsObject<span class="token punctuation">:</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>anObject
<span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">self</span> member<span class="token punctuation">:</span> anObject<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> YES <span class="token punctuation">:</span> NO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//在 GSSet,m 里有对 member 的实现</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> member<span class="token punctuation">:</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>anObject
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>anObject <span class="token operator">!=</span> nil<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      GSIMapNode node <span class="token operator">=</span> <span class="token function">GSIMapNodeForKey</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>map<span class="token punctuation">,</span> <span class="token punctuation">(</span>GSIMapKey<span class="token punctuation">)</span>anObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
	  <span class="token keyword">return</span> node<span class="token operator">-></span>key<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>找元素时是通过键值方式从 map 映射表里取出，因为 Set 里元素是唯一的，所以可以 hash 元素对象作为 key 达到快速获取值的目的。</p>
<h2 id="用-GCD-来做优化"><a href="#用-GCD-来做优化" class="headerlink" title="用 GCD 来做优化"></a>用 GCD 来做优化</h2><p>我们可以通过 GCD 提供的方法来将一些需要耗时操作放到非主线程上做，使得 App 能够运行的更加流畅响应更快。但是使用 GCD 时需要注意避免可能引起线程爆炸和死锁的情况，还有非主线程处理任务也不是万能的，如果一个处理需要消耗大量内存或者大量CPU操作 GCD 也没法帮你，只能通过将处理进行拆解分步骤分时间进行处理才比较妥当。</p>
<h3 id="异步处理事件"><a href="#异步处理事件" class="headerlink" title="异步处理事件"></a>异步处理事件</h3><p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/uploads/deeply-ios-performance-optimization/03.png" class="lozad post-image"src="/uploads/deeply-ios-performance-optimization/03.png"><br>上图是最典型的异步处理事件的方法</p>
<h3 id="需要耗时长的任务"><a href="#需要耗时长的任务" class="headerlink" title="需要耗时长的任务"></a>需要耗时长的任务</h3><p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/uploads/deeply-ios-performance-optimization/04.png" class="lozad post-image"src="/uploads/deeply-ios-performance-optimization/04.png"><br>将 GCD 的 block 通过 dispatch_block_create_with_qos_class 方法指定队列的 QoS 为 QOS_CLASS_UTILITY。这种 QoS 系统会针对大的计算，I&#x2F;O，网络以及复杂数据处理做电量优化。</p>
<h3 id="避免线程爆炸"><a href="#避免线程爆炸" class="headerlink" title="避免线程爆炸"></a>避免线程爆炸</h3><ul>
<li>使用串行队列</li>
<li>使用 NSOperationQueues 的并发限制方法 NSOperationQueue.maxConcurrentOperationCount</li>
</ul>
<p>举个例子，下面的写法就比较危险，可能会造成线程爆炸和死锁</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">999</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">dispatch_async</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">dispatch_barrier_sync</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/uploads/deeply-ios-performance-optimization/05.png" class="lozad post-image"src="/uploads/deeply-ios-performance-optimization/05.png"></p>
<p>那么怎么能够避免呢？首先可以使用 dispatch_apply</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token function">dispatch_apply</span><span class="token punctuation">(</span><span class="token number">999</span><span class="token punctuation">,</span> q<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>或者使用 dispatch_semaphore</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CONCURRENT_TASKS</span> <span class="token expression"><span class="token number">4</span></span></span>
sema <span class="token operator">=</span> <span class="token function">dispatch_semaphore_create</span><span class="token punctuation">(</span>CONCURRENT_TASKS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">999</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">dispatch_async</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">&#123;</span>
        <span class="token function">dispatch_semaphore_signal</span><span class="token punctuation">(</span>sema<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dispatch_semaphore_wait</span><span class="token punctuation">(</span>sema<span class="token punctuation">,</span> DISPATCH_TIME_FOREVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="GCD-相关-Crash-日志"><a href="#GCD-相关-Crash-日志" class="headerlink" title="GCD 相关 Crash 日志"></a>GCD 相关 Crash 日志</h3><p>管理线程问题</p>
<pre class="line-numbers language-none"><code class="language-none">Thread 1:: Dispatch queue: com.apple.libdispatch-manager
0   libsystem_kernel.dylib   0x00007fff8967e08a kevent_qos + 10
1   libdispatch.dylib        0x00007fff8be05811 _dispatch_mgr_invoke + 251
2   libdispatch.dylib        0x00007fff8be05465 _dispatch_mgr_thread + 52<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>线程闲置时</p>
<pre class="line-numbers language-none"><code class="language-none">Thread 6:
0   libsystem_kernel.dylib       0x00007fff8967d772 __workq_kernreturn + 10
1   libsystem_pthread.dylib      0x00007fff8fd317d9 _pthread_wqthread + 1283
2   libsystem_pthread.dylib      0x00007fff8fd2ed95 start_wqthread + 13<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>线程活跃时</p>
<pre class="line-numbers language-none"><code class="language-none">Thread 3 Crashed:: Dispatch queue: &lt;queue name&gt;
&lt;my code&gt;
7   libdispatch.dylib        0x07fff8fcfd323 _dispatch_call_block_and_release
8   libdispatch.dylib        0x07fff8fcf8c13 _dispatch_client_callout + 8
9   libdispatch.dylib        0x07fff8fcfc365 _dispatch_queue_drain + 1100
10  libdispatch.dylib        0x07fff8fcfdecc _dispatch_queue_invoke + 202
11  libdispatch.dylib        0x07fff8fcfb6b7 _dispatch_root_queue_drain + 463
12  libdispatch.dylib        0x07fff8fd09fe4 _dispatch_worker_thread3 + 91
13  libsystem_pthread.dylib  0x07fff93c17637 _pthread_wqthread + 729
14  libsystem_pthread.dylib  0x07fff93c1540d start_wqthread + 13<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主线程闲置时</p>
<pre class="line-numbers language-none"><code class="language-none">Thread 0 Crashed:: Dispatch queue: com.apple.main-thread
0   libsystem_kernel.dylib     0x00007fff906614de mach_msg_trap + 10
1   libsystem_kernel.dylib     0x00007fff9066064f mach_msg + 55
2   com.apple.CoreFoundation   0x00007fff9a8c1eb4 __CFRunLoopServiceMachPort
3   com.apple.CoreFoundation   0x00007fff9a8c137b __CFRunLoopRun + 1371
4   com.apple.CoreFoundation   0x00007fff9a8c0bd8 CFRunLoopRunSpecific + 296
...
10  com.apple.AppKit           0x00007fff8e823c03 -[NSApplication run] + 594
11  com.apple.AppKit           0x00007fff8e7a0354 NSApplicationMain + 1832
12  com.example                0x00000001000013b4 start + 52<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主队列</p>
<pre class="line-numbers language-none"><code class="language-none">Thread 0 Crashed:: Dispatch queue: com.apple.main-thread
&lt;my code&gt;
12  com.apple.Foundation      0x00007fff931157e8 __NSBLOCKOPERATION_IS_CALLING_OUT_TO_A_BLOCK__ + 7
13  com.apple.Foundation      0x00007fff931155b5 -[NSBlockOperation main] + 9
14  com.apple.Foundation      0x00007fff93114a6c -[__NSOperationInternal _start:] + 653
15  com.apple.Foundation      0x00007fff93114543 __NSOQSchedule_f + 184
16  libdispatch.dylib         0x00007fff935d6c13 _dispatch_client_callout + 8
17  libdispatch.dylib         0x00007fff935e2cbf _dispatch_main_queue_callback_4CF + 861
18  com.apple.CoreFoundation  0x00007fff8d9223f9 __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__
19  com.apple.CoreFoundation  0x00007fff8d8dd68f __CFRunLoopRun + 2159
20  com.apple.CoreFoundation  0x00007fff8d8dcbd8 CFRunLoopRunSpecific + 296
...
26  com.apple.AppKit          0x00007fff999a1bd3 -[NSApplication run] + 594
27  com.apple.AppKit          0x00007fff9991e324 NSApplicationMain + 1832
28  libdyld.dylib             0x00007fff9480f5c9 start + 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="I-x2F-O-性能优化"><a href="#I-x2F-O-性能优化" class="headerlink" title="I&#x2F;O 性能优化"></a>I&#x2F;O 性能优化</h2><p>I&#x2F;O 是性能消耗大户，任何的 I&#x2F;O 操作都会使低功耗状态被打破，所以减少 I&#x2F;O 次数是这个性能优化的关键点，为了达成这个目下面列出一些方法。</p>
<ul>
<li>将零碎的内容作为一个整体进行写入</li>
<li>使用合适的 I&#x2F;O 操作 API</li>
<li>使用合适的线程</li>
<li>使用 NSCache 做缓存能够减少 I&#x2F;O</li>
</ul>
<h3 id="NSCache"><a href="#NSCache" class="headerlink" title="NSCache"></a>NSCache</h3><p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/uploads/deeply-ios-performance-optimization/06.png" class="lozad post-image"src="/uploads/deeply-ios-performance-optimization/06.png"><br>达到如图的目的为何不直接用字典来做呢？<br>NSCache 具有字典的所有功能，同时还有如下的特性：</p>
<ul>
<li>自动清理系统占用内存</li>
<li>NSCache 是线程安全</li>
<li>-(void)cache:(NSCache *)cache willEvictObject:(id)obj;   缓存对象将被清理时的回调 </li>
<li>evictsObjectsWithDiscardedContent 可以控制是否清理</li>
</ul>
<p>那么 NSCache是如何做到这些特性的呢？</p>
<p>接下来学习下 NSCache 是如何做的。首先 NSCache 是会持有一个 NSMutableDictionary。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">@implementation NSCache
<span class="token operator">-</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> init
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nil <span class="token operator">==</span> <span class="token punctuation">(</span>self <span class="token operator">=</span> <span class="token punctuation">[</span>super init<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  _objects <span class="token operator">=</span> <span class="token punctuation">[</span>NSMutableDictionary new<span class="token punctuation">]</span><span class="token punctuation">;</span>
  _accesses <span class="token operator">=</span> <span class="token punctuation">[</span>NSMutableArray new<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> self<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>需要设计一个 Cached 对象结构来保存一些额外的信息</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">@interface _GSCachedObject <span class="token operator">:</span> NSObject
<span class="token punctuation">&#123;</span>
  @public
  id object<span class="token punctuation">;</span> <span class="token comment">//cache 的值</span>
  NSString <span class="token operator">*</span>key<span class="token punctuation">;</span> <span class="token comment">//设置 cache 的 key</span>
  <span class="token keyword">int</span> accessCount<span class="token punctuation">;</span> <span class="token comment">//保存访问次数，用于自动清理</span>
  NSUInteger cost<span class="token punctuation">;</span> <span class="token comment">//setObject:forKey:cost:</span>
  BOOL isEvictable<span class="token punctuation">;</span> <span class="token comment">//线程安全</span>
<span class="token punctuation">&#125;</span>
@end<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在 Cache 读取的时候会对 _accesses 数组的添加删除通过 isEvictable 布尔值来保证线程安全操作。使用 Cached 对象里的 accessCount 属性进行 +1 操作为后面自动清理的条件判断做准备。具体实现如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">-</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> objectForKey<span class="token operator">:</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>key
<span class="token punctuation">&#123;</span>
  _GSCachedObject <span class="token operator">*</span>obj <span class="token operator">=</span> <span class="token punctuation">[</span>_objects objectForKey<span class="token operator">:</span> key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nil <span class="token operator">==</span> obj<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token operator">-></span>isEvictable<span class="token punctuation">)</span> <span class="token comment">//保证添加删除操作线程安全</span>
    <span class="token punctuation">&#123;</span>
      <span class="token comment">// 将 obj 移到 access list 末端</span>
      <span class="token punctuation">[</span>_accesses removeObjectIdenticalTo<span class="token operator">:</span> obj<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">[</span>_accesses addObject<span class="token operator">:</span> obj<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  obj<span class="token operator">-></span>accessCount<span class="token operator">++</span><span class="token punctuation">;</span>
  _totalAccesses<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> obj<span class="token operator">-></span>object<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在每次 Cache 添加时会先去检查是否自动清理，会创建一个 Cached 对象将 key，object，cost 等信息记录下添加到 _accesses 数组和 _objects 字典里。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> setObject<span class="token operator">:</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>obj forKey<span class="token operator">:</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>key cost<span class="token operator">:</span> <span class="token punctuation">(</span>NSUInteger<span class="token punctuation">)</span>num
<span class="token punctuation">&#123;</span>
  _GSCachedObject <span class="token operator">*</span>oldObject <span class="token operator">=</span> <span class="token punctuation">[</span>_objects objectForKey<span class="token operator">:</span> key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  _GSCachedObject <span class="token operator">*</span>newObject<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>nil <span class="token operator">!=</span> oldObject<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token punctuation">[</span>self removeObjectForKey<span class="token operator">:</span> oldObject<span class="token operator">-></span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">[</span>self _evictObjectsToMakeSpaceForObjectWithCost<span class="token operator">:</span> num<span class="token punctuation">]</span><span class="token punctuation">;</span>
  newObject <span class="token operator">=</span> <span class="token punctuation">[</span>_GSCachedObject new<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// Retained here, released when obj is dealloc'd</span>
  newObject<span class="token operator">-></span>object <span class="token operator">=</span> <span class="token function">RETAIN</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
  newObject<span class="token operator">-></span>key <span class="token operator">=</span> <span class="token function">RETAIN</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  newObject<span class="token operator">-></span>cost <span class="token operator">=</span> num<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>obj conformsToProtocol<span class="token operator">:</span> @<span class="token function">protocol</span><span class="token punctuation">(</span>NSDiscardableContent<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      newObject<span class="token operator">-></span>isEvictable <span class="token operator">=</span> YES<span class="token punctuation">;</span>
      <span class="token punctuation">[</span>_accesses addObject<span class="token operator">:</span> newObject<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">[</span>_objects setObject<span class="token operator">:</span> newObject forKey<span class="token operator">:</span> key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">RELEASE</span><span class="token punctuation">(</span>newObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  _totalCost <span class="token operator">+=</span> num<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么上面提到的自动清理内存的方法是如何实现的呢？<br>既然是自动清理必定需要有触发时机和进入清理的条件判断，触发时机一个是发生在添加 Cache 内容时，一个是发生在内存警告时。条件判断代码如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// cost 在添加新 cache 值时指定的 cost</span>
<span class="token comment">// _costLimit 是 totalCostLimit 属性值</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>_costLimit <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> _totalCost <span class="token operator">+</span> cost <span class="token operator">></span> _costLimit<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	spaceNeeded <span class="token operator">=</span> _totalCost <span class="token operator">+</span> cost <span class="token operator">-</span> _costLimit<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 只有当 cost 大于人工限制时才会清理</span>
<span class="token comment">// 或者 cost 设置为0不进行人工干预</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>spaceNeeded <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> count <span class="token operator">>=</span> _countLimit<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所以 NSCache 的 totalCostLimit 的值会和每次 Cache 添加的 cost 之和对比，超出限制必然触发内存清理。</p>
<p>清理时会对经常访问的 objects 不清理，主要是通过 _totalAccesses 和总数获得平均访问频率，如果那个对象的访问次数是小于平均值的才需要清理。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//_totalAccesses 所有的值的访问都会 +1</span>
NSUInteger averageAccesses <span class="token operator">=</span> <span class="token punctuation">(</span>_totalAccesses <span class="token operator">/</span> count <span class="token operator">*</span> <span class="token number">0.2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//accessCount 每次 obj 取值时会 +1</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token operator">-></span>accessCount <span class="token operator">&lt;</span> averageAccesses <span class="token operator">&amp;&amp;</span> obj<span class="token operator">-></span>isEvictable<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>在清理之前还需要一些准备工作，包括标记 Cached 对象的 isEvictable 防止后面有不安全的线程操作。将满足条件的清理 objects 放到清理数组里，如果空间释放足够就不用再把更多的 objects 加到清理数组里了，最后遍历清理数组进行逐个清理即可。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">NSUInteger cost <span class="token operator">=</span> obj<span class="token operator">-></span>cost<span class="token punctuation">;</span>
obj<span class="token operator">-></span>cost <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// 不会被再次清除</span>
obj<span class="token operator">-></span>isEvictable <span class="token operator">=</span> NO<span class="token punctuation">;</span>
<span class="token comment">// 添加到 remove list 里</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>_evictsObjectsWithDiscardedContent<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span>evictedKeys addObject<span class="token operator">:</span> obj<span class="token operator">-></span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
_totalCost <span class="token operator">-=</span> cost<span class="token punctuation">;</span>
<span class="token comment">// 如果已经释放了足够空间就不用后面操作了</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>cost <span class="token operator">></span> spaceNeeded<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
spaceNeeded <span class="token operator">-=</span> cost<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在清理时会执行回调内容，这样如果有些缓存数据需要持续化存储可以在回调里进行处理。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> removeObjectForKey<span class="token operator">:</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>key
<span class="token punctuation">&#123;</span>
    _GSCachedObject <span class="token operator">*</span>obj <span class="token operator">=</span> <span class="token punctuation">[</span>_objects objectForKey<span class="token operator">:</span> key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nil <span class="token operator">!=</span> obj<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token punctuation">[</span>_delegate cache<span class="token operator">:</span> self willEvictObject<span class="token operator">:</span> obj<span class="token operator">-></span>object<span class="token punctuation">]</span><span class="token punctuation">;</span>
        _totalAccesses <span class="token operator">-=</span> obj<span class="token operator">-></span>accessCount<span class="token punctuation">;</span>
        <span class="token punctuation">[</span>_objects removeObjectForKey<span class="token operator">:</span> key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>_accesses removeObjectIdenticalTo<span class="token operator">:</span> obj<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>完整的实现可以查看 GNUstep Base 的 NSCache.m 文件。</p>
<p>下面可以看看 NSCache 在 SDWebImage 的运用是怎么样的：</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span>UIImage <span class="token operator">*</span><span class="token punctuation">)</span>imageFromMemoryCacheForKey<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>key <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>memCache objectForKey<span class="token punctuation">:</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>UIImage <span class="token operator">*</span><span class="token punctuation">)</span>imageFromDiskCacheForKey<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>key <span class="token punctuation">&#123;</span>
    <span class="token comment">// 检查 NSCache 里是否有</span>
    UIImage <span class="token operator">*</span>image <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span> imageFromMemoryCacheForKey<span class="token punctuation">:</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>image<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> image<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 从磁盘里读</span>
    UIImage <span class="token operator">*</span>diskImage <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span> diskImageForKey<span class="token punctuation">:</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>diskImage <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>shouldCacheImagesInMemory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        NSUInteger cost <span class="token operator">=</span> <span class="token function">SDCacheCostForImage</span><span class="token punctuation">(</span>diskImage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>memCache setObject<span class="token punctuation">:</span>diskImage forKey<span class="token punctuation">:</span>key cost<span class="token punctuation">:</span>cost<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> diskImage<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出利用 NSCache 自动释放内存的特点将图片都放到 NSCache 里这样在内存不够用时可以自动清理掉不常用的那些图片，在读取 Cache 里内容时如果没有被清理会直接返回图片数据，清理了的话才会执行 I&#x2F;O 从磁盘读取图片，通过这种方式能够利用空间减少磁盘操作，空间也能够更加有效的控制释放。</p>
<h2 id="控制-App-的-Wake-次数"><a href="#控制-App-的-Wake-次数" class="headerlink" title="控制 App 的 Wake 次数"></a>控制 App 的 Wake 次数</h2><p>通知，VoIP，定位，蓝牙等都会使设备从 Standby 状态唤起。唤起这个过程会有比较大的消耗，应该避免频繁发生。通知方面主要要在产品层面多做考虑。定位方面，下面可以看看定位的一些 API 看看它们对性能的不同影响，便于考虑采用合适的接口。</p>
<p>连续的位置更新</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token punctuation">[</span>locationManager startUpdatingLocation<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个方法会时设备一直处于活跃状态。</p>
<p>延时有效定位</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token punctuation">[</span>locationManager allowDeferredLocationUpdatesUntilTraveled<span class="token punctuation">:</span> timeout<span class="token punctuation">:</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>高效节能的定位方式，数据会缓存在位置硬件上。适合于跑步应用应该都采用这种方式。</p>
<p>重大位置变化</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token punctuation">[</span>locationManager startMonitoringSignificantLocationChanges<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>会更节能，对于那些只有在位置有很大变化的才需要回调的应用可以采用这种，比如天气应用。</p>
<p>区域监测</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token punctuation">[</span>locationManager startMonitoringForRegion<span class="token punctuation">:</span><span class="token punctuation">(</span>CLRegion <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>也是一种节能的定位方式，比如在博物馆里按照不同区域监测展示不同信息之类的应用比较适合这种定位。</p>
<p>经常访问的地方</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token comment">// Start monitoring</span>
locationManager<span class="token punctuation">.</span><span class="token function">startMonitoringVisits</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// Stop monitoring when no longer needed</span>
locationManager<span class="token punctuation">.</span><span class="token function">stopMonitoringVisits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>总的来说，不要轻易使用 startUpdatingLocation() 除非万不得已，尽快的使用 stopUpdatingLocation() 来结束定位还用户一个节能设备。</p>
<h2 id="内存对于性能的影响"><a href="#内存对于性能的影响" class="headerlink" title="内存对于性能的影响"></a>内存对于性能的影响</h2><p>首先 Reclaiming 内存是需要时间的，突然的大量内存需求是会影响响应的。</p>
<h1 id="如何预防这些性能问题，需要刻意预防么"><a href="#如何预防这些性能问题，需要刻意预防么" class="headerlink" title="如何预防这些性能问题，需要刻意预防么"></a>如何预防这些性能问题，需要刻意预防么</h1><p>坚持下面几个原则争取在编码阶段避免一些性能问题。</p>
<ul>
<li>优化计算的复杂度从而减少 CPU 的使用</li>
<li>在应用响应交互的时候停止没必要的任务处理</li>
<li>设置合适的 QoS</li>
<li>将定时器任务合并，让 CPU 更多时候处于 idle 状态</li>
</ul>
<p>那么如果写需求时来不及注意这些问题做不到预防的话，可以通过自动化代码检查的方式来避免这些问题吗？</p>
<h1 id="如何检查"><a href="#如何检查" class="headerlink" title="如何检查"></a>如何检查</h1><p>根据这些问题在代码里查，写工具或用工具自动化查？虽然可以，但是需要考虑的情况太多，现有工具支持不好，自己写需要考虑的点太多需要花费太长的时间，那么什么方式会比较好呢？</p>
<h1 id="通过监听主线程方式来监察"><a href="#通过监听主线程方式来监察" class="headerlink" title="通过监听主线程方式来监察"></a>通过监听主线程方式来监察</h1><p>首先用 CFRunLoopObserverCreate 创建一个观察者里面接受 CFRunLoopActivity 的回调，然后用 CFRunLoopAddObserver 将观察者添加到 CFRunLoopGetMain() 主线程 Runloop 的 kCFRunLoopCommonModes 模式下进行观察。</p>
<p>接下来创建一个子线程来进行监控，使用 dispatch_semaphore_wait 定义区间时间，标准是 16 或 20 微秒一次监控的话基本可以把影响响应的都找出来。监控结果的标准是根据两个 Runloop 的状态 BeforeSources 和 AfterWaiting 在区间时间是否能检测到来判断是否卡顿。</p>
<h1 id="如何打印堆栈信息，保存现场"><a href="#如何打印堆栈信息，保存现场" class="headerlink" title="如何打印堆栈信息，保存现场"></a>如何打印堆栈信息，保存现场</h1><p>打印堆栈整体思路是获取线程的信息得到线程的 state 从而得到线程里所有栈的指针，根据这些指针在 符号表里找到对应的描述即符号化解析，这样就能够展示出可读的堆栈信息。具体实现是怎样的呢？下面详细说说：</p>
<h2 id="获取线程的信息"><a href="#获取线程的信息" class="headerlink" title="获取线程的信息"></a>获取线程的信息</h2><p>这里首先是要通过 task_threads 取到所有的线程，</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">thread_act_array_t</span> threads<span class="token punctuation">;</span> <span class="token comment">//int 组成的数组比如 thread[1] = 5635</span>
<span class="token class-name">mach_msg_type_number_t</span> thread_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//mach_msg_type_number_t 是 int 类型</span>
<span class="token keyword">const</span> <span class="token class-name">task_t</span> this_task <span class="token operator">=</span> <span class="token function">mach_task_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//int</span>
<span class="token comment">//根据当前 task 获取所有线程</span>
<span class="token class-name">kern_return_t</span> kr <span class="token operator">=</span> <span class="token function">task_threads</span><span class="token punctuation">(</span>this_task<span class="token punctuation">,</span> <span class="token operator">&amp;</span>threads<span class="token punctuation">,</span> <span class="token operator">&amp;</span>thread_count<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>遍历时通过 thread_info 获取各个线程的详细信息</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">SMThreadInfoStruct threadInfoSt <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token class-name">thread_info_data_t</span> threadInfo<span class="token punctuation">;</span>
<span class="token class-name">thread_basic_info_t</span> threadBasicInfo<span class="token punctuation">;</span>
<span class="token class-name">mach_msg_type_number_t</span> threadInfoCount <span class="token operator">=</span> THREAD_INFO_MAX<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">thread_info</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">thread_act_t</span><span class="token punctuation">)</span>thread<span class="token punctuation">,</span> THREAD_BASIC_INFO<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">thread_info_t</span><span class="token punctuation">)</span>threadInfo<span class="token punctuation">,</span> <span class="token operator">&amp;</span>threadInfoCount<span class="token punctuation">)</span> <span class="token operator">==</span> KERN_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    threadBasicInfo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">thread_basic_info_t</span><span class="token punctuation">)</span>threadInfo<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>threadBasicInfo<span class="token operator">-></span>flags <span class="token operator">&amp;</span> TH_FLAGS_IDLE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        threadInfoSt<span class="token punctuation">.</span>cpuUsage <span class="token operator">=</span> threadBasicInfo<span class="token operator">-></span>cpu_usage <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">;</span>
        threadInfoSt<span class="token punctuation">.</span>userTime <span class="token operator">=</span> threadBasicInfo<span class="token operator">-></span>system_time<span class="token punctuation">.</span>microseconds<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">uintptr_t</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
NSMutableString <span class="token operator">*</span>reStr <span class="token operator">=</span> <span class="token punctuation">[</span>NSMutableString stringWithFormat<span class="token operator">:</span>@<span class="token string">"Stack of thread: %u:\n CPU used: %.1f percent\n user time: %d second\n"</span><span class="token punctuation">,</span> thread<span class="token punctuation">,</span> threadInfoSt<span class="token punctuation">.</span>cpuUsage<span class="token punctuation">,</span> threadInfoSt<span class="token punctuation">.</span>userTime<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="获取线程里所有栈的信息"><a href="#获取线程里所有栈的信息" class="headerlink" title="获取线程里所有栈的信息"></a>获取线程里所有栈的信息</h2><p>可以通过 thread_get_state 得到 machine context 里面包含了线程栈里所有的栈指针。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">_STRUCT_MCONTEXT machineContext<span class="token punctuation">;</span> <span class="token comment">//线程栈里所有的栈指针</span>
<span class="token comment">//通过 thread_get_state 获取完整的 machineContext 信息，包含 thread 状态信息</span>
<span class="token class-name">mach_msg_type_number_t</span> state_count <span class="token operator">=</span> <span class="token function">smThreadStateCountByCPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">kern_return_t</span> kr <span class="token operator">=</span> <span class="token function">thread_get_state</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> <span class="token function">smThreadStateByCPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">thread_state_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>machineContext<span class="token punctuation">.</span>__ss<span class="token punctuation">,</span> <span class="token operator">&amp;</span>state_count<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>创建一个栈结构体用来保存栈的数据</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//为通用回溯设计结构支持栈地址由小到大，地址里存储上个栈指针的地址</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">SMStackFrame</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">SMStackFrame</span> <span class="token operator">*</span><span class="token keyword">const</span> previous<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token class-name">uintptr_t</span> return_address<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> SMStackFrame<span class="token punctuation">;</span>

SMStackFrame stackFrame <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token comment">//通过栈基址指针获取当前栈帧地址</span>
<span class="token keyword">const</span> <span class="token class-name">uintptr_t</span> framePointer <span class="token operator">=</span> <span class="token function">smMachStackBasePointerByCPU</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>machineContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>framePointer <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">smMemCopySafely</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>framePointer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stackFrame<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stackFrame<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> KERN_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> @<span class="token string">"Fail frame pointer"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> stackFrame<span class="token punctuation">.</span>return_address<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> stackFrame<span class="token punctuation">.</span>previous <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">smMemCopySafely</span><span class="token punctuation">(</span>stackFrame<span class="token punctuation">.</span>previous<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stackFrame<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stackFrame<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> KERN_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="符号化"><a href="#符号化" class="headerlink" title="符号化"></a>符号化</h2><p>符号化主要思想就是通过栈指针地址减去 Slide 地址得到 ASLR 偏移量，通过这个偏移量可以在 __LINKEDIT segment 查找到字符串和符号表的位置。具体代码实现如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">info<span class="token operator">-></span>dli_fname <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
info<span class="token operator">-></span>dli_fbase <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
info<span class="token operator">-></span>dli_sname <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
info<span class="token operator">-></span>dli_saddr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token comment">//根据地址获取是哪个 image</span>
<span class="token keyword">const</span> <span class="token class-name">uint32_t</span> idx <span class="token operator">=</span> <span class="token function">smDyldImageIndexFromAddress</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> UINT_MAX<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> false<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/*
 Header
 ------------------
 Load commands
 Segment command 1 -------------|
 Segment command 2              |
 ------------------             |
 Data                           |
 Section 1 data |segment 1 &lt;----|
 Section 2 data |          &lt;----|
 Section 3 data |          &lt;----|
 Section 4 data |segment 2
 Section 5 data |
 ...            |
 Section n data |
 */</span>
<span class="token comment">/*----------Mach Header---------*/</span>
<span class="token comment">//根据 image 的序号获取 mach_header</span>
<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">mach_header</span><span class="token operator">*</span> machHeader <span class="token operator">=</span> <span class="token function">_dyld_get_image_header</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//返回 image_index 索引的 image 的虚拟内存地址 slide 的数量，如果 image_index 超出范围返回0</span>
<span class="token comment">//动态链接器加载 image 时，image 必须映射到未占用地址的进程的虚拟地址空间。动态链接器通过添加一个值到 image 的基地址来实现，这个值是虚拟内存 slide 数量</span>
<span class="token keyword">const</span> <span class="token class-name">uintptr_t</span> imageVMAddressSlide <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span><span class="token function">_dyld_get_image_vmaddr_slide</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*-----------ASLR 的偏移量---------*/</span>
<span class="token comment">//https://en.wikipedia.org/wiki/Address_space_layout_randomization</span>
<span class="token keyword">const</span> <span class="token class-name">uintptr_t</span> addressWithSlide <span class="token operator">=</span> address <span class="token operator">-</span> imageVMAddressSlide<span class="token punctuation">;</span>
<span class="token comment">//根据 Image 的 Index 来获取 segment 的基地址</span>
<span class="token comment">//段定义Mach-O文件中的字节范围以及动态链接器加载应用程序时这些字节映射到虚拟内存中的地址和内存保护属性。 因此，段总是虚拟内存页对齐。 片段包含零个或多个节。</span>
<span class="token keyword">const</span> <span class="token class-name">uintptr_t</span> segmentBase <span class="token operator">=</span> <span class="token function">smSegmentBaseOfImageIndex</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span> <span class="token operator">+</span> imageVMAddressSlide<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>segmentBase <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> false<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//</span>
info<span class="token operator">-></span>dli_fname <span class="token operator">=</span> <span class="token function">_dyld_get_image_name</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
info<span class="token operator">-></span>dli_fbase <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>machHeader<span class="token punctuation">;</span>

<span class="token comment">/*--------------Mach Segment-------------*/</span>
<span class="token comment">//地址最匹配的symbol</span>
<span class="token keyword">const</span> nlistByCPU<span class="token operator">*</span> bestMatch <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token class-name">uintptr_t</span> bestDistance <span class="token operator">=</span> ULONG_MAX<span class="token punctuation">;</span>
<span class="token class-name">uintptr_t</span> cmdPointer <span class="token operator">=</span> <span class="token function">smCmdFirstPointerFromMachHeader</span><span class="token punctuation">(</span>machHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>cmdPointer <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> false<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//遍历每个 segment 判断目标地址是否落在该 segment 包含的范围里</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> iCmd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> iCmd <span class="token operator">&lt;</span> machHeader<span class="token operator">-></span>ncmds<span class="token punctuation">;</span> iCmd<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">load_command</span><span class="token operator">*</span> loadCmd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">load_command</span><span class="token operator">*</span><span class="token punctuation">)</span>cmdPointer<span class="token punctuation">;</span>
    <span class="token comment">/*----------目标 Image 的符号表----------*/</span>
    <span class="token comment">//Segment 除了 __TEXT 和 __DATA 外还有 __LINKEDIT segment，它里面包含动态链接器的使用的原始数据，比如符号，字符串和重定位表项。</span>
    <span class="token comment">//LC_SYMTAB 描述了 __LINKEDIT segment 内查找字符串和符号表的位置</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loadCmd<span class="token operator">-></span>cmd <span class="token operator">==</span> LC_SYMTAB<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//获取字符串和符号表的虚拟内存偏移量。</span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">symtab_command</span><span class="token operator">*</span> symtabCmd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">symtab_command</span><span class="token operator">*</span><span class="token punctuation">)</span>cmdPointer<span class="token punctuation">;</span>
        <span class="token keyword">const</span> nlistByCPU<span class="token operator">*</span> symbolTable <span class="token operator">=</span> <span class="token punctuation">(</span>nlistByCPU<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>segmentBase <span class="token operator">+</span> symtabCmd<span class="token operator">-></span>symoff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token class-name">uintptr_t</span> stringTable <span class="token operator">=</span> segmentBase <span class="token operator">+</span> symtabCmd<span class="token operator">-></span>stroff<span class="token punctuation">;</span>
        
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> iSym <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> iSym <span class="token operator">&lt;</span> symtabCmd<span class="token operator">-></span>nsyms<span class="token punctuation">;</span> iSym<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//如果 n_value 是0，symbol 指向外部对象</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>symbolTable<span class="token punctuation">[</span>iSym<span class="token punctuation">]</span><span class="token punctuation">.</span>n_value <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//给定的偏移量是文件偏移量，减去 __LINKEDIT segment 的文件偏移量获得字符串和符号表的虚拟内存偏移量</span>
                <span class="token class-name">uintptr_t</span> symbolBase <span class="token operator">=</span> symbolTable<span class="token punctuation">[</span>iSym<span class="token punctuation">]</span><span class="token punctuation">.</span>n_value<span class="token punctuation">;</span>
                <span class="token class-name">uintptr_t</span> currentDistance <span class="token operator">=</span> addressWithSlide <span class="token operator">-</span> symbolBase<span class="token punctuation">;</span>
                <span class="token comment">//寻找最小的距离 bestDistance，因为 addressWithSlide 是某个方法的指令地址，要大于这个方法的入口。</span>
                <span class="token comment">//离 addressWithSlide 越近的函数入口越匹配</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addressWithSlide <span class="token operator">>=</span> symbolBase<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>currentDistance <span class="token operator">&lt;=</span> bestDistance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    bestMatch <span class="token operator">=</span> symbolTable <span class="token operator">+</span> iSym<span class="token punctuation">;</span>
                    bestDistance <span class="token operator">=</span> currentDistance<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bestMatch <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//将虚拟内存偏移量添加到 __LINKEDIT segment 的虚拟内存地址可以提供字符串和符号表的内存 address。</span>
            info<span class="token operator">-></span>dli_saddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>bestMatch<span class="token operator">-></span>n_value <span class="token operator">+</span> imageVMAddressSlide<span class="token punctuation">)</span><span class="token punctuation">;</span>
            info<span class="token operator">-></span>dli_sname <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token punctuation">)</span>stringTable <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token punctuation">)</span>bestMatch<span class="token operator">-></span>n_un<span class="token punctuation">.</span>n_strx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>info<span class="token operator">-></span>dli_sname <span class="token operator">==</span> <span class="token char">'_'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                info<span class="token operator">-></span>dli_sname<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">//所有的 symbols 的已经被处理好了</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token operator">-></span>dli_saddr <span class="token operator">==</span> info<span class="token operator">-></span>dli_fbase <span class="token operator">&amp;&amp;</span> bestMatch<span class="token operator">-></span>n_type <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                info<span class="token operator">-></span>dli_sname <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    cmdPointer <span class="token operator">+=</span> loadCmd<span class="token operator">-></span>cmdsize<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="需要注意的地方"><a href="#需要注意的地方" class="headerlink" title="需要注意的地方"></a>需要注意的地方</h2><p>需要注意的是这个程序有消耗性能的地方 thread get state。这个也会被监控检查出，所以可以过滤掉这样的堆栈信息。</p>
<h1 id="能够获取更多信息的方法"><a href="#能够获取更多信息的方法" class="headerlink" title="能够获取更多信息的方法"></a>能够获取更多信息的方法</h1><p>获取更多信息比如全层级方法调用和每个方法消耗的时间，那么这样做的好处在哪呢？</p>
<p>可以更细化的测量时间消耗，找到耗时方法，更快的交互操作能使用户体验更好，下面是一些可以去衡量的场景：</p>
<ul>
<li>响应能力</li>
<li>按钮点击</li>
<li>手势操作</li>
<li>Tab 切换</li>
<li>vc 的切换和转场</li>
</ul>
<p>可以给优化定个目标，比如滚动和动画达到 60fps，响应用户操作在 100ms 内完成。然后逐个检测出来 fix 掉。</p>
<p>如何获取到更多信息呢？</p>
<p>通过 hook objc_msgSend 方法能够获取所有被调用的方法，记录深度就能够得到方法调用的树状结构，通过执行前后时间的记录能够得到每个方法的耗时，这样就能获取一份完整的性能消耗信息了。</p>
<p>hook c 函数可以使用 facebook 的 <a target="_blank" rel="noopener" href="https://github.com/facebook/fishhook">fishhook</a>， 获取方法调用树状结构可以使用 <a target="_blank" rel="noopener" href="https://github.com/DavidGoldman/InspectiveC">InspectiveC</a>，下面对于他们的实现详细介绍一下：</p>
<h2 id="获取方法调用树结构"><a href="#获取方法调用树结构" class="headerlink" title="获取方法调用树结构"></a>获取方法调用树结构</h2><p>首先设计两个结构体，CallRecord 记录调用方法详细信息，包括 obj 和 SEL 等，ThreadCallStack 里面需要用 index 记录当前调用方法树的深度。有了 SEL 再通过 NSStringFromSelector 就能够取得方法名，有了 obj 通过 object_getClass 能够得到 Class 再用 NSStringFromClass 就能够获得类名。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// Shared structures.</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">CallRecord_</span> <span class="token punctuation">&#123;</span>
  id obj<span class="token punctuation">;</span>   <span class="token comment">//通过 object_getClass 能够得到 Class 再通过 NSStringFromClass 能够得到类名</span>
  SEL _cmd<span class="token punctuation">;</span> <span class="token comment">//通过 NSStringFromSelector 方法能够得到方法名</span>
  <span class="token class-name">uintptr_t</span> lr<span class="token punctuation">;</span>
  <span class="token keyword">int</span> prevHitIndex<span class="token punctuation">;</span>
  <span class="token keyword">char</span> isWatchHit<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> CallRecord<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">ThreadCallStack_</span> <span class="token punctuation">&#123;</span>
  FILE <span class="token operator">*</span>file<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>spacesStr<span class="token punctuation">;</span>
  CallRecord <span class="token operator">*</span>stack<span class="token punctuation">;</span>
  <span class="token keyword">int</span> allocatedLength<span class="token punctuation">;</span>
  <span class="token keyword">int</span> index<span class="token punctuation">;</span> <span class="token comment">//index 记录当前调用方法树的深度</span>
  <span class="token keyword">int</span> numWatchHits<span class="token punctuation">;</span>
  <span class="token keyword">int</span> lastPrintedIndex<span class="token punctuation">;</span>
  <span class="token keyword">int</span> lastHitIndex<span class="token punctuation">;</span>
  <span class="token keyword">char</span> isLoggingEnabled<span class="token punctuation">;</span>
  <span class="token keyword">char</span> isCompleteLoggingEnabled<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> ThreadCallStack<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="存储读取-ThreadCallStack"><a href="#存储读取-ThreadCallStack" class="headerlink" title="存储读取 ThreadCallStack"></a>存储读取 ThreadCallStack</h2><p>pthread_setspecific() 可以将私有数据设置在指定线程上，pthread_getspecific() 用来读取这个私有数据，利用这个特性可以就可以将 ThreadCallStack 的数据和该线程绑定在一起，随时进行数据的存取。代码如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> ThreadCallStack <span class="token operator">*</span> <span class="token function">getThreadCallStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  ThreadCallStack <span class="token operator">*</span>cs <span class="token operator">=</span> <span class="token punctuation">(</span>ThreadCallStack <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">pthread_getspecific</span><span class="token punctuation">(</span>threadKey<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//读取</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cs <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    cs <span class="token operator">=</span> <span class="token punctuation">(</span>ThreadCallStack <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>ThreadCallStack<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">MAIN_THREAD_ONLY</span></span>
    cs<span class="token operator">-></span>file <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">pthread_main_np</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">newFileForThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    cs<span class="token operator">-></span>file <span class="token operator">=</span> <span class="token function">newFileForThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    cs<span class="token operator">-></span>isLoggingEnabled <span class="token operator">=</span> <span class="token punctuation">(</span>cs<span class="token operator">-></span>file <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cs<span class="token operator">-></span>isCompleteLoggingEnabled <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    cs<span class="token operator">-></span>spacesStr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>DEFAULT_CALLSTACK_DEPTH <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>cs<span class="token operator">-></span>spacesStr<span class="token punctuation">,</span> <span class="token char">' '</span><span class="token punctuation">,</span> DEFAULT_CALLSTACK_DEPTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cs<span class="token operator">-></span>spacesStr<span class="token punctuation">[</span>DEFAULT_CALLSTACK_DEPTH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
    cs<span class="token operator">-></span>stack <span class="token operator">=</span> <span class="token punctuation">(</span>CallRecord <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span>DEFAULT_CALLSTACK_DEPTH<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CallRecord<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//分配 CallRecord 默认空间</span>
    cs<span class="token operator">-></span>allocatedLength <span class="token operator">=</span> DEFAULT_CALLSTACK_DEPTH<span class="token punctuation">;</span>
    cs<span class="token operator">-></span>index <span class="token operator">=</span> cs<span class="token operator">-></span>lastPrintedIndex <span class="token operator">=</span> cs<span class="token operator">-></span>lastHitIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    cs<span class="token operator">-></span>numWatchHits <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">pthread_setspecific</span><span class="token punctuation">(</span>threadKey<span class="token punctuation">,</span> cs<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//保存数据</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> cs<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="记录方法调用深度"><a href="#记录方法调用深度" class="headerlink" title="记录方法调用深度"></a>记录方法调用深度</h2><p>因为要记录深度，而一个方法的调用里会有更多的方法调用，所以方法的调用写两个方法分别记录开始 pushCallRecord 和记录结束的时刻 popCallRecord，这样才能够通过在开始时对深度加一在结束时减一。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//开始时</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">pushCallRecord</span><span class="token punctuation">(</span>id obj<span class="token punctuation">,</span> <span class="token class-name">uintptr_t</span> lr<span class="token punctuation">,</span> SEL _cmd<span class="token punctuation">,</span> ThreadCallStack <span class="token operator">*</span>cs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> nextIndex <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">++</span>cs<span class="token operator">-></span>index<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//增加深度</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextIndex <span class="token operator">>=</span> cs<span class="token operator">-></span>allocatedLength<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    cs<span class="token operator">-></span>allocatedLength <span class="token operator">+=</span> CALLSTACK_DEPTH_INCREMENT<span class="token punctuation">;</span>
    cs<span class="token operator">-></span>stack <span class="token operator">=</span> <span class="token punctuation">(</span>CallRecord <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">realloc</span><span class="token punctuation">(</span>cs<span class="token operator">-></span>stack<span class="token punctuation">,</span> cs<span class="token operator">-></span>allocatedLength <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CallRecord<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cs<span class="token operator">-></span>spacesStr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">realloc</span><span class="token punctuation">(</span>cs<span class="token operator">-></span>spacesStr<span class="token punctuation">,</span> cs<span class="token operator">-></span>allocatedLength <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>cs<span class="token operator">-></span>spacesStr<span class="token punctuation">,</span> <span class="token char">' '</span><span class="token punctuation">,</span> cs<span class="token operator">-></span>allocatedLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cs<span class="token operator">-></span>spacesStr<span class="token punctuation">[</span>cs<span class="token operator">-></span>allocatedLength<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  CallRecord <span class="token operator">*</span>newRecord <span class="token operator">=</span> <span class="token operator">&amp;</span>cs<span class="token operator">-></span>stack<span class="token punctuation">[</span>nextIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
  newRecord<span class="token operator">-></span>obj <span class="token operator">=</span> obj<span class="token punctuation">;</span>
  newRecord<span class="token operator">-></span>_cmd <span class="token operator">=</span> _cmd<span class="token punctuation">;</span>
  newRecord<span class="token operator">-></span>lr <span class="token operator">=</span> lr<span class="token punctuation">;</span>
  newRecord<span class="token operator">-></span>isWatchHit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//结束时</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> CallRecord <span class="token operator">*</span> <span class="token function">popCallRecord</span><span class="token punctuation">(</span>ThreadCallStack <span class="token operator">*</span>cs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token operator">&amp;</span>cs<span class="token operator">-></span>stack<span class="token punctuation">[</span>cs<span class="token operator">-></span>index<span class="token operator">--</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//减少深度</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="在-objc-msgSend-前后插入执行方法"><a href="#在-objc-msgSend-前后插入执行方法" class="headerlink" title="在 objc_msgSend 前后插入执行方法"></a>在 objc_msgSend 前后插入执行方法</h2><p>最后是 hook objc_msgSend 需要在调用前和调用后分别加入 pushCallRecord 和 popCallRecord。因为需要在调用后这个时机插入一个方法，而且不可能编写一个保留未知参数并跳转到 c 中任意函数指针的函数，那么这就需要用到汇编来做到。</p>
<p>下面针对 arm64 进行分析，arm64 有31个64 bit 的整数型寄存器，用 x0 到 x30 表示，主要思路就是先入栈参数，参数寄存器是 x0 - x7，对于objc_msgSend方法来说 x0 第一个参数是传入对象，x1 第二个参数是选择器 _cmd。 syscall 的 number 会放到 x8 里。然后交换寄存器中，将用于返回的寄存器 lr 移到 x1 里。先让 pushCallRecord 能够执行，再执行原始的 objc_msgSend，保存返回值，最后让 popCallRecord 能执行。具体代码如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">replacementObjc_msgSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  __asm__ <span class="token keyword">volatile</span> <span class="token punctuation">(</span>
    <span class="token comment">// sp 是堆栈寄存器，存放栈的偏移地址，每次都指向栈顶。</span>
    <span class="token comment">// 保存 &#123;q0-q7&#125; 偏移地址到 sp 寄存器</span>
      <span class="token string">"stp q6, q7, [sp, #-32]!\n"</span>
      <span class="token string">"stp q4, q5, [sp, #-32]!\n"</span>
      <span class="token string">"stp q2, q3, [sp, #-32]!\n"</span>
      <span class="token string">"stp q0, q1, [sp, #-32]!\n"</span>
    <span class="token comment">// 保存 &#123;x0-x8, lr&#125;</span>
      <span class="token string">"stp x8, lr, [sp, #-16]!\n"</span>
      <span class="token string">"stp x6, x7, [sp, #-16]!\n"</span>
      <span class="token string">"stp x4, x5, [sp, #-16]!\n"</span>
      <span class="token string">"stp x2, x3, [sp, #-16]!\n"</span>
      <span class="token string">"stp x0, x1, [sp, #-16]!\n"</span>
    <span class="token comment">// 交换参数.</span>
      <span class="token string">"mov x2, x1\n"</span>
      <span class="token string">"mov x1, lr\n"</span>
      <span class="token string">"mov x3, sp\n"</span>
    <span class="token comment">// 调用 preObjc_msgSend，使用 bl label 语法。bl 执行一个分支链接操作，label 是无条件分支的，是和本指令的地址偏移，范围是 -128MB 到 +128MB</span>
      <span class="token string">"bl __Z15preObjc_msgSendP11objc_objectmP13objc_selectorP9RegState_\n"</span>
      <span class="token string">"mov x9, x0\n"</span>
      <span class="token string">"mov x10, x1\n"</span>
      <span class="token string">"tst x10, x10\n"</span>
    <span class="token comment">// 读取 &#123;x0-x8, lr&#125; 从保存到 sp 栈顶的偏移地址读起</span>
      <span class="token string">"ldp x0, x1, [sp], #16\n"</span>
      <span class="token string">"ldp x2, x3, [sp], #16\n"</span>
      <span class="token string">"ldp x4, x5, [sp], #16\n"</span>
      <span class="token string">"ldp x6, x7, [sp], #16\n"</span>
      <span class="token string">"ldp x8, lr, [sp], #16\n"</span>
    <span class="token comment">// 读取 &#123;q0-q7&#125;</span>
      <span class="token string">"ldp q0, q1, [sp], #32\n"</span>
      <span class="token string">"ldp q2, q3, [sp], #32\n"</span>
      <span class="token string">"ldp q4, q5, [sp], #32\n"</span>
      <span class="token string">"ldp q6, q7, [sp], #32\n"</span>
      <span class="token string">"b.eq Lpassthrough\n"</span>
    <span class="token comment">// 调用原始 objc_msgSend。使用 blr xn 语法。blr 除了从指定寄存器读取新的 PC 值外效果和 bl 一样。xn 是通用寄存器的64位名称分支地址，范围0到31</span>
      <span class="token string">"blr x9\n"</span>
    <span class="token comment">// 保存 &#123;x0-x9&#125;</span>
      <span class="token string">"stp x0, x1, [sp, #-16]!\n"</span>
      <span class="token string">"stp x2, x3, [sp, #-16]!\n"</span>
      <span class="token string">"stp x4, x5, [sp, #-16]!\n"</span>
      <span class="token string">"stp x6, x7, [sp, #-16]!\n"</span>
      <span class="token string">"stp x8, x9, [sp, #-16]!\n"</span>
    <span class="token comment">// 保存 &#123;q0-q7&#125;</span>
      <span class="token string">"stp q0, q1, [sp, #-32]!\n"</span>
      <span class="token string">"stp q2, q3, [sp, #-32]!\n"</span>
      <span class="token string">"stp q4, q5, [sp, #-32]!\n"</span>
      <span class="token string">"stp q6, q7, [sp, #-32]!\n"</span>
    <span class="token comment">// 调用 postObjc_msgSend hook.</span>
      <span class="token string">"bl __Z16postObjc_msgSendv\n"</span>
      <span class="token string">"mov lr, x0\n"</span>
    <span class="token comment">// 读取 &#123;q0-q7&#125;</span>
      <span class="token string">"ldp q6, q7, [sp], #32\n"</span>
      <span class="token string">"ldp q4, q5, [sp], #32\n"</span>
      <span class="token string">"ldp q2, q3, [sp], #32\n"</span>
      <span class="token string">"ldp q0, q1, [sp], #32\n"</span>
    <span class="token comment">// 读取 &#123;x0-x9&#125;</span>
      <span class="token string">"ldp x8, x9, [sp], #16\n"</span>
      <span class="token string">"ldp x6, x7, [sp], #16\n"</span>
      <span class="token string">"ldp x4, x5, [sp], #16\n"</span>
      <span class="token string">"ldp x2, x3, [sp], #16\n"</span>
      <span class="token string">"ldp x0, x1, [sp], #16\n"</span>
      <span class="token string">"ret\n"</span>
      <span class="token string">"Lpassthrough:\n"</span>
    <span class="token comment">// br 无条件分支到寄存器中的地址</span>
      <span class="token string">"br x9"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="记录时间的方法"><a href="#记录时间的方法" class="headerlink" title="记录时间的方法"></a>记录时间的方法</h2><p>为了记录耗时，这样就需要在 pushCallRecord 和 popCallRecord 里记录下时间。下面列出一些计算一段代码开始到结束的时间的方法</p>
<p>第一种： NSDate 微秒</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec">NSDate<span class="token operator">*</span> tmpStartData <span class="token operator">=</span> <span class="token punctuation">[</span>NSDate date<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">//some code need caculate</span>
<span class="token keyword">double</span> deltaTime <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSDate date<span class="token punctuation">]</span> timeIntervalSinceDate<span class="token punctuation">:</span>tmpStartData<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@"cost time: %f s"</span><span class="token punctuation">,</span> deltaTime<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>第二种：clock_t 微秒clock_t计时所表示的是占用CPU的时钟单元</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec">clock_t start <span class="token operator">=</span> <span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//some code need caculate</span>
clock_t end <span class="token operator">=</span> <span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@"cost time: %f s"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token operator">/</span>CLOCKS_PER_SEC<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>第三种：CFAbsoluteTime 微秒</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec">CFAbsoluteTime start <span class="token operator">=</span> <span class="token function">CFAbsoluteTimeGetCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//some code need caculate</span>
CFAbsoluteTime end <span class="token operator">=</span> <span class="token function">CFAbsoluteTimeGetCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@"cost time = %f s"</span><span class="token punctuation">,</span> end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//s</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>第四种：CFTimeInterval 纳秒</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec">CFTimeInterval start <span class="token operator">=</span> <span class="token function">CACurrentMediaTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//some code need caculate</span>
CFTimeInterval end <span class="token operator">=</span> <span class="token function">CACurrentMediaTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@"cost time: %f s"</span><span class="token punctuation">,</span> end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>第五种：mach_absolute_time 纳秒</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec">uint64_t start <span class="token operator">=</span> <span class="token function">mach_absolute_time</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//some code need caculate</span>
uint64_t end <span class="token operator">=</span> <span class="token function">mach_absolute_time</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
uint64_t elapsed <span class="token operator">=</span> <span class="token number">1e-9</span> <span class="token operator">*</span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后两种可用，本质区别<br>NSDate 或 CFAbsoluteTimeGetCurrent() 返回的时钟时间将会会网络时间同步，从时钟 偏移量的角度。mach_absolute_time() 和 CACurrentMediaTime() 是基于内建时钟的。选择一种，加到 pushCallRecord 和 popCallRecord 里，相减就能够获得耗时。</p>
<h1 id="如何-hook-msgsend-方法"><a href="#如何-hook-msgsend-方法" class="headerlink" title="如何 hook msgsend 方法"></a>如何 hook msgsend 方法</h1><p>那么 objc_msgSend 这个 c 方法是如何 hook 到的呢。首先了解下 dyld 是通过更新 Mach-O 二进制的 __DATA segment 特定的部分中的指针来邦定 lazy 和 non-lazy 符号，通过确认传递给 rebind_symbol 里每个符号名称更新的位置就可以找出对应替换来重新绑定这些符号。下面针对关键代码进行分析：</p>
<h2 id="遍历-dyld"><a href="#遍历-dyld" class="headerlink" title="遍历 dyld"></a>遍历 dyld</h2><p>首先是遍历 dyld 里的所有的 image，取出 image header 和 slide。注意第一次调用时主要注册 callback。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_rebindings_head<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">_dyld_register_func_for_add_image</span><span class="token punctuation">(</span>_rebind_symbols_for_image<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">uint32_t</span> c <span class="token operator">=</span> <span class="token function">_dyld_image_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> c<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">_rebind_symbols_for_image</span><span class="token punctuation">(</span><span class="token function">_dyld_get_image_header</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_dyld_get_image_vmaddr_slide</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="找出符号表相关-Command"><a href="#找出符号表相关-Command" class="headerlink" title="找出符号表相关 Command"></a>找出符号表相关 Command</h2><p>接下来需要找到符号表相关的 command，包括 linkedit segment command，symtab command 和 dysymtab command。方法如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">segment_command_t</span> <span class="token operator">*</span>cur_seg_cmd<span class="token punctuation">;</span>
<span class="token class-name">segment_command_t</span> <span class="token operator">*</span>linkedit_segment <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">symtab_command</span><span class="token operator">*</span> symtab_cmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">dysymtab_command</span><span class="token operator">*</span> dysymtab_cmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

<span class="token class-name">uintptr_t</span> cur <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>header <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">mach_header_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>uint i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> header<span class="token operator">-></span>ncmds<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> cur <span class="token operator">+=</span> cur_seg_cmd<span class="token operator">-></span>cmdsize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    cur_seg_cmd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">segment_command_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>cur<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_seg_cmd<span class="token operator">-></span>cmd <span class="token operator">==</span> LC_SEGMENT_ARCH_DEPENDENT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur_seg_cmd<span class="token operator">-></span>segname<span class="token punctuation">,</span> SEG_LINKEDIT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            linkedit_segment <span class="token operator">=</span> cur_seg_cmd<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_seg_cmd<span class="token operator">-></span>cmd <span class="token operator">==</span> LC_SYMTAB<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        symtab_cmd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">symtab_command</span><span class="token operator">*</span><span class="token punctuation">)</span>cur_seg_cmd<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_seg_cmd<span class="token operator">-></span>cmd <span class="token operator">==</span> LC_DYSYMTAB<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        dysymtab_cmd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dysymtab_command</span><span class="token operator">*</span><span class="token punctuation">)</span>cur_seg_cmd<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="获得-base-和-indirect-符号表"><a href="#获得-base-和-indirect-符号表" class="headerlink" title="获得 base 和 indirect 符号表"></a>获得 base 和 indirect 符号表</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// Find base symbol/string table addresses</span>
<span class="token class-name">uintptr_t</span> linkedit_base <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>slide <span class="token operator">+</span> linkedit_segment<span class="token operator">-></span>vmaddr <span class="token operator">-</span> linkedit_segment<span class="token operator">-></span>fileoff<span class="token punctuation">;</span>
<span class="token class-name">nlist_t</span> <span class="token operator">*</span>symtab <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">nlist_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>linkedit_base <span class="token operator">+</span> symtab_cmd<span class="token operator">-></span>symoff<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> <span class="token operator">*</span>strtab <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>linkedit_base <span class="token operator">+</span> symtab_cmd<span class="token operator">-></span>stroff<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get indirect symbol table (array of uint32_t indices into symbol table)</span>
<span class="token class-name">uint32_t</span> <span class="token operator">*</span>indirect_symtab <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>linkedit_base <span class="token operator">+</span> dysymtab_cmd<span class="token operator">-></span>indirectsymoff<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="进行方法替换"><a href="#进行方法替换" class="headerlink" title="进行方法替换"></a>进行方法替换</h2><p>有了符号表和传入的方法替换数组就可以进行符号表访问指针地址的替换，具体实现如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint32_t</span> <span class="token operator">*</span>indirect_symbol_indices <span class="token operator">=</span> indirect_symtab <span class="token operator">+</span> section<span class="token operator">-></span>reserved1<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>indirect_symbol_bindings <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>slide <span class="token operator">+</span> section<span class="token operator">-></span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>uint i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> section<span class="token operator">-></span>size <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">uint32_t</span> symtab_index <span class="token operator">=</span> indirect_symbol_indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>symtab_index <span class="token operator">==</span> INDIRECT_SYMBOL_ABS <span class="token operator">||</span> symtab_index <span class="token operator">==</span> INDIRECT_SYMBOL_LOCAL <span class="token operator">||</span>
        symtab_index <span class="token operator">==</span> <span class="token punctuation">(</span>INDIRECT_SYMBOL_LOCAL   <span class="token operator">|</span> INDIRECT_SYMBOL_ABS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">uint32_t</span> strtab_offset <span class="token operator">=</span> symtab<span class="token punctuation">[</span>symtab_index<span class="token punctuation">]</span><span class="token punctuation">.</span>n_un<span class="token punctuation">.</span>n_strx<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>symbol_name <span class="token operator">=</span> strtab <span class="token operator">+</span> strtab_offset<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strnlen</span><span class="token punctuation">(</span>symbol_name<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">struct</span> <span class="token class-name">rebindings_entry</span> <span class="token operator">*</span>cur <span class="token operator">=</span> rebindings<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>cur<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>uint j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> cur<span class="token operator">-></span>rebindings_nel<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>symbol_name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cur<span class="token operator">-></span>rebindings<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cur<span class="token operator">-></span>rebindings<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>replaced <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span>
                    indirect_symbol_bindings<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> cur<span class="token operator">-></span>rebindings<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>replacement<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token operator">*</span><span class="token punctuation">(</span>cur<span class="token operator">-></span>rebindings<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>replaced<span class="token punctuation">)</span> <span class="token operator">=</span> indirect_symbol_bindings<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                indirect_symbol_bindings<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> cur<span class="token operator">-></span>rebindings<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>replacement<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> symbol_loop<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        cur <span class="token operator">=</span> cur<span class="token operator">-></span>next<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
symbol_loop<span class="token operator">:</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="统计方法调用频次"><a href="#统计方法调用频次" class="headerlink" title="统计方法调用频次"></a>统计方法调用频次</h1><p>在一些应用场景会有一些频繁的方法调用，有些方法的调用实际上是没有必要的，但是首先是需要将那些频繁调用的方法找出来这样才能够更好的定位到潜在的会造成性能浪费的方法使用。这些频繁调用的方法要怎么找呢？</p>
<p>大致的思路是这样，基于上面章节提到的记录方法调用深度的方案，将每个调用方法的路径保存住，调用相同路径的相同方法调用一次加一记录在数据库中，最后做一个视图按照调用次数的排序即可找到调用频繁的那些方法。下图是完成后展示的效果：</p>
<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/uploads/deeply-ios-performance-optimization/07.PNG" class="lozad post-image"src="/uploads/deeply-ios-performance-optimization/07.PNG"></p>
<p>接下来看看具体实现方式</p>
<h2 id="设计方法调用频次记录的结构"><a href="#设计方法调用频次记录的结构" class="headerlink" title="设计方法调用频次记录的结构"></a>设计方法调用频次记录的结构</h2><p>在先前时间消耗的 model 基础上增加路径，频次等信息</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> strong<span class="token punctuation">)</span> NSString <span class="token operator">*</span>className<span class="token punctuation">;</span>       <span class="token comment">//类名</span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> strong<span class="token punctuation">)</span> NSString <span class="token operator">*</span>methodName<span class="token punctuation">;</span>      <span class="token comment">//方法名</span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> assign<span class="token punctuation">)</span> BOOL isClassMethod<span class="token punctuation">;</span>        <span class="token comment">//是否是类方法</span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> assign<span class="token punctuation">)</span> NSTimeInterval timeCost<span class="token punctuation">;</span>   <span class="token comment">//时间消耗</span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> assign<span class="token punctuation">)</span> NSUInteger callDepth<span class="token punctuation">;</span>      <span class="token comment">//Call 层级</span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> copy<span class="token punctuation">)</span> NSString <span class="token operator">*</span>path<span class="token punctuation">;</span>              <span class="token comment">//路径</span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> assign<span class="token punctuation">)</span> BOOL lastCall<span class="token punctuation">;</span>             <span class="token comment">//是否是最后一个 Call</span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> assign<span class="token punctuation">)</span> NSUInteger frequency<span class="token punctuation">;</span>      <span class="token comment">//访问频次</span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> strong<span class="token punctuation">)</span> NSArray <span class="token operator">&lt;</span>SMCallTraceTimeCostModel <span class="token operator">*</span><span class="token operator">></span> <span class="token operator">*</span>subCosts<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="拼装方法路径"><a href="#拼装方法路径" class="headerlink" title="拼装方法路径"></a>拼装方法路径</h2><p>在遍历 SMCallTrace 记录的方法 model 和 遍历方法子方法时将路径拼装好，记录到数据库中</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token keyword">for</span> <span class="token punctuation">(</span>SMCallTraceTimeCostModel <span class="token operator">*</span>model <span class="token keyword">in</span> arr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//记录方法路径</span>
    model<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token punctuation">[</span>NSString stringWithFormat<span class="token punctuation">:</span><span class="token string">@"[%@ %@]"</span><span class="token punctuation">,</span>model<span class="token punctuation">.</span>className<span class="token punctuation">,</span>model<span class="token punctuation">.</span>methodName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span> appendRecord<span class="token punctuation">:</span>model to<span class="token punctuation">:</span>mStr<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>appendRecord<span class="token punctuation">:</span><span class="token punctuation">(</span>SMCallTraceTimeCostModel <span class="token operator">*</span><span class="token punctuation">)</span>cost to<span class="token punctuation">:</span><span class="token punctuation">(</span>NSMutableString <span class="token operator">*</span><span class="token punctuation">)</span>mStr <span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span>mStr appendFormat<span class="token punctuation">:</span><span class="token string">@"%@\n path%@\n"</span><span class="token punctuation">,</span><span class="token punctuation">[</span>cost des<span class="token punctuation">]</span><span class="token punctuation">,</span>cost<span class="token punctuation">.</span>path<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cost<span class="token punctuation">.</span>subCosts<span class="token punctuation">.</span>count <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        cost<span class="token punctuation">.</span>lastCall <span class="token operator">=</span> YES<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//记录到数据库中</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span>SMLagDB shareInstance<span class="token punctuation">]</span> increaseWithClsCallModel<span class="token punctuation">:</span>cost<span class="token punctuation">]</span> subscribeNext<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>SMCallTraceTimeCostModel <span class="token operator">*</span>model <span class="token keyword">in</span> cost<span class="token punctuation">.</span>subCosts<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//记录方法的子方法的路径</span>
        model<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token punctuation">[</span>NSString stringWithFormat<span class="token punctuation">:</span><span class="token string">@"%@ - [%@ %@]"</span><span class="token punctuation">,</span>cost<span class="token punctuation">.</span>path<span class="token punctuation">,</span>model<span class="token punctuation">.</span>className<span class="token punctuation">,</span>model<span class="token punctuation">.</span>methodName<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token keyword">self</span> appendRecord<span class="token punctuation">:</span>model to<span class="token punctuation">:</span>mStr<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="记录方法调用频次数据库"><a href="#记录方法调用频次数据库" class="headerlink" title="记录方法调用频次数据库"></a>记录方法调用频次数据库</h2><h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><p>这里的 lastcall 是记录是否是最后一个方法的调用，展示时只取最后一个方法即可，因为也会有完整路径可以知道父方法和来源方法。</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec">_clsCallDBPath <span class="token operator">=</span> <span class="token punctuation">[</span>PATH_OF_DOCUMENT stringByAppendingPathComponent<span class="token punctuation">:</span><span class="token string">@"clsCall.sqlite"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>NSFileManager defaultManager<span class="token punctuation">]</span> fileExistsAtPath<span class="token punctuation">:</span>_clsCallDBPath<span class="token punctuation">]</span> <span class="token operator">==</span> NO<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    FMDatabase <span class="token operator">*</span>db <span class="token operator">=</span> <span class="token punctuation">[</span>FMDatabase databaseWithPath<span class="token punctuation">:</span>_clsCallDBPath<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>db open<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/*
         cid: 主id
         fid: 父id 暂时不用
         cls: 类名
         mtd: 方法名
         path: 完整路径标识
         timecost: 方法消耗时长
         calldepth: 层级
         frequency: 调用次数
         lastcall: 是否是最后一个 call
         */</span>
        NSString <span class="token operator">*</span>createSql <span class="token operator">=</span> <span class="token string">@"create table clscall (cid INTEGER PRIMARY KEY AUTOINCREMENT  NOT NULL, fid integer, cls text, mtd text, path text, timecost integer, calldepth integer, frequency integer, lastcall integer)"</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>db executeUpdate<span class="token punctuation">:</span>createSql<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="添加记录"><a href="#添加记录" class="headerlink" title="添加记录"></a>添加记录</h3><p>添加记录时需要先检查数据库里是否有相同路径的同一个方法调用，这样可以给 frequency 字段加一已达到记录频次的目的。</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec">FMResultSet <span class="token operator">*</span>rsl <span class="token operator">=</span> <span class="token punctuation">[</span>db executeQuery<span class="token punctuation">:</span><span class="token string">@"select cid,frequency from clscall where path = ?"</span><span class="token punctuation">,</span> model<span class="token punctuation">.</span>path<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>rsl next<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//有相同路径就更新路径访问频率</span>
    <span class="token keyword">int</span> fq <span class="token operator">=</span> <span class="token punctuation">[</span>rsl intForColumn<span class="token punctuation">:</span><span class="token string">@"frequency"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> cid <span class="token operator">=</span> <span class="token punctuation">[</span>rsl intForColumn<span class="token punctuation">:</span><span class="token string">@"cid"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>db executeUpdate<span class="token punctuation">:</span><span class="token string">@"update clscall set frequency = ? where cid = ?"</span><span class="token punctuation">,</span> <span class="token operator">@</span><span class="token punctuation">(</span>fq<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">@</span><span class="token punctuation">(</span>cid<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//没有就添加一条记录</span>
    NSNumber <span class="token operator">*</span>lastCall <span class="token operator">=</span> <span class="token operator">@</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>model<span class="token punctuation">.</span>lastCall<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        lastCall <span class="token operator">=</span> <span class="token operator">@</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">[</span>db executeUpdate<span class="token punctuation">:</span><span class="token string">@"insert into clscall (cls, mtd, path, timecost, calldepth, frequency, lastcall) values (?, ?, ?, ?, ?, ?, ?)"</span><span class="token punctuation">,</span> model<span class="token punctuation">.</span>className<span class="token punctuation">,</span> model<span class="token punctuation">.</span>methodName<span class="token punctuation">,</span> model<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token operator">@</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>timeCost<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">@</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>callDepth<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">@</span><span class="token number">1</span><span class="token punctuation">,</span> lastCall<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>db close<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>subscriber sendCompleted<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="检索记录"><a href="#检索记录" class="headerlink" title="检索记录"></a>检索记录</h3><p>检索时注意按照调用频次字段进行排序即可。</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec">FMResultSet <span class="token operator">*</span>rs <span class="token operator">=</span> <span class="token punctuation">[</span>db executeQuery<span class="token punctuation">:</span><span class="token string">@"select * from clscall where lastcall=? order by frequency desc limit ?, 50"</span><span class="token punctuation">,</span><span class="token operator">@</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">@</span><span class="token punctuation">(</span>page <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
NSUInteger count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
NSMutableArray <span class="token operator">*</span>arr <span class="token operator">=</span> <span class="token punctuation">[</span>NSMutableArray array<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>rs next<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    SMCallTraceTimeCostModel <span class="token operator">*</span>model <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span> clsCallModelFromResultSet<span class="token punctuation">:</span>rs<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>arr addObject<span class="token punctuation">:</span>model<span class="token punctuation">]</span><span class="token punctuation">;</span>
    count <span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span>arr<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span>subscriber sendError<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>subscriber sendCompleted<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>db close<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="找出-CPU-使用大的线程堆栈"><a href="#找出-CPU-使用大的线程堆栈" class="headerlink" title="找出 CPU 使用大的线程堆栈"></a>找出 CPU 使用大的线程堆栈</h1><p>在前面检测卡顿打印的堆栈里提到使用 thread_info 能够获取到各个线程的 cpu 消耗，但是 cpu 不在主线程即使消耗很大也不一定会造成卡顿导致卡顿检测无法检测出更多 cpu 消耗的情况，所以只能通过轮询监控各线程里的 cpu 使用情况，对于超过标准值比如70%的进行记录来跟踪定位出耗电的那些方法。下图是列出 cpu 过载时的堆栈记录的展示效果：</p>
<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/uploads/deeply-ios-performance-optimization/08.PNG" class="lozad post-image"src="/uploads/deeply-ios-performance-optimization/08.PNG"></p>
<p>有了前面的基础，实现起来轻松多了</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec"><span class="token comment">//轮询检查多个线程 cpu 情况</span>
<span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>updateCPU <span class="token punctuation">&#123;</span>
    thread_act_array_t threads<span class="token punctuation">;</span>
    mach_msg_type_number_t threadCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> task_t thisTask <span class="token operator">=</span> <span class="token function">mach_task_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    kern_return_t kr <span class="token operator">=</span> <span class="token function">task_threads</span><span class="token punctuation">(</span>thisTask<span class="token punctuation">,</span> <span class="token operator">&amp;</span>threads<span class="token punctuation">,</span> <span class="token operator">&amp;</span>threadCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>kr <span class="token operator">!=</span> KERN_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threadCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        thread_info_data_t threadInfo<span class="token punctuation">;</span>
        thread_basic_info_t threadBaseInfo<span class="token punctuation">;</span>
        mach_msg_type_number_t threadInfoCount <span class="token operator">=</span> THREAD_INFO_MAX<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">thread_info</span><span class="token punctuation">(</span><span class="token punctuation">(</span>thread_act_t<span class="token punctuation">)</span>threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> THREAD_BASIC_INFO<span class="token punctuation">,</span> <span class="token punctuation">(</span>thread_info_t<span class="token punctuation">)</span>threadInfo<span class="token punctuation">,</span> <span class="token operator">&amp;</span>threadInfoCount<span class="token punctuation">)</span> <span class="token operator">==</span> KERN_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            threadBaseInfo <span class="token operator">=</span> <span class="token punctuation">(</span>thread_basic_info_t<span class="token punctuation">)</span>threadInfo<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>threadBaseInfo<span class="token operator">-></span>flags <span class="token operator">&amp;</span> TH_FLAGS_IDLE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                integer_t cpuUsage <span class="token operator">=</span> threadBaseInfo<span class="token operator">-></span>cpu_usage <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cpuUsage <span class="token operator">></span> <span class="token number">70</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//cup 消耗大于 70 时打印和记录堆栈</span>
                    NSString <span class="token operator">*</span>reStr <span class="token operator">=</span> <span class="token function">smStackOfThread</span><span class="token punctuation">(</span>threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//记录数据库中</span>
                    <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span>SMLagDB shareInstance<span class="token punctuation">]</span> increaseWithStackString<span class="token punctuation">:</span>reStr<span class="token punctuation">]</span> subscribeNext<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@"CPU useage overload thread stack：\n%@"</span><span class="token punctuation">,</span>reStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h1><p>工具已整合到先前做的 <a target="_blank" rel="noopener" href="https://github.com/ming1016/GCDFetchFeed">GCDFetchFeed</a> 里。</p>
<ul>
<li>子线程检测主线程卡顿使用的话在需要开始检测的地方添加 [[SMLagMonitor shareInstance] beginMonitor]; 即可。</li>
<li>需要检测所有方法调用的用法就是在需要检测的地方调用 [SMCallTrace start]; 就可以了，不检测打印出结果的话调用 stop 和 save 就好了。这里还可以设置最大深度和最小耗时检测来过滤不需要看到的信息。</li>
<li>方法调用频次使用可以在需要开始统计的地方加上 [SMCallTrace startWithMaxDepth:3]; 记录时使用 [SMCallTrace stopSaveAndClean]; 记录到到数据库中同时清理内存的占用。可以 hook VC 的 viewWillAppear 和 viewWillDisappear，在 appear 时开始记录，在 disappear 时记录到数据库同时清理一次。结果展示的 view controller 是 SMClsCallViewController，push 出来就能够看到列表结果。</li>
</ul>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><h2 id="WWDC"><a href="#WWDC" class="headerlink" title="WWDC"></a>WWDC</h2><ul>
<li>WWDC 2013 224 Designing Code for Performance</li>
<li>WWDC 2013 408 Optimizing Your Code Using LLVM</li>
<li>WWDC 2013 712 Energy Best Practices</li>
<li>WWDC 2014 710 writing energy efficient code part 1</li>
<li>WWDC 2014 710 writing energy efficient code part 2</li>
<li>WWDC 2015 230 performance on ios and watchos</li>
<li>WWDC 2015 707 achieving allday battery life</li>
<li>WWDC 2015 708 debugging energy issues</li>
<li>WWDC 2015 718 building responsive and efficient apps with gcd</li>
<li>WWDC 2016 406 optimizing app startup time</li>
<li>WWDC 2016 719 optimizing io for performance and battery life</li>
<li>WWDC 2017 238 writing energy efficient apps</li>
<li>WWDC 2017 706 modernizing grand central dispatch usage</li>
</ul>
<h1 id="PS"><a href="#PS" class="headerlink" title="PS:"></a>PS:</h1><p>最近我这需要招一名实习生来滴滴和我一起攻克一个工程开发效率的项目，绝对会成就感满满的，有兴趣的可以将简历发我 <a href="mailto:&#x64;&#97;&#105;&#x6d;&#105;&#x6e;&#x67;&#64;&#x64;&#x69;&#x64;&#105;&#99;&#x68;&#117;&#x78;&#x69;&#110;&#x67;&#46;&#x63;&#x6f;&#109;">&#x64;&#97;&#105;&#x6d;&#105;&#x6e;&#x67;&#64;&#x64;&#x69;&#x64;&#105;&#99;&#x68;&#117;&#x78;&#x69;&#110;&#x67;&#46;&#x63;&#x6f;&#109;</a> 或者在微博上联系我 @戴铭</p>

  </div>
  <div>
    
      <div 
        class="post-note note-warning copyright" 
        style="margin-top: 42px">
        <p>
          <span style="font-weight: bold;">作者：</span><a 
            target="_blank" 
            rel="nofollow noopener noreferrer" 
            href="/about">
            戴铭
          </a>
        </p>
        <p>
          <span style="font-weight: bold;">文章链接：</span><a 
            target="_blank" 
            rel="nofollow noopener noreferrer" 
            href="http://ming1016.github.io/2017/06/20/deeply-ios-performance-optimization/">
            http://ming1016.github.io/2017/06/20/deeply-ios-performance-optimization/
          </a>
        </p>
        <p><span style="font-weight: bold;">版权声明：</span>本博客所有文章除特别声明外，均采用<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0 协议</a>。转载请注明出处！</p>
      </div>
    
  </div>
</article>
<div class="nav">
  
    <div class="nav-item-prev">
      <a 
        href="/2017/10/11/deeply-analyse-webkit/" 
        class="nav-link">
        <i class="iconfont icon-left nav-prev-icon"></i>
        <div>
          <div class="nav-label">上一篇</div>
          
            <div class="nav-title">深入剖析 WebKit </div>
          
        </div>
      </a>
    </div>
  
  
    <div class="nav-item-next">
      <a 
        href="/2017/06/12/gmtc-ios-slimming-practice/" 
        class="nav-link">
        <div>
          <div class="nav-label">下一篇</div>
          
            <div class="nav-title">GMTC 上分享滴滴出行 iOS 端瘦身实践的 Slides </div>
          
        </div>
        <i class="iconfont icon-right nav-next-icon"></i>
      </a>
    </div>
  
</div>

<div 
  class="card card-content toc-card" 
  id="mobiletoc">
  <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>目錄
</div>
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E7%A7%8D%E7%B1%BB"><span class="toc-number">1.</span> <span class="toc-text">问题种类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6"><span class="toc-number">1.1.</span> <span class="toc-text">时间复杂度</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NSArray-x2F-NSMutableArray"><span class="toc-number">1.1.1.</span> <span class="toc-text">NSArray &#x2F; NSMutableArray</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSSet-x2F-NSMutableSet-x2F-NSCountedSet"><span class="toc-number">1.1.2.</span> <span class="toc-text">NSSet &#x2F; NSMutableSet &#x2F; NSCountedSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSDictionary-x2F-NSMutableDictionary"><span class="toc-number">1.1.3.</span> <span class="toc-text">NSDictionary &#x2F; NSMutableDictionary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#containsObject-%E6%96%B9%E6%B3%95%E5%9C%A8%E6%95%B0%E7%BB%84%E5%92%8C-Set-%E9%87%8C%E4%B8%8D%E5%90%8C%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.4.</span> <span class="toc-text">containsObject 方法在数组和 Set 里不同的实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8-GCD-%E6%9D%A5%E5%81%9A%E4%BC%98%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text">用 GCD 来做优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.2.1.</span> <span class="toc-text">异步处理事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E8%80%97%E6%97%B6%E9%95%BF%E7%9A%84%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.2.2.</span> <span class="toc-text">需要耗时长的任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E7%BA%BF%E7%A8%8B%E7%88%86%E7%82%B8"><span class="toc-number">1.2.3.</span> <span class="toc-text">避免线程爆炸</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GCD-%E7%9B%B8%E5%85%B3-Crash-%E6%97%A5%E5%BF%97"><span class="toc-number">1.2.4.</span> <span class="toc-text">GCD 相关 Crash 日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#I-x2F-O-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">1.3.</span> <span class="toc-text">I&#x2F;O 性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NSCache"><span class="toc-number">1.3.1.</span> <span class="toc-text">NSCache</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6-App-%E7%9A%84-Wake-%E6%AC%A1%E6%95%B0"><span class="toc-number">1.4.</span> <span class="toc-text">控制 App 的 Wake 次数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%AF%B9%E4%BA%8E%E6%80%A7%E8%83%BD%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-number">1.5.</span> <span class="toc-text">内存对于性能的影响</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%A2%84%E9%98%B2%E8%BF%99%E4%BA%9B%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%EF%BC%8C%E9%9C%80%E8%A6%81%E5%88%BB%E6%84%8F%E9%A2%84%E9%98%B2%E4%B9%88"><span class="toc-number">2.</span> <span class="toc-text">如何预防这些性能问题，需要刻意预防么</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%A3%80%E6%9F%A5"><span class="toc-number">3.</span> <span class="toc-text">如何检查</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E7%9B%91%E5%90%AC%E4%B8%BB%E7%BA%BF%E7%A8%8B%E6%96%B9%E5%BC%8F%E6%9D%A5%E7%9B%91%E5%AF%9F"><span class="toc-number">4.</span> <span class="toc-text">通过监听主线程方式来监察</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%89%93%E5%8D%B0%E5%A0%86%E6%A0%88%E4%BF%A1%E6%81%AF%EF%BC%8C%E4%BF%9D%E5%AD%98%E7%8E%B0%E5%9C%BA"><span class="toc-number">5.</span> <span class="toc-text">如何打印堆栈信息，保存现场</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-number">5.1.</span> <span class="toc-text">获取线程的信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%BA%BF%E7%A8%8B%E9%87%8C%E6%89%80%E6%9C%89%E6%A0%88%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-number">5.2.</span> <span class="toc-text">获取线程里所有栈的信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E5%8C%96"><span class="toc-number">5.3.</span> <span class="toc-text">符号化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%9C%B0%E6%96%B9"><span class="toc-number">5.4.</span> <span class="toc-text">需要注意的地方</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%83%BD%E5%A4%9F%E8%8E%B7%E5%8F%96%E6%9B%B4%E5%A4%9A%E4%BF%A1%E6%81%AF%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">6.</span> <span class="toc-text">能够获取更多信息的方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%A0%91%E7%BB%93%E6%9E%84"><span class="toc-number">6.1.</span> <span class="toc-text">获取方法调用树结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E8%AF%BB%E5%8F%96-ThreadCallStack"><span class="toc-number">6.2.</span> <span class="toc-text">存储读取 ThreadCallStack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%B7%B1%E5%BA%A6"><span class="toc-number">6.3.</span> <span class="toc-text">记录方法调用深度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8-objc-msgSend-%E5%89%8D%E5%90%8E%E6%8F%92%E5%85%A5%E6%89%A7%E8%A1%8C%E6%96%B9%E6%B3%95"><span class="toc-number">6.4.</span> <span class="toc-text">在 objc_msgSend 前后插入执行方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E6%97%B6%E9%97%B4%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">6.5.</span> <span class="toc-text">记录时间的方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95-hook-msgsend-%E6%96%B9%E6%B3%95"><span class="toc-number">7.</span> <span class="toc-text">如何 hook msgsend 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%8D%E5%8E%86-dyld"><span class="toc-number">7.1.</span> <span class="toc-text">遍历 dyld</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%BE%E5%87%BA%E7%AC%A6%E5%8F%B7%E8%A1%A8%E7%9B%B8%E5%85%B3-Command"><span class="toc-number">7.2.</span> <span class="toc-text">找出符号表相关 Command</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%BE%97-base-%E5%92%8C-indirect-%E7%AC%A6%E5%8F%B7%E8%A1%A8"><span class="toc-number">7.3.</span> <span class="toc-text">获得 base 和 indirect 符号表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E8%A1%8C%E6%96%B9%E6%B3%95%E6%9B%BF%E6%8D%A2"><span class="toc-number">7.4.</span> <span class="toc-text">进行方法替换</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%9F%E8%AE%A1%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E9%A2%91%E6%AC%A1"><span class="toc-number">8.</span> <span class="toc-text">统计方法调用频次</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E9%A2%91%E6%AC%A1%E8%AE%B0%E5%BD%95%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-number">8.1.</span> <span class="toc-text">设计方法调用频次记录的结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BC%E8%A3%85%E6%96%B9%E6%B3%95%E8%B7%AF%E5%BE%84"><span class="toc-number">8.2.</span> <span class="toc-text">拼装方法路径</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E9%A2%91%E6%AC%A1%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">8.3.</span> <span class="toc-text">记录方法调用频次数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">8.3.1.</span> <span class="toc-text">创建数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%AE%B0%E5%BD%95"><span class="toc-number">8.3.2.</span> <span class="toc-text">添加记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E7%B4%A2%E8%AE%B0%E5%BD%95"><span class="toc-number">8.3.3.</span> <span class="toc-text">检索记录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%BE%E5%87%BA-CPU-%E4%BD%BF%E7%94%A8%E5%A4%A7%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%A0%86%E6%A0%88"><span class="toc-number">9.</span> <span class="toc-text">找出 CPU 使用大的线程堆栈</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Demo"><span class="toc-number">10.</span> <span class="toc-text">Demo</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B5%84%E6%96%99"><span class="toc-number">11.</span> <span class="toc-text">资料</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WWDC"><span class="toc-number">11.1.</span> <span class="toc-text">WWDC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PS"><span class="toc-number">12.</span> <span class="toc-text">PS:</span></a></li></ol>
</div>
            </main>
            <aside class="right-column">
              <div class="sticky-widescreen">
  
  
    <article class="card card-content toc-card">
      <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>目錄
</div>
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E7%A7%8D%E7%B1%BB"><span class="toc-number">1.</span> <span class="toc-text">问题种类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6"><span class="toc-number">1.1.</span> <span class="toc-text">时间复杂度</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NSArray-x2F-NSMutableArray"><span class="toc-number">1.1.1.</span> <span class="toc-text">NSArray &#x2F; NSMutableArray</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSSet-x2F-NSMutableSet-x2F-NSCountedSet"><span class="toc-number">1.1.2.</span> <span class="toc-text">NSSet &#x2F; NSMutableSet &#x2F; NSCountedSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSDictionary-x2F-NSMutableDictionary"><span class="toc-number">1.1.3.</span> <span class="toc-text">NSDictionary &#x2F; NSMutableDictionary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#containsObject-%E6%96%B9%E6%B3%95%E5%9C%A8%E6%95%B0%E7%BB%84%E5%92%8C-Set-%E9%87%8C%E4%B8%8D%E5%90%8C%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.4.</span> <span class="toc-text">containsObject 方法在数组和 Set 里不同的实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8-GCD-%E6%9D%A5%E5%81%9A%E4%BC%98%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text">用 GCD 来做优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.2.1.</span> <span class="toc-text">异步处理事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E8%80%97%E6%97%B6%E9%95%BF%E7%9A%84%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.2.2.</span> <span class="toc-text">需要耗时长的任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E7%BA%BF%E7%A8%8B%E7%88%86%E7%82%B8"><span class="toc-number">1.2.3.</span> <span class="toc-text">避免线程爆炸</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GCD-%E7%9B%B8%E5%85%B3-Crash-%E6%97%A5%E5%BF%97"><span class="toc-number">1.2.4.</span> <span class="toc-text">GCD 相关 Crash 日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#I-x2F-O-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">1.3.</span> <span class="toc-text">I&#x2F;O 性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NSCache"><span class="toc-number">1.3.1.</span> <span class="toc-text">NSCache</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6-App-%E7%9A%84-Wake-%E6%AC%A1%E6%95%B0"><span class="toc-number">1.4.</span> <span class="toc-text">控制 App 的 Wake 次数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%AF%B9%E4%BA%8E%E6%80%A7%E8%83%BD%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-number">1.5.</span> <span class="toc-text">内存对于性能的影响</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%A2%84%E9%98%B2%E8%BF%99%E4%BA%9B%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%EF%BC%8C%E9%9C%80%E8%A6%81%E5%88%BB%E6%84%8F%E9%A2%84%E9%98%B2%E4%B9%88"><span class="toc-number">2.</span> <span class="toc-text">如何预防这些性能问题，需要刻意预防么</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%A3%80%E6%9F%A5"><span class="toc-number">3.</span> <span class="toc-text">如何检查</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E7%9B%91%E5%90%AC%E4%B8%BB%E7%BA%BF%E7%A8%8B%E6%96%B9%E5%BC%8F%E6%9D%A5%E7%9B%91%E5%AF%9F"><span class="toc-number">4.</span> <span class="toc-text">通过监听主线程方式来监察</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%89%93%E5%8D%B0%E5%A0%86%E6%A0%88%E4%BF%A1%E6%81%AF%EF%BC%8C%E4%BF%9D%E5%AD%98%E7%8E%B0%E5%9C%BA"><span class="toc-number">5.</span> <span class="toc-text">如何打印堆栈信息，保存现场</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-number">5.1.</span> <span class="toc-text">获取线程的信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%BA%BF%E7%A8%8B%E9%87%8C%E6%89%80%E6%9C%89%E6%A0%88%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-number">5.2.</span> <span class="toc-text">获取线程里所有栈的信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E5%8C%96"><span class="toc-number">5.3.</span> <span class="toc-text">符号化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%9C%B0%E6%96%B9"><span class="toc-number">5.4.</span> <span class="toc-text">需要注意的地方</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%83%BD%E5%A4%9F%E8%8E%B7%E5%8F%96%E6%9B%B4%E5%A4%9A%E4%BF%A1%E6%81%AF%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">6.</span> <span class="toc-text">能够获取更多信息的方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%A0%91%E7%BB%93%E6%9E%84"><span class="toc-number">6.1.</span> <span class="toc-text">获取方法调用树结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E8%AF%BB%E5%8F%96-ThreadCallStack"><span class="toc-number">6.2.</span> <span class="toc-text">存储读取 ThreadCallStack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%B7%B1%E5%BA%A6"><span class="toc-number">6.3.</span> <span class="toc-text">记录方法调用深度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8-objc-msgSend-%E5%89%8D%E5%90%8E%E6%8F%92%E5%85%A5%E6%89%A7%E8%A1%8C%E6%96%B9%E6%B3%95"><span class="toc-number">6.4.</span> <span class="toc-text">在 objc_msgSend 前后插入执行方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E6%97%B6%E9%97%B4%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">6.5.</span> <span class="toc-text">记录时间的方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95-hook-msgsend-%E6%96%B9%E6%B3%95"><span class="toc-number">7.</span> <span class="toc-text">如何 hook msgsend 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%8D%E5%8E%86-dyld"><span class="toc-number">7.1.</span> <span class="toc-text">遍历 dyld</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%BE%E5%87%BA%E7%AC%A6%E5%8F%B7%E8%A1%A8%E7%9B%B8%E5%85%B3-Command"><span class="toc-number">7.2.</span> <span class="toc-text">找出符号表相关 Command</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%BE%97-base-%E5%92%8C-indirect-%E7%AC%A6%E5%8F%B7%E8%A1%A8"><span class="toc-number">7.3.</span> <span class="toc-text">获得 base 和 indirect 符号表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E8%A1%8C%E6%96%B9%E6%B3%95%E6%9B%BF%E6%8D%A2"><span class="toc-number">7.4.</span> <span class="toc-text">进行方法替换</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%9F%E8%AE%A1%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E9%A2%91%E6%AC%A1"><span class="toc-number">8.</span> <span class="toc-text">统计方法调用频次</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E9%A2%91%E6%AC%A1%E8%AE%B0%E5%BD%95%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-number">8.1.</span> <span class="toc-text">设计方法调用频次记录的结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BC%E8%A3%85%E6%96%B9%E6%B3%95%E8%B7%AF%E5%BE%84"><span class="toc-number">8.2.</span> <span class="toc-text">拼装方法路径</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E9%A2%91%E6%AC%A1%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">8.3.</span> <span class="toc-text">记录方法调用频次数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">8.3.1.</span> <span class="toc-text">创建数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%AE%B0%E5%BD%95"><span class="toc-number">8.3.2.</span> <span class="toc-text">添加记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E7%B4%A2%E8%AE%B0%E5%BD%95"><span class="toc-number">8.3.3.</span> <span class="toc-text">检索记录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%BE%E5%87%BA-CPU-%E4%BD%BF%E7%94%A8%E5%A4%A7%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%A0%86%E6%A0%88"><span class="toc-number">9.</span> <span class="toc-text">找出 CPU 使用大的线程堆栈</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Demo"><span class="toc-number">10.</span> <span class="toc-text">Demo</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B5%84%E6%96%99"><span class="toc-number">11.</span> <span class="toc-text">资料</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WWDC"><span class="toc-number">11.1.</span> <span class="toc-text">WWDC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PS"><span class="toc-number">12.</span> <span class="toc-text">PS:</span></a></li></ol>
    </article>
  
  
  <article class="card card-content">
    <div class="recent-posts-card">
  <div class="recent-posts-header">
    <i 
      class="iconfont icon-wenzhang_huaban" 
      style="padding-right: 2px;">
    </i>最新文章
  </div>
  <div class="recent-posts-list">
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2022-07-08</div>
        <a href="/2022/07/08/slides-of-use-llvm/"><div class="recent-posts-item-content">使用 LLVM 分享的幻灯片</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2022-06-10</div>
        <a href="/2022/06/10/use-llvm/"><div class="recent-posts-item-content">使用 LLVM</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2022-06-10</div>
        <a href="/2022/06/10/wwdc22-notes/"><div class="recent-posts-item-content">WWDC22 笔记</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2022-03-25</div>
        <a href="/2022/03/25/develop-with-swiftui/"><div class="recent-posts-item-content">在苹果加速器活动做的 SwiftUI 开发分享</div></a>
      </div>
    
  </div>
</div>
  </article>
  
  
</div>
            </aside>
          </div>
        </div>
      </div>
    </div>
     
    <footer class="footer">
  <div class="footer-container">
    <div>
      <div class="footer-dsc">
        <span>
          Copyright ©
          
            2014
          
          
                - 
                2022
          
        </span>
        &nbsp;
        <a 
          href="/" 
          class="footer-link">
          戴铭的博客
        </a>
      </div>
    </div>

    
    
    
      <div class="BbeiAn-info">
        <a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">鄂ICP备17011999号 </a>
      </div>
      
        <div class="BbeiAn-info">
          <span style="padding-left: 25px;background: url(/img/beian.png) no-repeat left center"></span>
          <a target="_blank" rel="noopener" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=7011999 ">京公网安备 7011999号
          </a>
          <br />
        </div>
      
    
    
      <div class="footer-dsc">
        
          本站总访问量<span id="busuanzi_value_site_pv"></span>次
        
        
          <span>&nbsp;|&nbsp;</span>
        
        
          本站总访客数<span id="busuanzi_value_site_uv"></span>次
        
      </div>
      
    
</footer>
 
    
  <a 
    role="button" 
    id="scrollbutton" 
    class="basebutton" 
    aria-label="回到顶部">
    <i class="iconfont icon-arrowleft button-icon"></i>
  </a>

<a 
  role="button" 
  id="menubutton"
  aria-label="menu button"
  class="basebutton">
  <i class="iconfont icon-menu button-icon"></i>
</a>
<a 
  role="button" 
  id="popbutton" 
  class="basebutton" 
  aria-label="控制中心">
  <i class="iconfont icon-expand button-icon"></i>
</a>
<a 
  role="button" 
  id="darkbutton" 
  class="basebutton darkwidget" 
  aria-label="夜色模式">
  <i class="iconfont icon-weather button-icon"></i>
</a>
<a 
  role="button" 
  id="searchbutton" 
  class="basebutton searchwidget" 
  aria-label="搜索">
  <i class="iconfont icon-search button-icon"></i>
</a> 
     
     
     
      <script>
  var addImgLayout = function () {
    var img = document.querySelectorAll('.post-content img')
    var i
    for (i = 0; i < img.length; i++) {
      var wrapper = document.createElement('a')
      wrapper.setAttribute('href', img[i].getAttribute('data-src'))
      wrapper.setAttribute('aria-label', 'illustration')
      wrapper.style.cssText =
        'width: 100%; display: flex; justify-content: center;'
      if (img[i].alt) wrapper.dataset.caption = img[i].alt
      wrapper.dataset.nolink = true
      img[i].before(wrapper)
      wrapper.append(img[i])
      var divWrap = document.createElement('div')
      divWrap.classList.add('gallery')
      wrapper.before(divWrap)
      divWrap.append(wrapper)
    }
    baguetteBox.run('.gallery')
  }
</script>
<script>
  loadScript(
    "/js/lib/lightbox/baguetteBox.min.js",
    addImgLayout
  )
</script>
 
     
     
    <script src="/js/main.js"></script> 
    
      <script> 
        loadScript('/js/lib/busuanzi.min.js') 
      </script>
     
    
      <script>
        var addLazyload = function () {
          var observer = lozad('.lozad', {
            load: function (el) {
              el.srcset = el.getAttribute('data-src')
            },
            loaded: function (el) {
              el.classList.add('loaded')
            },
          })
          observer.observe()
        }
      </script>
      <script>
        loadScript('/js/lib/lozad.min.js', addLazyload)
      </script>
    
    <script src="//instant.page/5.1.0" type="module"
      integrity="sha384-by67kQnR+pyfy8yWP4kPO12fHKRLHZPfEsiSXR8u2IKcTdxD805MGUXBzVPnkLHw"></script>
    
    
  </body>
</html>
